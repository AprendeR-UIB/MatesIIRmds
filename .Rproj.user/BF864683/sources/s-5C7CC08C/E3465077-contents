--- 
title: "Matemàtiques II"
author: "The Matemàtiques II team"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output: 
   bookdown::html_book:
    includes:
      in_header: style.css
documentclass: book
#bibliography: [book.bib, packages.bib]
biblio-style: apalike
link-citations: yes
github-repo: cescrossello/MatesII
description: "Apunts Matemàtiques II bookdown::gitbook."
---

```{r global_options,  include=FALSE}
library(knitr)
#library(xtable)
#library(printr)
knitr::opts_chunk$set(
  fig.width=5, 
  fig.asp = 1,
  fig.align="center", 
  fig.show = "hold",
  echo=TRUE, 
  warning=FALSE, 
  message=FALSE,
  cache=TRUE
#  tidy.opts=list(width.cutoff=60),
#  tidy=TRUE
)
knitr::opts_knit$set(global.par=TRUE)
options(knitr.graphics.auto_pdf=TRUE)
warning.length=100
```

```{r,  include=FALSE}
par(cex.main=0.9,cex.axis=0.8,cex.lab=0.8)
```



```{r, paquets, include=FALSE}
library(latex2exp)
library(epitools)
library(car)
```

\renewcommand\chaptername{Tema}
\renewcommand{\leq}{\leqslant}
\renewcommand{\geq}{\geqslant}

# Presentació {-}

Això és una edició en línea dels apunts de Matemàtiques II dels graus de Biologia i Bioquímica de la UIB.

El llibre està escrit en *R Markdown*, emprant *RStudio* com a editor de textos i el paquet **bookdown** per convertir els fitxers *markdown* en un llibre 

Aquest treball se publica sota llicència [Atribució-No Comercial-SenseDerivats 4.0](https://creativecommons.org/licenses/by-nc-nd/4.0/)


<!--chapter:end:index.Rmd-->

# (PART\*) Part II: Estadística inferencial {-}

# Tema 0 &nbsp;&nbsp; Repàs de la distribució normal {-}

## Propietats de la distribució normal 

Una variable aleatòria contínua $X$ és **normal** de paràmetres $\mu$ i $\sigma$, i ho indicarem escrivint $X\sim N(\mu,\sigma)$, quan la seva funció de densitat és 

```{r, echo=FALSE,fig.width=1,out.width="35%"}
knitr::include_graphics("Bioestadistica-II_files/figure-html/censored.png")
```

Naturalment, no cal saber aquesta fórmula. El que cal saber és que:

* Una variable aleatòria normal $X$ és contínua, i per tant $P(X=x)=0$, $P(X\leq x)=P(X<x)$ etc.

* Si $X\sim N(\mu,\sigma)$, aleshores el seu valor esperat és $E(X)=\mu$ i la seva desviació típica és $\sigma_X=\sigma$

Una variable aleatòria normal és **típica** (o **estàndard**) quan $\mu=0$ i $\sigma=1$; la indicarem usualment amb $Z$. Per tant, si $Z\sim N(0,1)$,  $E(Z)=0$ i $\sigma_Z=1$.

La gràfica de la densitat d'una variable aleatòria normal és la famosa **campana de Gauss**:

```{r,echo=FALSE,fig.width=5}
curve(dnorm(x),-5,5,col="blue",lwd=3,ylim=c(0,0.5),main="Densitat de N(0,1)",xlab="",ylab="")
abline(v=0)
```

La gràfica de la densitat d'una variable aleatòria normal és també la menys famosa **gràfica del capell del gendarme**:

```{r, echo=FALSE,fig.width=4,out.width="50%"}
knitr::include_graphics("Bioestadistica-II_files/figure-html/gendarme.png")
```


La distribució normal és una distribució teòrica, no la trobareu exacta en la pràctica. I malgrat el seu nom, no és més "normal" que les altres distribucions que estudiarem. 

```{r, echo=FALSE, fig.width=4, out.width="50%"}
knitr::include_graphics("Bioestadistica-II_files/figure-html/paranormal.png")
```


La distribució normal és important perquè aproxima bé moltes distribucions reals, perquè:

```{block2, type='rmdimportant'}
Moltes variables aleatòries que consisteixen a prendre $n$ observacions independents d'una o diverses variables aleatòries i sumar-les, tenen distribució aproximadament normal quan $n$ és gran, encara que les variables aleatòries de partida no ho siguin.
```

Per exemple:

* Si $X$ és una variable aleatòria binomial *B(n,p)*, amb $n$ gran, alehores $X$ és aproximadament $N(np,\sqrt{np(1-p)})$, en el sentit que les dues funcions de densitat (salvant la diferència pel fet que la binomial és discreta i la normal contínua) són semblants:

```{r,echo=FALSE}
y=0:30
plot(y,dbinom(y,50,0.3),pch=20,xlab="",ylab="", col="red",
     main="B(50,0.3) i N(50*0.3,sqrt(50*0.3*(1-0.3)))")
curve(dnorm(x,50*0.3,sqrt(50*0.3*(1-0.3))),col="blue",add=TRUE,lwd=2)
legend("topright",legend=c("Normal","Binomial"),col=c("blue","red"),
       pch=c(NA,20), lty=c("solid",NA),lwd=c(2,1),cex=0.75)
```


* Si $X$ és una variable aleatòria de Poisson $Po(\lambda)$ i $\lambda$ és gran, aleshores $X$ és aproximadament $N(\lambda,\sqrt{\lambda})$

```{r,echo=FALSE}
y=30:110
plot(y,dpois(y,70),pch=20,xlab="",ylab="", col="red",
     main="Pois(70) i N(70,sqrt(70))")
curve(dnorm(x,70,sqrt(70)),col="blue",add=TRUE,lwd=2)
legend("topright",legend=c("Normal","Poisson"),col=c("blue","red"),
       pch=c(NA,20), lty=c("solid",NA),cex=0.75)
```


Una de les propietats principals de la distribució normal és la seva simetria:

```{block2, type='rmdimportant'}
Si $X\sim N(\mu,\sigma)$, la seva densitat $f_X$ és simètrica respecte de $x=\mu$, és a dir,
$$
f_{X}(\mu-x)=f_{X}(\mu+x),
$$
i té el màxim en $x=\mu$.
```

```{r, echo=FALSE,  fig.width=8, fig.asp = 0.5}
curve(dnorm,-4,4,xaxt="n",yaxt="n",xaxs="i",yaxs="i",xlab="",bty="l",ylab="",lwd=2)
abline(v=0,lty=2)
axis(1,at=c(0), labels=c(expression(mu)))
```

Diem aleshores que $\mu$ és la **moda** de $X$.

```{block2, type='rmdnote'}
Recordem que no té sentit definir la moda d'una variable contínua $X$ com el valor $x_0$ tal que $P(X=x_0)$ sigui màxim, perquè $P(X=x)=0$ per a tot $x\in \mathbb{R}$. Es defineix llavors la **moda** d'una variable contínua $X$ com el valor $x_0$ tal que $f_X(x_0)$ és màxim.
```

En particular, si $Z\sim N(0,1)$, llavors $f_{Z}$ és simètrica al voltant de $x=0$, és a dir, $f_{Z}(-x)=f_{Z}(x)$, i la moda de $Z$ és 0.

Si la $\mu$ creix, el màxim es desplaça a la dreta, i amb ell tota la corba de manera rígida.

```{r, echo=FALSE,  fig.width=8, fig.asp = 0.5}
curve(dnorm(x,0,1),-4,6,col="red",xaxs="i",yaxs="i",ylim=c(0,0.5),bty="l",xaxt="n",yaxt="n",xlab="",ylab="",lwd=2,main=expression(mu[1]<mu[2]))
curve(dnorm(x,2,1),-4,6,col="blue",lwd=2,add=T)
abline(v=0)
abline(v=2)
axis(1,at=c(0,2), labels=c(expression(mu[1]),expression(mu[2])))
text(-1.5,0.32,expression(N(mu[1],sigma)),col="red")
text(3.5,0.32,expression(N(mu[2],sigma)),col="blue")
```


Si la $\sigma$ creix, la corba s'aplata: en augmentar la desviació típica, els valors s'allunyen més del valor mitjà.

```{r, echo=FALSE,  fig.width=8, fig.asp = 0.5}
curve(dnorm(x,0,1),-6,6,col="red",xaxs="i",yaxs="i",ylim=c(0,0.5),bty="l",xaxt="n",yaxt="n",xlab="",ylab="",lwd=2,main=expression(sigma[1]<sigma[2]))
curve(dnorm(x,0,1.5),col="blue",lwd=2,add=T)
abline(v=0)
axis(1,at=c(0), labels=c(expression(mu)))
text(-1.5,0.32,expression(N(mu,sigma[1])),col="red")
text(3.5,0.1,expression(N(mu,sigma[2])),col="blue")
```

Vegem  l'efecte combinat:

```{r, echo=FALSE,  fig.width=8, fig.asp = 0.5}
curve(dnorm(x,0,1),-4,8,col="red",xaxs="i",yaxs="i",ylim=c(0,0.5),bty="l",xaxt="n",yaxt="n",xlab="",ylab="",
      lwd=2,main=expression(paste(mu[1]<mu[2], " i ", sigma[1]<sigma[2])))
curve(dnorm(x,2,1.5),col="blue",lwd=2,add=T)
abline(v=0)
abline(v=2)
axis(1,at=c(0,2), labels=c(expression(mu[1]),expression(mu[2])))
text(-1.5,0.32,expression(N(mu[1],sigma[1])),col="red")
text(3.5,0.25,expression(N(mu[2],sigma[2])),col="blue")
```


Recordem que la funció de distribució d'una variable aleatòria contínua $X$
$$
F_X(x)=P(X\leq x)
$$ 
és l'àrea compresa entre la corba definida per la densitat $y=f_X(x)$ i l'eix d'abscisses a l'esquerra de $x$.

```{r,echo=FALSE,  fig.width=8, fig.asp = 0.5}
x <- seq(-4,4,.1)

plot(x,dnorm(x),type="l",xlab="",ylab=expression(f[X](x)),xaxs="i",yaxs="i",ylim=c(0,.4),bty="l",xaxt="n",yaxt="n")
polysection <- function(a,b,dist=dnorm,col="blue",n=11){
    dx <- seq(a,b,length.out=n)
    polygon(c(a,dx,b),c(0,dist(dx),0),border=NA,col=col)
}

for(i in -4:0){
    polysection(i,i+1,col="grey")
}

axis(1,at=c(1), labels=c(expression(x)))
arrows(-0,0.1,-2.5,0.3,lwd=2)
text(-2.5,0.32,expression(F[X](x)== P(X<=x) ) )
```

La simetria de $f_X$ fa que les àrees a l'esquerra de $\mu-x$ i a la dreta de $\mu+x$ siguin iguals.

```{r, echo=FALSE,  fig.width=8, fig.asp = 0.5}
x <- seq(-4,4,.1)

plot(x,dnorm(x),type="l",xlab="",ylab="",xaxs="i",yaxs="i",ylim=c(0,.4),bty="l",xaxt="n",yaxt="n",lwd=2)
polysection <- function(a,b,dist=dnorm,col="blue",n=11){
    dx <- seq(a,b,length.out=n)
    polygon(c(a,dx,b),c(0,dist(dx),0),border=NA,col=col)
}

for(i in -4:-2){
    polysection(i,i+1,col="blue")
  #  polysection(-i-1,-i,col="grey")
}
for(i in 1:4){
    polysection(i,i+1,col="blue")
  #  polysection(-i-1,-i,col="grey")
}


axis(1,at=c(-1,0,1), labels=c(expression(mu-x),expression(mu),expression(mu+x)))
abline(v=0,lty=2)
```

És a dir,
$$
P(X\leq \mu-x) = P(X\geq \mu+x)=1-P(X\leq \mu+x)
$$
En particular (prenent $x=0$)
$$
P(X\leq \mu)=1-P(X\leq \mu)\Rightarrow P(X\leq \mu)=0.5,
$$
i per tant $\mu$ és també la *mediana* de $X$.

```{block2, type='rmdimportant'}
Si $X\sim N(\mu,\sigma)$, $\mu$ és la moda, la mitjana, o esperança, i la mediana de $X$.
```


En particular, si $Z\sim N(0,1)$, les àrees a l'esquerra de $-z$ i a la dreta de $z$ són iguals,
$$
P(Z\leq -z)=P(Z\geq z)=1-P(Z\leq z),
$$
i per tant, la mediana de $Z$ és 0.



```{r, eval=FALSE, echo=FALSE,  fig.width=8, fig.asp = 0.5}
x <- seq(-4,4,.1)

plot(x,dnorm(x),type="l",xlab="",ylab="",xaxs="i",yaxs="i",ylim=c(0,.4),bty="l",xaxt="n",yaxt="n",lwd=2)
polysection <- function(a,b,dist=dnorm,col="blue",n=11){
    dx <- seq(a,b,length.out=n)
    polygon(c(a,dx,b),c(0,dist(dx),0),border=NA,col=col)
}

for(i in -4:-2){
    polysection(i,i+1,col="blue")
  #  polysection(-i-1,-i,col="grey")
}
for(i in 1:4){
    polysection(i,i+1,col="blue")
  #  polysection(-i-1,-i,col="grey")
}


axis(1,at=c(-1,0,1), labels=c(expression(-z),"0",expression(z)))
abline(v=0,lty=2)
```


Indicarem amb $z_q$ el $q$**-quantil** d'una variable normal estàndard $Z$. És a dir, $z_q$ és el valor tal que $P(Z\leq z_q)=q$. 

A banda del fet que $z_{0.5}=0$ (la mediana de $Z$ és 0),  hi ha dos quantils més de la normal estándard que heu de saber "de memòria":

* $z_{0.95}=1.64$, és a dir, $P(Z<-1.64)=P(Z>1.64)=0.05$.

* $z_{0.975}=1.96$, és a dir, $P(Z<-1.96)=P(Z>1.96)=0.025$

```{block2, type='rmdnote'}
Molt sovint el valor 1.96 de $z_{0.975}$ s'aproxima per 2. Teniu permís per fer-ho quan no disposeu de mitjans (R, aplis de mòbil) per calcular quantils.
```


## Amb R

Per calcular probabilitats d'una variable normal emprant R, heu de recordar que la normal és `norm`.
Per tant, si $X\sim N(\mu,\sigma)$:

* `dnorm(x,mu,sigma)` dóna el valor de la densitat $f_X(x)$

* `pnorm(x,mu,sigma)` dóna el valor de la distribució $F_X(x)=P(X\leq x)$

* `qnorm(q,mu,sigma)` dóna el $q$-quantil de $X$

* `rnorm(N,mu,sigma)` dóna un vector de $n$ nombres aleatoris generats amb aquesta distribució

A la normal estàndard no és necessari entrar-hi $\mu=0$ i $\sigma=1$, són els valors per defecte d'aquests paràmetres.

Vegem-ne alguns exemples:

* Si $X\sim N(3,0.5)$, què val $P(X\leq 2)$? 

```{r}
pnorm(2,3,0.5)
```

* Si $X\sim N(0,1)$, què val $P(-1\leq X\leq 1)$? 

    Com que $P(-1\leq X\leq 1)=P(X\leq 1)-P(X\leq -1)$,  

```{r}
pnorm(1)-pnorm(-1)
```

* Què val el primer quartil d'una variable $N(3,0.5)$?

```{r}
qnorm(0.25,3,0.5)
```


## Tipificació

El resultat següent descriu el comportament de l'esperança $E$ i la variància $\sigma^2$ d'una combinació lineal de variables aleatòries:

```{theorem, combvar}
Siguin $Y_1,\ldots,Y_n$ variables aleatòries, $a_1,\ldots,a_n,b\in \mathbb{R}$, i $Y$ la variable aleatòria
$$
Y=a_1Y_1+\cdots+a_nY_n+b.
$$
Aleshores

1. $E(Y)=a_1E(Y_1)+\cdots+a_nE(Y_n)+b$.

2. Si $Y_1,\ldots,Y_n$ són **independents**, aleshores 
$$
  \sigma_Y^2=a_1^2\sigma_1^2+\cdots+a_n^2\sigma_n^2
$$ 
i per tant 
$$
  \sigma_Y=\sqrt{a_1^2\sigma_1^2+\cdots+a_n^2\sigma_n^2}.
$$

```

Una altra propietat destacada de la distribució normal és que tota combinació lineal de variables aleatòries normals independents torna a ser normal: 


```{theorem, combnormal}
Si $Y_1,\ldots,Y_n$ son variables aleatòries normals independents, cada $Y_i\sim N(\mu_i,\sigma_i)$, i $a_1,\ldots,a_n,b\in \mathbb{R}$, aleshores
$$
Y=a_1Y_1+\cdots+a_nY_n+b
$$
és una variable aleatòria $N(\mu,\sigma)$ amb $\mu$ i $\sigma$ els que toquin pel teorema anterior:

* $\mu=a_1\mu_1+\cdots+a_n\mu_n+b$

* $\sigma=\sqrt{a_1^2\sigma_1^2+\cdots+a_n^2\sigma_n^2}$
```


Com a cas particular, obtenim que una transformació afí d'una  variable aleatòria normal torna a ser normal:

```{theorem}
Si $X\sim N(\mu,\sigma)$ i $a,b\in \mathbb{R}$, llavors $aX+b$ també és normal, i en concret és $N(a\mu+b,|a|\cdot\sigma)$.
```

En particular, si $X\sim N(\mu,\sigma)$, llavors la seva **tipificada** 
$$
Z=\dfrac{X-\mu}{\sigma}
$$ 
és $N(0,1)$.

Les probabilitats de la normal tipificada determinen les de la normal original, perquè si $X\sim N(\mu,\sigma)$,
$$
\begin{array}{rl}
P(a\leq X\leq b) & \displaystyle  =P\Big( \frac{a-\mu}{\sigma}\leq \frac{X-\mu}{\sigma}\leq \frac{b-\mu}{\sigma}\Big)\\ & \displaystyle =P\Big(\frac{a-\mu}{\sigma}\leq Z\leq \frac{b-\mu}{\sigma}\Big)
\end{array}
$$










## Intervals de referència 

Un **interval de referència del q%**  per a una variable aleatòria $X$ és un interval $[a,b]$ tal que 
$$
P(a\leq X\leq b)=\frac{q}{100}.
$$
És a dir, un interval de referència del q% per a $X$ és un interval que conté els valors de $X$ del q% de subjectes de la població on està definida.

Els més comuns són els intervals de referència del 95%, que satisfan que
$$
P(a\leq X\leq b)=0.95
$$
i són els, que per exemple, us donen com a valors de referència a les analítiques:

```{r, echo=FALSE,  fig.width=2, fig.asp = 2}
knitr::include_graphics("Bioestadistica-II_files/figure-html/analit.png")

```


Quan es parla d'un **interval de referència** sense donar-ne la probabilitat, se sobreentén sempre que és l'interval de referència del 95%.


Quan $X\sim N(\mu,\sigma)$, aquests intervals de referència es prenen *sempre centrats en la mitjana* $\mu$, és a dir, de la forma $[\mu-x,\mu+x]$. Per calcular-los fàcilment, podem emprar el resultat següent:


```{theorem} 
Si $X\sim N(\mu,\sigma)$, un interval de referència del 100q% és
$$
[\mu- z_{(1+q)/2}\cdot \sigma, \mu+ z_{(1+q)/2}\cdot \sigma]
$$
on, recordau, $z_{(1+q)/2}$ indica el $(1+q)/2$-quantil de $Z\sim N(0,1)$. L'escriurem
$$
\mu\pm z_{(1+q)/2}\cdot \sigma.
$$

```

```{block2, type='rmdcorbes'}
En efecte:
$$
\begin{array}{l}
P(\mu-x\leq X\leq \mu+x)=q\\
\qquad \Longleftrightarrow \displaystyle P\Big(\frac{\mu-x-\mu}{\sigma}\leq \frac{X-\mu}{\sigma}\leq \frac{\mu+x-\mu}{\sigma}\Big)=q\\
\qquad \Longleftrightarrow \displaystyle P(-x/{\sigma}\leq Z\leq {x}/{\sigma})=q\\
\qquad \Longleftrightarrow \displaystyle P(Z\leq {x}/{\sigma})-P(Z\leq -{x}/{\sigma})=q\\
\qquad \Longleftrightarrow \displaystyle P(Z\leq {x}/{\sigma})-(1-P(Z\leq {x}/{\sigma}))=q\\
\qquad \mbox{(per la simetria de $f_Z$ al voltant de 0)}\\
\qquad \Longleftrightarrow \displaystyle 2P(Z\leq {x}/{\sigma})=q+1\\
\qquad \Longleftrightarrow P(Z\leq {x}/{\sigma})=(1+q)/2\\
\qquad \Longleftrightarrow x/\sigma=
z_{(1+q)/2}\\
\qquad \Longleftrightarrow x=z_{(1+q)/2}\cdot \sigma
\end{array}
$$

```

En particular, com que si $q=0.95$, aleshores $(1+q)/2=0.975$ i llavors $z_{0.975}=1.96$, i això sovint s'aproxima per 2, l'interval de referència del 95% per a $X\sim N(\mu,\sigma)$ és
$$
\mu\pm 1.96\sigma
$$
o simplement, per simplificar,
$$
\mu\pm 2\sigma.
$$
Això diu, bàsicament, que

> si una població segueix una distribució normal $N(\mu,\sigma)$, un 95% dels seus individus estan a distància como a màxim $2\sigma$ ("a dues sigmes") de $\mu$.

```{example}
Segons l'OMS, les alçades de les dones europees de 18 anys segueixen una llei $N(163.1,18.53)$.  Vull trobar un interval d'alçades centrat en la mitjana que contengui les de la meitat de les europees de 18 anys. És, a dir, vull trobar  l'interval de referència del 50% per a la variable aleatòria $X$ definida per les alçades de les dones europees de 18 anys. 

Com que $X\sim N(163.1,18.53)$ i si $q=0.5$, aleshores $(1+q)/2=0.75$, aquest interval és

```

```{r}
163.1+qnorm(0.75)*18.53*c(-1,1)
```

Arrodonint a cm, és l'interval [`r round(163.1+qnorm(0.75)*18.53*c(-1,1))`]. Per tant, la meitat de les dones europees de 18 anys fan entre 
`r round((163.1-qnorm(0.75)*18.53)/100,2)` m i `r round((163.1+qnorm(0.75)*18.53)/100,2)` m d'alçada.



```{example}
Quin és l'interval de referència per a les alçades de les dones europees de 18 anys? 

```

Com que sobreentenem que es tracta de l'interval de referència del 95%, és 
$$
163.1\pm 1.96\times 18.53\Longrightarrow [`r round(163.1+qnorm(0.975)*18.53*c(-1,1))`]
$$


## El z-score 

El **z-score** (o **valor z**, **puntuació z**) d'un valor $x_0$ respecte d'una distribució $N(\mu,\sigma)$ és 
$$
\frac{x_0-\mu}{\sigma}.
$$
Com més gran és en valor absolut, més "rar" és $x_0$; el signe ens diu si és més gran o més petit que el valor esperat $\mu$. 

```{example} 
Recordau que, segons l'OMS, les altures de les dones europees de 18 anys segueixen una llei $N(163.1,18.53)$. Quin és el z-score d'una jugadora de bàsket de 18 anys que faci 191 cm?
  
```

Serà:
$$ 
\frac{191-163.1}{18.53}=1.5
$$
Això normalment es llegeix dient que aquesta alçada "està a 1.5 sigmes de l'alçada mitjana."



<!--chapter:end:01-Normal.Rmd-->


# Estimació puntual

## Definicions bàsiques

Una **població** és un conjunt d'individus o objectes sobre el que volem obtenir informació.

Una **mostra de mida** $n$ d'una població és simplement un conjunt de $n$ individus (possiblement repetits) de la població.

```{block2,type="rmdcaution"}
Una **població** inclou *tots* els membres d'un grup específic, mentre que una **mostra** està formada per *alguns* membres de la població, els que mesuram al nostre estudi.
```


Una **mostra aleatòria simple**  de mida $n$ d'una població s'obté repetint $n$ vegades, cada una de manera independent de les altres, el procés d'escollir equiprobablement un individu de la població; els individus triats es poden repetir. D'aquesta manera, totes les mostres possibles de $n$ individus (possiblement repetits: en diem **multiconjunts**) tenen la mateixa probabilitat d'obtenir-se.

Un **estimador** (**puntual**) o **estadístic** és una funció que aplicada a una mostra d'una població dóna un valor  que ens permet **estimar** alguna cosa que vulguem saber de tota la població.

```{r, echo=FALSE,out.width="60%",fig.cap="Població *versus* mostra (Font: https//towardsdatascience.com)"}
knitr::include_graphics("Bioestadistica-II_files/figure-html/poblaciomostra.png")
```


```{example, uib1}
Si escollim a l'atzar, un rere l'altre i permetent que es repeteixin, 30 estudiants de la UIB i mesuram les seves alçades,  obtenim una *mostra aleatòria simple* de mida 30 d'alçades de la *població* formada pels estudiants de la UIB. Si llavors calculam la mitjana aritmètica d'aquestes alçades amb l'objectiu d'estimar la mitjana de les alçades de tots els estudiants de la UIB, aquesta mitjana aritmètica és un *estimador*.

```

```{block2,type="rmdnote"}
Per què prenem una mostra, en lloc d'estudiar directament la població? Doncs perquè sovint és impossible accedir a tota la població:

* La població pot ser massa gran: per exemple, si volem calcular l'alçada mitjana dels europeus que avui tenen 18 anys, és pràcticament  impossible midar-los tots

* La població pot ser *virtual* en el sentit que pot contenir membres que en aquest moment ni existeixin: per exemple, si volem saber qualque cosa sobre els diabètics, això hauria d'incloure els passats, que ja són morts, els presents, que n'hi haurà molts que ni saben que ho són, i els futurs, que encara no ho són o per ventura no hagin ni nascut.

* Simplement, pot ser difícil accedir a tota la població: per exemple, els estudiants de la UIB són relativament pocs, uns 12000, però seria molt difícil aconseguir midar-los tots.

```

Formalment:

* Una **població** és un conjunt on està definida una variable aleatòria (**poblacional**) $X$.

* Una **mostra aleatòria simple**  de mida $n$ de la variable aleatòria $X$ és un vector $(X_1,\ldots,X_n)$ format per $n$ còpies *independents*  de $X$.

* Una **realització** de la mostra aleatòria simple $(X_1,\ldots,X_n)$ és un vector $(x_1,\ldots,x_n)$ de valors presos per aquestes variables aleatòries. 

* Un  **estimador**  és una variable aleatòria $f(X_1,\ldots,X_n)$ obtinguda aplicant una funció $f$ a una mostra aleatòria simple $X_1,\ldots,X_n$. 

    Aquest estimador s'aplica a les realitzacions de la mostra i dóna nombres reals. Com que és una variable aleatòria,  té distribució (en diem la **distribució mostral** de l'estimador), esperança, desviació típica (en diem l'**error estàndard**, o **típic**, de l'estimador), etc.


```{example} 
Podem formalitzar l'Exemple \@ref(exm:uib1) de la manera següent:

```

* *Població*: El conjunt dels estudiants de la UIB

* *Variable aleatòria poblacional* $X$: Prenem un estudiant de la UIB i midam la seva alçada. 

* *Mostra  aleatòria simple de mida 30*: Un vector $(X_1,\ldots,X_{30})$ format per 30 còpies independents de $X$.

* Una *realització* d'aquesta mostra  aleatòria simple: Un vector $(x_1,\ldots,x_{30})$ obtingut repetint 30 vegades, de manera independent cada una de les altres, el procés d'escollir un estudiant de la UIB i midar-li l'alçada.

* *Estimador*: La mitjana aritmètica que farem servir sobre aquesta mostra és
$$
\overline{X}=\frac{X_1+\cdots+X_{30}}{30}
$$
i sobre la realització concreta obtinguda pren el valor 
$$
\overline{x}=\frac{x_1+\cdots+x_{30}}{30}
$$

```{block2, type='rmdnote'}
A partir d'ara, quan no hi hagi necessitat de filar prim, cometrem l'abús de llenguatge de dir *mostra aleatòria simple* tant al vector de variables aleatòries $(X_1,\ldots,X_n)$ com a una realització $(x_1,\ldots,x_n)\in \mathbb{R}^n$; i hi ometrem els parèntesis.

```

A la vida real, les mostres aleatòries se solen prendre prohibint les repeticions  (**sense reposició**). No són mostres aleatòries simples, però la situació encara pot tenir salvació.

Si la mida $N$ de la població és MOLT més gran que la mida $n$ de la mostra,  els resultats per a mostres aleatòries simples valen (aproximadament) en aquest cas, perquè les  variables aleatòries que formen la mostra són gairebé idèntiques i independents i les repeticions són improbables. 

Més en concret, si la població és MOLT gran (per exemple de 10^6^ individus), excloure, per evitar repeticions, uns pocs individus ja escollits (per exemple, 9) no canvia gaire la probabilitat d'escollir un individu dels que queden: abans d'eliminar els 9 ja escollits, la probabilitat de triar un individu concret era $1/10^6=`r 1/10^6`$ i després d'excloure'ls és $1/999991=`r 1/(10^6-9)`$.

Observau també que si prenem una mostra aleatòria sense repeticions d'una població molt gran, gairebé és com si hagués estat presa permetent repeticions, perquè per molt que les permetéssim, seria molt improbable que es donassin. Tornant al nostre exemple, si prenem una mostra aleatòria simple (permetent repeticions) de 10 individus d'una població de 10^6^ individus, la probabilitat que escollim qualque individu més d'una vegada és 
$$
1-\frac{10^6(10^6-1)\cdots (10^6-9)}{(10^6)^{10}}=`r round(pbirthday(10,10^6),6)`.
$$
Molt petita. Per tant, si ens trobam al davant d'una mostra aleatòria de 10 individus d'aquesta població escollida sense permetre repeticions, ens podem creure perfectament que l'hem obtinguda permetent repeticions i que simplement no n'hi ha hagut cap per pur atzar.

En resum:
    
```{block2,type="rmdimportant"}
Si prenem una mostra sense reposició de mida $n$ d'una població de mida $N$ MOLT més gran que n,  la tractarem com si fos una mostra aleatòria simple (i direm sense manies que és una mostra aleatòria simple).
```

Ara bé, quan $n$ és relativament gran per comparació amb $N$, ja és mal de creure que una mostra sense repeticions hagi estat escollida permetent-les. Per exemple, si prenem una mostra aleatòria simple (permetent repeticions) de 10 individus d'una població de 100 individus, la probabilitat que escollim qualque individu més d'una vegada és 
$$
1-\frac{100\cdot 99\cdots 91}{100^{10}}=`r round(pbirthday(10,100),2)`.
$$
Més d'una de cada 3 mostres aleatòries simples de 10 individus d'una població de 100 individus contenen qualque repetició, per tant no podem acceptar amb els ulls clucs que si no tenim cap repetició, les hàgim permeses.


```{example, uib2}
Recordau que si una població té $N$ individus, la probabilitat que una mostra aleatòria simple de mida $n$ tingui tots els seus membres diferents és
$$
\frac{N(N-1)\cdots (N-n+1)}{N^n}
$$

  
```

Per exemple, la UIB té uns 12000 estudiants.  El gràfic següent mostra la probabilitat que si prenem una mostra aleatòria simple de $n$ estudiants de la UIB, siguin tots diferents, en funció de $n$:
```{r}
f=function(N,i){prod((N:(N-i+1))/N)}
prob=sapply(1:200,f,N=1200)
plot(1:200,prob,type="l",lwd=2,xlab="n",ylab="probabilitat",
     xaxp=c(0,200,20),yaxp=c(0,1,10))
```

El gràfic següent mostra la mida màxima $n$ d'una mostra aleatòria simple extreta d'una població de mida $N$ per què la probabilitat de repeticions sigui menor que 0.05, en funció de $N$

```{r}
h=function(n){max(which(sapply(1:(n/50),f,N=n)>0.95))}
fites=sapply(500+100*(0:150),h)
plot(500+100*(0:150),fites,pch=20,xlab="N",ylab="n",xaxp=c(500,15500,30))
```

```{block2,type="rmdnote"}
Com que sabem que us agraden les regles, fixem d'ara endavant que entendrem que $N$ és MOLT més gran que $n$ quan $N$ sigui com a mínim 1000 vegades més gran que $n$.
```

A la pràctica, en realitat (gairebé) mai no disposarem d'una mostra *aleatòria*. 
Fixau-vos, per exemple, que per poder obtenir una mostra aleatòria, necessitam una llista de tota la població, per poder sortejar qui cau i qui no cau dins la mostra, i aquesta llista normalment no existeix. Una llista de tots els conills de Mallorca, o de tots els arbres  afectats per la *Xyllella fastidiosa*? Complicat. Així que ens haurem de conformar amb una **mostra oportunista** (o **de conveniència**: la que poguem obtenir).  

Heu de tenir clar que, en principi, *els resultats que donarem NO són vàlids per a mostres no aleatòries*, però si no tenim res millor...  El que es fa aleshores és explicar amb detall com s'ha obtingut la mostra i descriure amb detall les seves característiques, a fi que altres investigadors puguin decidir si els individus "són típics" i podrien passar per una mostra aleatòria, i si poden extrapolar les estimacions al seu context.

Per exemple, si per saber l'opinió dels estudiants de Biologia espanyols sobre un tema, ho deman als meus estudiants, serà una mostra clarament oportunista i caldrà llavors esbrinar si podria passar per una mostra aleatòria simple a efectes de l'estudi que vull portar a terme.

```{block2, type='rmdcaution'}
Els estimadors tenen sempre sentit per a mostres en general, però gairebé tots els  teoremes que estableixen les seves propietats són vertaders només sota determinades restriccions (mostra aleatòria simple, condicions extra sobre $X$, ...),  per la qual cosa les seves conseqüències tan sols són segures sota aquestes restriccions.

```

## Mitjana mostral

La **mitjana mostral** $\overline{X}$ d'una mostra aleatòria de mida $n$ d'una variable aleatòria $X$ és simplement la seva mitjana artimètica.

Formalment,  la **mitjana mostral** és una variable aleatòria obtinguda prenent $n$ còpies $X_1,\ldots,X_n$ de la  variable aleatòria $X$ i calculant
$$
\overline{X}=\frac{X_1+\cdots+X_n}{n}
$$

Com a conseqüència del Teorema \@ref(thm:combvar), tenim el següent:


```{theorem, mitjmostgral}
Siguin $X$ una variable aleatòria d'esperança $\mu_X$ i desviació  típica $\sigma_X$,
$X_1,\ldots,X_n$ una mostra aleatòria de $X$ i $\overline{X}$ la seva mitjana mostral. Aleshores

a) El valor esperat de $\overline{X}$ és $E(\overline{X})=\mu_X$.

b) Si la mostra aleatòria és simple, l'**error estàndard** o **típic** de $\overline{X}$ (la *desviació típica* de $\overline{X}$) és  $\sigma(\overline{X})={\sigma_X}/{\sqrt{n}}$.

```


Per tant:

* $\overline{X}$ és un estimador puntual de $\mu_X$.


* $E(\overline{X})=\mu_X$ (*esperam que la mitjana mostral doni $\mu_X$*) significa que si repetíssim moltes vegades el procés de prendre una mostra aleatòria simple de mida $n$ i calcular-ne la mitjana mostral, molt probablement el valor mitjà d'aquestes mitjanes s'acostaria molt a $\mu_X$.


* $\sigma(\overline{X})= \sigma_X/\sqrt{n}$ indica que la variabilitat dels resultats de $\overline{X}$ creix amb la variabilitat de $X$ i decreix amb la mida  $n$ de la mostra, tendint a 0 quan $n\to\infty$.

```{example, experimentTCL1}
El fitxer **tests.txt** que trobareu a l'Aula Digital conté les notes (sobre 100) de tests dels estudiants de Matemàtiques I de fa uns cursos. 

```

```{r}
tests=scan("tests.txt")
head(tests)
```
La seva mitjana és
```{r}
mean(tests)
```

```{r,include=FALSE}
set.seed(100)
```


Si en prenem una mostra aleatòria simple, per exemple de mida 40, la seva mitjana mostral no té perquè coincidir amb la mitjana poblacional:
```{r}
MAS=sample(tests,40,replace=TRUE)
mean(MAS)
```

Però si prenem *moltes* mostres aleatòries simples, la mitjana de les seves mitjanes és molt probable que sí que s'acosti  a la mitjana poblacional. Vegem si tenim sort:
```{r}
mitjanes=replicate(10^5,mean(sample(tests,40,replace=TRUE)))
mean(mitjanes)
```

Vegem ara que la desviació típica d'aquesta mostra de mitjanes s'acosta a l'error típic de la mitjana mostral, no a la desviació típica de la població:
```{r}
sd(mitjanes)
sd(tests)
sd(tests)/sqrt(40)
```


Recordau del Teorema \@ref(thm:combnormal)  que una combinació lineal de variables aleatòries normals independents torna a ser normal. Com que la mitjana mostral d'una mostra aleatòria simple és una combinació lineal de variables aleatòries independents, obtenim el resultat següent:

```{theorem, TCLnorm}
Siguin $X$ una variable aleatòria normal $N(\mu_X,\sigma_X)$ i $X_1,\ldots, X_n$ una mostra aleatòria simple de $X$. Aleshores, la seva mitjana mostral $\overline{X}$ és normal, i en concret
$$
\overline{X}\sim N\Big(\mu_X,\frac{\sigma_X}{\sqrt{n}}\Big)
$$
i per tant
$$
Z=\frac{\overline{X}-\mu_X}{{\sigma_X}/{\sqrt{n}}}\sim N(0,1)
$$
  
```

El **Teorema Central del Límit** diu que la conclusió del teorema anterior és aproximadament vertadera si la mida $n$ de les mostres aleatòries simples és gran:



```{theorem, TCL}
**(Teorema Central del Límit)** 
Siguin $X$ una variable aleatòria *qualsevol* d'esperança $\mu_X$ i desviació típica $\sigma_X$ i $X_1,\ldots, X_n$ una mostra aleatòria simple de $X$.  Quan $n\to \infty$, la distribució de probabilitats de la seva mitjana mostral $\overline{X}$ tendeix a la d'una
$$
N\Big(\mu_X,\frac{\sigma_X}{\sqrt{n}}\Big)
$$
i per tant la distribució de probabilitats de
$$
Z=\frac{\overline{X}-\mu_X}{{\sigma_X}/{\sqrt{n}}}
$$
tendeix a la d'una variable normal estàndard $N(0,1)$.

```

```{block2, type='rmdnote'}
Com us podeu imaginar, quan un resultat l'anomenen "Teorema Central" de qualque cosa és perquè és molt important.
```

Normalment aplicarem el Teorema Central del Límit de la manera següent:

```{block2,type="rmdimportant"}
Siguin $X$ una variable aleatòria *qualsevol* d'esperança $\mu_X$ i desviació típica $\sigma_X$ i $X_1,\ldots, X_n$ una mostra aleatòria simple de $X$.  Si la mida $n$ de la mostra és gran, la seva mitjana mostral $\overline{X}$ és aproximadament nomal
$N(\mu_X,\sigma_X/\sqrt{n})$. 

Aquí, "$n$ gran" voldrà dir a partir de 30 o 40, potser menys si $X$ no és molt diferent d'una normal i potser més si la $X$ és molt diferent d'una normal.

```

A partir d'ara, sovint cometrem l'abús de llenguatge d'ometre l'adverbi "aproximadament" de l'expressió anterior, i direm simplement que si $n$ és gran, $\overline{X}$ és normal. Però hem de recordar que aquest "és normal" en realitat vol dir "la seva distribució és aproximadament la d'una variable normal".


```{example} 
Suposem que tenim una variable aleatòria $X$ de mitjana $\mu_X=3$ i desviació típica $\sigma_X=0.2$ i que en prenem mostres aleatòries simples de mida 100. Pel Teorema Central del Límit, la distribució de la mitjana mostral $\overline{X}$ és aproximadament
$$
N\Big(3,\frac{0.2}{\sqrt{100}}\Big)=N(3,0.02)
$$
  
```


```{example,experimentTCL2}
Tornem a la situació de l'Exemple \@ref(exm:experimentTCL1). Teníem les notes guardades en un vector anomenat **tests**. Amb l'histograma següent podem veure que aquestes notes no tenen pinta de seguir una distribució normal.


````

```{r,}
fact.trans=hist(tests,plot=FALSE)$counts[1]/hist(tests,plot=FALSE)$density[1]
hist(tests,col="light blue",xlab="Notes dels tests",
     ylab="Freqüències",main="Histograma de notes de tests")
curve(fact.trans*dnorm(x,mean(tests),sd(tests)),col="red",lwd=2,add=TRUE)
```

A l'Exemple \@ref(exm:experimentTCL1) també hem construit un vector anomenat **mitjanes** format per 10^5^ mitjanes de mostres aleatòries simples de notes de mida 40. Pel Teorema Central del Límit, aquestes mitjanes mostrals haurien de seguir aproximadament una distribució normal, malgrat que la "població original" (les notes dels tests) no sigui normal. Vegem-ho amb un histograma:

```{r}  
fact.trans.m=hist(mitjanes,plot=FALSE)$counts[1]/hist(mitjanes,plot=FALSE)$density[1]
hist(mitjanes,col="light blue",xlab="Mitjanes",
     ylab="Freqüències",main="Histograma de la mostra de mitjanes")
curve(fact.trans.m*dnorm(x,mean(mitjanes),sd(mitjanes)),col="red",lwd=2,add=TRUE)
```


L'exemple següent és un tipus de pregunta que més endavant ens preocuparà molt.

```{example}
L'alçada d'una espècie de matolls té valor mitjà  115 cm, amb una desviació típica de 25 cm. Si prenem una mostra aleatòria simple de 100 matolls d'aquesta espècie, quina és la probabilitat que la mitjana mostral de les alçades sigui més petita que 110 cm?

```

Diguem $X$ a la variable aleatòria definida per les alçades d'aquests matolls. Pel Teorema Central del Límit, la mitjana mostral $\overline{X}$ de mostres aleatòries simples de 100 alçades segueix una distribució aproximadament $N(115,25/\sqrt{100})=N(115,2.5)$. Llavors, la probabilitat que ens demanen és
$$
P(\overline{X}< 110)
$$
que podem calcular amb 
```{r}
round(pnorm(110,115,2.5),4)
```



Sigui ara $X_1,\ldots, X_n$ una mostra aleatòria **sense reposició** de mida $n$ d'una variable aleatòria $X$ d'esperança $\mu_X$ i desviació típica $\sigma_X$.  Si $n$ és molt petit en relació a la mida $N$ de la població, ja hem explicat que podem suposar que aquesta mostra aleatòria és simple i per tant tot funciona com fins ara; en particular, en aquest cas entendrem que els tres teoremes anteriors són vertaders.


Si $n$ és gran en relació a $N$, aleshores el resultat per l'esperança segueix essent vertader (al Teorema \@ref(thm:mitjmostgral).a no suposàvem que la mostra fos simple), i per tant encara tenim que
$$
E(\overline{X})=\mu_X.
$$
Però en aquest cas cal modificar la fórmula del Teorema \@ref(thm:mitjmostgral).b per a la desviació típica, que ara és:
$$
\sigma_{\overline{X}}=\frac{\sigma_X}{\sqrt{n}}\cdot\sqrt{\frac{N-n}{N-1}}
$$
A més, en aquest cas les conclusions dels Teoremes \@ref(thm:TCLnorm) i \@ref(thm:TCL) no són certes, ni tan sols amb aquesta correcció de l'error típic.  

Al terme
$$
\sqrt{\frac{N-n}{N-1}}
$$
que apareix a la fórmula anterior li diuen el **factor de població finita**.

```{block2, type='rmdcorbes'}
Si us en recordau, aquest factor de població finita és el factor que passava de la desviació típica d'una distribució binomial a la d'una hipergeomètrica. En efecte:

* Si $X_B\sim B(n,p)$, $\sigma^2_{X_B}=np(1-p)$ i per tant $\sigma_{X_B}=\sqrt{np(1-p)}$

* Si $X_H\sim H(A,B,n)$,  amb $A+B=N$ i $p=A/N$,

$$
\begin{array}{rl}
\sigma^2_{X_H} & \displaystyle =\dfrac{nAB}{(A+B)^2}\cdot\dfrac{A+B-n}{A+B-1}\\ & \displaystyle =n\cdot\frac{A}{N}\cdot\frac{N-A}{N}\cdot\dfrac{N-n}{N-1}\\ & \displaystyle =
np(1-p)\cdot \dfrac{N-n}{N-1}
\end{array}
$$
i per tant
$$
\sigma_{X_H}=\sqrt{np(1-p)}\cdot \sqrt{\dfrac{N-n}{N-1}}=\sigma_{X_B}\cdot \sqrt{\dfrac{N-n}{N-1}}.
$$
  
```

```{example}
Tornem a la situació dels Exemples \@ref(exm:experimentTCL1) i \@ref(exm:experimentTCL2). 
Què passa  si prenem les mostres aleatòries de notes de tests sense reposició?
  
````

Prenguem ara 10^5^ mostres aleatòries sense reposició de 40 notes de tests.
```{r}
mitjanes.norep=replicate(10^5,mean(sample(tests,40)))
```

Un altre cop, la mitjana d'aquest vector de mitjanes hauria de ser propera a la mitjana de la població original, que era `r round(mean(tests),2)`:

```{r}
round(mean(mitjanes.norep),2)
```

Calculem ara la desviació típica d'aquest vector de mitjanes:

```{r}
round(sd(mitjanes.norep),2)
```

Aquesta desviació típica no s'apropa a la desviació típica de la població partida per l'arrel quadrada de la mida de les mostres, que hem calculat abans i era `r round(sd(tests)/sqrt(40),2)`. En canvi, pel que acabam d'explicar, la desviació típica d'aquest vector de mitjanes de mostres sense reposició hauria de ser molt propera a la desviació típica de la població partida per l'arrel quadrada de la mida de les mostres *i tot multiplicat pel factor de  població finita* $\sqrt{(N-n)/(N-1)}$, on $N$ és la mida de la població, és a dir, la longitud del vector `tests`, i $n$ la mida de les mostres, 40. Vegem si és veritat:

```{r}
round((sd(tests)/sqrt(40))*sqrt((length(tests)-40)/(length(tests)-1)),2)
```


## Proporció mostral

Suposem que ara tenim una variable aleatòria poblacional $X$ que és Bernoulli amb **probabilitat d'èxit** (o **proporció d'èxits**) $p_X$. Entendrem que $X$ pren els valors 1 (èxit) o 0 (fracàs). Recordau que $E(X)=p_X$ i $\sigma_X=\sqrt{p_X(1-p_X)}$.

Sigui $X_1,\ldots,X_n$ una mostra aleatòria de mida $n$ de $X$ i sigui $S=\sum_{i=1}^n X_i$  el nombre d'èxits observats en aquesta mostra aleatòria. 


La **proporció mostral** d'èxits de la nostra mostra és 
$$
\widehat{p}_X=\frac{S}{n}=\frac{\sum_{i=1}^n X_i}{n}.
$$


```{block2, type="rmdcaution"}
Recordau que si aquesta mostra és aleatòria simple, la $S$ és una variable aleatòria binomial $B(n,p)$. Però és un doi dir que la proporció mostral $\widehat{p}_X$ és una variable aleatòria binomial, encara que només sigui perquè les variables aleatòries binomials prenen valors nombres naturals i els valors que pot prendre $\widehat{p}_X$ són fraccions entre 0 i 1.
```

```{block2, type="rmdnote"}
Recordau del Teorema \@ref(thm:combvar) que si $X$ és normal, aleshores $X/n$ també és normal. En canvi, si $X$ és binomial, $X/n$ *no* és binomial. Per exemple, pel que acabam de veure, la $S$ d'una mostra aleatòria simple d'una variable Bernoulli és una variable binomial però $\widehat{p}_X=S/n$ no. 

El fet que una combinació lineal de normals torni a ser normal és una molt bona propietat de la normal, que molt poques altres distribucions tenen.
```


Fixau-vos que $\widehat{p}_X$ és un cas particular de la mitjana mostral $\overline{X}$, per tant per a les proporcion mostrals val tot el que hem dit fins ara per a mitjanes mostrals:

```{theorem, pX}
Si $X$ és una variable aleatòria Bernoulli amb probabilitat d'èxit $p_X$ i $X_1,\ldots,X_n$ és una mostra aleatòria de mida $n$ de $X$, de proporció mostral $\widehat{p}_X$, aleshores

1. $E(\widehat{p}_X)=p_X$

2. Si la mostra aleatòria és simple, $\sigma({\widehat{p}_X})=\sqrt{\dfrac{p_X(1-p_X)}{n}}$

3. Si la mostra aleatòria és sense reposició i $n$ és relativament gran per comparació amb la mida de la població $N$,
$$
\sigma({\widehat{p}_X})=\sqrt{\frac{p_X(1-p_X)}{n}}\cdot
\sqrt{\frac{\vphantom{(}N-n}{N-1}}
$$

4. Pel Teorema Central del Límit, si la mostra és aleatòria simple i la seva mida $n$ és gran, la distribució de $\widehat{p}_X$ és aproximadament la d'una variable 
$$
  N\left({p}_X,\sqrt{\frac{{p}_X(1-{p}_X)}{n}}\right)
$$
i per tant 
$$
\frac{\widehat{p}_X-p_X}{\sqrt{\frac{{p}_X(1-{p}_X)}{n}}}
$$
és aproximadament $N(0,1)$.
```



Alguns comentaris:

* $E(\widehat{p}_X)=p_X$: Si repetíssim moltes vegades el procés de prendre una mostra aleatòria simple de mida $n$ d'una variable aleatòria de Bernoulli $X$ i calcular-ne la proporció mostral d'èxits, molt probablement la mitjana d'aquestes proporcions mostrals s'acostaria molt a $p_X$. 

* En particular, $\widehat{p}_X$ serveix per estimar $p_X$

* $\sigma(\widehat{p}_X)= \sqrt{{p_X(1-p_X)}/{n}}$: la variabilitat dels resultats de $\widehat{p}_X$ decreix amb $n$ i tendeix a 0 quan $n\to \infty$

* $\sqrt{{p_X(1-p_X)}/{n}}$ és l'**error típic** de $\widehat{p}_X$. L'estimam amb l'**error típic de l'estimació** $\sqrt{{\widehat{p}_X(1-\widehat{p}_X)}/{n}}$.

* A partir d'ara, sovint cometrem l'abús de llenguatge d'ometre l'adverbi "aproximadament" de l'apartat (4) del teorema anterior, i direm simplement que si $n$ és gran, $\widehat{p}_X$ és normal. Però hem de recordar que aquest "és normal" en realitat vol dir "la seva distribució és aproximadament la d'una variable normal".



```{example}
Tornem  una altra vegada a la situació dels Exemples \@ref(exm:experimentTCL1) i \@ref(exm:experimentTCL2). Vaig a traduir el fitxer de notes de tests en un vector binari: 0 per suspens (haver tret menys de 50) i 1 per aprovat (haver tret 50 o més):
  

```

```{r}
# Iniciam totes les notes a 1
aprovs=rep(1,length(tests))
# Posam 0 on la nota del test és suspesa
aprovs[which(tests<50)]=0
```
Aquest vector **aprovs** el podem entendre com una població de Bernoulli de probabilitat poblacional d'èxit (aprovat) $p_X$.
Les proporcions de suspesos i aprovats són:
```{r}
round(prop.table(table(aprovs)),4) 
```
Per tant, $p_X$ és:
```{r}
p_X=as.numeric(prop.table(table(aprovs))[2])
round(p_X,4)
```

Ara n'extreurem 10^5^ mostres aleatòries simples de mida 40, en calcularem les proporcions mostrals d'aprovats i comprovarem si es confirmen les conclusions del teorema anterior.

```{r}
set.seed(100)
props.mostrals=replicate(10^5,mean(sample(aprovs,40,rep=TRUE)))
```

La mitjana d'aquest vector de proporcions hauria de ser propera a la proporció poblacional d'aprovats $p_X=`r round(p_X,4)`$.

```{r}  
round(mean(props.mostrals),4)
```

Vegem ara la seva desviació típica:

```{r}
round(sd(props.mostrals),4)
```

Pel Teorema \@ref(thm:pX), sabem que això hauria de ser proper a $\sqrt{p_X(1-p_X)/n}$

```{r}
round(sqrt(p_X*(1-p_X)/40),4)
```

I pel Teorema Central del Límit, aquestes proporcions mostrals haurien de seguir aproximadament una distribució normal. Vegem-ho amb un histograma:

```{r}
fact.trans.p=hist(props.mostrals,plot=FALSE)$counts[1]/hist(props.mostrals,plot=FALSE)$density[1]
hist(props.mostrals,col="light blue",xlab="Proporcions mostrals",
     ylab="Freqüències",main="Histograma de la mostra de proporcions")
curve(fact.trans.p*dnorm(x,mean(props.mostrals),sd(props.mostrals)),
      col="red",lwd=2,add=TRUE)
```

I això que la mida de les mostres, 40, no és especialment gran.

```{example}
Un  59.1% dels estudiants de la UIB són dones. Hem pres una mostra més o menys aleatòria de 60 estudiants de la UIB i hi hem trobat 40 dones, un 66.67%. Ens demanam si 40 de 60 és una quantitat raonable de dones en una mostra aleatòria simple d'estudiants de la UIB, o si són moltes (atès que hi esperaríem al voltant d'un 60% de dones).  
 
```

Aquesta pregunta, que serà molt típica d'aquí a pocs temes, la traduïm en la següent pregunta: 
  
> Si prenem una mostra aleatòria simple de 60 estudiants, quina és la probabilitat que la proporció mostral de dones sigui superior al 66.67%?

Una manera senzilla de respondre aquesta pregunta és aprofitar el Teorema Central del Límit, segons el qual la proporció mostral $\widehat{p}_X$ de dones en mostres aleatòries simples de 60 estudiants de la UIB segueix una distribució aproximadament normal amb $\mu=0.591$ i
$$
\sigma=\sqrt{\dfrac{0.591(1-0.591)}{60}}=0.0635
$$
Per tant, la probabilitat que $\widehat{p}_X\geq 0.6667$ és (recordau, aproximadament)
```{r}
round(1-pnorm(0.6667,0.591,0.0635),4)
```

Naturalment, si tenim R o qualsevol altra manera de calcular probabilitats, també podem fer servir la distribució binomial per calcular aquesta probabilitat, i de fet és més correcte, ja que la probabilitat anterior ha emprat una aproximació de la distribució de $\widehat{p}_X$ i en canvi sabem que el nombre de dones en mostres aleatòries simples de 60 estudiants de la UIB segueix una distribució binomial $B(60,0.591)$ i com que el 66.67% de la pregunta en realitat representa 40 dones, la probabilitat exacta demanada és
```{r}
round(1-pbinom(39,60,0.591),4)
```

```{block2,type="rmdcaution"}
Recordau que si $X$ és una variable aleatòria discreta que pren valors enters, com ara la binomial,
$P(X\geq 40)=1-P(X\leq 39)$.
```


## Variància mostral

Sigui $X_1,\ldots, X_n$ una mostra aleatòria simple de mida $n$ d'una variable aleatòria $X$ d'esperança $\mu_X$ i desviació típica $\sigma_X$.

La **variància mostral** d'aquesta mostra aleatòria simple és
$$
\widetilde{S}_{X}^2=\frac{\sum_{i=1}^n (X_{i}-\overline{X})^2}{n-1}
$$
La seva **desviació típica mostral** és 
$$
\widetilde{S}_{X}=+\sqrt{\widetilde{S}_{X}^2}
$$
A més, de tant en tant també farem servir la **variància** i la **desviació típica** **vertaderes**:
$$
\begin{array}{l}
\displaystyle S^2_{X}=\frac{\sum_{i=1}^n (X_{i}-\overline{X})^2}{n}=\frac{(n-1)}{n}\widetilde{S}^2_{X}\\
\displaystyle S_X=+\sqrt{S_X^2}
\end{array}
$$

La variància vertadera admet la següent expressió senzilla:
$$
S^2_X=\frac{\sum_{i=1}^n X_{i}^2}{n}-\overline{X}^2
$$

```{block2, type='rmdcorbes'}
En efecte:
$$
\begin{array}{l}
\displaystyle \frac{\sum_{i=1}^n (X_{i}-\overline{X})^2}{n}=\frac{1}{n}\sum_{i=1}^n (X_{i}^2-2\overline{X}X_i+\overline{X}^2)\\
\displaystyle\qquad = \frac{1}{n}\Big(\sum_{i=1}^n X_{i}^2-2\overline{X}\sum_{i=1}^n X_{i}+n\overline{X}^2\Big)\\
\displaystyle\qquad =\frac{\sum_{i=1}^n X_{i}^2}{n}-2\overline{X}\frac{\sum_{i=1}^n X_{i}}{n}+\frac{n\overline{X}^2}{n}\\
\displaystyle\qquad =\frac{\sum_{i=1}^n X_{i}^2}{n}-2\overline{X}\cdot\overline{X} + \overline{X}^2=\frac{\sum_{i=1}^n X_{i}^2}{n}- \overline{X}^2
\end{array}
$$

  
```

```{theorem}
Si $X$ és una variable aleatòria **normal** de desviació típica $\sigma_X$ i $X_1,\ldots,X_n$ és una mostra aleatòria simple de mida $n$ de $X$, amb variància mostral $\widetilde{S}_{X}^2$, aleshores $E(\widetilde{S}_{X}^2)=\sigma_{X}^2$ i 
la variable aleatòria
$$
\frac{(n-1)\widetilde{S}_{X}^2}{\sigma_{X}^2}
$$
té distribució coneguda: $\chi_{n-1}^2$ (es llegeix "khi quadrat amb $n-1$ graus de llibertat").

```


```{block2,type="rmdcaution"}
La lletra $\chi$  en català es diu *khi*; en castellà, *ji*; i en anglès, *chi*, pronunciat *xai*.
```


De la distribució $\chi_n^2$, on $n$ són els **graus de llibertat**, heu de saber que:

* Per definició, és la distribució de la suma dels quadrats de $n$ variables aleatòries normals estàndard independents. És a dir, si $Z_{1},Z_{2},\ldots, Z_{n}\sim N(0,1)$ són independents, la variable
$$
Z_{1}^{2}+Z_{2}^{2}+\cdots +Z_{n}^{2}
$$ 
té distribució $\chi_n^2$.

* La $n$ és un paràmetre del que depèn la seva distribució. 

* Amb R és `chisq`

* Si $X$ és una variable aleatòria amb distribució  $\chi_n^2$, aleshores $E(X)=n$ i $\sigma_X^2=2 n$


* Per a $n$ petits, la distribució d'una $\chi_{n}^2$ presenta una cua a la dreta, i a mida que $n$ creix, pel Teorema Central del Límit,  es va aproximant a una distribució normal $N(n,\sqrt{2n})$, com podeu veure als gràfics següents



```{r}
curve(dchisq(x,1),col=1,lwd=2,xlim=c(0,20),xlab="",ylab="",ylim=c(0,0.3),main="Algunes khi quadrat")
curve(dchisq(x,2),col=2,lwd=2,add=TRUE)
curve(dchisq(x,3),col=3,lwd=2,add=TRUE)
curve(dchisq(x,4),col=4,lwd=2,add=TRUE)
curve(dchisq(x,5),col=5,lwd=2,add=TRUE)
curve(dchisq(x,10),col=6,lwd=2,add=TRUE)
legend("topright",col=1:6,lty=c(1,1),
       lwd=c(2,2),legend=paste("n=",c(1:5,10),sep=""),cex=0.8)
```


```{r}
curve(dchisq(x,300),xlim=c(150,450),lwd=2,xlab="",ylab="",main="Khi quadrat vs Normal")
curve(dnorm(x,300,sqrt(600)),lwd=2,col="red",add=TRUE)
legend("topleft",col=c("black","red"),lty=c(1,1),
       lwd=c(2,2),legend=c("Khi quadrat amb n=300","Normal"),cex=0.7)
```


Tornem un instant a això dels *graus de llibertat*. Per què diem que la variància (mostral) té $n-1$ graus de llibertat? 

Doncs perquè si volem construir un conjunt de $n$ nombres $x_1,\ldots,x_n$ que tenguin variància un valor donat, posem $y_0$, aleshores podem escollir $n-1$ d'ells, $x_1,\ldots,x_{n-1}$, com volguem i aleshores el darrer, $x_n$, queda bastant fixat. En matemàtiques això se sol expressar dient que "tenim $n-1$ graus de llibertat a l'hora d'escollir $x_1,\ldots,x_n$ amb variància fixada $y_0$".

```{block2, type='rmdcorbes'}
En efecte, si fixam el valor $y_0\geq 0$ de la variància i volem trobar $x_1,\ldots,x_{n}$ 
tals que
$$
y_0=\frac{\sum_{i=1}^n (x_i-\overline{x})^2}{n}=\frac{\sum_{i=1}^n x_i^2}{n}-\overline{x}^2
$$
vegem que podem triar amb total llibertat els valors de $x_1,\ldots,x_{n-1}$ i llavors el valor de $x_n$ quedarà fixat per una equació quadràtica:
$$
\begin{array}{l}
ny_0 & =\displaystyle \sum_{i=1}^n x_i^2-n\overline{x}^2= \sum_{i=1}^n x_i^2-n\Big(\frac{\sum_{i=1}^n x_i}{n}\Big)^2\\
& =\displaystyle \sum_{i=1}^n x_i^2-\frac{(\sum_{i=1}^n x_i)^2}{n}\\
& \displaystyle =\frac{1}{n}\left(n\sum_{i=1}^n x_i^2-\Big(\sum_{i=1}^{n} x_i\Big)^2\right)\\
& =\displaystyle \frac{1}{n}\left(n\sum_{i=1}^{n-1} x_i^2+n\mathbf{x_n}^2-\Big(\sum_{i=1}^{n-1} x_i\Big)^2\right.\\
& \displaystyle\qquad\qquad \left. -2\Big(\sum_{i=1}^{n-1} x_i\Big)\mathbf{x_n}-\mathbf{x_n}^2\right)\\
& =\displaystyle \frac{1}{n}\left((n-1)\mathbf{x_n}^2-2\Big(\sum_{i=1}^{n-1} x_i\Big)\mathbf{x_n}\right.\\
& \displaystyle\qquad\qquad \left.+n\sum_{i=1}^{n-1} x_i^2-\Big(\sum_{i=1}^{n-1} x_i\Big)^2 \right)
\end{array}
$$
d'on (multiplicant els dos costats de la igualtat per $n$ i dividint-los per $n-1$) obtenim, finalment, l'equació de segon grau en $\mathbf{x_n}$
$$
\mathbf{x_n}^2-\frac{2\sum_{i=1}^{n-1} x_i}{n-1}\mathbf{x_n}+\frac{n\sum_{i=1}^{n-1} x_i^2-\Big(\sum_{i=1}^{n-1} x_i\Big)^2-n^2y_0^2}{n-1}=0
$$
Per tant, fixat $y_0$, podem escollir $x_1,\ldots,x_{n-1}$ com vulguem i aleshores $x_n$ haurà de ser per força una de les dues solucions d'aquesta equació de segon grau.
  
```


## La t de Student

Tornem a les mitjanes mostrals de variables normals.

```{theorem}
Sigui $X$ una variable $N(\mu_X,\sigma_X)$ i 
sigui $X_1,\ldots,X_n$ una mostra aleatòria simple de $X$, amb mitjana $\overline{X}$ i desviació típica mostral $\widetilde{S}_{X}$. Aleshores, la variable aleatòria
$$
T=\frac{\overline{X}-\mu_X}{\widetilde{S}_{X}/\sqrt{n}}
$$
segueix una distribució coneguda, anomenada **t de Student amb $n-1$ graus de llibertat**, $t_{n-1}$.
  

```

```{block2,type="rmdimportant"}
A $\widetilde{S}_{X}/\sqrt{n}$ li diem l'**error típic**, o **estàndard**, **de la mostra**: estima l'error típic $\sigma_X/\sqrt{n}$ de $\overline{X}$.
```



De la distribució t de Student amb $n$ graus de llibertat, $t_{n}$, heu de saber que:


* Amb R és `t`

* Si $T_{n}$ és una variable amb distribució $t_{n}$, aleshores  $E(T_{n})=0$  si $n\geq 2$ i $\sigma_{T_{n}}^2=n/(n-2)$ si $n\geq 3$

* La funció de densitat d'una variable $T_{n}$ amb distribució $t_{n}$ és simètrica al voltant de 0 (com la d'una $N(0,1)$):
$$
P(T_{n}\leq -x)=P(T_{n}\geq x)=1-P(T_{n}\leq x)
$$

* Si $n$ és gran, la distribució d'una variable $T_{n}$ amb distribució $t_{n}$ és aproximadament la d'una $N(0,1)$ (però amb més variància: un poc més aplatada), com podeu veure als gràfics següents:

```{r}
curve(dnorm(x),col=1,lwd=2,xlim=c(-4,4),xlab="",ylab="",ylim=c(0,0.4),
      main="Algunes t de Student")
curve(dt(x,2),col=2,lwd=2,add=TRUE)
curve(dt(x,3),col=3,lwd=2,add=TRUE)
curve(dt(x,4),col=4,lwd=2,add=TRUE)
curve(dt(x,5),col=5,lwd=2,add=TRUE)
curve(dt(x,10),col=6,lwd=2,add=TRUE)
legend("topleft",col=1:6,lty=rep(1,6), lwd=rep(2,6),
legend=c("Normal estàndard", paste("Student amb g.l.=",c(2:5,10),sep="")),cex=0.7)
```

```{r}
curve(dnorm(x),col=1,lwd=2,xlim=c(-4,4),xlab="",ylab="",ylim=c(0,0.4),
      main="t vs Normal estàndard")
curve(dt(x,50),col=2,lwd=2,add=TRUE)
legend("topleft",col=1:2,lty=rep(1,2), lwd=rep(2,2),
       legend=c("Normal estàndard", "Student amb g.l.=50"),cex=0.7)
```




Indicarem amb $t_{n,q}$ el  $q$-quantil d'una  variable aleatòria  $T_{n}$ que segueix una distribució   $t_n$. És a dir, $t_{n,q}$ és el valor tal que
$$
P(T_{n}\leq t_{n,q})=q
$$
Per la simetria de la distribució $t_n$,
$$
t_{n,q}=-t_{n,1-q}.
$$


```{r, echo=FALSE}
x <- seq(-4,4,.1)

plot(x,dt(x,5),type="l",xlab="",ylab="",xaxs="i",yaxs="i",ylim=c(0,.4),bty="l",xaxt="n",yaxt="n",lwd=2)
polysection <- function(a,b,col="light blue",n=11){
    dx <- seq(a,b,length.out=n)
    polygon(c(a,dx,b),c(0,dt(dx,5),0),border=NA,col=col)
}

for(i in -4:-2){
    polysection(i,i+1,col="light blue")
  #  polysection(-i-1,-i,col="grey")
}
for(i in 1:4){
    polysection(i,i+1,col="light blue")
  #  polysection(-i-1,-i,col="grey")
}


axis(1,at=c(-1,0,1), labels=c(expression(t["n,q"]),0,expression(t["n,1-q"])))
abline(v=0,lty=2)
text(-1.5,dt(-1.5,5)/2,labels="q")
text(1.5,dt(1.5,5)/2,labels="q")
```

Hi ha algunes propietats dels quantils de la t de Student que heu de saber, per poder aplicar-les quan no tingueu a l'abast R o una apli per calcular quantils:

* $t_{n ,q}\approx z_{q}$ si $n$ és molt gran, posem $n \geq 200$

* $t_{n,0.95}$ (per a $10\leq n\leq 200$) està entre 1.65 i 1.8; ho podeu aproximar $t_{n,0.95}\approx 1.7$

* $t_{n,0.975}$  (per a $10\leq n\leq 200$) està entre 1.97 i 2.2; ho podeu aproximar $t_{n,0.95}\approx 2$



```{block2, type='rmdcaution'}
Abans de tancar aquesta secció, recordau que  no heu de confondre:

* **Desviació típica** (o **estàndard**) *d'una variable aleatòria*: El paràmetre poblacional, normalment desconegut

* **Desviació típica** (o **estàndard**) (sigui mostral o vertadera) *d'una mostra*: L'estadístic que calculam sobre la mostra i que quantifica la variabilitat de la mostra

* **Error típic** (o **estàndard**) *d'un estimador*: La desviació típica de la variable aleatòria que defineix l'estimador, normalment desconeguda

* **Error típic** (o **estàndard**) *d'una mostra*: Estimació de l'error típic de la mitjana mostral (o de la proporció mostral) a partir d'una mostra; servirà per calcular intervals de confiança. És la desviació típica mostral dividida per $\sqrt{n}$.

```

## "Bons" estimadors

### Estimadors no esbiaixats

Un estimador puntual $\widehat{\theta}$ d'un paràmetre poblacional $\theta$ és  **no esbiaixat** quan el seu valor esperat és precisament el valor poblacional del paràmetre, és a dir, quan
$$
E(\widehat{\theta})=\theta
$$ 
Es diu aleshores que l'estimació puntual és **no esbiaixada**.

El  **biaix** d'un estimador $\widehat{\theta}$ d'un paràmetre $\theta$ és la diferència $E(\widehat{\theta})-\theta$


**Exemples:** Ja hem vist a les seccions anteriors que

* $E(\overline{X})=\mu_X$. Per tant, $\overline{X}$ és sempre un estimador no esbiaixat de $\mu_X$


* $E(\widehat{p}_X)=p_X$. Per tant, $\widehat{p}_X$ és  sempre un estimador no esbiaixat de $p_X$


* $E(\widetilde{S}_{X}^2)=\sigma_X^2$ si $X$ és normal. Per tant, $\widetilde{S}_{X}^2$ és un estimador no esbiaixat de $\sigma_X^2$ quan $X$ és normal


* Com que ${S}_{X}^2=\dfrac{n-1}{n}\widetilde{S}_{X}^2$, tenim que $E({S}_{X}^2)=\dfrac{n-1}{n}\sigma_X^2$ si $X$ és normal. Per tant, en aquest cas, 
${S}_{X}^2$ *és un estimador esbiaixat de* $\sigma_X^2$, amb biaix
$$
E({S}_{X}^2)-\sigma_X^2=\dfrac{n-1}{n}\sigma_X^2-\sigma_X^2=-\dfrac{\sigma_X^2}{n}\ \mathop{\longrightarrow}_{\scriptscriptstyle
n\to\infty}\ 0
$$

* $E(\widetilde{S}_{X}), E({S}_{X})\neq \sigma_X$ ni tan sols quan $X$ és normal. Per tant,  $\widetilde{S}_{X}$ i ${S}_{X}$ són estimadors  *esbiaixats* de $\sigma_X$


### Estimadors eficients

Donats dos estimadors $\widehat{\theta}_1$, $\widehat{\theta}_2$ del mateix paràmetre $\theta$, direm que  $\widehat{\theta}_1$ és **més eficient** que $\widehat{\theta}_2$ quan l'error típic de $\widehat{\theta}_1$ és més petit que el de $\widehat{\theta}_2$:
$$
\sigma(\widehat{\theta}_1)< \sigma(\widehat{\theta}_2).
$$  



Normalment, només comparam l'eficiència de dos estimadors quan són no esbiaixats (o, com a molt, quan el seu biaix tendeix a 0 quan $n$ tendeix a $\infty$). En aquest cas, que $\widehat{\theta}_1$ sigui més eficient que $\widehat{\theta}_2$ significa que la seva variabilitat és menor i que per tant *les estimacions amb $\widehat{\theta}_1$ es concentren més al voltant del seu valor esperat, que és el paràmetre $\theta$ que volem estimar, que les estimacions amb $\widehat{\theta}_2$*.


**Exemples:**

* Si $X$ és normal, $\overline{X}$ és l'estimador no esbiaixat més eficient de la mitjana poblacional $\mu_X$.


* Si $X$ és Bernoulli, $\widehat{p}_X$ és l'estimador
no esbiaixat més eficient de la proporció poblacional $p_X$.


* Si $X$ és normal, $\widetilde{S}_X^2$ és l'estimador
no esbiaixat  més eficient de la variància poblacional $\sigma_X^2$.


```{example}
Sigui $X$ una variable aleatòria normal $N(\mu_X,\sigma_X)$.
Considerem la mediana $\mathit{Me}=Q_{0.5}$ d'una mostra aleatòria simple de $X$ com a estimador puntual de $\mu_X$, que coincideix amb la mediana de $X$ per la simetria de les variables normals.


```

Resulta que $E(\mathit{Me})=\mu_X$ però
$$
\sigma^2(\mathit{Me})\approx \dfrac{\pi}{2}\cdot
     \dfrac{\sigma_{X}^2}{n}\approx 1.57 \cdot \frac{\sigma_{X}^2}{n}=1.57\sigma^2(\overline{X})
$$

Per tant, si $X$ és normal, la mediana $\mathit{Me}$ és un estimador no esbiaixat de $\mu_X$, però menys eficient que $\overline{X}$. Per això preferim emprar la mitjana mostral per estimar $\mu_X$.



```{block2, type='rmdnote'}
Hem dit que si la població és normal, $\widetilde{S}_X^2$ és l'estimador no esbiaixat  més eficient de la variància poblacional $\sigma_X^2$. La variància vertadera
$$
S_X^2=\frac{(n-1)}{n} \widetilde{S}_X^2
$$   
és més eficient, perquè
$$
\sigma(S_X^2)=\sqrt{\frac{(n-1)}{n}}\sigma(\widetilde{S}_X^2)<\sigma(\widetilde{S}_X^2),
$$   
però és un estimador esbiaixat de $\sigma_X^2$, amb biaix que tendeix a 0 quan $n\to \infty$.

Si $n$ és petit (per davall de 30), és millor fer servir la variància mostral $\widetilde{S}_X^2$ per estimar la variància, ja que el biaix pot esbiaixar el resultat, però si $n$ és gran, el biaix de $S_X^2$ ja és petit i es pot fer servir $S_X^2$: de fet, si $n$ és molt gran, dividir per $n$ o per $n-1$ no varia gaire el resultat i per tant $\widetilde{S}_X^2$ i $S_X^2$ donen valors molt semblants.
```

### Estimadors màxim versemblants

Un estimador d'un paràmetre és **màxim versemblant**  quan, aplicat a cada mostra aleatòria simple, 
dóna el valor del paràmetre que fa màxima la probabilitat d'obtenir aquesta mostra.


```{example}
Suposem que tenim una variable aleatòria Bernoulli $X$ de probabilitat d'èxit $p_X$ desconeguda. Donada una mostra aleatòria simple $x_1,\ldots,x_n$ de $X$, siguin $\widehat{p}_x$ la seva proporció mostral i  
$$
P(x_1,\ldots,x_n\mid p_X=p)
$$ 
la probabilitat d'obtenir la mostra quan la probabilitat poblacional $p_X$ és igual $p$. Un estimador  per a $p_X$ és màxim versemblant quan, aplicat a cada mostra aleatòria simple $x_1,\ldots,x_n$ de $X$, ens dóna el valor de $p$ que fa que 
$$
P(x_1,\ldots,x_n\mid p_X=p)
$$ 
sigui el màxim possible. 


```

Quin creieu que és l'estimador màxim versemblant de $p_X$? Doncs sí, la proporció mostral $\widehat{p}_X$.

```{theorem}
El valor de $p$ per al qual $P(x_1,\ldots,x_n\mid p)$ és màxim és $\widehat{p}_x$.

```


La demostració és senzilla. Suposau que dins $x_1,\ldots,x_n$ hi ha $m$ 1s i $n-m$ 0s, de manera que $\widehat{p}_X=m/n$. Aleshores, la probabilitat d'obtenir $x_1,\ldots,x_n$ és
$$
P(x_1,\ldots,x_n\mid p)=p^m(1-p)^{n-m}
$$
Per trobar el valor de $p$ que fa aquest probabilitat màxima, derivau respecte de $p$ i estudiau el signe de la derivada, i concloureu que el màxim es dóna efectivament a $p=m/n$.


Alguns altres estimadors màxim versemblants:

* $\overline{X}$  és l'estimador màxim versemblant del paràmetre $\lambda$ d'una variable aleatòria Poisson

* $\overline{X}$  és l'estimador màxim versemblant de la mitjana $\mu$ d'una variable aleatòria normal



## Estimació de poblacions

### Estimació de poblacions numerades

```{example, taxi1}
Un dia vaig voler estimar quants taxis hi havia a Palma.
Per fer-ho, assegut en un bar del Passeig Marítim vaig apuntar les llicències dels 40 primers taxis que passaren. Els entraré directament en un vector de R.

```

```{r}
taxis=c(1217,600,883,1026,150,715,297,137,508,134,38,961,538,1154,314,1121,823,158,940,99,
  977,286,1006,1207,264,1183,1120,498,606,566,1239,860,114,701,381,836,561,494,858,187)
sort(taxis)
```

Puc estimar quants taxis hi ha a Palma a partir d'aquesta mostra? Us pot semblar una beneitura de pregunta, però aquest és un problema de rellevància històrica, com podeu consultar en [aquest article](https://www.investigacionyciencia.es/files/14469.pdf).

La solució d'aquest problema és donada pel resultat següent:

```{theorem}
Sigui $X$ una variable aleatòria uniforme sobre $\{1,2,\ldots,N\}$, i sigui $x_1,\ldots,x_n$ una mostra aleatòria de $X$. Sigui $m=\max(x_1,\ldots,x_n)$. Aleshores, l'estimador no esbiaixat més eficient de $n$ és
$$
\widehat{N}=m+\frac{m-n}{n}
$$

```


```{block2, type='rmdcorbes'}
La idea que hi ha sota aquesta fórmula és que si suposau que teniu $x_1,\ldots,x_n$ ordenats en ordre creixent, de manera que $x_n=m$, i calculau la mitjana de la longitud dels 'forats' a l'esquerra de cada valor $x_i$, tenim que a l'esquerra de $x_1$ hi ha $x_1-1$ nombres i entre cada $x_{i-1}$ i $x_{i}$ hi ha $x_{i}-x_{i-1}-1$ nombres, i per tant aquesta mitjana és
$$
\begin{array}{l}
\displaystyle \frac{(x_1-1)+(x_2-x_1-1)+\cdots+(x_{n}-x_{n-1}-1)}{n}\\
\displaystyle \qquad\quad =\frac{x_n-n}{n}=\frac{m-n}{n}
\end{array}
$$
i el que fa l'estimador $\widehat{N}$ és sumar al màxim de la mostra, $m$, la mitjana dels forats entre membres de la mostra.
```

```{example}
Continuem amb l'Exemple \@ref(exm:taxi1). Emprant la fórmula anterior, obtenim

```

```{r}
max(taxis)+(max(taxis)-length(taxis))/length(taxis)
```

la qual cosa ens permet estimar que hi havia `r round(max(taxis)+(max(taxis)-length(taxis))/length(taxis))` taxis a Palma. 
En realitat, consultant la web de l'Ajuntament, després vaig saber que en aquell moment n'hi havia 1246.

### Marca-recaptura

Suposem que en una població hi ha $N$ individus, en capturam $K$ (tots diferents), els marcam i els tornam a amollar.  Al cap de poc temps, en capturam $n$, dels quals $k$ estan marcats. A partir d'aquestes dades, volem estimar $N$.


Si suposam que $N$ i $K$ no han canviat de la primera a la segona captura, aleshores la variable aleatòria
$X$ definida per "Capturam un individu i miram si està marcat" és Bernoulli $Be(p)$ amb $p=K/N$, on coneixem la $K$ volem estimar la $N$.

Sigui ara $x_1,\ldots,x_n$ la mostra capturada en segon lloc. La seva proporció mostral d'individus marcats és  $\widehat{p}_X=k/n$. Com que $\widehat{p}_X$ és l'estimador màxim versemblant de $p$, estimam que
$$
\dfrac{K}{N}=\dfrac{k}{n}
$$
d'on, aïllant la $N$, estimam que
$$
N=\frac{n\cdot K}{k}.
$$

En resum, l'estimador
$$
\widehat{N}=\frac{n\cdot K}{k}
$$
maximitza la probabilitat d'obtenir $k$ individus marcats en una mostra aleatòria de $n$ individus. És l'**estimador màxim versemblant** de $N$ a partir de $K$, $k$ i $n$. Fixau-vos que aquest estimador no fa res més que traduir la proporció "Si he trobat $k$ individus marcats en un conjunt de $n$ individus, què ha de valer el nombre total $N$ de individus perquè hi hagi en total $K$ individus marcats?"


```{example, MR}
Suposem que hem marcat 15 peixos d'un llac, i que en una captura posterior de 10 peixos, n'hi ha 4 de marcats. Quants peixos estimau que conté el llac?
  
  
```


$$
\widehat{N}=\frac{15\cdot 10}{4}=37.5
$$
Per tant, estimam que hi haurà entre 37 i 38 peixos al llac.

En aquest cas podem comprovar la màxima versemblança d'aquesta estimació, calculant la probabilitat d'obtenir 4 individus marcats en una mostra aleatòria de 10 individus d'una població on hi ha 15 individus marcats. Per fer-ho, recordem que si una població està formada per $K$ subjectes marcats i $N-K$ subjectes no marcats, el nombre de subjectes marcats en mostres aleatòries sense reposició de mida $n$ segueix una distribució hipergeomètrica $H(K, N-K,n)$. Per tant, per a cada possible $N$, la probabilitat que en una mostra de 10 peixos del nostre llac n'hi hagi 4 de marcats serà `dhyper(4,15,N-15,10)`.


```{r}
N=15:100  #Possibles valors de N
p=dhyper(4,15,N-15,10)  #Probabilitats de 4 marcats en 10
Nmax=N[which(p==max(p))] # N que maximitza la probabilitat
Nmax
```

Aquest `Nmax` és la $N$ que fa màxima la probabilitat que en una mostra de 10 peixos del nostre llac n'hi hagi 4 de marcats. Vegem-ho en un gràfic:

```{r}
plot(N,p,type="h",xaxp=c(15,100,17))
points(Nmax,dhyper(4,15,Nmax-15,10),type="h",col="red",lwd=1.5)
```

Un altre estimador per a $N$ a partir de $K$, $n$ i $k$ és l'**estimador de Chapman**:
$$
\widehat{N}=\frac{(n+1)\cdot (K+1)}{k+1}-1
$$

La idea és que afegim a la població un individu extra i marcat, que suposam que també capturam a la segona mostra. Llavors, aplicam l'estimador anterior i finalment restam 1, per descomptar l'individu marcat extra que realment no pertany a la població que volem estimar.


En la situació de l'Exemple \@ref(exm:MR), aquest estimador dóna
$$
\widehat{N}=\frac{16\cdot 11}{5}-1=34.2
$$
i ens fa estimar una població total d'uns 34 peixos. Abans hem obtingut entre 37 i 38 peixos. 

```{block2,type="rmdnote"}
Quina de les dues estimacions s'acosta més a la realitat? Ni idea, no ho podem saber, amb una altra recaptura segurament haguéssim obtingut resultats diferents.
```

L'estimador màxim versemblant
$$
\widehat{N}=\frac{n\cdot K}{k}
$$
és esbiaixat, amb biaix que tendeix a 0 quan $n$ tendeix a $\infty$. L'estimador de Chapman
és menys esbiaixat per a mostres petites, i no esbiaixat si $K+n\geq N$ (però no és màxim versemblant). 




<!--chapter:end:02-EstimacioPuntual.Rmd-->

# Intervals de confiança


## Definicions bàsiques

Amb un estimador, estimam el paràmetre amb una certa precisió, que depèn:

* De la variabilitat de la variable aleatòria  d'interès

* De la mida de la mostra

* De la variabilitat de l'estimador (que segurament depèn de les dues anteriors)

* Del **nivell de confiança**, o *seguretat*, de l'estimació: com de segurs volem estar que l'estimació és correcta


```{r, echo=FALSE, fig.width=5}
knitr::include_graphics("Bioestadistica-II_files/figure-html/Garfield.png")
```

Un **interval de confiança del q%**  (abreviadament, un **IC q%**) d'un paràmetre poblacional és un interval obtingut aplicant a una mostra aleatòria simple una fórmula que satisfà la propietat següent: 

```{block2, type='rmdimportant'}
L'interval obtingut conté el valor del paràmetre poblacional el q% de les vegades que l'aplicam sobre mostres aleatòries simples preses a l'atzar
```

*Tenir una confiança del q%* significa doncs que empram una fórmula que encerta el q% de les vegades; o, per ser precisos, el q% de les vegades que l'aplicam bé. Però assumim que un (1-q)% de les vegades que l'aplicam ens equivocam, i no sabem quin és el nostre cas.


```{example}
En un experiment hem mesurat el percentatge d'augment d'alcohol en sang a 40 persones després de prendre 4 canyes de cervesa. La mitjana i la desviació típica mostral d'aquests percentatges d'increment han estat $\overline{x}=41.2$ i $\widetilde{s}=2.1$. Com veurem a l'Exemple \@ref(exm:alcohol1), un IC 95%  per al percentatge d'augment mitjà d'alcohol en sang  d'una persona després de beure 4 canyes de cervesa és [40.53, 41.87].

Això significa que estam *segurs al 95%* que l'augment mitjà d'alcohol en sang  d'una persona després de beure 4 canyes de cervesa està entre el 40.53% i el 41.87%, perquè aquest interval l'haurem calculat amb una fórmula que el 95% de les vegades que l'aplicam (bé) dóna un interval que conté la mitjana poblacional que volem estimar. Nosaltres som optimistes i "confiam" estar dins aquest 95% d'encerts.

```

```{block2,  type='rmdcaution'}
No confongueu: 

* **Interval de referència del q% per a una variable aleatòria**: Interval que conté *el valor de la variable aleatòria  en un individu* amb probabilitat q%. 

* **Interval de confiança del q% per a un paràmetre**: Interval que conté *el valor poblacional del paràmetre de la variable aleatòria* "amb probabilitat" q%, en el sentit que l'hem calculat amb una fórmula que dóna un interval que conté el paràmetre el q% de les vegades que l'aplicam a una mostra aleatòria.

* **Interval de referència del q% per a un estimador**: Interval que conté *el valor de l'estimador sobre una mostra aleatòria* amb probabilitat q%.  

```


Per exemple:

* Si diem que un *interval de referència del 95%* per a la concentració d'una proteïna en sèrum en individus sans mesurada en g/dl és [11,16], això significa significa que un 95% dels individus sans tenen una concentració d'aquesta proteïna en sèrum entre 11 i 16 g/dl, o, equivalentment, que un individu sa escollit a l'atzar té, amb un 95% de probabilitat, una concentració d'aquesta proteïna en sèrum entre 11 i 16 g/dl

* Si diem que un *interval de confiança del 95%* per a la concentració mitjana d'una proteïna en sèrum en individus sans mesurada en g/dl és [11,16], això significa que hem pres una mostra aleatòria de concentracions d'aquesta proteïna en sèrum en individus sans i a partir d'aquesta mostra hem estimat que, amb un 95% de confiança, la concentració mitjana d'aquesta proteïna en sèrum en individus sans està entre 11 i 16 g/dl (i tenim un 95% de confiança en aquest interval perquè l'hem calculat amb una fórmula que dóna un interval que conté la mitjana poblacional un 95% de les vegades que l'empram).

* Si diem que el 95% de les mostres de 100 concentracions d'una determinada proteïna en sèrum en individus sans tenen la mitjana mostral entre 11 i 16, això és un *interval de referència del 95% per a la mitjana mostral* de mostres de mida 100, no un interval de confiança per a la concentració mitjana poblacional ni un interval de referència per al valor de la concentració en un individu.


Que un IC q% per a un paràmetre $\theta$ sigui $[a,b]$ serveix:

* Per estimar $\theta$ amb aquest marge de *confiança*: Estam bastant segurs que el valor poblacional de $\theta$ està entre $a$ i $b$ (la fórmula emprada encerta sovint)

* Per poder rebutjar un valor concret de $\theta$ amb aquest marge de *confiança*: Estam bastant segurs que el valor real de $\theta$ no està ni per sota de $a$ ni per sobre de $b$

**Per exemple:** si un IC 95% per a la **prevalència** $p$ d'una determinada característica en una població (la fracció d'individus que tenen aquesta característica) va de 0.025 a 0.047:

* Estam molt ("un 95%") segurs que $p\in [0.025,0.047]$ (perquè la fórmula emprada per calcular aquest interval encerta en un 95% de les vegades)

* Estam molt segurs que $p>0.02$ (perquè tot l'interval on estam molt segurs que cau el valor real de $p$ està a la dreta de 0.02)

* Estam molt segurs que $p\neq 0.05$ (perquè  0.05 no pertany a l'interval on estam molt segurs que cau el valor real de $p$)

* Però *no estam molt segurs* que $p=0.03$, per molt que $0.03\in [0.025,0.047]$: estam molt segurs que $p$ està entre 0.025 i 0.047, però no tenim cap seguretat que valgui un valor concret entre aquests límits, només que està entre aquests límits.


Hi ha dos tipus de mètodes bàsics de càlcul d'intervals de confiança a partir d'una mostra aleatòria:


* **Paramètrics**: Usant alguna fórmula basada en la distribució mostral de l'estimador

    * Es basen en teoremes

    * Només serveixen si la variable aleatòria  $X$ i la mostra aleatòria satisfan (aproximadament) les hipòtesis del teorema

* **No paramètrics**: El més emprat és el **bootstrap**:

    * De la mostra, es prenen a l'atzar moltes (~1000) mostres aleatòries simples de la mateixa mida que la mostra, es calcula l'estimador amb cada una d'aquestes mostres i s'usa el vector de resultats per estimar un interval de confiança (per exemple, podríem prendre com a IC 95% l'interval entre els quantils 0.025 i 0.975 d'aquest vector)

    * Es pot usar sempre (si la mostra és aleatòria)

    * Empra un procés aleatori: en cada execució sobre les mateixes dades pot donar un interval diferent


## Exemple: Interval de confiança del 95% per a la mitjana d'una variable aleatòria normal

Una de les fórmules més conegudes per a intervals de confiança és la següent:

```{block2, type="rmdimportant"}
Si $X\sim N(\mu,\sigma)$ i en tenim una mostra aleatòria simple de mida $n$, mitjana mostral $\overline{X}$ i variància mostral $\widetilde{S}^2_X$, un IC 95% per a $\mu$ és
$$
\Bigg[\overline{X}-t_{n-1,0.975}\cdot \frac{\widetilde{S}_X}{\sqrt{n}},\ \overline{X}+t_{n-1,0.975}\cdot\frac{\widetilde{S}_X}{\sqrt{n}}\Bigg]
$$
on $t_{n-1,0.975}$ indica el 0.975-quantil de la distribució $t_{n-1}$.
```

Anem a explicar d'on surt aquesta fórmula, ja que és un paradigma de com s'obtenen la majoria de les fórmules paramètriques per a intervals de confiança.

Suposem  doncs que $X\sim N(\mu,\sigma)$ i que en tenim una mostra aleatòria simple de mida $n$, mitjana mostral $\overline{X}$ i variància mostral $\widetilde{S}^2_X$. En aquesta situació, sabem que 
$$
T=\frac{\overline{X}-\mu}{\widetilde{S}_{X}/\sqrt{n}}
$$
té distribució  t de Student amb $n-1$ graus de llibertat, $t_{n-1}$.




Si podem trobar $A,B\in \mathbb{R}$ tals que
$$
P(A\leq T\leq B)=0.95,
$$
llavors:
$$
\begin{array}{rl}
0.95 & =P\Bigg(A\leq   \dfrac{\overline{X}-\mu}{\widetilde{S}_{X}/\sqrt{n}}\leq  B\Bigg)\\[2ex]
& =P\Bigg(A\cdot \dfrac{\widetilde{S}_X}{\sqrt{n}}\leq  \overline{X}-\mu \leq  B\cdot \dfrac{\widetilde{S}_X}{\sqrt{n}}\Bigg)\\[2ex]
& =P\Bigg(-\overline{X}+A\cdot \dfrac{\widetilde{S}_X}{\sqrt{n}}\leq  -\mu \leq  -\overline{X}+B\cdot \dfrac{\widetilde{S}_X}{\sqrt{n}}\Bigg)\\[2ex]
& =P\Bigg(\overline{X}-B\cdot \dfrac{\widetilde{S}_X}{\sqrt{n}}\leq  \mu \leq  \overline{X}-A\cdot \dfrac{\widetilde{S}_X}{\sqrt{n}}\Bigg)
\end{array}
$$


Com que $P(A\leq  T\leq  B)=0.95$ significa que per al 95% de les mostres aleatòries simples de mida $n$ el valor de $T$ està  entre $A$ i $B$, 
$$
P\Bigg(\overline{X}-B\cdot \frac{\widetilde{S}_X}{\sqrt{n}}\leq  \mu \leq  \overline{X}-A\cdot \frac{\widetilde{S}_X}{\sqrt{n}}\Bigg)=0.95
$$
significa que per al 95% de les mostres aleatòries simples de mida $n$ la $\mu$ cau dins l'interval
$$
\Bigg[\overline{X}-B\cdot \frac{\widetilde{S}_X}{\sqrt{n}},\ \overline{X}-A\cdot \frac{\widetilde{S}_X}{\sqrt{n}}\Bigg]
$$
Per tant, això serà un IC 95% per a $\mu$.

Ens falta trobar els $A,B$ tals que $P(A\leq  T\leq  B)=0.95$. Per trobar-los, emprarem *quantils de la distribució de $T$*. Recordem que si indicam amb  $t_{n-1,0.975}$ el 0.975-quantil d'una $t_{n-1}$, per definició tenim que 
$$
P(T\leq  t_{n-1,0.975})=0.975
$$
i per la simetria de la $t$,
$$
P(T\leq  -t_{n-1,0.975})=P(T\geq t_{n-1,0.975})=0.025
$$
Per tant:
$$
\begin{array}{l}
P(-t_{n-1,0.975}\leq  T\leq  t_{n-1,0.975})\\
\quad =P(T\leq  t_{n-1,0.975})-P(T\leq  -t_{n-1,0.975})\\
\quad =0.975-0.025=0.95
\end{array}
$$

Així doncs, podem prendre 
$$
A=-t_{n-1,0.975},\quad B=t_{n-1,0.975}
$$
i obtenim l'IC 95% per a $\mu$ anunciat:
$$
\Bigg[\overline{X}-t_{n-1,0.975}\cdot \frac{\widetilde{S}_X}{\sqrt{n}},\ \overline{X}+t_{n-1,0.975}\cdot\frac{\widetilde{S}_X}{\sqrt{n}}\Bigg]
$$


L'escriurem
$$
\overline{X}\pm t_{n-1,0.975}\cdot \frac{\widetilde{S}_X}{\sqrt{n}}
$$

```{example}
Fem un experiment per veure que, efectivament, aquesta fórmula "encerta", en el sentit que conté la $\mu$, al voltant del 95% de les vegades. Al bloc de codi següent: generam una *Població* de 10^7^ "individus" que segueixen una llei normal estàndard i en calculam la mitjana `mu`;  definim una funció `IC` que calcula l'IC 95% per a la mitjana $\mu$ amb la fórmula anterior; prenem 200 mostres aleatòries simples de mida 50 de la nostra població i les aplicam aquesta funció, obtenint una matriu `M` de  200 columnes formades pels dos extrems dels intervals (l'inferior a la primera filera i el superior a la segona filera); finalment, miram quantes vegades hem encertat, és a dir, a quantes columnes de `M` la mitjana poblacional `mu` està entre l'entrada de la primera filera i la de la segona. 


```

```{r}
set.seed(42)
Poblacio=rnorm(10^7)
mu=mean(Poblacio)
IC=function(x){
  n=length(x)
  mean(x)+qt(0.975,n-1)*sd(x)/sqrt(n)*c(-1,1)}
M=replicate(200,IC(sample(Poblacio,50,replace=TRUE)))
Encerts=length(which(mu>=M[1,] & mu<=M[2,]))
Encerts
```

Hem encertat `r Encerts` vegades, és a dir, un `r round(100*Encerts/200,1)`% de les vegades.  És aproximadament el que esperàvem. Si ho provau amb altres llavors d'aleatorietat obtendreu altres resultats, de vegades millors, de vegades pitjors.

Per veure millor els encerts, dibuixam els intervals en un gràfic, on apareixeran en gris els que encerten i en vermell els que no encerten.

```{r,results="hide"}
plot(1,type="n",xlim=c(-0.8,0.8),ylim=c(0,200),
  xlab="Valors",ylab="Repeticions", main="200 IC 95%")
seg.int=function(i){color="grey";
  if((mu<M[1,i]) | (mu>M[2,i])){color="red"}
  segments(M[1,i],i,M[2,i],i,col=color,lwd=2)}
sapply(1:200,FUN=seg.int)
abline(v=mu,lwd=2)
```



```{block2, type='rmdcaution'}
**Atenció!** De mitjana, un IC *q%* NO conté el valor real del paràmetre en un *(100-q)%* de les ocasions.
```

Per exemple, de mitjana, un 5% de les vegades que calculam un IC 95%, el paràmetre poblacional no pertany a l'interval obtingut. Per tant, si calculam $n$ IC 95% sobre mostres aleatòries simples independents, el nombre de vegades que l'interval resultant no contendrà el paràmetre poblacional seguirà una distribució binomial $B(n,0.05)$. El gràfic següent dóna el valor de $P(X\geq 1)$ per a una variable aleatòria $X$ de tipus $B(n,0.05)$, per a  $n=0,...,100$, i per tant la probabilitat que si calculam $n$ IC 95% sobre mostres aleatòries simples independents, almenys un d'ells no contengui el paràmetre poblacional desitjat.

```{r}
plot(1-dbinom(0,0:100,0.05),pch=20,xlab="n",ylab="Probabilitat",
     main="Probabilitat d'algun èxit en una B(n,0.05)")
```


Tornant a l'IC 95% per a $\mu$ d'una variable normal donat per la fórmula
$$
\overline{X}\pm t_{n-1,0.975}\cdot \frac{\widetilde{S}_X}{\sqrt{n}}
$$
fixau-vos que: 

*  Està centrat en $\overline{X}$, per tant en cada càlcul estarà centrat en la mitjana mostral

* Tal i com l'hem calculat, la probabilitat que $\mu$ caigui fora d'aquest interval es reparteix per igual als dos costats: un 2.5% de les vegades la $\mu$ poblacional estarà a l'esquerra de l'extrem inferior i un 2.5% de les vegades estarà a la dreta de l'extrem superior



```{example, alcohol1}
En un experiment hem mesurat el percentatge d'augment d'alcohol en sang a 40 persones després de prendre 4 canyes de cervesa. La mitjana i la desviació típica mostral d'aquests percentatges d'increment han estat
$$
\overline{x}=41.2,\quad \widetilde{s}=2.1
$$
Per calcular un IC 95% per al percentatge mitjà d'augment, suposarem que la variable aleatòria que dóna el percentatge d'augment d'alcohol en sang en una persona després de prendre 4 canyes de cervesa és  *normal* i que la mostra que hem pres d'aquesta variable és *aleatòria simple*.


```

Llavors, com que $t_{n-1,0.975}$=`qt(0.975,39)`=`r round(qt(0.975,39),4)`, un IC 95% és
$$
41.2\pm 2.0227\cdot \frac{2.1}{\sqrt{40}}\Rightarrow 41.2\pm 0.67\Rightarrow [40.53, 41.87]
$$

Per tant, estimam amb un 95% de confiança que el percentatge mitjà d'augment d'alcohol en sang després de prendre 4 canyes de cervesa està entre el 40.53% i el 41.87%.

Per calcular l'interval anterior hem suposat que la variable poblacional "Percentatge d'augment d'alcohol en sang després de prendre 4 canyes de cervesa" segueix una distribució normal. I si no fos normal? 

* En aquest cas, com que $n=40$, és gran pel Teorema \@ref(thm:ICmu) de la propera secció l'interval obtingut segueix essent (aproximadament) un interval de confiança del 95% per a $\mu$

* Si $n$ fos petit i $X$ molt diferent d'una normal, no es pot usar aquesta fórmula i cal buscar-se la vida (per exemple, emprar el mètode de *bootstrap*)

També hem suposat que era una mostra aleatòria simple. I si no ho és?

* Si és aleatòria, com que el nombre de persones que poden prendre 4 canyes de cervesa és pràcticament la població mundial, molt gran, a efectes pràctics la podem considerar simple.

* Però segur que no és aleatòria, sinó oportunista. No hem tret per sorteig de la llista de tota la població mundial, ni tan sols de la de Mallorca, 40 persones i les hem fetes prendre 4 cerveses, sinó que hem cercat voluntaris. En aquest cas no podem fer res per salvar la fórmula, i la seva validesa depèn de si la mostra de persones presa pot passar per aleatòria o no.



## Interval de confiança per a la mitjana basat en la t de Student

```{block2,type="rmdnote"}
A partir d'ara, per tal d'evitar ambigüitats, a les fórmules expressarem el nivell de confiança dels intervals en tant per u, no en tant per cent, i parlarem d'intervals de confiança de nivell de confiança $q$, amb $q$ entre 0 i 1, en lloc d'intervals de confiança del $100q\%$. És a dir, per exemple, els intervals de confiança del 95% seran intervals de confiança de nivell de confiança 0.95.
```

### La fórmula {-}

El mateix argument que abans, canviant 0.95 per $q$ dóna:

```{theorem}
Si $X\sim N(\mu,\sigma)$ i en prenem una mostra aleatòria simple de mida $n$, un interval de confiança de nivell de confiança $q$ (en tant per u) per a $\mu$ és
$$
\overline{X}\pm t_{n-1,(1+q)/2}\cdot \frac{\widetilde{S}_X}{\sqrt{n}}
$$
  
```

Fixau-vos que als IC 95%, $q=0.95$ i per tant $(1+q)/2=1.95/2=0.975$.

Usant el Teorema Central del Límit i algunes aproximacions, tenim el següent resultat:

```{theorem, ICmu}
Sigui $X$ una variable aleatòria  qualsevol de mitjana poblacional $\mu$. Suposem que prenem una mostra aleatòria simple de $X$ de mida $n$ gran (diguem, de 40 o més elements). Llavors, un interval de confiança de nivell de confiança $q$ per a $\mu$ és aproximadament
$$
\overline{X}\pm t_{n-1,(1+q)/2}\cdot \frac{\widetilde{S}_X}{\sqrt{n}}
$$
  
  
```

L'aproximació del teorema anterior és millor com més gran sigui $n$ o com més propera a una normal sigui la variable poblacional $X$.

En resum:
```{block2, type='rmdimportant'}
Podem emprar la fórmula per a l'interval de confiança de nivell de confiança $q$ per a la mitjana poblacional basada en la t de Student
$$
\overline{X}\pm t_{n-1,(1+q)/2}\cdot \frac{\widetilde{S}_X}{\sqrt{n}}
$$
quan la variable poblacional és normal o quan la mostra aleatòria simple és gran.
```

```{example, RXprint}
L'empresa *RX-print* ofereix una impressora de radiografies d'altíssima qualitat. En la seva publicitat afirma que els seus
cartutxos imprimeixen una mitjana de 500 radiografies amb l'especificació: 

> Dades tècniques: Mostra de mida $n=25$, població suposada normal, nivell de confiança del 90%
 

```

Uns radiòlegs desitgen comprovar aquestes afirmacions i prenen una mostra de cartutxos a l'atzar de mida $n=25$, obtenint una mitjana de $\overline{x}=518$ radiografies i una desviació típica mostral $\widetilde{s}=39.9$.

Amb aquesta mostra, la mitjana poblacional anunciada pel fabricant cau dins l'interval de confiança del 90%?

La variable aleatòria d'interès és $X$ és "Prenem un cartutxo d'aquesta empresa i miram el nombre de radiografies que permet imprimir", de mitjana $\mu$ per a la qual volem calcular un IC 90%. Suposarem que la variable $X$ és normal, perquè l'empresa ho suposa a les dades tècniques. Per tant podem emprar la fórmula
$$
\overline{x}\pm t_{n-1,(q+1)/2} \frac{\widetilde{s}}{\sqrt{n}}
$$
on $n=25$, $\overline{x}=518$, $\widetilde{s}=39.9$, $q=0.9$, $(q+1)/2=0.95$ i $t_{24,0.95}$=`qt(0.95,24)`$=`r round(qt(0.95,24),2)`$.

Operant: 
$$
518\pm 1.71\times \frac{39.9}{\sqrt{25}}\Rightarrow 
518\pm 13.65\Rightarrow
[504.35,531.65]
$$ 
Tenim, doncs, un 95% de confiança que el nombre mitjà de radiografies per cartutxo està entre 504.35 i 531.65, i en particular que no és 500 (però en benefici del consumidor: estam molt segurs que és més gran que 500).

```{example, RXprint2}
A l'exemple anterior hem suposat que la variable aleatòria era normal. Què passaria si fos molt diferent d'una normal?

``` 

Com que $n=25$ no és prou gran, en principi no podríem aplicar la fórmula de l'interval de confiança basada en la t de Student. Emprarem el mètode del *bootstrap*, per a la qual cosa necessitam tenir les dades originals, i no només els seus estadístics. Tenim aquestes dades en  el vector `Radios` següent:
```{r}
Radios=c(485,511,509,509,561,529,458,532,545,546,
        503,577,547,477,507,548,480,444,461,573,
        513,604,542,501,488)
mean(Radios)
sd(Radios)
```

Prenem 5000 mostres aleatòries simples de mida 25 (la mateixa mida que el conjunt de dades original) de les dades i calculam la mitjana de cada mostra; fixam la llavor d'aleatorietat perquè el càlcul sigui reproduïble:
```{r}
set.seed(100)
Simulacions=replicate(5000,mean(sample(Radios,25,rep=TRUE)))
```

Ara prenem com a IC 90% l'interval que tanca el 90% de valors centrals d'aquest vector de mitjanes mostrals, és a dir, l'interval que va del quantil 0.05 al quantil 0.95 d'aquest vector de mitjanes:

```{r}
quantile(Simulacions,c(0.05,0.95))
```

Obtenim l'interval [`r round(quantile(Simulacions,0.05),2)`,`r round(quantile(Simulacions,0.95),2)`]: amb la fórmula basada en la t de Student, havíem obtingut l'interval [504.35,531.65].


### Algunes consideracions {-}


Observau que l'estructura de l'interval de confiança de nivell de confiança $q$ per a $\mu$ donat al Teorema \@ref(thm:ICmu)
\begin{align}
& \text{estimador}\nonumber\\
& \qquad \pm \frac{1+q}{2}\text{-quantil de la distr. mostral}\times \text{error típic de l'estimació}
(\#eq:ICMgral)
\end{align}

Aquesta estructura és molt típica (tot i que, com veurem, no tots els intervals de confiança paramètrics tenen aquesta forma) i satisfà que:

* L'interval de confiança està centrat en el valor de l'estimador

* La "probabilitat d'equivocar-se" es reparteix per igual als dos costats de l'interval: una fracció $q/2$ de les vegades el paràmetre estarà a l'esquerra de l'extrem inferior i una fracció $q/2$ de les vegades estarà a la dreta de l'extrem superior


A més, tenim que:

* Per a una mateixa mostra i una mateixa fórmula (paramètrica) per calcular l'interval de confiança, si el nivell de confiança creix, l'interval s'eixampla

    Això és general, per a tots els intervals de confiança paramètrics. La idea intuitiva és que, per estar més segurs que un interval conté un valor, l'interval ha de ser més ample. A un interval de confiança amb l'estructura \@ref(eq:ICMgral), el motiu matemàtic és que si $q$ creix, el quantil (1+$q$)/2 de la distribució mostral creix.
    
   Per exemple, a l'Exemple \@ref(exm:alcohol1), teníem $n=40$, $\overline{x}=41.2$ i $\widetilde{s}=2.1$:

   * L'IC 95% té $q=0.95$, per tant $t_{n-1,(1+q)/2}=t_{39,0.975}=2.02$, i donava 
$$
41.2\pm 2.02\cdot \frac{2.1}{\sqrt{40}}\Rightarrow 41.2\pm 0.67
$$

   * L'IC 99% té $q=0.99$, per tant $t_{n-1,(1+q)/2}=t_{39,0.995}=2.71$, i dóna
$$
41.2\pm 2.71\cdot \frac{2.1}{\sqrt{40}}\Rightarrow 41.2\pm 0.9
$$
    més ample

* Però si canviam  de mostra (o de fórmula, si n'hi ha més d'una) per calcular l'interval de confiança, pot passar qualsevol cosa.




### Amb R {-}

La funció 
```{r,eval=FALSE}
t.test(X,conf.level=...)$conf.int
```
calcula l'interval de confiança basat en la t de Student per a la $\mu$ de la variable aleatòria de la que el vector `X` n'és una mostra. El paràmetre `conf.level` permet especificar el nivell de confiança (en tant per u). El seu valor per defecte és 0.95, així que per calcular un IC 95% no cal especificar-lo.

Per exemple, l'IC 90% del vector de  nombres de radiografies de l'Exemple \@ref(exm:RXprint) es calcularia amb
```{r}
t.test(Radios,conf.level=0.9)$conf.int
```


### Càlcul de la mida de la mostra per fixar l'error {-}

Recordem que l'interval de confiança de nivell de confiança $q$ per a $\mu$ basat en la t de Student
$$
\overline{X}\pm t_{n-1,(1+q)/2}\cdot \frac{\widetilde{S}_X}{\sqrt{n}}
$$
és simètric i centrat en $\overline{X}$. La seva **amplada** és la diferència entre els seus extrems
$$
2t_{n-1,(1+q)/2}\times \frac{\widetilde{S}_X}{\sqrt{n}}
$$

El **marge d'error** (**error**, **precisió**) $M$ en l'estimació de $\mu$ per mitjà d'aquest interval de confiança és el que sumam i restam a $\overline{X}$ per obtenir l'interval, és a dir, la meitat de la seva amplada:
$$
M=t_{n-1,(1+q)/2}\times \frac{\widetilde{S}_X}{\sqrt{n}}
$$


Una pregunta típica a l'hora de planejar un experiment és quina ha de ser la mida de la mostra que hem de prendre perquè el marge d'error sigui com a màxim un cert valor desitjat $M_{max}$. És a dir, volem trobar la $n$ més petita tal que
$$
t_{n-1,(1+q)/2}\times \frac{\widetilde{S}_X}{\sqrt{n}}\leq M_{max}.
$$
Però fixau-vos que en aquesta desigualtat la $n$ hi apareix al quantil i a l'error típic, i a més la $\widetilde{S}_X$ depèn de la mostra. El que farem per respondre la pregunta serà fer algunes trampes:

* Aproximarem la t de Student per una normal estàndard (ja que segurament la $n$ haurà de ser gran):
$$
t_{n-1,(1+q)/2}\rightsquigarrow z_{(1+q)/2} 
$$

* Estimarem el valor de $\widetilde{S}_X$ mitjançant la desviació típica mostral $\widetilde{S}_0$ d'una **prova pilot** (una experiment anterior, realitzat per nosaltres o per qualcú altre)

* D'aquesta manera, aproximam l'error $M$ per mitjà de
$$
M\approx z_{(1+q)/2}\times \frac{\widetilde{S}_0}{\sqrt{n}}
$$

* I ara si imposam que $M\leq M_{max}$, ja podem aïllar la $n$:

$$
z_{(1+q)/2}\times \frac{\widetilde{S}_0}{\sqrt{n}}\leq M_{max}\Longrightarrow
n\geq \left(\frac{ z_{(1+q)/2}\cdot \widetilde{S}_0}{M_{max}}
\right)^2
$$

En resum:

```{theorem}
Per estimar la $\mu$  amb nivell de confiança $q$ amb un marge d'error com a màxim $M_{max}$ mitjançant la fórmula basada en la t de Student, prendrem una mostra de mida 
$$
n\geq \left(\frac{ z_{(1+q)/2}\cdot \widetilde{S}_0}{M_{max}}
\right)^2,
$$
on $\widetilde{S}_0$ és la desviació típica mostral obtinguda en una estimació anterior de $\mu$ (en una *prova pilot*).

```

Naturalment, quan després prenguem una mostra de mida $n$ calculada d'aquesta manera, pot passar qualsevol cosa, ja que hem emprat els resultats d'una mostra per estimar la desviació típica d'una altra mostra i a més hem aproximat els quantils de la t de Student per els d'una normal estàndard, que són més petits. Però almenys haurem fet tot el que haurem pogut per fitar l'error dins el marge desitjat.



```{example}
A l'Exemple \@ref(exm:alcohol1),  hem emprat una mostra de $n=40$ persones, amb $\overline{x}=41.2$ i $\widetilde{s}=2.1$, i l'error ha estat
$$
t_{0.975,39}\cdot \frac{2.1}{\sqrt{40}}=0.67
$$
Quin és el nombre mínim de persones que hauríem hagut d'emprar per obtenir un IC 95% amb un error de (com màxim) 0.5?


```

Empram l'exemple com a prova pilot:
$$
n\geq \left(\frac{ z_{(1+q)/2}\cdot \widetilde{s}}{M_{max}} \right)^2=
\left(\frac{1.96\cdot 2.1}{0.5}
\right)^2=67.77
$$

El valor de $n$ més petit que satisfà aquesta condició és 68, per tant aquest és el nombre mínim de persones que hauríem hagut d'emprar per esperar obtenir un IC 95% amb un error de (com màxim) 0.5.

## Intervals de confiança per a proporcions 

Suposem que tenim una variable Bernoulli $X$ amb probabilitat d'èxit $p_X$ desconeguda. Volem calcular un interval de confiança per a $p_X$. 
Per fer-ho, prenem una mostra aleatòria simple de $X$ de mida $n$, amb nombre d'èxits $x$ i per tant proporció mostral  d'èxits $\widehat{p}_{X}=x/n$

Explicarem tres mètodes per calcular aquest interval de confiança:

```{block2, type='rmdimportant'}
* El **mètode exacte de Clopper-Pearson**, que es pot aplicar sempre però sol donar intervals de confiança més amples del necessari.

* El **mètode aproximat de Wilson**, que es pot emprar quan la mostra és gran, posem de mida 40 o més, i es basa en el fet que, pel Teorema Central del Límit, la proporció mostral de mostres aleatòries simples segueix una distribució aproximadament normal. 

* El **mètode aproximat de Laplace**, que és una simplificació del mètode de Wilson, però només es pot emprar quan la mostra és bastant més gran, posem de mida 100 o més, i la proporció mostral $\widehat{p}_{X}$ no és molt propera a 0 o a 1. És el mètode més clàssic i conegut.

```


### Mètode "exacte" de Clopper-Pearson {-}

Aquest mètode es basa en el fet que el nombre d'èxits $x$ en mostres aleatòries simples de mida $n$ de $X$ segueix una distribució binomial $B(n,p_X)$. Raonant de manera similar a com obteníem l'interval per a $\mu$ basat en la t de Student (us estalviarem els detalls) arribam a la fórmula següent:

```{theorem}
Un interval de confiança de nivell de confiança $q$ per a $p_X$ és $[p_0,p_1]$, on 

* $p_0$ és la solució de l'equació 
$$
\sum_{k=x}^n\binom{n}{k}p_0^k(1-p_0)^{n-k}= \frac{1-q}{2}
$$

* $p_1$ és la solució de l'equació
$$
\sum_{k=0}^x\binom{n}{k}p_1^k(1-p_1)^{n-k}= \frac{1-q}{2}
$$
```


Calcular a mà aquest interval és intractable, i en general dóna més ample del necessari (degut a la natura discreta de la distribució binomial, que només pren valors nombres naturals), però es pot emprar amb  mostres aleatòries simples de qualsevol mida ja que empra que el nombre d'èxits $x$ en mostres aleatòries simples de mida $n$ de $X$ segueix una distribució binomial i això sempre és veritat.

Per calcular-lo amb R, podeu emprar la funció del paquet **epitools**
```{r,eval=FALSE}
binom.exact(x,n,conf.level=...)
```
on `x`és el nombre d'èxits, `n` la mida de la mostra, i `conf.level` el nivell de confiança en tant per u, que per defecte val 0.95.

```{example,CP1}
De 10 pacients tractats amb un medicament, 2 s'han curat. Quin seria un IC 95% per a la proporció *p* de pacients que aquest medicament cura?

``` 

Emprarem el mètode de Clopper-Pearson
```{r}
library(epitools)
round(binom.exact(2,10),3)
```
Dóna l'interval [`r library(epitools);round(binom.exact(2,10)$lower,3)`,`r round(binom.exact(2,10)$upper,3)`]. Estimam per tant amb una confiança del 95% que aquest medicament cura entre el `r library(epitools);round(binom.exact(2,10)$lower,3)*100`% i el `r round(binom.exact(2,10)$upper,3)*100`% dels pacients.

L'interval de Clopper-Pearson té l'inconvenient que, en general, no està centrat en $\widehat{p}_{X}$. Per exemple, el centre de l'interval anterior és $(`r round(binom.exact(2,10)$lower,3)`+`r round(binom.exact(2,10)$upper,3)`)/2=	`r round((round(binom.exact(2,10)$lower,3)+ round(binom.exact(2,10)$upper,3))/2,2)`$, diferent de $\widehat{p}_X=0.2$

### Mètode de Wilson {-}

Suposem ara que prenem una mostra aleatòria simple de $X$ de mida $n$ gran (posem, de 40 o més subjectes) i proporció mostral d'èxits $\widehat{p}_{X}$. En aquestes condicions, pel Teorema Central del Límit,
$$
Z=\dfrac{\widehat{p}_{X}-p_X}
{\sqrt{\frac{p_X(1-p_X)}{n}}}\approx N(0,1)
$$
Per tant
$$
P\Big(-z_{(1+q)/2}\leq \dfrac{\widehat{p}_{X}-p_X}
{\sqrt{\frac{p_X(1-p_X)}{n}}}\leq z_{(1+q)/2}\Big)=q
$$

Aïllant $p_X$ obtenim:

```{theorem}
Si la mida $n$ de la mostra és gran, un interval de confiança de nivell de confiança $q$ per a $p_X$ és (aproximadament): 
$$
\frac{\widehat{p}_{X}+\frac{z_{(1+q)/{2}}^2}{2n}\pm z_{(1+q)/{2}}\sqrt{\frac{\widehat{p}_{X}(1-\widehat{p}_{X})}{n}+\frac{z_{(1+q)/{2}}^2}{4n^2}}}{1+\frac{z_{(1+q)/{2}}^2}{n}}
$$
```


Amb R es calcula amb la funció 
```{r,eval=FALSE}
binom.wilson(x,n,conf.level=...)
```
del paquet **epitools**, amb la mateixa sintaxi que `binom.exact`. Aquest interval també té l'inconvenient que, si us hi fixau, no està centrat en $\widehat{p}_{X}$: el seu centre és 
$$
\frac{\widehat{p}_{X}+\frac{z_{(1+q)/{2}}^2}{2n}}{1+\frac{z_{(1+q)/{2}}^2}{n}}
$$



### Mètode de Laplace {-}

Suposem finalment que prenem una mostra aleatòria simple de $X$ de mida $n$ més gran i $\widehat{p}_{X}$ enfora de 0 i 1. Per fixar idees, suposem que
$$
n\geq 100,\ n\widehat{p}_{X}\geq 10,\  n(1-\widehat{p}_{X})\geq 10
$$
En aquest cas, a la fórmula de l'interval de Wilson  podem suposar que els termes $z_{(1+q)/{2}}^2/n$ són (aproximadament) 0 i obtenim la fórmula següent:

```{theorem}
En les condicions explicades, un interval de confiança de nivell de confiança $q$ per a $p_X$ és (aproximadament): 
$$
\widehat{p}_{X}\pm z_{(q+1)/2}\sqrt{\frac{\widehat{p}_{X}
(1-\widehat{p}_{X})}{n}}
$$
```

Amb R es calcula amb la funció 
```{r,eval=FALSE}
binom.approx(x,n,conf.level=...)
```
del paquet **epitools**, amb la mateixa sintaxi que `binom.exact`. Aquesta fórmula és la més popular, amb més de 200 anys de rodatge.

```{block2,type="rmdnote"}
Us heu de saber la fórmula de Laplace, no cal saber les fórmules dels altres dos intervals.

```

```{r, echo=FALSE, out.width="50%"}
knitr::include_graphics("Bioestadistica-II_files/figure-html/mercifulgod.png")
```



### Més exemples  {-}

```{example}
En una mostra aleatòria de 500 famílies amb nins en edat escolar es va trobar que 340 introduïen fruita diàriament en la dieta dels seus fills. A partir d'aquestes dades, volem calcular un interval de confiança del 95% per a la proporció real de famílies d'aquesta ciutat amb nins en edat escolar que incorporen fruita fresca cada dia en la dieta dels seus fills.


```

Diguem $X$ a la variable aleatòria "Prenem una família amb nins en edat escolar i miram si inclou diàriament fruita a la dieta dels fills". És Bernoulli, diguem $p_X$ a la seva probabilitat d'èxit: la probabilitat que una família amb nins en edat escolar inclogui diàriament fruita a la dieta dels fills. Cercam un interval de confiança del 95% per a $p_X$.

Com que $n=500\geq 100$, $n\widehat{p}_X=340\geq 10$ i $n(1-\widehat{p}_X)=160\geq 10$, podem emprar la fórmula de Laplace
$$
\widehat{p}_{X}\pm z_{(q+1)/2}\sqrt{\frac{\widehat{p}_{X}
(1-\widehat{p}_{X})}{n}}
$$
amb $n=500$, $\widehat{p}_{X}=340/500=0.68$ i $z_{(q+1)/2}=z_{0.975}=1.96$. 
Dóna
$$
0.68\pm 1.96\sqrt{\frac{0.68(1-0.68)}{500}}\Rightarrow [0.639,0.721]
$$

Amb R:
```{r}
round(binom.approx(340,500), 3)
```


Amb els altres mètodes, que també podríem aplicar en aquest cas, obtenim els intervals:
```{r}
round(binom.exact(340,500),3)
round(binom.wilson(340,500),3)
```

En resum, estimam que entre aproximadament un 64% i un 72% de les famílies d'aquesta ciutat amb nins en edat escolar inclouen diàriament fruita fresca en la dieta dels seus fills.


Quan podem calcular més d'un interval per a $p_X$, quin calculam?

D'entrada cal dir que si podem calcular més d'un interval, segurament donaran molt parescuts, com heu pogut comprovar a l'exemple anterior. A més, recordau que les tres fórmules només ens donen "una confiança del 100q%" si s'apliquen a mostres aleatòries simples, i les nostres mostres gairebé sempre seran oportunistes, cas en el qual, si ens posam perepunyetes, no en podem aplicar cap.

Però en tot cas, si no filam molt prim i podem triar, hem de tenir en compte que:

* L'interval de Clopper-Pearson és exacte, no empra cap aproximació, però:
    * Tendeix a donar un interval més ample del necessari
    * No està centrat en la proporció mostral
    * Només és un interval "exacte" si la mostra és aleatòria simple, cosa que gairebé sempre serà fals (com a molt, serà "aproximadament" aleatòria simple)
    * Com que no es pot calcular "a mà", no és molt popular

* L'interval de Wilson és aproximat, fa servir l'aproximació a la normal donada pel Teorema Central del Límit. Això no és un gran emperò, pequè tanmateix segurament la mostra serà com a molt "aproximadament" aleatòria simple. Ara bé, tampoc no està centrat en la proporció mostral, i ens agrada poder donar els intervals en la forma "tal més menys qual" perquè d'aquesta manera donam l'estimació puntual i el marge d'error.

* L'interval de Laplace és *molt* aproximat, però:
    * Forma part de la cultura general del científic, tothom el coneix
    * És l'únic centrat en la proporció mostral


```{example}
En un assaig d'un nou tractament de quimioteràpia, en una mostra de $n$ malalts tractats, cap desenvolupà càncer testicular com a efecte secundari. Quin seria un interval de confiança al 95% per a la proporció de malalts tractats amb aquesta quimio que desenvolupen càncer testicular?


```

Per calcular-lo podem emprar el mètode de Clopper-Pearson i, si $n$ és gran, el de Wilson. No podem emprar la fórmula de Laplace, perquè $\widehat{p}_X=0$. 

Pel que fa a Clopper-Pearson, aquest és un dels pocs casos que admeten solució analítica senzilla: dóna l'interval 
$$
\Big[0,1-\Big(\frac{1-q}{2}\Big)^{1/n}\Big]
$$
que, si $q=0.95$, queda
$$
[0,1-0.025^{1/n}].
$$
Per exemple, si $n=40$
```{r}
binom.exact(0,30)
1-0.025^(1/30)
```

Si podem emprar el mètode de Wilson, la fórmula
$$
\frac{\widehat{p}_{X}+\frac{z_{(q+1)/2}^2}{2n}\pm z_{(q+1)/2}\sqrt{\frac{\widehat{p}_{X}(1-\widehat{p}_{X})}{n}+\frac{z_{(q+1)/2}^2}{4n^2}}}{1+\frac{z_{(q+1)/2}^2}{n}}
$$
amb $\widehat{p}_{X}=0$ i $z_{(1+q)/2}=1.96$ dóna
$$
\frac{\frac{1.96^2}{2n}\pm 1.96\sqrt{\frac{1.96^2}{4n^2}}}{1+\frac{1.96^2}{n}}\Longrightarrow
\Big[0,\frac{1.96^2}{n+1.96^2}\Big]
$$
Per exemple, un altre cop amb $n=40$
```{r}
binom.wilson(0,40)
qnorm(0.975)^2/(40+qnorm(0.975)^2)
```

Quan s'ha de calcular "a ull" un interval de confiança del 95% per a una probabilitat $p_X$ a partir d'una mostra aleatòria simple on no hi ha hagut cap èxit, sovint es fa servir la regla següent:

> **Regla del 3:** Quan en una mostra aleatòria simple de mida $n$ d'una variable aleatòria de Bernoulli de paràmetre $p_X$ no hi trobam cap èxit, un IC 95% per a $p_X$ va, aproximadament, de 0 a $3/n$.

Amb aquesta regla, en el nostre exemple amb $n=40$ obtendríem l'interval [0,3/40]=[0,`r round(3/40,4)`], no molt enfora del [0,0.088] que hem obtingut amb els altres dos mètodes. 

Per veure com la regla del 3 aproxima l'interval de Clopper-Pearson, el gràfic següent mostra els valors $3/n$ i l'extrem superior de l'IC 95% de Clopper-Pearson a partir d'una mostra de mida $n$ amb 0 èxits:

```{r}
f=function(n){binom.exact(0,n)$upper}
plot(1:100,sapply(1:100,f),pch=20,cex=0.7,xlab="n",ylab="Extrem superior",
     main="Extrem superior d'un IC 95% en cas de 0 èxits")
curve(3/x,col="red",lwd=2,add=TRUE)
legend("topright",lty=c(NA,1),pch=c(20,NA),
       legend=c("Clopper-Pearson","Regla del 3"),col=c("black","red"),cex=0.7)
```

El gràfic següent mostra els valors $3/n$  i els extrems superiors dels IC 95% de Clopper-Pearson i de Wilson a partir d'una mostra de mida $n$ ($n\geq 40$ per als intervals de confiança de Wilson) amb 0 èxits:

```{r}
f=function(n){binom.exact(0,n)$upper}
plot(1:100,sapply(1:100,f),pch=20,cex=0.5,xlab="n",ylab="Extrem superior",
     main="Extrem superior d'un IC 95% en cas de 0 èxits")
curve(3/x,col="red",lwd=1.5,add=TRUE)
points(40:100,3.84/(40:100+3.84),pch=20,cex=0.5,col="blue")
legend("topright",lty=c(NA,NA,1),pch=c(20,20,NA),
    legend=c("Clopper-Pearson","Wilson","Regla del 3"),col=c("black","blue","red"),cex=0.7)
```

Els extrems superiors dels intervals de Clopper-Pearson i Wilson se superposen en aquest darrer gràfic.

 
```{example} 
En un assaig d'un tractament de quimioteràpia, en una mostra de 100 pacients tractats, 25 desenvoluparen càncer testicular secundari. Volem calcular un  IC 95% per a la proporció  de pacients tractats amb aquesta quimioteràpia que desenvolupen càncer testicular.

```

En aquest cas podem emprar els tres mètodes:
```{r}
round(binom.exact(25,100),4)
round(binom.wilson(25,100),4)
round(binom.approx(25,100),4)
```

Concloem, amb un nivell de confiança del 95%, que entre aproximadament un 17% i un 34% dels pacients tractats amb aquesta quimioteràpia  desenvolupen càncer testicular.

### Càlcul de la mida de la mostra per a fixar l'error {-}

L'**error** de l'interval de confiança de Laplace és
$$
M= z_{(q+1)/2} \sqrt{\frac{\widehat{p}_{X} (1-\widehat{p}_{X})}{n}}
$$
No podem determinar la mida de la mostra a fi que l'interval de confiança tingui un error màxim sense conèixer $\widehat{p}_{X}$, que no coneixem sense una mostra.

Però en el cas de l'interval de Laplace per a una proporció, podem donar un $n$ que garanteixi una amplada màxima donada valgui el que valgui $\widehat{p}_{X}\in [0,1]$.


Fixau-vos que la funció $y=p (1-p)$, amb $p\in [0,1]$, és una paràbola còncava amb vèrtex al punt $p=0.5$
```{r}
curve(x*(1-x),xlim=c(0,1),xlab="p",ylab="")
abline(v=0.5,lty="dashed")
```
Per tant, el seu màxim s'assoleix a $p=0.5$. Així, doncs
$$
\widehat{p}_{X} (1-\widehat{p}_{X})\leq 0.5(1-0.5)=0.5^2\text{ per a tot $\widehat{p}_X\in[0,1]$}
$$
i per tant
$$
\begin{array}{l}
\displaystyle M=z_{(q+1)/2} \sqrt{\frac{\widehat{p}_{X} (1-\widehat{p}_{X})}{n}}\\
\qquad\displaystyle 
\leq z_{(q+1)/2}\sqrt{\frac{0.5^2}{n}}=\frac{0.5z_{(q+1)/2}}{\sqrt{n}}=\frac{z_{(q+1)/2}}{2\sqrt{n}}
\end{array}
$$

D'aquesta manera, si prenem $n$ tal que
$$
\frac{z_{(q+1)/2}}{2\sqrt{n}}\leq M_{max}
$$
aleshores segur que $M\leq M_{max}$, valgui el que valgui $\widehat{p}_{X}$.

Per tant, el que farem serà calcular la $n$ per obtenir un error com a màxim $M_{max}$ **en el cas més desfavorable**: quan l'interval és el més ample possible, és  a dir, suposant que $\widehat{p}_{X}=0.5$:
$$
M_{max}\geq \frac{z_{(q+1)/2}}{2\sqrt{n}}
\Rightarrow
n\geq \left(\frac{z_{(q+1)/2}}{2\cdot M_{max}}\right)^2
$$

En resum:

```{theorem}
Si 
$$
  n\geq \left(\frac{z_{(q+1)/2}}{2\cdot M_{max}}\right)^2,
$$
l'error de l'interval de Laplace calculat amb una mostra de mida $n$ sempre serà com a molt $M_{max}$.

  
```

```{example}
Quina és la mida més petita d'una mostra que ens garanteix un error de com a màxim 0.05 en estimar una  proporció $p_X$ emprant un interval de confiança de Laplace del 95%?

```

Pel teorema anterior, per garantir un error de 0.05 en calcular un IC 95% per una proporció $p_X$ emprant la fórmula de Laplace, hem d'emprar una mostra de mida $n$ tal que
$$
n\geq \Bigg(\frac{z_{(1+q)/2}}{2M_{max}}\Bigg)^2=\Bigg(\frac{1.96}{0.1}\Bigg)^2=384.16
$$

La mida més petita que satisfà aquesta condició és $n=385$.

```{block2,type="rmdcaution"}
La resposta correcta no és 384, per molt que 384.16 s'arrodoneixi a 384. Fixau-vos que 384 no és més gran que 384.16.
```

Observau tres coses:

* El valor de $n$ només depèn de la precisió i del nivell de confiança, no de la natura  de l'estudi ni de proves pilot

* Tal i com hem trobat la $n$, estam segurs que si la mostra és com a mínim d'aquesta mida, el marge d'error de l'interval de confiança de Laplace serà com a màxim  $M_{max}$ (la seva amplada serà com a màxim $2M_{max}$), sigui quina sigui la mostra. És de les poques vegades que podem estar segurs de qualque cosa en estadística.

* El teorema anterior és per l'amplada de l'interval de Laplace, però la $n$ segurament us sortirà molt gran i en aquest cas l'interval de Laplace aproxima molt bé els altres dos intervals.


## Intervals de confiança per a la variància d'una variable normal

Suposem que tenim una variable normal $X\sim N(\mu,\sigma)$. Volem trobar un IC 95% per a la seva variància $\sigma^2$ (o la seva desviació típica $\sigma$). Per calcular-lo, prenem una mostra aleatòria simple de mida $n$, de variància mostral $\widetilde{S}^2_X$. 


Recordau que, en  aquestes condicions,
$$
\frac{(n-1) \widetilde{S}_{X}^2}{\sigma^2}
$$
té distribució $\chi^2_{n-1}$

Podem aprofitar aquest fet per obtenir intervals de confiança per a $\sigma^2$:

```{theorem}
Si la variable $X$ és normal,  un interval de confiança de nivell de confiança $q$ per a $\sigma^2$ és  
$$
\left[ \frac{(n-1)\widetilde{S}_{X}^2}{\chi_{n-1,(1+q)/2}^2},
\frac{(n-1)\widetilde{S}_{X}^2}{\chi_{n-1,(1-q)/2}^2}
\right],
$$
on $\chi_{n-1,r}^2$ és el $r$-quantil de la distribució $\chi_{n-1}^2$
```

```{block2, type='rmdcorbes'}
La justificació d'aquesta fórmula és la usual: com que 
$$
\begin{array}{l}
\displaystyle P(\chi_{n-1}^2\leq \chi_{n-1,(1-q)/2}^2)=\frac{1-q}{2}\\  
\displaystyle P(\chi_{n-1}^2\geq \chi_{n-1,(1+q)/2}^2)=\frac{1-q}{2},
\end{array}
$$
tenim que
$$
\begin{array}{l}
q=P\left(\chi_{n-1,(1-q)/2}^2\leq \chi_{n-1}^2\leq
\chi_{n-1,(1+q)/2}^2\right)\\[2ex]
\quad\displaystyle =P\left(\chi_{n-1,(1-q)/2}^2\leq \frac{(n-1) \widetilde{S}_{X}^2}{\sigma^2}\leq
\chi_{n-1,(1+q)/2}^2
\right)\\[2ex]
\quad\displaystyle = P\left(\frac{(n-1)
\widetilde{S}_{X}^2}{\chi_{n-1,(1+q)/2}^2}\leq\sigma^2\leq\frac{
(n-1)\widetilde{S}_{X}^2}{\chi_{n-1,(1-q)/2}^2}
\right)
\end{array}
$$
 
````

Fixau-vos que aquest interval de confiança per $\sigma^2$ no està centrat en $\widetilde{S}_{X}^2$. A més, com que  $\chi_{n-1}^2$ no és simètrica, s'han de calcular els dos quantils  $\chi_{n-1,(1-q)/2}^2$ i $\chi_{n-1,(1+q)/2}^2$

```{example}
Un índex de qualitat d'un reactiu químic és la variabilitat en el temps que triga a actuar: es demana que aquest temps sigui aproximadament constant, és a dir, que tengui una desviació típica petita.

```

Hem realitzat 30 proves en les quals hem mesurat el temps d'actuació d'un determinat reactiu, i a partir dels resultats volem calcular un IC 95% per a la desviació típica del seu temps d'actuació. Suposarem que la distribució del temps d'actuació d'aquest reactiu és aproximadament normal. Tenim els resultats guardats en el vector següent:
  


```{r}
Temps=c(12,13,13,14,14,14,15,15,16,17,17,18,18,19,19,
        25,25,26,27,30,33,34,35,40,40,51,51,58,59,83)
```

Com que la variable que ens dóna el temps és (aproximadament) normal, podem emprar la fórmula per a l'IC 95% per a $\sigma^2$ anterior:
$$
\left[ \frac{(n-1)\widetilde{S}_{X}^2}{\chi_{n-1,(1+q)/2}^2},
\frac{(n-1)\widetilde{S}_{X}^2}{\chi_{n-1,(1-q)/2}^2}
\right]
$$

on:

* $n=$`length(Temps)`$=`r length(Temps)`$
* $\widetilde{S}_X^2=$`var(Temps)`$=`r var(Temps)`$
* $q=0.95$, per tant $\chi_{n-1,(1+q)/2}^2=$`qchisq(0.975,29)`$=`r qchisq(0.975,29)`$ i $\chi_{n-1,(1-q)/2}^2=$`qchisq(0.025,29)`$=`r qchisq(0.025,29)`$


Obtenim l'interval:
$$
\left[ \frac{29\cdot 301.55}{45.72}, \frac{29\cdot 301.55}{16.05}\right]= [191.26, 544.96]
$$

Però aquest  interval és per a la variància. Per obtenir un interval de confiança per a la desviació típica, prenem arrels quadrades dels extrems:
$$
[\sqrt{191.26}, \sqrt{544.96}]=[13.83,23.34]
$$

Per tant la variabilitat dels temps d'actuació d'aquest reactiu és molt gran. Comparau aquest interval amb l'IC 95% per al seu temps mitjà d'actuació:
```{r}
round(t.test(Temps)$conf.int,2)
```

L'extrem superior de l'IC 95% per a la desviació típica és més gran que l'extrem inferior d'aquest IC 95% per a la mitjana.

Amb R, aquest interval de confiança amb nivell de confiança $q$ per a la variància es pot calcular amb la funció

```{r,eval=FALSE}
varTest(X,conf.level=...)$conf.int
```

del paquete **EnvStats**, on `X` és el vector que conté la mostra i `conf.level` indica el nivell de confiança en tant per u, que per defecte és igual a 0.95.

Així, l'interval de confiança que ens demanàvem a l'exemple anterior es calcularia amb

```{r}
library(EnvStats)
varTest(Temps)$conf.int
```

No, aquest és el de la variància. El de la desviació típica és:
```{r}
sqrt(varTest(Temps)$conf.int)
```


```{block2,type="rmdcaution"}
L'interval per a la variància basat en la distribució $\chi^2$ no és vàlid si la variable poblacional no és (aproximadament) normal. En aquest cas, el millor és emprar un mètode no paramètric, com per exemple el *bootstrap*.
```

## "Poblacions finites"

Fins ara hem emprat mostres aleatòries simples. Què passa si prenem mostres aleatòries sense reposició?

Si la mida $N$ de la població és molt més gran que la mida $n$ de la mostra (posem $N\geq 1000n$), les fórmules donades fins ara funcionen (aproximadament) bé.

Quan la mida $N$ de la població *no* és molt més gran que la mida $n$ de la mostra, el que es fa és, a les fórmules que hem donat per als intervals de confiança per a $\mu$ o $p_X$, multiplicar-hi l'error estàndard  pel *factor de població finita*
$$
\sqrt{\frac{N-n}{N-1}}
$$

Així:

* Si $X$ és una població  de mida $N$ amb mitjana poblacional $\mu$  i prenem una mostra aleatòria sense reposició de $X$, amb mitjana $\overline{X}$ i desviació típica mostral $\widetilde{S}_X$, i si $X$ normal o si $n$ és  gran, es recomana prendre com a interval de confiança de nivell de confiança $q$ per a $\mu$
$$
\overline{X}\pm t_{n,(q+1)/2}\frac{\widetilde{S}_X}{\sqrt{n}}\sqrt{\frac{\vphantom{(}N-n}{N-1}}
$$


* Si $X$ una població de mida $N$ que segueix una distribució Bernoulli amb probabilitat d'èxit $p_X$ i prenem una mostra aleatòria sense reposició de $X$, amb $n$ molt gran i nombres d'èxits i fracassos com a mínim 10, es recomana prendre com a interval de confiança de nivell de confiança $q$ per a $p_X$
$$
\widehat{p}_{X}\pm z_{(q+1)/2}\sqrt{\frac{\widehat{p}_{X}
(1-\widehat{p}_{X})}{n}}\sqrt{\frac{\vphantom{(}N-n}{N-1}}
$$

* En les condicions del punt anterior, per obtenir un interval de confiança de nivell de confiança $q$ per a $p_X$ amb un marge d'error $M_{max}$ en el cas més desfavorable caldrà prendre una mostra de mida
$$
n\geq \frac{Nz_{(q+1)/2}^2}{4M_{max}^2(N-1)+z_{(q+1)/2}^2}
$$

```{example}
En una mostra aleatòria de 727 estudiants (diferents) de la UIB ($N=12000$), 557 afirmàrem haver comès plagi en algun treball durant els seus estudis. Quin seria un interval de confiança del 95% per a la proporció $p_X$ d'estudiants de la UIB que han comès plagi en algun treball?


```

Una mostra de 727 estudiants diferents és molt gran respecte del total d'estudiants de la UIB, per la qual cosa convé emprar la fórmula de Laplace amb el factor de població finita
$$
\widehat{p}_{X}\pm z_{(q+1)/2}\sqrt{\frac{\widehat{p}_{X}
(1-\widehat{p}_{X})}{n}}\sqrt{\frac{\vphantom{(}N-n}{N-1}}
$$
on $\widehat{p}_{X}=557/727=`r round(557/727,3)`$, $z_{(q+1)/2}=1.96$, $n=727$ i $N=12000$: dóna
$$
0.766\pm \sqrt{\frac{0.766(1-0.766)}{727}}\sqrt{\frac{\vphantom{(}12000-727}{12000-1}}\Rightarrow [0.751,0.781]
$$
Estimam amb un nivell de confiança del 95% que entre un 75.1 i un 78.1 dels estudiants de la UIB han comès plagi en algun treball.




```{example}
De quina mida hem de prendre una mostra aleatòria sense reposició d'estudiants de la UIB per estimar una proporció amb nivell de confiança del 95% i un marge d'error màxim de 0.05?


```

Per la fórmula anterior (prenent $N=12000$ i $z_{(1+q)/2}=1.96$), per garantir un marge d'error màxim de 0.05 cal prendre una mostra de mida
$$
n\geq \frac{12000\cdot 1.96^2}{4\cdot 0.05^2(12000-1)+1.96^2}=`r round(12000*1.96^2/(4*0.05^2*(12000-1)+1.96^2),1)`
$$
Per tant, ens calen `r ceiling(12000*1.96^2/(4*0.05^2*(12000-1)+1.96^2))` estudiants.




<!--chapter:end:03-Intervals.Rmd-->

# Contrastos d'hipòtesis: Generalitats

##  Hipòtesis nul·la i alternativa

En moltes situacions, s'ha de prendre  a partir d'una mostra una **decisió** sobre si es pot acceptar o rebutjar una **hipòtesi** relativa  al valor d'un paràmetre d'una població o diverses poblacions. 
Per exemple:

* Volem saber si una moneda està trucada a favor de cara. Per decidir-ho, la llançam en l'aire una sèrie de vegades, i comptam quantes cares surten.

* Volem decidir si un tractament nou A és més efectiu que el tractament vell B en la curació d'una malaltia X. Per decidir-ho, portam a terme un assaig clínic, tractant amb A un grup de malalts i amb B un altre grup de malalts, i comparam la taxa de curació dels tractaments sobre aquests dos grups.

El mètode estadístic que s'empra per acceptar o rebutjar  una hipòtesi rep el nom de **contrast d'hipòtesis**.

En un contrast d'hipòtesis, es comparen sempre dues hipòtesis  alternatives: la **hipòtesi nul·la** $H_{0}$ i la **hipòtesi
alternativa** $H_{1}$. Se sol plantejar formalment
$$
\left\{\begin{array}{ll}
H_{0}:\text{hipòtesi nul·la}\\ 
H_{1}:\text{hipòtesi alternativa}
\end{array}
\right.
$$

En un contrast d'hipòtesis:

* Típicament, la **hipòtesi nul·la**  $H_{0}$ és "no hi ha diferència", "no passa res", "no hi ha res d'estrany" o l'equivalent en el context del contrast:

    *  La moneda és honrada (50% de probabilitat de cara)

    *  Els tractaments A i B són igual d'efectius en la curació de la malaltia X

* La **hipòtesi alternativa** $H_{1}$ planteja la diferència de la qual cercam evidència:

    * La moneda està trucada a favor de cara (més del 50% de probabilitat de cara)

    *  A és més efectiu que B en la curació de la malaltia X

*  Per defecte, estam disposats a acceptar $H_0$: que no hi ha diferència, no passa res. 

    * Per defecte, estam disposats a acceptar que la moneda és honrada (la majoria ho són, no?)

    *  Per defecte, estam disposats a acceptar que els dos tractaments són igual d'efectius

* Si obtenim evidència suficient que $H_1$ és la hipòtesi vertadera, rebutjarem $H_0$ en favor de $H_1$ i conclourem que $H_1$ és vertadera. 

    Què vol dir "obtenir evidència suficient que $H_1$ és vertadera"? Doncs que les proves obtingudes fan que $H_0$ sigui  **inversemblant** (mala de creure) per comparació amb $H_1$:

   *  Tendrem evidència que la moneda està trucada a favor de cara si a la nostra sèrie de llençaments la proporció de cares és tan i tan gran que fa molt difícil creure que la probabilitat de cara sigui del 50%

    * Tendrem evidència que el tractament A és més efectiu que B en la curació de la malaltia X si en el nostre assaig la taxa de curació de la malaltia X amb el tractament A és tan i tan més gran que la de B que fa molt difícil creure que els dos tractaments siguin iguals d'efectius

*  Si no obtenim evidència suficient de $H_1$, és a dir, si les nostres dades són compatibles amb $H_0$, no podrem rebutjar-la: acceptarem la hipòtesi nul·la.

     *  Acceptarem que la moneda no està trucada a favor de cara si a la nostra sèrie de llençaments la proporció de cares no és prou gran com per fer molt difícil creure que no hi estigui

     * Acceptarem que el tractament A és igual d'efectiu que B en la curació de la malaltia X si en el nostre assaig la taxa de curació de la malaltia X amb el tractament A no és prou més gran que la de B com per fer molt difícil creure que els dos tractaments siguin iguals d'efectius
     
     


```{block2,type="rmdcaution"}
* Si rebutjam $H_0$ en favor de $H_1$ *no* serà perquè hàgim provat que $H_0$ sigui impossible, ni tan sols que sigui improbable: tan sols haurem observat que és *mala de creure vists els resultats del nostre experiment*
  
* Si acceptam la hipòtesi nul·la és perquè no trobam motius per dubtar d'ella, però no haurem trobat evidència que sigui vertadera ni haurem demostrat que sigui probable (i possible en principi ho és sempre).

```



```{example,judici}
En un judici (on l'acusat és innocent si no es demostra el contrari), se cerca evidència que l'acusat és culpable, per tant aquesta és la hipòtesi alternativa:

```
* El contrast és
$$
\left\{\begin{array}{ll} 
H_{0}:\text{L'acusat és innocent}\\ 
H_{1}:\text{L'acusat és culpable}
\end{array}
\right.
$$
* S'obtenen proves

* Si el jurat troba prou incriminatòries les proves, "més enllà de tot dubte raonable", declara **culpable**  l'acusat (rebutja $H_0$ en favor de $H_1$)

* Si el jurat no les troba prou incriminatòries, el considera **no culpable** (no rebutja $H_{0}$)

Observau que considerar no culpable no és el mateix que demostrar que és innocent: simplement, es considera que l'acusat no és culpable si no s'ha trobat prou evidència que sigui culpable.


```{example,examen}
Un examen és un contrast d'hipòtesis. En aquest cas, "no passa res" significa que l'estudiant és com si no hagués anat al curs, no ha après res, i per tant aquesta és la hipòtesi nul·la; amb l'examen cercam evidència que l'estudiant ha après la matèria, per tant aquesta serà la hipòtesi alternativa:

```

* Contrast:
$$
\left\{\begin{array}{ll} 
H_{0}:\text{L'estudiant no sap la matèria}\\ 
H_{1}:\text{L'estudiant sap la matèria}
\end{array}
\right.
$$

* Prenem una mostra del coneixement de l'estudiant (l'estudiant fa l'examen)

* Si hi ha prou evidència en favor de $H_1$ (si l'examen li surt prou bé), rebutjam $H_0$: decidim que l'estudiant sap la matèria, aprova l'assignatura

* Si no hi ha prou evidència en favor de $H_1$ (si l'examen no li surt prou bé), ens quedam amb $H_0$: concloem que l'estudiant no ha après  la matèria, suspèn l'assignatura

```{r, echo=FALSE, fig.width=4,out.width="75%"}
knitr::include_graphics("Bioestadistica-II_files/figure-html/hipnul.png")
```

```{example,esport1}
Ens trobam amb la notícia següent al diari, i ens demanam si les dones practiquen realment menys esport  que els homes.


```
 

```{r, echo=FALSE, fig.width=4,out.width="75%"}
knitr::include_graphics("Bioestadistica-II_files/figure-html/mujeresdeporte.png")
```

Aquesta pregunta la podem plantejar de moltes maneres:

*  Totes les dones fan cada dia menys hores d'esport que tots els homes?

*  Si prenc una dona i un home a l'atzar, hi ha més d'un 50% de probabilitat que ella practiqui menys esport que ell?

*  La majoria de les dones fan cada dia menys hores d'esport que la majoria dels homes?

*  La proporció de practicants d'esport entre les dones és més petita que entre els homes?

*  La mitjana setmanal de vegades que les dones practiquen esport  és més petita que la  dels homes?

*  La mitjana setmanal d'hores que les dones practiquen esport  és més petita que la  dels homes?

*  ...

Cada una d'aquestes preguntes es traduiria en un contrast d'hipòtesis diferent i possiblement mostres de tipus de dades diferents per realitzar-los.

Com que aquí estam tractant contrastos sobre paràmetres poblacionals (mitjanes, proporcions, etc.), podríem plantejar algun dels tres darrers. Anem a centrar-nos en la darrera qüestió, sobre mitjanes setmanals d'hores d'esport. 

Aquí, les variables poblacionals d'interés són:

*  $X_d$: prenc una dona i calcul el seu nombre mitjà d'hores setmanals d'esport, de mitjana $\mu_d$: la mitjana d'hores setmanals d'esport de les dones
*  $X_h$: prenc una dona i calcul el seu nombre mitjà d'hores setmanals d'esport, de mitjana $\mu_h$: la mitjana d'hores setmanals d'esport dels homes


El contrast que volem realitzar és 

* *Hipòtesi nul·la*: no hi ha diferència entre les mitjanes d'hores setmanals d'esport d'homes i dones 

* *Hipòtesi alternativa*: la mitjana d'hores setmanals d'esport de les dones és més petita que la dels homes

És a dir
$$
\left\{\begin{array}{ll} 
H_{0}: \mu_d=\mu_h\\ 
H_{1}:\mu_d<\mu_h
\end{array}
\right.
$$

El procediment per realitzar-lo serà:

* Prenem mostres aleatòries de dones i d'homes i els demanam pels seus hàbits de pràctica d'esport

* Calculam la mitjana mostral $\overline{X}_d$  d'hores setmanals d'esport en les dones de la mostra

* Calculam la mitjana mostral $\overline{X}_h$  d'hores setmanals d'esport  en els homes de la mostra

* Si $\overline{X}_d$ és molt més petita que $\overline{X}_h$, ho prendrem com a evidència que  $\mu_d<\mu_h$

* En cas contrari, no podrem rebutjar que $\mu_d=\mu_h$

Què significa "suficientment més petit"? Una opció, que podríem importar del tema anterior, seria calcular un interval de confiança del 95% per a $\mu_d-\mu_h$ a partir de la mostra

*  Si està totalment a l'esquerra del 0, amb un 95% de confiança podem concloure que $\mu_d<\mu_h$

*  En cas contrari (si conté el 0 o si està totalment a la dreta del 0), amb un 95% de confiança no podem concloure que $\mu_d<\mu_h$

Com que aquí voldrem filar més prim que això del "nivell de confiança", el procediment serà una mica més complicat.


```{block2,type="rmdcaution"}
Les hipòtesis dels contrastos són sobre les poblacions, sobre les mostres.
```

Aquí les hipòtesis del contrast comparaven les mitjanes **poblacionals** d'hores setmanals d'esport de les dones i els homes, no les mitjanes mostrals d'hores setmanals d'esport de les dones i els homes de la nostra mostra.

```{block2,type="rmdcaution"}
La falta d'evidència a favor de $H_1$ no és evidència a favor de $H_0$
```

Si no podem assegurar que les dones practiquin menys esport que els homes (perquè no hàgim trobat evidència a favor d'aquesta hipòtesi), això no significarà que hàgim trobat evidència que els homes i les dones practiquin la mateixa quantitat d'esport o que les dones en practiquin més.

Simplement, significarà que *l'evidència a favor de $H_1$ no ha estat prou forta com per poder afirmar que és vertadera* i per tant acceptam que tothom practica la mateixa quantitat d'esport.

```{block2,type="rmdcaution"}
En general, mai no podrem trobar evidència de la hipòtesi nul·la.
```

Si per exemple al nostre estudi haguéssim trobat que $\overline{X}_d=\overline{X}_h$, això seria compatible amb la hipòtesi nul·la $\mu_d=\mu_h$, i per això no la podríem rebutjar, però no aporta evidència que $\mu_d=\mu_h$, ja que segurament també seria compatible, per exemple, amb $\mu_d=\mu_h+0.0007$ (les dones fan, de mitjana, un minut més d'esport a la setmana que els homes).


```{block2,type="rmdcaution"}
No val canviar de contrast a la vista de les dades
```

La pregunta la plantejam abans d'obtenir la mostra. Si estam interessats en el contrast
$$
\left\{\begin{array}{ll} 
H_{0}: \mu_d=\mu_h\\ 
H_{1}:\mu_d<\mu_h
\end{array}
\right.
$$
i obtenim $\overline{X}_d$ molt més gran que $\overline{X}_h$ en la nostra mostra, concloem que no tenim evidència que $\mu_d<\mu_h$ i punt. És fer *trampes* dir "No hem trobat evidència que les dones practiquin menys esport que els homes, però si amb aquestes mateixes dades realitzam el contrast
$$
\left\{\begin{array}{ll} 
H_{0}: \mu_d=\mu_h\\ 
H_{1}:\mu_d>\mu_h
\end{array}
\right.
$$
sí que obtenim evidència que elles practiquen més esport  que ells. 

D'això s'en diu "anar a pescar": obteniu unes dades i mirau de què donen evidència. És mala pràctica científica. Qualsevol conjunt de dades dóna evidència de qualque cosa.

```{block2,type="rmdcaution"}
Triau la hipòtesi alternativa en funció del que cercau evidència
```

No confongueu
$$
\left\{\begin{array}{ll} 
H_{0}: \mu_d=\mu_h\\ 
H_{1}:\mu_d<\mu_h
\end{array}
\right.
$$
amb
$$
\left\{\begin{array}{ll} 
H_{0}: \mu_d=\mu_h\\ 
H_{1}:\mu_d\neq \mu_h
\end{array}
\right.
$$
que tradueix la pregunta "Els homes i les dones,  de mitjana, practiquen esport un nombre diferent d'hores a la setmana?''


La pregunta (el contrast) us la plantejau *a priori* a partir d'hipòtesis o suposicions prèvies 

```{block2,type="rmdimportant"}
**Regles per triar $H_0$ i $H_1$ en aquest curs**:

*  $H_0$ sempre ha de significar "no hi ha diferència" i s'ha de definir formalment mitjançant una igualtat

*  $H_1$ és la hipòtesi de la que cercam evidència, i s'ha de definir formalment mitjançant alguna cosa "estricta":

    *  **Hipòtesi unilateral** (*one-sided*; també **d'una cua**, *one-tailed*): definida amb **<** o amb **>**

    *  **Hipòtesi bilateral** (*two-sided*; també **de dues cues**, *two-tailed*): definida amb $\neq$
```

Els contrastos prenen el nom del tipus d'hipòtesi alternativa: **contrast unilateral**, **de dues cues**, etc.




## Un exemple {#sec:moneda}

Tenc una moneda, i crec que està trucada a favor de cara. Vull contrastar-ho.  

Aquí la variable aleatòria $X$ que ens interessa és "Llenç la moneda en l'aire i mir si surt cara", que és Bernoulli amb probabilitat d'èxit (és a dir, probabilitat de treure cara amb la meva moneda)  $p_{\mathit{Cara}}$.


La hipòtesi nul·la serà que la moneda no està trucada (no hi ha res estrany en la meva moneda), i l'alternativa (de la que cerc evidència) que la moneda està trucada a favor de cara. 
en termes de  $p_{\mathit{Cara}}$, el contrast és
$$
\left\{\begin{array}{ll} 
H_{0}:p_{\mathit{Cara}}= 0.5\\ 
H_{1}:p_{\mathit{Cara}}> 0.5
\end{array}
\right.
$$

**1)** Suposem que llanç la moneda en l'aire 3 vegades i obtenc 3 cares. És evidència suficient que està trucada?

Diguem $S_3$ a la variable aleatòria "Nombre de cares en 3 llançaments d'aquesta moneda."

Si la moneda no està trucada, $S_3\sim B(3,0.5)$ i per tant
$$
P(S_3=3)=0.5^{3}=0.125
$$

El resultat obtingut no és molt improbable amb una moneda honrada (ho esperaríem 1 de cada 8 vegades): no és evidència suficient que estigui trucada.

```{block2,type="rmdnote"}
D'aquest tipus de procediment, emprant la distribució binomial del nombre d'èxits en una mostra aleatòria simple per contrastar un valor de la probabilitat poblacional d'èxit, en direm un **test binomial**.
```


**2)** Suposem que ara llanç  la moneda en l'aire 10 vegades i obtenc 10 cares. És evidència suficient que està trucada?

Diguem ara $S_{10}$ a la variable aleatòria "Nombre de cares en 10 llançaments."

Si la moneda no està trucada, $S_{10}\sim B(10,0.5)$ i per tant
$$
P(S_{10}=10)=0.5^{10}=0.001
$$

El resultat obtingut és molt improbable si la moneda no està trucada: si la moneda no estigués trucada, només en 1 de cada 1000 seqüències de 10 llançaments obtendríem 10 cares. És a dir:

> El resultat del nostre experiment seria molt estrany si la moneda no estigués trucada, per tant és *inversemblant* que no estigui trucada.

Ho consideram evidència que sí està trucada.


Fixau-vos en el procediment:

1.  Hem plantejat el contrast:
$$
\left\{\begin{array}{ll} 
H_{0}:p_{\mathit{Cara}}= 0.5\\ 
H_{1}:p_{\mathit{Cara}}> 0.5
\end{array}
\right.
$$

2.  Hem recollit una mostra aleatòria: la seqüència de llançaments

3.  Hem triat un **estadístic de contrast** amb distribució coneguda quan $H_0$ és vertadera: al nostre cas, el nombre de cares

4.  Hem calculat el valor d'aquest estadístic sobre la nostra mostra

5.  Hem calculat la probabilitat que l'estadístic prengui el valor observat si $H_0$ és vertadera

6.  Si aquesta probabilitat és molt petita, ho consideram evidència que $H_1$ és vertadera

7.  Si no és prou petita, no tenim evidència que $H_0$ sigui falsa

Bé, això és el que hem fet, però no és del tot correcte. Als punts (5) i (6) diem que:  "Calculam la probabilitat que l'estadístic prengui el valor observat si $H_0$ és vertadera i  si   és molt petita, ho consideram evidència que $H_1$ és vertadera." *Segur??*

* Suposem que, al contrast anterior, llançam la moneda en l'aire 10 vegades i ara obtenim *10 creus*. És evidència suficient que està trucada a favor de cara? Òbviament no ho pot ser, però la probabilitat és la mateixa que abans:
$$
P(S_{10}=0)=0.5^{10}=0.001
$$


* En molts casos, *la probabilitat d'obtenir exactament el que hem obtingut pot ser molt petita, independentment del que hàgim obtingut*. Per exemple, suposem que llançam la moneda en l'aire 10000 vegades i obtenim 5000 cares. Si la moneda és honrada, el nombre de cares seguirà una distribució binomial $B(10000,0.5)$ i la probabilitat d'obtenir 5000 cares serà `dbinom(5000,10000,0.5)`=`r round(dbinom(5000,10000,0.5),4)`, ben petita, però clarament si la meitat de llançaments donen cara, no podem tenir mai evidència que la moneda estigui trucada.  

    O, encara més exagerat, si l'estadístic de contrast té distribució contínua,  recordau que la probabilitat que una variable aleatòria contínua prengui un valor concret és 0. Més petit impossible, però no sempre rebutjarem la hipòtesi nu·la.

```{block2,type="rmdimportant"}
En realitat, a (5) es calcula la probabilitat que, si $H_0$ és vertadera, l'estadístic prengui un valor tan extrem o més (en el sentit de $H_1$) que l'obtingut. Li diem el **p-valor**. 

Recordau aquest nom.
```

Al nostre exemple de la moneda, com que la hipòtesi nul·la és $p_{\mathit{Cara}}= 0.5$ i la hipòtesi alternativa és $p_{\mathit{Cara}}> 0.5$, el p-valor és la probabilitat que, si $p_{\mathit{Cara}}= 0.5$, el nombre de cares sigui tan o més gran que l'obtingut a la nostra mostra. En els dos exemples anteriors concrets, 3 cares en 3 llançaments i 10 cares en 10 llançaments, és el mateix, perquè eren nombre màxim possible de cares i per tant, per exemple, treure 3 o més cares en 3 llançaments és exactament el mateix que treure 3 cares en 3 llançaments. Però en general no serà el cas.


**3)** Tornem al nostre contrast
$$
\left\{\begin{array}{ll} 
H_{0}:p_{\mathit{Cara}}= 0.5\\ 
H_{1}:p_{\mathit{Cara}}> 0.5
\end{array}
\right.
$$
Suposem que llanç la moneda en l'aire 10 vegades i obtenc 7 cares. És evidència suficient que està trucada?

Seguim dient $S_{10}$ a la variable aleatòria "Nombre de cares en 10 llançaments". Si la moneda no està trucada, $S_{10}\sim B(10,0.5)$ i per tant
$$
\text{p-valor}=P(S_{10}\geq 7)=\texttt{1-pbinom(6,10,0.5)}=0.172
$$
Un resultat tan extrem o més que l'obtingut no és molt improbable si la moneda no està trucada:  passaria 1 de cada 6 vegades. Per tant, com que és bastant compatible amb el fet que la moneda sigui honrada, no ho podem considerar evidència que estigui trucada a favor de cara.

```{example}
Tenc una moneda, i ara crec que està trucada a favor de creu. Vull contrastar-ho. Plantejat en termes de $p_{\mathit{Cara}}$,  el contrast que vull realitzar és
$$
\left\{\begin{array}{ll} 
H_{0}:p_{\mathit{Cara}}= 0.5\\ 
H_{1}: p_{\mathit{Cara}}< 0.5
\end{array}
\right.
$$
Suposem que llanç la moneda en l'aire 10 vegades i obtenc 1 cara. És evidència suficient que $p_{\mathit{Cara}}< 0.5$?


```

Seguim dient $S_{10}$ a la variable aleatòria "Nombre de cares en 10 llançaments d'aquesta moneda." Si la moneda no està trucada, $S_{10}\sim B(10,0.5)$.

Ara, com que $H_{1}$ és $p_{\mathit{Cara}}< 0.5$, el p-valor, que és la probabilitat d'obtenir, si la moneda no està trucada, un nombre de cares tan extrem o més en el sentit de la hipòtesi alternativa que el que hem obtingut, serà la probabilitat de treure una cara o menys: com que $H_{1}$ és $p_{\mathit{Cara}}< 0.5$, "tan extrem o més en el sentit de la hipòtesi alternativa" significa "més petit o igual". Per tant, el p-valor és
$$
P(S_{10}\leq 1)=\texttt{pbinom(1,10,0.5)}=0.01
$$
Un resultat tan extrem o més que l'obtingut és molt improbable si $p_{\mathit{Cara}}= 0.5$, passaria en 1 de cada 100 seqüències de 10 llançaments: ho podem considerar evidència que la moneda està trucada a favor de creu


## El p-valor {#sec:pval}

El **p-valor** d'un contrast és la probabilitat que, si la hipòtesi nul·la és vertadera,  l'estadístic de contrast prengui  en una mostra aleatòria simple un valor tan o més extrem, en el sentit de la hipòtesi alternativa, que l'obtingut amb la mostra emprada per realitzar el contrast. 

Ho tornarem a repetir, posant èmfasi en els components fonamentals de la definició. El **p-valor** és:

* La probabilitat que,
* si la hipòtesi nul·la és vertadera, 
* l'estadístic de contrast prengui en una mostra aleatòria simple
* un valor tan o més extrem, en el sentit de la hipòtesi alternativa, 
* que l'obtingut amb la nostra mostra.

```{example}
Per exemple, suposem que al contrast de les mitjanes d'hores setmanals d'esport d'homes i dones de l'Exemple \@ref(exm:esport1) empram com a estadístic de contrast la diferència entre les mitjanes mostrals $\overline{X}_d-\overline{X}_h$ (**que no serà el cas: només és un exemple!**). Aleshores, el p-valor del contrast és


```

* La probabilitat que,

* si la hipòtesi nul·la és vertadera, 

    *si els homes i les dones practiquen de mitjana el mateix nombre d'hores d'esport a la setmana,*

* l'estadístic de contrast prengui  en una mostra aleatòria simple

    *el valor de la mitjana d'hores setmanals d'esport en les dones menys la mitjana d'hores setmanals d'esport en els homes d'una mostra aleatòria*

*  un valor tan o més extrem, en el sentit de la hipòtesi alternativa, 

    *sigui més petit o igual* (perquè la hipòtesi alternativa és $\mu_d<\mu_h$, és a dir $\mu_d-\mu_h<0$)
    
* que l'obtingut amb la nostra mostra.

    *que el de la nostra mostra*
    
En resum, el p-valor seria en aquest cas

> La probabilitat, suposant que els homes i les dones practiquen de mitjana el mateix nombre d'hores d'esport a la setmana, que, si prenem una mostra aleatòria d'homes i dones i calculam la diferència de la mitjana d'hores setmanals d'esport en les dones menys la mitjana d'hores setmanals d'esport en els homes d'aquesta mostra, el seu valor sigui més petit o igual que el de la nostra mostra.

Si aquesta probabilitat és molt petita, la mostra obtinguda és poc consistent amb la hipòtesi nul·la i per tant conclourem que la hipòtesi alternativa és vertadera. Si, en canvi, aquesta probabilitat no és molt petita, la mostra obtinguda és compatible amb la hipòtesi nul·la i per tant no podrem rebutjar que sigui vertadera.


El p-valor no és:

* La probabilitat que $H_0$ sigui vertadera condicionada al nostre resultat

* La probabilitat que $H_1$ sigui falsa condicionada al nostre resultat

És a l'inrevés: El p-valor és la probabilitat del nostre resultat (o quelcom més extrem) condicionada al fet que $H_0$ sigui vertadera. Per tant, el p-valor és una **evidencia indirecta inversa** de $H_1$: 

> Com  més petit sigui el p-valor, més rar seria el que hem obtingut si $H_0$ fos vertadera i $H_1$ falsa, i per tant més evidència tenim que $H_0$ no pot ser vertadera i que la vertadera és $H_1$.

Per exemple, que el p-valor d'un contrast doni 0.03 

*  **Significa** que, si $H_0$ és vertadera, la probabilitat que l'estadístic de contrast prengui sobre una mostra un valor tan extrem o més que el que ha pres és 0.03 

    * *El trobau petit?* Ho preneu com a evidència que $H_0$ és falsa en favor de $H_1$
    
    * *No el trobau petit?* No teniu evidència per rebutjar que $H_0$ és vertadera

*  **No significa** que:

    *  La probabilitat que $H_0$ sigui vertadera és 0.03

    * $H_0$ és vertadera un 3% de les vegades


```{block2,type="rmdimportant"}
En un contrast d'hipòtesis no obtenim cap informació directa sobre la probabilitat de $H_0$ o de $H_1$.
```


```{example}
Tenc una moneda i crec que està trucada; a favor de cara o a favor de creu, no ho sé, només sospit que està trucada. Vull contrastar-ho. 

```

Plantejat en termes de la probabilitat de treure cara $p_{\mathit{Cara}}$,  el contrast que vull realitzar ara és
$$
\left\{\begin{array}{ll} 
H_{0}:p_{\mathit{Cara}}= 0.5\\ 
H_{1}:p_{\mathit{Cara}}\neq 0.5
\end{array}
\right.
$$
Suposem que la llanç en l'aire 10 vegades i obtenc 8 cares. És evidència suficient que està trucada?


Com a la secció anterior, diguem $S_{10}$ a la variable "Nombre de cares en 10 llançaments". Si $p_{\mathit{Cara}}= 0.5$, 
$S_{10}\sim B(10,0.5)$.

En aquest exemple, "obtenir un resultat tan o més extrem, en el sentit de la hipòtesi alternativa, que l'obtingut" és treure un resultat *tant o més diferent de 5 cares i 5 creus que l'obtingut*: és a dir, treure almenys 8 cares o almenys 8 creus, o el que és el mateix, treure o bé 8 o més cares, o bé 2 o menys cares. Per tant, el p-valor és
$$
\begin{array}{l}
P(S_{10}\geq 8\text{ o }S_{10}\leq 2) =P(S_{10}\geq 8) + P(S_{10}\leq 2)\\
\qquad =1-P(S_{10}\leq 7) + P(S_{10}\leq 2)\\
\qquad =\texttt{1-pbinom(7,10,0.5)+pbinom(2,10,0.5)}\\
\qquad =`r round(1-pbinom(7,10,0.5)+pbinom(2,10,0.5),2)`
\end{array}
$$


En realitat, i per motius històrics, en un contrast bilateral com aquest no es pren com a p-valor
$$
P(S_{10}\geq 8\text{ o }S_{10}\leq 2)
$$ 
sinó 
$$
2\times\min\{P(S_{10}\geq 8),P(S_{10}\leq 8)\}.
$$
Al nostre cas coincideix amb el que hem calculat perquè la variable $S_{10}\sim B(10,0.5)$ és simètrica, però si no ho fos no té perquè coincidir. Comprovem que, en efecte, en aquest exemple coincideixen:

* $P(S_{10}\geq 8)=$`1-pbinom(7,10,0.5)`$=`r round(1-pbinom(7,10,0.5),3)`$

* $P(S_{10}\leq 8)=$`pbinom(8,10,0.5)`$=`r round(pbinom(8,10,0.5),3)`$

* $\min\{`r round(1-pbinom(7,10,0.5),3)`,`r round(pbinom(8,10,0.5),3)`\}=`r round(1-pbinom(7,10,0.5),3)`$

* p-valor$=2\times 0.055=0.11$.  

En resum, si la moneda no està trucada, el resultat obtingut és improbable, però no gaire (1 de cada 9 vegades passaria).
És evidència suficient que estigui trucada?

```{block2,type="rmdimportant"}
Per conveni, als contrastos bilaterals, per calcular el p-valor:
  
* es calcula la probabilitat que l'estadístic de contrast prengui un valor més gran o igual que el de la mostra

* es calcula la probabilitat que l'estadístic de contrast prengui un valor més petit o igual que el de la mostra

* es pren el mínim d'aquests dos valors

* i es multiplica per 2
```


## Tipus d'errors

Al darrer exemple ens ha sorgit la qüestió de quin p-valor marca el llindar entre obtenir evidència o no. És 0.11 prou petit? La resposta és que depèn de quant estiguem disposats a equivocar-nos.

La comparació entre la realitat i la decisió resultant d'un contrast dóna lloc a quatre situacions possibles, resumides en la taula següent:


```{r, echo=FALSE,fig.width=1,out.width="60%"}
knitr::include_graphics("Bioestadistica-II_files/figure-html/errors.png")
```


* *$H_0$ és la vertadera a la realitat i nosaltres decidim que $H_1$ és vertadera*. 

    * La conclusió del contrast és errònia. En diem **error de tipus I** o **positiu fals**. 
    
    * Indicarem amb $\alpha$ la probabilitat de cometre un error de tipus I i en direm el **nivell de significació**. 

* *$H_1$ és vertadera a la realitat i nosaltres acceptam $H_0$*. 

    * La conclusió del contrast és errònia. En diem **error de tipus II** o **negatiu fals**. 
    
    * Indicarem amb $\beta$ la probabilitat de cometre un error de tipus II. 


* *$H_1$ és vertadera a la realitat i nosaltres decidim que $H_1$ és vertadera*. 

    * La conclusió del contrast és correcta.  En diem un **positiu vertader**. 
    
    * La probabilitat d'encertar amb un positiu vertader és $1-\beta$ i en direm la **potència**. 

* *$H_0$ és la vertadera a la realitat i nosaltres l'acceptam*. 

    * La conclusió del contrast és correcta. En diem un **negatiu vertader**. 
    
    * La probabilitat d'encertar amb un negatiu vertader és $1-\alpha$ i en direm el **nivell de confiança**.

```{block2,type="rmdnote"}
Observau que, en el context d'un contrast d'hipòtesi, 

* un resultat **positiu** és rebutjar la hipòtesi nul·la i decidir que l'alternativa és la vertadera (hem trobat qualque cosa)

* un resultat **negatiu** és acceptar la hipòtesi nul·la (no hem trobat res i ens hem de conformar amb la hipòtesi nul·la)

```


És a dir:

* el **nivell de significació** d'un contrast és la probabilitat que, si la hipótesi nul·la és vertadera, nosaltres ens equivoquem i la rebutjem en favor de l'alternativa.

* la **potència** d'un contrast és la probabilitat que, si la hipótesi alternativa és vertadera, nosaltres ho detectem i rebutjem la hipòtesi nul·la en favor de l'alternativa.

```{example}
En un test d'embaraç, el contrast que es realitza és:
$$
\left\{\begin{array}{ll} 
H_{0}:\text{No estàs embaraçada}\\ 
H_{1}:\text{Estàs embaraçada}
\end{array}
\right.
$$

```

```{r, echo=FALSE,fig.width=1,out.width="60%"}
knitr::include_graphics("Bioestadistica-II_files/figure-html/types.png")
```


```{example}
En un judici, on s'ha de declarar un acusat innocent o culpable, el contrast era
$$
\left\{\begin{array}{ll} 
H_{0}:\text{L'acusat és innocent}\\ 
H_{1}:\text{L'acusat és culpable}
\end{array}
\right.
$$

````

Es poden cometre dos errors:

* *Error de tipus I*: Declarar culpable un innocent

* *Error de tipus II*: Declarar no culpable un culpable

És pitjor l'error de tipus I, convé minimitzar-lo. Per això només es declara qualcú culpable quan les proves ho demostren més enllà de qualsevol dubte raonable

```{example}
En un examen,  el contrast era
$$
\left\{\begin{array}{ll} 
H_{0}:\text{L'estudiant no sap la matèria}\\ 
H_{1}:\text{L'estudiant sap la matèria}
\end{array}
\right.
$$
  
```

Es poden donar dos errors:

*  Que l'estudiant aprovi sense saber la matèria 

*  Que l'estudiant suspengui sabent la matèria

Quin és el de tipus I i quin el de tipus II? Quin creieu que és pitjor?


L'objectiu primari en un contrast és trobar una regla de rebuig de $H_{0}$ que tengui poca
probabilitat $\alpha$ d'error de tipus I. Però també voldríem minimitzar la probabilitat $\beta$ d'error de tipus II.
El problema és quan fem disminuir $\alpha$, sol augmentar $\beta$.

```{r, echo=FALSE,fig.width=5,fig.asp=2}
knitr::include_graphics("Bioestadistica-II_files/figure-html/columpio.png")
```

Què se sol fer? 

1.  Donar una regla de decisió per a un $\alpha$ màxim fixat

2. Després,  augmentar la mida $n$ de la mostra per arribar a la $\beta$ desitjada


Abans d'acabar amb els errors, fixau-vos que si efectuam $m$ contrastos (independents) emprant una regla de decisió que garanteixi un nivell de significació $\alpha$ fixat, i a tots aquests contrastos la $H_0$ és vertadera, el nombre de contrastos d'aquests on ens equivocarem i rebutjarem $H_0$ té distribució $B(m,\alpha)$. En particular, assumim que esperam cometre un error de tipus I en 1 de cada $1/\alpha$ contrastos on l'hipòtesi nul·la sigui vertadera.

```{block2,type="rmdcaution"}
Si efectuam molts de contrastos, augmenta la probabilitat de "trobar qualque cosa" encara que no hi hagi res que trobar.
```


```{r, echo=FALSE,fig.cap="\"Significant\" (https://xkcd.com/882/ (CC-BY-NC 2.5))"}
library(linguisticsdown)
include_graphics2("http://imgs.xkcd.com/comics/significant.png")
```


## Exemple: El test t {#sec:exttest}

Ens demanam si els homes joves amb diabetis tenen una concentració de calci en plasma superior a la dels homes joves sans. Ho traduirem en un contrast d'hipòtesis sobre la concentració mitjana de calci en plasma en els homes joves amb diabetis, diguem-li $\mu$: 

* La hipòtesi nul·la serà que no hi ha diferència entre $\mu$ i la concentració mitjana de calci en plasma en els homes joves sans, és a dir, que són iguals

* La hipòtesi alternativa és d'allò que cercam evidència: que $\mu$ és més gran que la concentració mitjana de calci en plasma en els homes joves sans.

Se sap que la concentració de calci en plasma en homes sans segueix una llei aproximadament normal. El seu valor mitjà en homes sans de 22 a 44 anys s'estima en 2.5 mmol/l. 

Per tant, el contrast que volem realitzar és 
$$
\left\{\begin{array}{l}
H_{0}:\mu=2.5\\ 
H_{1}:\mu >2.5
\end{array}
\right.
$$

En una mostra de 20 diabètics d'aquesta franja d'edat, es va obtenir una concentració mitjana de calci $\overline{x}=3.2$ mmol/l amb una desviació típica mostral $\widetilde{s}=1.5$. Suposem que aquesta mostra de diabètics joves és representativa i raonablement aleatòria. Volem decidir el contrast a partir d'aquesta mostra.

Diguem $X$ a la variable aleatòria "Prenem un home diabètic de 22 a 44 anys i li mesuram la concentració de calci en plasma", de mitjana $\mu$. Com que la concentració de calci en plasma en homes sans segueix una llei normal, suposarem que en els diabètics també. 

La nostra situació, doncs, és un cas particular del cas general següent. Tenim una variable aleatòria poblacional $X\sim N(\mu,\sigma)$ i plantejam el contrast
$$
\left\{\begin{array}{l}
H_{0}:\mu=\mu_0\\ 
H_{1}:\mu >\mu_0
\end{array}
\right.
$$
per a un valor concret $\mu_0$. Volem prendre una decisió a partir d'una mostra aleatòria simple.

En aquesta situació, si $H_0$ és vertadera, és a dir, si la mitjana de $X$ és $\mu_0$, sabem que
$$
T=\frac{\overline{X}-\mu_0}{{\widetilde{S}_X}/{\sqrt{n}}}\sim t_{n-1}
$$

La idea que guiarà el procediment per prendre una decisió en aquest contrast serà:

> Rebutjarem $H_0$ en favor de $H_1$ si aquest *estadístic de contrast* $T$ pren un valor "suficientment gran" sobre la mostra, és a dir, si $\overline{X}$ és "molts errors típics" més gran que $\mu_0$.

Per concretar "suficientment gran" cal fixar $\alpha$. 

```{block2,type="rmdimportant"}
Usualment es pren $\alpha=0.05$ (una mica menys que la probabilitat de treure 4 cares seguides amb una moneda no trucada).
```

Aquí ara prendrem aquest mateix nivell de significació $\alpha=0.05$. És a dir, acceptarem que la probabilitat d'equivocar-nos rebutjant $H_0$ en favor de $H_1$ és 0.05, o el que és el mateix, assumirem que ens podem permetre el cometre un error de tipus I una vegada de cada 20  que la hipòtesi nul·la sigui vertadera.

Sigui $T_0$ el valor que pren l'estadístic de contrast $T$ en la nostra mostra.  Rebutjarem $H_{0}$ si $T_0$ és més gran que un cert llindar $L_0$, que determinam a partir de $\alpha$:

$$
\begin{array}{l}
\alpha = P(\text{Rebutjar } H_{0}| H_{0} \text{ certa})=P(T> L_0)\\
\qquad\quad \Longrightarrow 1-\alpha= P(T\leq L_0)\Longrightarrow 
L_0= t_{n-1,1-\alpha}
\end{array}
$$
Per tant, a fi que el nivell de significació del contrast sigui $\alpha$, 

> Rebutjarem $H_0$ si $T_0>t_{n-1,1-\alpha}$

En direm una **regla de rebuig** per aquest tipus de constrast.

Tornant al nostre exemple dels diabètics 
$$
\left\{\begin{array}{l}
H_{0}:\mu=2.5\\ 
H_{1}:\mu > 2.5
\end{array}
\right.
$$
Si $\alpha=0.05$ i $n=20$, el llindar a partir del qual rebutjam $H_0$ és $t_{n-1,1-\alpha}=t_{19,0.95}=\texttt{qt(0.95,19)}=1.73$.

A la nostra mostra hi tenim que $\overline{x}=3.2$, $\widetilde{s}=1.5$ i $n=20$, per tant  l'estadístic de contrast val
$$
T_0=\frac{3.2-2.5}{1.5/\sqrt{20}}=2.09
$$

 
Com que $2.09>1.73$, *concloem amb un nivell de significació de 0.05 que el nivell mitjà de calci en sang en els joves diabètics és més gran que en els joves sans.*


Anem a veure com entra en joc el p-valor. Recordem que rebutjarem $H_0$ quan $T_0>t_{n-1,1-\alpha}$:
$$
\begin{array}{l}
\text{Rebutjarem $H_0$} \Longleftrightarrow T_0> t_{n-1,1-\alpha}\\
\qquad \Longleftrightarrow P(T\geq T_0)< P(T\geq t_{n-1,1-\alpha})\\
\qquad \Longleftrightarrow P(T\geq T_0)< 1-P(T\leq t_{n-1,1-\alpha})=1-(1-\alpha)=\alpha\\
\qquad \Longleftrightarrow P(T\geq T_0)<\alpha
\end{array}
$$

I ara observau que $P(T\geq T_0)$ és la probabilitat que, si $H_0$ és vertadera, l'estadístic de contrast $T$ prengui un valor tan  extrem o més, en el sentit de $H_1: \mu>2.5$, que l'obtingut en la nostra mostra, $T_0$: és el *p-valor* del contrast. Per tant, tenim una altra regla de rebuig (equivalent a l'anterior):

> Rebutjarem $H_0$ quan el  p-valor sigui més petit que $\alpha$

En el nostre exemple, ja hem calculat $T_0=2.09$. Llavors,
$$
\text{p-valor}  =P(T\geq 2.09)=\texttt{1-pt(2.09,19)} =0.025
$$
Com que el p-valor és més petit que 0.05, *concloem amb un nivell de significació de 0.05 que el nivell mitjà de calci en sang en els joves diabètics és més gran que en els  sans*.

```{r, echo=FALSE,fig.width=1,out.width="35%"}
knitr::include_graphics("Bioestadistica-II_files/figure-html/pfm.png")
```

```{block2,type="rmdnote"}
D'aquest tipus de procediment, emprant la distribució t de Student de
$$
T=\frac{\overline{X}-\mu_0}{{\widetilde{S}_X}/{\sqrt{n}}}\sim t_{n-1}
$$
per comparar la $\mu$ d'una variable amb el valor $\mu_0$ en direm un **test t**.
```



Fixau-vos que la nostra conclusió ha estat que "concloem amb un *nivell de significació de 0.05* que el nivell mitjà de calci en sang en els joves diabètics és més gran que en els joves sans."

Per tant, *reconeixem una probabilitat d'equivocar-nos del 5%*: Si en realitat el nivell mitjà de calci en sang en els joves diabètics és el mateix que en els sans, la probabilitat que teníem d'equivocar-nos i concloure que el nivell mitjà de calci en sang en els joves diabètics és més gran que en els sans és del 5%.

Anem a estudiar aquesta taxa d'encerts per mitjà d'una simulació.

Primer suposarem que el nivell mitjà real és 2.5, i simularem la probabilitat d'error de tipus I. Com que estam fent el contrast amb nivell de significació 0.05, esperam que aquesta sigui la probabilitat d'error de tipus I. Per fixar idees, modelarem la població de joves diabètics per mitjà d'una mostra de 10^6^ nombres generats amb distribució $N(2.5,0.5)$. La $\sigma=0.5$ ens l'hem inventada. Aprofitam per fixar la llavor d'aleatorietat.


```{r}
set.seed(42)
mu0=2.5
sigma=0.5
poblacio=rnorm(10^6,mu0,sigma)
L=qt(0.95,19)  #el llindar per n=20 i alfa=0.05
```

La funció `estadístic` següent pren una mostra aleatòria de mida $n$ d'un vector $X$ (sense repeticions, per simular l'experiment dels diabètics, on la mostra era sense reposició; com que la població és de 10 milions, si la $n$ no és exageradament gran això no influirà en les conclusions) i en calcula l'estadístic de contrast $T$:

```{r}
estadístic=function(n,X){
mostra=sample(X,n,rep=FALSE) 
(mean(mostra)-mu0)/(sd(mostra)/sqrt(n))
}
```

I ara repetim 200 vegades el procés de prendre una mostra aleatòria de mida 20 de la nostra població i calcular la $T$ corresponent. Després miram la proporció de vegades que això ha donat més gran que el llindar, és a dir, la proporció de vegades que rebutjam la hipòtesi nul·la $\mu=2.5$ i que per tant cometem un error de tipus I.

```{r}
tes=replicate(200,estadístic(20,poblacio))
p.error.Tipus.I=length(which((tes>L)==TRUE))/200
p.error.Tipus.I
```

Hem comès un `r 100*p.error.Tipus.I`% d'errors de tipus I, molt proper al 5% que esperàvem.

Ara suposarem que el nivell mitjà real és estrictament més gran que 2.5, i anam a simular la probabilitat d'error de tipus II. Per començar, generam de manera uniforme un vector de 100 $\mu$'s entre 2.51 i 3.

```{r}
mus=runif(100,2.51,3)
```

I ara el que farem serà el següent: per a cada $\mu_i$ d'aquest vector, generam una "població de diabètics" per mitjà d'una mostra de 10^6^ nombres generats amb distribució $N(\mu_i,0.5)$, i repetim 100 vegades el procés de prendre una mostra de mida 20 d'aquesta població i calcular la $T$ corresponent. Després, per a cada $i$, miram la proporció de vegades que això ha donat més petit o igual que el llindar, és a dir, la proporció de vegades que acceptam la hipòtesi nul·la $\mu=2.5$ i que per tant cometem un error de tipus II. Organitzam totes aquestes proporcions en un vector **p.error.Tipus.II**.

```{r}
p.error.Tipus.II=c()
for (j in 1:100){
  poblacio=rnorm(10^5,mus[j],sigma)
  Tes=replicate(200,estadístic(20,poblacio))    
  p.error.Tipus.II=c(p.error.Tipus.II, round( length(which((Tes<=L)==TRUE))/200,2))
}
p.error.Tipus.II
```

La proporció mitjana d'errors de tipus II, que ens dóna una idea de la probabilitat d'error de tipus II, ha estat:

```{r}
mean(p.error.Tipus.II)
```

Si prenguéssim mostres més grans, aquesta probabilitat disminuiria. Repetim aquest segon experiment amb mostres de mida 200 per veure-ho.

```{r}
p.error.Tipus.II=c()
for (j in 1:100){
  poblacio=rnorm(10^5,mus[j],sigma)
  Tes=replicate(200,estadístic(200,poblacio))    
  p.error.Tipus.II=c(p.error.Tipus.II, round( length(which((Tes<=L)==TRUE))/200,2))
}
mean(p.error.Tipus.II)
```

Recordau que la **potència** d'un contrast és la probabilitat de *no* cometre un error de tipus II. Hem vist que prenent mostres més grans, la proporció d'errors de tipus II ha disminuït, és a dir, la potència ha augmentat. Això és general.

```{block2,type="rmdimportant"}
Si fixam el nivell de significació, com més grans són les mostres, més gran és la potència del contrast.
```

Tornem a la situació general en la que tenim una variable aleatòria $X\sim N(\mu,\sigma)$ i volem contrastar $\mu$ amb un cert valor $\mu_0$ i suposem que ara cercam evidència que $\mu<\mu_0$, de manera que el contrast és
$$
\left\{\begin{array}{l}
H_{0}:\mu=\mu_0\\ 
H_{1}:\mu < \mu_0
\end{array}
\right.
$$
En aquest cas, el p-valor és $P(T\leq T_0)$ i, raonant exactament igual com abans, obtenim les dues regles de rebuig equivalents següents:

> Rebutjarem $H_0$ si  $T_0< t_{n-1,\alpha}$  
> Rebutjarem $H_0$ si el p-valor és més petit que $\alpha$


I què passa si ara cercam evidència que $\mu$ és *diferent* de $\mu_0$, és a dir, si tenim el contrast
$$
\left\{\begin{array}{l}
H_{0}:\mu=\mu_0\\ 
H_{1}:\mu\ \neq  \mu_0
\end{array}
\right.
$$

Aleshores rebutjarem $H_{0}$ quan $\overline{X}$ és prou diferent de $\mu_0$, per damunt o per davall de $\mu_0$, i això ho traduïm en que rebutjarem $H_{0}$ quan $|T_0|$ (el valor absolut de $T_0$) sigui més gran que un cert llindar $L_0$, que determinam a partir de $\alpha$ com abans:

$$
\begin{array}{l}
\alpha = P(\text{Rebutjar } H_{0}| H_{0} \text{ certa})=P(|T|> L_0)\\
\hphantom{\alpha} = P(T< -L_0\text{ o } T>L_0)= P(T< -L_0)+P(T>L_0)\\
\hphantom{\alpha} =2P(T>L_0) \text{ (per la simetria de $t_{n-1}$)}\\
 \Longrightarrow \alpha/2=P(T>L_0)= 1-P(T\leq L_0) \\
\Longrightarrow P(T\leq L_0)=1-\alpha/2\Longrightarrow 
L_0= t_{n-1,1-\alpha/2}
\end{array}
$$

Per tant, en un contrast bilateral amb nivell de significació $\alpha$, tenim la regla de rebuig següent:

>  Rebutjarem $H_0$ si $|T_0|>t_{n-1,1-\alpha/2}$

En aquest cas, el p-valor serà la probabilitat que $T$ prengui un valor tant o més extrem que $T_0$ en el sentit de la hipòtesi alternativa: és a dir, més enfora de 0 que $T_0$: més gran que $|T_0|$ o més petit que $-|T_0|$:
$$
\text{p-valor} =P(T\leq -|T_0|)+P(T\geq |T_0|)=2 P(T\geq |T_0|)
$$
Per tant,
$$
\begin{array}{l}
\text{p-valor} < \alpha \Longleftrightarrow 2 P(T\geq |T_0|)<\alpha\\
\qquad \Longleftrightarrow P(T\geq |T_0|)<{\alpha}/{2}\\
\qquad \Longleftrightarrow |T_0|>t_{n-1,1-\alpha/2}\\
\qquad \Longleftrightarrow  \text{Rebutjam $H_0$}
\end{array}
$$

Per tant, en un contrast bilateral amb nivell de significació $\alpha$ també tenim la regla de rebuig:

> Rebutjarem $H_0$ si el p-valor és més petit que $\alpha$



```{block2, type="rmdcorbes"}
Abans de continuar, fixau-vos que, com que $|T_0|\geq 0$ i una distribució t de Student és simètrica al voltant de 0, 
$$
P(T\geq |T_0|)\leq P(T\leq |T_0|)
$$
i per tant
$$
\text{p-valor} =2 P(T\geq |T_0|)=2\min\{P(T\geq |T_0|),P(T\leq |T_0|)\}
$$
Al nostre cas, $T_0$ ha donat positiu i per tant $|T_0|=T_0$ i   
$$
\text{p-valor} =2\min\{P(T\geq T_0),P(T\leq T_0)\}.
$$
Si $T_0$ hagués donat negatiu, i per tant $T_0=-|T_0|$, per la simetria de la t de Student tendríem que 
$$
\begin{array}{l}
P(T\geq |T_0|)=P(T\geq -T_0)=P(T\leq T_0)\\
P(T\leq |T_0|)=P(T\leq -T_0)=P(T\geq T_0)
\end{array}
$$
i tornam a tenir
$$
\text{p-valor} =2\min\{P(T\leq T_0),P(T\geq T_0)\}.
$$
Això és consistent amb el que us explicàvem al final de la Secció \@ref(sec:pval): als contrastos bilaterals es pren com a p-valor el mínim de les probabilitats que l'estadístic de contrast prengui un valor més gran o igual que el de la mostra i que prengui un valor més petit o igual que el de la mostra, multiplicat per 2.
```


```{example}
Sigui $X$ una població normal. Volem fer el contrast
$$
\left\{\begin{array}{l}
H_{0}:\mu=20\\ H_{1}:\mu>20
\end{array}
\right.
$$
amb un nivell de significació de 0.05. Prenem una m.a.s. de $n=25$ observacions i obtenim $\overline{x}=20.7$ i $\widetilde{s}=1.8$. Què decidim?

```


*  Estadístic de contrast: 
$T=\dfrac{\overline{X}-\mu_0}{\widetilde{S}_X/\sqrt{n}}$


*  Pren el valor 
$$
T_0=\dfrac{20.7-20}{{1.8}/{\sqrt{25}}}=1.944
$$


*  p-valor
$$
P(T\geq 1.944)=\texttt{1-pt(1.944,24)}=0.032
$$

*  **Decisió**: Com que el p-valor és més petit que 0.05,  rebutjam $H_0$ i concloem (amb $\alpha=0.05$) que $\mu>20$

```{example}
Sigui $X$ una població normal. Volem fer el contrast
$$
\left\{\begin{array}{l}
H_{0}:\mu=20\\ H_{1}:\mu>20
\end{array}
\right.
$$
amb un nivell de significació de 0.01. Amb la mateixa m.a.s. de l'exemple anterior. Què decidim?

```

El p-valor és el mateix que abans, 0.032, perquè el contrast i la mostra són els mateixos. Com que aquest p-valor ara és més gran que 0.01, no podem  rebutjar $H_0$ amb $\alpha=0.01$ i  hem d'acceptar que $\mu=20$

```{block2,type="rmdnote"}
Fixau-vos que per reduir la probabilitat d'equivocar-nos rebutjant $H_0$ si és vertadera, fem més fàcil acceptar-la "per si de cas".

```


```{example}
Sigui $X$ una població normal. Volem fer el contrast
$$
\left\{\begin{array}{l}
H_{0}:\mu=20\\ H_{1}:\mu\neq 20
\end{array}
\right.
$$
amb un nivell de significació de 0.05. Amb la mateixa m.a.s. dels exemples anteriors. Què decidim?

```

Recordem que $n=25$, $\overline{x}=20.7$ i $\widetilde{s}=1.8$. L'estadístic de contrast prenia el valor $T_0=1.944$.

Ara el p-valor és
$$
2\cdot P(T\geq 1.944)=\texttt{2*(1-pt(1.944,24))}=0.064
$$

Com que el p-valor és més gran que $\alpha$, no podem rebutjar $H_0$: no podem afirmar amb $\alpha=0.05$ que $\mu\neq 20$


```{example}
Sigui $X$ una població normal. Volem fer el contrast
$$
\left\{\begin{array}{l}
H_{0}:\mu=20\\ H_{1}:\mu\neq 20
\end{array}
\right.
$$
amb un nivell de significació de 0.05. Prenem una m.a.s. de $n=25$ observacions i obtenim $\overline{x}=19$ i $\widetilde{s}=1.8$. Què decidim?

```


*  Estadístic de contrast: 
$T=\dfrac{\overline{X}-\mu_0}{\widetilde{S}_X/\sqrt{n}}$


*  Pren el valor 
$$
T_0=\dfrac{19-20}{{1.8}/{\sqrt{25}}}=-2.778
$$

*  p-valor
$$
2P(T\geq -2.778)=\texttt{2*(1-pt(-2.778,24))}=1.99
$$

*  Decisió:  com que el p-valor és més gran que $\alpha$, no podem rebutjar $H_0$.

```{block2,type="rmderror"}
El p-valor és una probabiitat. Com voleu que doni 1.99?
```

**NO!** El p-valor és $2\cdot P(T\geq |T_0|)$, no $2\cdot P(T\geq T_0)$. Per tant, el p-valor és
$$
2\cdot P(T\geq 2.778)=\texttt{2*(1-pt(2.778,24))}=0.01
$$
i com que p-valor és més petit que $\alpha$, podem rebutjar $H_0$ i concloure, amb nivell de significació 0.05, que $\mu\neq 20$.


## Recapitulació 

Repassem els conceptes introduïts fins ara, i posem nom a alguns altres:

*  **Nivell de significació**, $\alpha$: probabilitat de rebutjar $H_0$ si aquesta és vertadera (*probabilitat d'error de tipus I*, *de positiu fals*)

*  **Nivell de confiança**, $1-\alpha$: probabilitat d'acceptar $H_0$ si aquesta és vertadera (*probabilitat de negatiu vertader*)

*  **Potència**, $1-\beta$: probabilitat de rebutjar $H_0$ si $H_1$ és vertadera (*probabilitat de  positiu vertader*)


*  **Estadístic de contrast**: el que calculam sobre una mostra aleatòria simple i ens permet definir una regla de rebuig de $H_{0}$

*  **Regió crítica o de rebuig**:  el rang de valors de l'estadístic de contrast per als quals rebutjam $H_{0}$ amb un nivell de significació $\alpha$ donat

*  **Regió d'acceptació**:  el complementari de la regió de rebuig, és a dir, el rang de valors de l'estadístic de contrast per als quals acceptam $H_{0}$ amb un nivell de significació $\alpha$ donat

*  **p-valor**: La probabilitat que,  si $H_0$ és vertadera, l'estadístic de contrast prengui sobre una mostra aleatòria simple un valor tan o més extrem (en el sentit de $H_1$) que l'obtingut sobre la nostra mostra


```{example}
Si realitzam un test t per efectuar un contrast
$$
\left\{\begin{array}{l}
H_{0}:\mu=\mu_0\\ 
H_{1}:\mu > \mu_0
\end{array}
\right.
$$
rebutjam $H_0$ amb nivell de significació $\alpha$ (o amb nivell de confiança $1-\alpha$) quan
$$
T=\dfrac{\overline{X}-\mu_0}{{\widetilde{S}_X}/{\sqrt{n}}}>t_{n-1,1-\alpha}
$$

```
Per tant:

*  *Estadístic de contrast*: Aquest $T$

*  *Regió crítica* per aquest $\alpha$: l'interval $(t_{n-1,1-\alpha},\infty)$

*  *Regió d'acceptació* per aquest $\alpha$: l'interval $(-\infty,t_{n-1,1-\alpha}]$

* *p-valor*: $P(T\geq T_0)$

Si en canvi el contrast que volem efectuar és
$$
\left\{\begin{array}{l}
H_{0}:\mu=\mu_0\\ 
H_{1}:\mu < \mu_0
\end{array}
\right.
$$
rebutjam $H_0$ amb nivell de significació $\alpha$ (o amb nivell de confiança $1-\alpha$) quan
$$
T=\dfrac{\overline{X}-\mu_0}{{\widetilde{S}_X}/{\sqrt{n}}}<t_{n-1,\alpha}
$$

Per tant:

*  *Estadístic de contrast*: El mateix $T$ que abans

*  *Regió crítica* per aquest $\alpha$: l'interval $(-\infty,t_{n-1,\alpha})$

*  *Regió d'acceptació* per aquest $\alpha$: l'interval $[t_{n-1,\alpha},\infty]$

* *p-valor*: $P(T\leq T_0)$

Finalment, si el contrast que volem realitzar és
$$
\left\{\begin{array}{l}
H_{0}:\mu=\mu_0\\ 
H_{1}:\mu \neq \mu_0
\end{array}
\right.
$$
rebutjam $H_0$ amb nivell de significació $\alpha$ (o amb nivell de confiança $1-\alpha$) quan
$$
|T|=\left|\dfrac{\overline{X}-\mu_0}{{\widetilde{S}_X}/{\sqrt{n}}}\right|>t_{n-1,1-\alpha/2}
$$
Per tant:

*  *Estadístic de contrast*: El mateix $T$ que abans

*  *Regió crítica* per aquest $\alpha$: la unió d'intervals $(-\infty,-t_{n-1,1-\alpha/2})\cup (t_{n-1,1-\alpha/2},\infty)$

*  *Regió d'acceptació* per aquest $\alpha$: l'interval $[-t_{n-1,1-\alpha/2},t_{n-1,1-\alpha/2}]$

* *p-valor*: $2P(T\geq |T_0|)$


### Interval de confiança d'un contrast {-}

L'**interval de confiança de nivell de confiança $1-\alpha$** d'un contrast és  un interval on el paràmetre poblacional que contrastam té probabilitat $1-\alpha$ de pertànyer-hi (en el sentit dels intervals de confiança del tema anterior: calculat amb una fórmula que un $(1-\alpha)\cdot 100\%$ de les vegades que l'aplicam a una mostra aleatòria simple dóna un interval que conté el paràmetre d'interès).


Aquest interval de confiança s'obté imposant que l'estadístic de contrast pertanyi a la regió d'acceptació per al nivell de significació $\alpha$ i aïllant el paràmetre poblacional.

*  Quan $H_1$ és bilateral, coincideix amb l'interval de confiança donat en el tema anterior

*  Quan $H_1$ és unilateral, dóna un interval infinit al costat definit per la hipòtesi alternativa.

Per exemple, considerem el cas de un test t per efectuar un contrast
$$
\left\{\begin{array}{l}
H_{0}:\mu=\mu_0\\ 
H_{1}:\mu > \mu_0
\end{array}
\right.
$$
Acceptam $H_0$ amb nivell de significació $\alpha$ quan
$$
\dfrac{\overline{X}-\mu_0}{{\widetilde{S}_X}/{\sqrt{n}}}\leq t_{n-1,1-\alpha}
$$
Aïllant $\mu_0$, obtenim
$$
\overline{X}- t_{n-1,1-\alpha}\cdot \dfrac{\widetilde{S}_X}{\sqrt{n}}\leq \mu_0
$$
Per tant, l'**interval de confiança de nivell de confiança $1-\alpha$ per a aquest contrast** és
$$
\Bigg[\overline{X}- t_{n-1,1-\alpha}\cdot \dfrac{\widetilde{S}_X}{\sqrt{n}},\infty\Bigg)
$$


En l'exemple dels diabètics de la Secció \@ref(sec:exttest), dóna l'interval
$$
\Bigg[3.2- 1.73\cdot \dfrac{1.5}{\sqrt{20}},\infty\Bigg)=[2.62,\infty)
$$

Obtenim que, amb un nivell de confiança del 95%, la concentració mitjana de calci en sang en els joves diabètics 
és com a mínim 2.62, i que per tant, amb aquest nivell de confiança, no pot ser 2.5, encara que per poc.

Si efectuam un contrast bilateral amb un test t 
$$
\left\{\begin{array}{l}
H_{0}:\mu=\mu_0\\ 
H_{1}:\mu\neq  \mu_0
\end{array}
\right.
$$
acceptam $H_0$ amb nivell de significació $\alpha$ quan
$$
-t_{n-1,1-\alpha/2}\leq \dfrac{\overline{X}-\mu_0}{{\widetilde{S}_X}/{\sqrt{n}}}\leq t_{n-1,1-\alpha/2}
$$
Aïllant $\mu_0$, obtenim:
$$
\overline{X}- t_{n-1,1-\alpha/2}\cdot \dfrac{\widetilde{S}_X}{\sqrt{n}}\leq \mu_0 \leq \overline{X}+ t_{n-1,1-\alpha/2}\cdot \dfrac{\widetilde{S}_X}{\sqrt{n}}
$$
Per tant, l'**interval de confiança de nivell de confiança $1-\alpha$ per a aquest contrast** és
$$
\Bigg[\overline{X}- t_{n-1,1-\alpha/2}\cdot \dfrac{\widetilde{S}_X}{\sqrt{n}},\overline{X}+ t_{n-1,1-\alpha/2}\cdot \dfrac{\widetilde{S}_X}{\sqrt{n}}\Bigg]
$$
Us sona? Fent $q=1-\alpha$, és el del tema anterior.


```{block2,type="rmdimportant"}
Donat un contrast d'hipòtesis, podem decidir si rebutjam $H_0$ en favor de $H_1$ amb nivell de significació $\alpha$ emprant:

*  **La regió crítica**: Si l'estadístic de contrast cau dins la regió crítica per al nivell de significació $\alpha$, rebutjam $H_0$

*  **El p-valor**: Si el p-valor és més petit que el nivell de significació $\alpha$, rebutjam $H_0$

*  **L'interval de confiança**: Si el paràmetre poblacional a contrastar no pertany a  l'interval de confiança de nivell de confiança $1-\alpha$, rebutjam $H_0$

Els tres mètodes són equivalents. El més adequat és donar el p-valor i l'interval de confiança: el p-valor perquè el lector el pugui comparar amb el nivell de significació que consideri oportú i l'interval de confiança perquè mostra el marge amb el qual hem acceptat o rebutjat la hipòtesi nul·la amb el nostre nivell de significació.

```

Si no establim un nivell de significació $\alpha$, el que és habitual en Biologia és:

*  Acceptam $H_0$ si el p-valor és més gran que 0.1: es diu que el p-valor  **no és estadísticament significatiu**

*  Rebutjam $H_0$ si el p-valor és més petit que 0.05: es diu que el p-valor **és estadísticament significatiu**

*  Si el  p-valor està entre 0.05 i 0.1 i no s'ha fixat nivell de significació, el millor que podeu fer és no concloure res

Quan el p-valor és <0.05, se solen distingir tres franges:

*  **Significatiu** si és <0.05
*  **Fortament significatiu** si és <0.01
*  **Molt significatiu** si és <0.001
    
R marca aquestes franges amb un codi d'asteriscs

```
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
```


```{r, echo=FALSE,fig.cap="Emoticones per representar els nivells de significació estadística (BMJ 2018; 363, doi: https://doi.org/10.1136/bmj.k5033)", out.width="80%"}
knitr::include_graphics("Bioestadistica-II_files/figure-html/emojis.png")
```


Atès que rebutjam $H_0$ si, i només si, el p-valor és $<\alpha$, el p-valor d'un contrast és el nivell de significació més petit per al qual rebutjaríem la hipòtesi nul·la. És a dir:

```{block2,type="rmdimportant"}
El p-valor obtingut en un contrast és la probabilitat mínima que tenim d'equivocar-nos rebutjant la hipòtesi nul·la si és vertadera.
```

Per tant, per favor, acostumau-vos a donar el p-valor, i no la franja de significació on cau.



### La potència {-}

Recordau que la **potència** $1-\beta$ és la probabilitat de rebutjar $H_0$ quan $H_1$ és vertadera.

Per exemple, en l'exemple del calci en diabètics de la Secció \@ref(sec:exttest), la regla de rebuig era 
$$
T=\frac{\overline{X}-2.5}{\widetilde{S}_X/\sqrt{n}}>1.73,
$$
per tant la potència era
$$
1-\beta=P(T>1.73| \mu>2.5).
$$
Aquesta probabilitat és difícil de calcular, però hi ha paquets de R que ho saben fer.

Per a cada tipus de contrast es té una relació numèrica entre:


*  La **potència** $1-\beta$

*  La **mida** de la mostra $n$: la potència creix amb $n$

*  El **nivell de significació** $\alpha$: la potència decreix amb $\alpha$

*  La **mida de l'efecte**, un valor que quantifica la diferència  entre el paràmetre mostral i el valor contrastat: la potència creix amb el valor absolut de la mida de l'efecte

Aquesta relació permet calcular qualsevol dels quatre valors a partir dels altres tres; amb R, el paquet **pwr** permet fer-ho amb els contrastos més usuals.

A l'hora de planejar un experiment per realitzar un contrast, el que s'ha de fer és:

*  Fixar el nivell de significació desitjat

*  Fixar la potència desitjada

*  Estimar la mida de l'efecte esperat (a partir de la nostra teoria, de la nostra experiència, dels resultats d'altres estudis...) o que volguem detectar (per rebutjar la hipòtesi nul·la ens bastarà una mida de l'efecte petita o la requerirem grossa?)

i emprar la relació anterior per calcular la mida de la mostra necessària per assolir la potència desitjada.

```{block2,type="rmdcaution"}
Desconfiau dels treballs on això no es faci. Podria ser que la potència fos molt baixa i hi hagués un  **biaix de infrapotència** (*underpower*): es necessitava un efecte molt gran per poder rebutjar la hipòtesi nul·la i publicar l'article.
```



### El risc de falsos positius {-}

El paquet **statcheck** de R permet revisar de manera automàtica tots els càlculs d'un article escrit en un format concret en psicologia i comprovar-ne els p-valors. Els autors van analitzar 30,000 articles  i varen concloure que (*Behavior research methods* 48 (2016), 1205-1226):

> "Hem trobat que la meitat dels articles contenen almenys un p-valor erroni. I un de cada vuit articles conté un p-valor molt inconsistent que afecta la conclusió estadística."

Per tant,

* Qualsevol article pot donar un p-valor petit que estigui equivocat

No us en refieu. A més, teniu present que:

* Qualsevol estudi mal dissenyat o mal realitzat pot donar un p-valor petit... que no signifiqui absolutament res

* Qualsevol estudi perfectament dissenyat i realitzat pot donar per pur atzar un p-valor petit... que impliqui un positiu fals 

El **risc de positiu fals**, **FPR**, en un contrast és
$$
P(H_0\text{ vertadera}|H_0\text{ rebutjada}).
$$
Pel teorema de Bayes (notau que entenem $H_1= \text{no }H_0$)
$$
\begin{array}{rl}
FPR&=\dfrac{P(H_0)\cdot P(H_0\text{ reb.}|H_0)}{P(H_0)\cdot P(H_0\text{ reb.}|H_0)+P(H_1)\cdot P(H_0\text{ reb.}|H_1)}\\
& =\dfrac{P(H_0)\cdot \alpha}{P(H_0)\cdot \alpha+(1-P(H_0))\cdot (1-\beta)}\\
& =\dfrac{(1-P(H_1))\cdot \alpha}{(1-P(H_1))\cdot \alpha+ P(H_1)\cdot (1-\beta)}
\end{array}
$$

Per calcular-lo, hem de saber el nivell de significació i la potència i hem de decidir *a priori* quina probabilitat assignam al fet que $H_1$ sigui vertadera. 


```{example}
En un estudi (publicat a *Psychological Science* 22 (2011), pp. 1011-1018) es repartiren 66 participants en dos grups de 33, als que direm grup Bandera i grup Control, i els mostraren les mateixes 4 fotos d'edifcis. En les del grup Bandera, dues mostraven una bandera dels EUA, i en les del grup Control, aquestes banderes havien estat eliminades digitalment. Per emmascarar l'estudi, se'ls demanà que endevinassin l'hora del dia en què varen ser preses les fotos.

```


Després de mirar les fotos, els participants emplenaren un qüestionari sobre idees polítiques, a partir del qual es pot calcular un cert "índex de republicanisme" $M$ del que l'ha contestat. Resulta que $M$ va ser significativament més gran en el grup Bandera que en el grup Control, i amb un nivell de significació $\alpha=0.05$ els autors de l'estudi  conclogueren que mirar fotos amb banderes estatals et "dretitza" (almenys temporalment) les idees polítiques. Vaig a estimar el risc que aquest positiu sigui fals.

Com que *a priori*, trob molt improbable que la conclusió sigui certa, li assignaré $P(H_1)=0.1$ i gràcies. Emprarem $\alpha=0.05$, i si es calcula la potència del contrast publicat, resulta ser 0.51

Llavors 
$$
FPR =\dfrac{0.9\cdot 0.05}{0.9\cdot 0.05+0.1\cdot 0.51}=0.47
$$
Per tant, *a posteriori*, crec que hi ha un 47% de probabilitats que $H_1$ sigui falsa i un 53% de probabilitats que $H_1$ sigui vertadera.



<!--chapter:end:04-Contrastos1.Rmd-->

# Contrastos d'hipòtesis d'un i dos paràmetres

## Contrastos de mitjanes

### Test t per a una mitjana

Si estam en una de les dues situacions següents: 

* $X$ una variable aleatòria normal de mitjana $\mu$ i en prenem una mostra aleatòria simple de mida $n$ qualsevol

* $X$ una variable aleatòria qualsevol de mitjana $\mu$ i en prenem una mostra aleatòria simple de mida $n$ gran (diguem  de mida com a mínim 30, o millor 40)

i volem realitzar un contrast
$$
\left\{\begin{array}{l}
H_{0}:\mu=\mu_0\\ 
H_{1}:\mu \neq\mu_0\text{ o }\mu >\mu_0\text{ o }\mu<\mu_0
\end{array}
\right.
$$
podem emprar el **test t** que ja hem explicat a la Secció \@ref(sec:exttest), basat en l'estadístic de contrast
$$
T= \frac{\overline{X}-\mu_{0}}{{\widetilde{S}_X}/{\sqrt{n}}}
$$
que, en les condicions donades i si $\mu=\mu_0$, té una distribució (aproximadament, quan $X$ no és normal però $n$ és gran) $t_{n-1}$.

```{example, ttest1}
Una organització ecologista afirma que el pes  mitjà dels individus adults d'una espècie  ha disminuït dràsticament.
Se sap per les dades històriques que el pes mitjà poblacional era de 460 g.

```

Una mostra aleatòria de 50 individus d'aquesta espècie ha donat una mitjana mostral de 428 g i una desviació típica mostral de 119 g. Amb aquestes dades, podem afirmar  amb un nivell de significació del 5%  que el pes mitjà és inferior a 460 g?


* *Variable aleatòria d'interès*: $X$: "Prenem un animaló d'aquests i mesuram el seu pes, en grams",  de mitjana $\mu$

* *Contrast*:
$$
\left\{\begin{array}{l}
H_{0}:\mu=460\\
H_{1}:\mu<460
\end{array}
\right.
$$

* *Nivell de significació*: $\alpha=0.05$

* *Estadístic*: Com que $n=50$ és  gran, podem usar
$$
T=\frac{\overline{X}-\mu_0}{{\widetilde{S}_X}/{\sqrt{n}}}
$$
que sí $H_0$ és vertadera serà (aproximadament) t de Student amb $n-1=49$ graus de llibertat

* *Valor de l'estadístic*:
$$
\dfrac{428-460}{{119}/{\sqrt{50}}}=-1.9
$$

* *p-valor*:
$$
P(T\leq -1.9)=\texttt{pt(-1.9,49)}=0.032
$$

* *Interval de confiança del 95%*:
$$
\left(-\infty, \overline{X}-t_{n-1,\alpha}\cdot \frac{\widetilde{S}_X}{\sqrt{n}}\right]=(-\infty, 456.2]
$$


* *Decisió*: Com que el p-valor és més petit que 0.05,  concloem (amb $\alpha=0.05$) que el pes mitjà actual és més petit que 460 g. Amb un 95% de confiança podem afirmar que el pes mitjà actual és inferior a 456.2 g.

Ho resumiríem dient:

> Hi ha evidència estadísticament significativa que el pes mitjà actual és menor que 460 g (p=0.03, IC 95% $-\infty$ a 456.2) i que per tant ha minvat en els darrers anys.


### Test t per a dues mitjanes

Si estam en una de les situacions següents:


* $X_1,X_2$ dues variables aleatòries normals de mitjanes $\mu_1$, $\mu_2$ i en prenem mostres aleatòries simples de mides $n_1$, $n_2$ qualssevol

* $X_1,X_2$ dues variables aleatòries qualssevol de mitjanes $\mu_1$, $\mu_2$ i i en prenem mostres aleatòries simples de mides $n_1$, $n_2$ grans (diguem cadascuna de mida com a mínim 30, o millor 40)

i volem realitzar un contrast
$$
\left\{\begin{array}{l}
H_{0}:\mu_1=\mu_2\\ 
H_{1}:\mu_1 \neq\mu_2\text{ o }\mu_1 >\mu_2\text{ o }\mu_1<\mu_2
\end{array}
\right.
$$
podem usar un **test t**, basat en un estadístic de contrast $T$ adequat que segueix una llei t de Student.

L'estadístic de contrast concret i els graus de llibertat de la seva distribució t de Student depenen:


* De si les dues mostres són **independents** (hem mesurat $X_1$ i $X_2$ sobre dues mostres obtingudes de manera independent una de l'altra) o **aparellades** (hem mesurat $X_1$ i $X_2$ sobre els subjectes d'una mateixa mostra o hi ha un aparellament natural entre els subjectes de les dues mostres)

* Quan les mostres són independents, també depenen de si $X_1$ i $X_2$ tenen la *mateixa variància* o no (la qual cosa es pot decidir amb un altre contrast: vegeu la Secció \@ref(sec:contrvar)); per a mostres de la mateixa mida de variables normals, la conclusió sol ser la mateixa

Quan les mostres són aparellades, podem entendre que tenim una sola mostra, formada per les parelles. En aquest cas, traduïm
$$
\left\{\begin{array}{l}
H_{0}:\mu_1=\mu_2\\ 
H_{1}:\mu_1 \neq\mu_2\text{ o }\mu_1 >\mu_2\text{ o }\mu_1<\mu_2
\end{array}
\right.
$$
en
$$
\left\{\begin{array}{l}
H_{0}:\mu_1-\mu_2=0\\ 
H_{1}:\mu_1-\mu_2 \neq0\text{ o }\mu_1-\mu_2 >0\text{ o }\mu_1-\mu_2<0
\end{array}
\right.
$$
on $\mu_1-\mu_2$ és la mitjana de $X_1-X_2$, i el consideram un contrast d'una sola mitjana, emprant com a mostra les diferències $X_1-X_2$ a les parelles.

Per tant, quan les mostres són aparellades, si diem $\overline{D}$ a la mitjana mostral de $X_1-X_2$ i $\widetilde{S}_D$ a la desviació típica mostral de $X_1-X_2$ sobre la mostra de parelles i diem $n$ a la mida de la mostra de parelles,  l'estadístic de contrast és
$$
T=\frac{\overline{D}}{\widetilde{S}_D/\sqrt{n}}
$$
que quan $\mu_1-\mu_2=0$ té (aproximadament, en el cas que $X_1,X_2$ no siguin normals però la $n$ sigui gran) distribució $t_{n-1}$.


Quan les mostres són independents, siguin $\overline{X}_1$ i $\widetilde{S}^2_1$ la mitjana mostral i la variància mostral de la mostra de $X_1$ i $\overline{X}_2$ i $\widetilde{S}^2_2$ la mitjana mostral i la variància mostral de la mostra de $X_2$. Diguem, a més, $\sigma_1^2$ i $\sigma_2^2$ a les variàncies (poblacionals) de $X_1$ i $X_2$. Aleshores:


* Si $\sigma_1^2=\sigma_2^2$, l'estadístic de contrast és
$$
T=\frac{\overline{X}_1-\overline{X}_2}{\sqrt{(\frac{1}{n_1}+\frac{1}{n_2})\cdot 
\frac{(n_1-1)\widetilde{S}_1^2+(n_2-1)\widetilde{S}_2^2}{n_1+n_2-2}}}
$$
que, quan $\mu_1=\mu_2$, té distribució (aproximadament, en el cas que $X_1,X_2$ no siguin normals però $n_1$ i $n_2$ siguin grans) $t_{n_1+n_2-2}$


* Si $\sigma_1^2\neq \sigma_2^2$, l'estadístic de contrast és
$$
T=\frac{\overline{X}_1-\overline{X}_2}{\sqrt{\frac{\widetilde{S}_1^2}{n_1}+\frac{\widetilde{S}_2^2}{n_2}}}
$$
que, quan $\mu_1=\mu_2$, té distribució (aproximadament, en el cas que $X_1,X_2$ no siguin normals però $n_1$ i $n_2$ siguin grans) $t_{\nu}$ amb
$$
\nu=\frac{\displaystyle \left( \frac{\widetilde{S}_1^2}{n_1}+\frac{\widetilde{S}_2^2}{n_2}\right)^2}
{\displaystyle \frac{1}{n_1-1}\left(\frac{\widetilde{S}_1^2}{n_1}\right)^2+\frac{1}{n_2-1}\left(\frac{\widetilde{S}_2^2}{n_2}\right)^2}
$$

```{block2,type="rmdnote"}
No cal que sapigueu aquestes fórmules per a mostres independents, només que l'estadístic de contrast i la seva distribució depenen de si les variàncies poblacionals són iguals o diferents.
```

El nombre de graus de llibertat de la distribució t de Student usada en un contrast sobre dues mostres de mida $n$:

* Si les mostres són aparellades, és $n-1$

* Si les mostres són independents, és aproximadament $2(n-1)$

Això fa que la probabilitat d'error de Tipus I del contrast amb mostres aparellades (a igualtat de la resta de valors) sigui més petita. Per exemple, suposem que volem realitzar el contrast
$$
\left\{
\begin{array}{l}
H_0: \mu_1=\mu_2\\
H_1: \mu_1>\mu_2
\end{array}
\right.
$$
i que l'estadístic de contrast $T$ sobre dues mostres de mides $n_1=n_2=20$ dóna 1.7. Aleshores

* Si les mostres són independents,
$$
\text{p-valor}=P(T>1.7)\approx \texttt{1-pt(1.7,38)}=0.0487
$$

* Si les mostres són aparellades,
$$
\text{p-valor}=P(T>1.7)=\texttt{1-pt(1.7,19)}=0.0527
$$

Per tant, amb nivell de significació $\alpha=0.05$, rebutjaríem la hipòtesi nul·la amb les mostres independents i l'acceptaríem amb les mostres aparellades.

### Tests t amb R

Tots aquests tests t estan implementats en la funció de R
```{r,eval=FALSE}
t.test(x, y, mu=..., alternative=..., conf.level=..., paired=..., var.equal=...)
```

on:

* Entram com a `x` una mostra i a `mu` el valor amb el qual volem contrastar $\mu$, o entram com a `x` i `y` les
mostres de $X_1$ i  de $X_2$

* A `alternative` hi hem d'indicar el tipus de contrast segons la hipòtesi alternativa:

    * `alternative="two.sided"` ($\neq$, el valor per defecte)
    * `alternative="less"` ($<$)
    * `alternative="greater"` ($>$)  

* En el cas d'un contrast de dues mitjanes, a `paired` hi hem d'indicar si les mostres són independents, amb `paired=FALSE` (el valor per defecte), o aparellades, amb `paired=TRUE`

* En el cas d'un contrast de dues mitjanes amb mostres independents, a `var.equal`  hi hem d'indicar si les variàncies són iguals,  amb `var.equal=TRUE`, o diferents, amb `var.equal=FALSE` (el valor per defecte)

* A `conf.level` hi hem d'especificar el nivell de confiança $1-\alpha$: el seu valor per defecte és 0.95, que correspon al nivell de significació $\alpha=0.05$ usual 

### Exemples


```{example, temphomes1}
La temperatura mitjana del cos humà, és el valor usualment acceptat de 98.6^o^ F (37^o^ C)?

```

Per contrastar-ho, emprarem la taula de dades **Body_Temperature.txt**, construïda per P.A. Mackowiak, S. S. Wasserman i M.M. Levine en 1992 precisament per realitzar aquest contrast i que trobareu a l'Aula Digital. 

* *Variable aleatòria d'interès*: $X$: "Prenem una persona i li miram la temperatura, en graus F", de mitjana $\mu$

* *Contrast*:
$$
\left\{\begin{array}{l}
H_{0}:\mu=98.6\\
H_{1}:\mu \neq 98.6
\end{array}
\right.
$$


Realitzarem aquest contrast amb R. Carregam la taula de temperatures, que prèviament hem guardat en el directori de treball de R, en un dataframe que anomenarem `BT`.

```{r}
BT=read.table("Body_Temperature.txt")
head(BT)
str(BT)
```

Veiem que la taula `BT` consta de 230 individus i 3 variables mesurades sobre cadascun d'ells: el sexe (variable `Gender`, amb valors `F` per a dona i `M` per a home), les pulsacions per minut (variable `HeartRate`) i la temperatura en graus F (variable `Temperature`).

Com que la mostra és gran, $n=230$, podem emprar un test t. Emprarem la funció `t.test`, aplicant-la al vector de temperatures i al valor que contrastam, 98.6, entrat amb el parametre `mu`. El paràmetre `alternative="two.sided"` indica que el test serà bilateral.

```{r}
t.test(BT$Temperature, mu=98.6, alternative="two.sided")
```

Del resultat cal destacar:

* El p-valor, `p-value`, en el nostre cas $`r round(t.test(BT$Temperature, mu=98.6, alternative="two.sided")$p.value,11)`$ (R l'ha escrit en notació científica: `r sprintf("%.3e", t.test(BT$Temperature, mu=98.6, alternative="two.sided")$p.value)`).

* L'IC 95%, `95 percent confidence interval`, per al valor que contrastam (aquí, la temperatura mitjana poblacional), en el nostre cas [`r round(t.test(BT$Temperature, mu=98.6, alternative="two.sided")$conf.int,5)`].

* La mitjana mostral de la mostra, `sample of x`, en el nostre cas `r round(t.test(BT$Temperature, mu=98.6, alternative="two.sided")$estimate,5)`.

La conclusió és:
 
* El p-valor és $3\times 10^{-8}$, per la qual cosa obtenim evidència estadísticament significativa que la temperatura mitjana del cos humà no és de 98.6^o^ F (37^o^ C)

* A més, com com que l'IC 95% per a la temperatura mitjana del cos humà que hem obtingut  va de 98.2 a 98.4 (36.78 a 36.89^o^ C), hem trobat evidència a aquest nivell de confiança que aquesta temperatura mitjana és (lleugerament) inferior 98.6^o^ F

En resum, hi ha evidència estadísticament significativa que la temperatura mitjana del cos humà no és de 98.6^o^ F (p=3·10^-8^, IC 95% 98.2 a 98.4).



```{example, temphomesdones}
La temperatura mitjana dels homes, és més alta que la de les dones?
  

```

Per resoldre aquesta qüestió, emprarem la mateixa taula de dades que abans. 

```{block2,type"rmdnote"}
Sí, ja sabem que no està ben fet marejar unes dades amb més d'un contrast, però estam fent exemples, no publicant articles.
```

* *Variables aleatòries d'interès*:

    * $X_d$: temperatura d'una dona en graus F, de mitjana $\mu_d$
    * $X_h$: temperatura d'un home en graus F, de mitjana $\mu_h$


* *Contrast*:
$$
\left\{\begin{array}{l}
H_{0}:\mu_d=\mu_h\\
H_{1}:\mu_d< \mu_h
\end{array}
\right.
$$

Per poder emprar un t test, primer ens cal saber si hi ha nombres suficientment grans d'homes i dones a la nostra mostra per emprar-lo. Per això calcularem la taula de freqüències dels sexes, aplicant la funció `table` al vector `BT$Gender` dels sexes:

```{r}
table(BT$Gender)
```

Són prou grans.

Anam a crear uns vectors amb les temperatures d'homes i de dones. Recordau que per extreure d'un dataframe el vector de valors d'una variable `V1` per als individus que prenen un valor concret `X` en una altra variable `V2` s'empra la construcció `dataframe[V2==X,V1]`. Així, les temperatures dels homes (individus on la variable `Gender` és igual a `M`) són

```{r}
BT[BT$Gender=="M","Temperature"]
```

Bé, cream els vectors $X_d$ (dones) i $X_h$ (homes)

```{r}
X_d=BT[BT$Gender=="F","Temperature"]  #temperatures de dones
X_h=BT[BT$Gender=="M","Temperature"]  #temperatures d'homes
```

Per portar a terme un test t per comparar dues mitjanes, aplicam la funció `t.test` als vectors `X_d`i `X_h` amb paràmetre `alternative="less"` per indicar que el test és unilateral: la hipòtesi alternativa és que la mitjana de la primera població (dones) és més gran que la de la segona (homs). En aquest exemple, a més, especificarem que les mostres són independents amb `paired=FALSE` (no caldria, ja que és el valor per defecte) i a més hem d'especificar si les variàncies poblacionals són iguals (`var.equal=TRUE`) o diferents (`var.equal=FALSE`). El que farem serà provar quan les variàncies són iguals i quan són diferents: si les dues conclusions són la mateixa, aquesta serà la conclusió que prendrem. 


```{r}
t.test(X_d, X_h, alternative="less",paired=FALSE, var.equal=TRUE)
t.test(X_d, X_h, alternative="less",paired=FALSE, var.equal=FALSE)
```

En tots dos casos obtenim un p-valor (`p-value`) gran i un IC 95 % (`95 percent confidence interval`) per a la diferència de les mitjanes que conté el 0, per la qual cosa no podem descartar que les dues mitjanes siguin iguals.  

Ho resumiríem dient que no hi ha evidència estadísticament significativa que la temperatura mitjana de les dones sigui més baixa que la dels homes  (p=0.99, IC 95% $-\infty$ a 0.46).


```{block2,type="rmdnote"}
Vegem, si $\overline{X_h}=98.14$ i $\overline{X_d}=98.42$, com volíeu que obtinguéssim evidència que $\mu_h>\mu_d$? *Mirau sempre les dades primer!*
```

**Exercici**: Emprant les mateixes dades, trobau evidència que $\mu_h<\mu_d$? I que $\mu_h\neq \mu_d$? Spoiler:

```{r, echo=FALSE,out.width="50%"}
knitr::include_graphics("Bioestadistica-II_files/figure-html/tempcorp3.png")
```



```{example,oatbran}
Desdijunar segó de civada (*oat bran*) en lloc de flocs de blat de moro (*corn flakes*), ajuda a reduir el nivell de colesterol?


```

Per resoldre aquesta qüestió, emprarem la taula de dades **oatbran.txt**, que trobareu a l'Aula Digital. Aquestes dades es recolliren en un assaig creuat sobre 14 individus. A cada un d'ells se li assignà un dels dos desdijunis i el prengueren durant  15 dies. Al final d'aquest període, se'ls analitzà el nivell de colesterol en sang. Passat un mes de descans, cada participant va desdijunar durant 15 dies  l'altre producte, i al final se'ls tornà a analitzar el nivell de colesterol en sang.

<!-- (J. Anderson \textsl{et a el}, ``Oat-bran cereal lowers serum total and LDL cholesterol in hypercholesterolemic men.'' \textsl{The American journal of clinical nutrition} 52 (1990), 495--499)
-->

* *Variables aleatòries d'interès*:

    * $X_{ob}$: Nivell de colesterol en sang d'una persona que consumeix  *oat bran*, de mitjana $\mu_{ob}$
    * $X_{cf}$: nivell de colesterol en sang d'una persona que consumeix  *corn flakes*, de mitjana $\mu_{cf}$

* *Contrast*:
$$
\left\{\begin{array}{l}
H_{0}:\mu_{ob}=\mu_{cf}\\
H_{1}:\mu_{ob}< \mu_{cf}
\end{array}
\right.
$$


Carregam la taula de dades, que prèviament hem guardat en el directori de treball de R, en un dataframe al que anomenam `OBR` i consultam la seva estructura:

```{r}
OBR=read.table("oatbran.txt",header=TRUE)
head(OBR)
str(OBR)
```

N'extraiem les dues variables en forma de vectors:

```{r}
OAT=OBR$OATBRAN
CFL=OBR$CORNFLK
```

Com que 14 dades són poques, si volem aplicar un test t necessitam que provinguin d'una distribució normal. Per decidir si és veritat o no, més endavant explicarem contrastos de bondat d'ajustament, amb hipòtesi nul·la "Aquesta mostra prové d'una variable aleatòria amb tal distribució" i hipòtesi alternativa "No és veritat que aquesta mostra provengui d'una variable aleatòria amb tal distribució". Per ara ens conformarem amb decidir-ho a partir d'un gràfic.

A Matemàtiques I us explicàvem que podeu dibuixar un histograma de les dades amb la densitat estimada de la distribució que les ha generades i la densitat de la normal amb la seva mitjana i desviació típica, i mirar si sembla que les dades segueixen aquesta densitat. Però amb poques dades això és mal de veure:

```{r,fig.show="as.is"}
hist(OAT,freq=FALSE, breaks=4,col="light blue",xlab="Colesterol",ylab="Densitat", main="Histograma de OATBRAN")
lines(density(OAT),lty=2,lwd=2)
curve(dnorm(x,mean(OAT),sd(OAT)),col="red",lwd=2,add=TRUE)
legend("topright",legend=c("Densitat estimada","Normal"),col=c("black","red"),lty=c(2,1),cex=0.5)
hist(CFL,freq=FALSE, breaks=4,col="light blue",xlab="Colesterol",ylab="Densitat", main="Histograma de CORNFLK",ylim=c(0,0.5))
curve(dnorm(x,mean(CFL),sd(CFL)),col="red",lwd=2,add=TRUE)
lines(density(CFL),lty=2,lwd=2)
legend("topright",legend=c("Densitat estimada","Normal"),col=c("black","red"),lty=c(2,1),cex=0.5)
```


En aquest cas, una opció millor és dibuixar un *q-q-plot*.  Un **q-q-plot** d'una mostra i una distribució teòrica és el gràfic dels  **q-q-punts**: els punts de la forma  (q-quantil de la distribució, q-quantil de la mostra), per a tots els valors de q que tengui sentit donada la mida de la mostra.  Quan la distribució amb la que comparam la mostra és una normal, se'n diu un **normal-plot**.

Si la mostra prové de la distribució emprada en el q-q-plot, és d'esperar que el q-quantil de la mostra sigui aproximadament igual al q-quantil de la distribució i per tant que aquests q-q-punts estiguin prop de la diagonal principal $y=x$.

La funció `qqPlot` del paquet **car** produeix uns *q-q-plots* que contenen una regió de confiança del 95% que especifica què vol dir això que "els q-q-punts estiguin prop de la diagonal principal $y=x$", amb el significat usual de nivell de confiança. Ja l'explicarem en detall a la lliçó de R sobre contrastos de bondat d'ajustament. 

```{r,eval=FALSE}
library(car)
qqPlot(OAT, distribution="norm", mean=mean(OAT), sd=sd(OAT),
        ylab="Quantils de OATBRAN", xlab="Quantils de normal", pch=20, id=FALSE)
```

```{r,echo=FALSE}
library(car)
car::qqPlot(OAT, distribution="norm", mean=mean(OAT), sd=sd(OAT),
        ylab="Quantils de OATBRAN", xlab="Quantils de normal", pch=20, id=FALSE)
```


```{r,eval=FALSE}
qqPlot(CFL, distribution="norm", mean=mean(CFL),sd=sd(CFL),
       ylab="Quantils de CORNFLK", xlab="Quantils de normal", pch=20, id=FALSE)
```


```{r,echo=FALSE}
car::qqPlot(CFL, distribution="norm", mean=mean(CFL),sd=sd(CFL),
       ylab="Quantils de CORNFLK", xlab="Quantils de normal", pch=20, id=FALSE)
```

Aceptarem per tant que les nostres dades provenen de dues distribucions normals: podem fer servir la funció `t.test`.

En aquest cas, el test t és de mostres aparellades (hem mesurat les dues variable aleatòries sobre els mateixos individus), per la qual cosa hem d'especificar `paired=TRUE` i no hem  d'especificar el paràmetre `var.equal`. Emprarem el paràmetre `alternative="less"` per indicas que el test és unilateral: la mitjana de la primera població és més petita que la de la segona


```{r}
t.test(OAT,CFL,alternative="less", paired=TRUE)
```

Com abans, el resultat inclou el p-valor, l'IC 95% per a la mitjana de les diferències (que és igual a la diferència de les mitjanes: recordau que $E(X-Y)=E(X)-E(Y)$) i ara, com a novetat, la mitjana de les diferències (`mean of the differences`) en comptes de les dues mitjanes, ja que el que ens interessa és contrastar si la mitjana de les diferències és menor que 0.

La conclusió és que hi ha evidència estadísticament significativa que desdijunar *oatbran* redueix el colesterol respecte dels *corn flakes* (p=0.003, IC 95% $-\infty$ a -0.163).

```{example,sangumbil}
Volem contrastar si el nivell de triglicèrids als nadons de 2 setmanes és més alt que el del seu cordó umbilical. Es prengué una mostra de 25 nadons i es mesuraren els nivells de triglicèrids en plasma a la sang del seu cordó umbilical i en la seva sang al cap de 2 setmanes de néixer. Tenim les dades a la taula **trignadons.txt** que trobareu a l'Aula Digital. Les seves variables són `CU`, les mesures del cordó umbilical, `DS`, les mesures al cap de dues setmanes, i `Nin`, que identifica el nadó.

```


* *Variables aleatòries d'interès*:

    * $X_{cu}$: Nivell de triglicèrids en plasma a la sang del cordó umbilical d'un nadó, de mitjana $\mu_{cu}$
    * $X_{ds}$: Nivell de triglicèrids en plasma d'un nadó de 2 setmanes, de mitjana $\mu_{cf}$

* *Contrast*: Plantejarem el contrast en termes d'una comparació dels nivells mitjans de triglicèrids:
$$
\left\{\begin{array}{l}
H_{0}:\mu_{cu}=\mu_{ds}\\
H_{1}:\mu_{cu}< \mu_{ds}
\end{array}
\right.
$$

Carregam la taula de dades, que prèviament hem guardat en el directori de treball de R, en un dataframe al que anomenam `TGN` i consultam la seva estructura:

```{r}
TGN=read.table("trignadons.txt",header=TRUE)
head(TGN)
str(TGN)
```

Com que 25 dades són poques, miram si segueixen distribucions normals amb els seus normal-plots:


```{r,eval=FALSE}
qqPlot(TGN$CU, distribution="norm", id=FALSE, mean=mean(TGN$CU), sd=sd(TGN$CU),
        ylab="Quantils de la mostra", xlab="Quantils de normal", pch=20)
```
```{r,echo=FALSE}
car::qqPlot(TGN$CU, distribution="norm", id=FALSE, mean=mean(TGN$CU), sd=sd(TGN$CU),
        ylab="Quantils de la mostra", xlab="Quantils de normal", pch=20)
```

```{r,eval=FALSE}
qqPlot(TGN$DS,  distribution="norm", mean=mean(TGN$DS), sd=sd(TGN$DS),
       ylab="Quantils de la mostra", xlab="Quantils de normal", pch=20,id=FALSE)
```
```{r,echo=FALSE}
car::qqPlot(TGN$DS,  distribution="norm", mean=mean(TGN$DS), sd=sd(TGN$DS),
       ylab="Quantils de la mostra", xlab="Quantils de normal", pch=20,id=FALSE)
```

Vaja, no sembla que segueixin una distribució normal. Vegem els seus histogrames


```{r}
hist(TGN$CU, freq=FALSE, main="Histograma de TGN$CU", 
     xlab="",ylab="",col="light blue")
lines(density(TGN$CU),lty=2,lwd=2)
curve(dnorm(x,mean(TGN$CU),sd(TGN$CU)),col="red",lwd=2,add=TRUE)
legend("topright",legend=c("Densitat estimada","Normal"),col=c("black","red"),lty=c(2,1),cex=0.5)
```
```{r}
hist(TGN$DS, freq=FALSE, main="Histograma de TGN$DS", 
     xlab="",ylab="",col="light blue")
lines(density(TGN$DS),lty=2,lwd=2)
curve(dnorm(x,mean(TGN$DS),sd(TGN$DS)),col="red",lwd=2,add=TRUE)
legend("topright",legend=c("Densitat estimada","Normal"),col=c("black","red"),lty=c(2,1),cex=0.5)
```

Les dues mostres presenten una cua a la dreta. En casos així, de vegades els logaritmes seguexen aproximadament una distribució normal:

```{r,eval=FALSE}
LogCU=log(TGN$CU)
qqPlot(LogCU, distribution="norm", mean=mean(LogCU), sd=sd(LogCU),
        ylab="Quantils dels logaritmes", xlab="Quantils de normal", pch=20, id=FALSE)
```
```{r,echo=FALSE}
LogCU=log(TGN$CU)
car::qqPlot(LogCU, distribution="norm", mean=mean(LogCU), sd=sd(LogCU),
        ylab="Quantils dels logaritmes", xlab="Quantils de normal", pch=20, id=FALSE)
```
```{r,eval=FALSE}
LogDS=log(TGN$DS)
qqPlot(LogDS, distribution="norm", mean=mean(LogDS), sd=sd(LogCU),
        ylab="Quantils dels logaritmes", xlab="Quantils de normal", pch=20, id=FALSE)
```
```{r,echo=FALSE}
LogDS=log(TGN$DS)
car::qqPlot(LogDS, distribution="norm", mean=mean(LogDS), sd=sd(LogCU),
        ylab="Quantils dels logaritmes", xlab="Quantils de normal", pch=20, id=FALSE)
```

Aquests logaritmes ja poden passar per normals. Per tant, el que farem serà, en lloc de comparar les mitjanes dels nivells de triglicèrids, comparar les mitjanes dels seus logaritmes.

```{block2,type="rmdcaution"}
No són contrastos equivalents, perquè el logaritme de la mitjana no és la mitjana del logaritme. Però en realitat la pregunta que originava aquesta investigació era si el nivell de triglicèrids augmenta en les dues primeres setmanes de vida dels nadons, i ho plantejàvem en termes de si és veritat que **el  nivell mitjà de triglicèrids** augmenta en les dues primeres setmanes de vida dels nadons. 

Ara, demanar-nos si "el nivell de triglicèrids augmenta en les dues primeres setmanes de vida dels nadons" sí que és equivalent a demanar-nos si "el logaritme del nivell de triglicèrids augmenta en les dues primeres setmanes de vida dels nadons". I el que fem és plantejar aquesta pregunta en termes de si és veritat que **el valor mitjà del logaritme del nivell de triglicèrids** augmenta en les dues primeres setmanes de vida dels nadons
```



* *Variables aleatòries d'interès*:

    * $\log(X_{cu})$: Logaritme del nivell de triglicèrids en plasma a la sang del cordó umbilical d'un nadó, de mitjana $\mu_{logcu}$
    * $\log(X_{ds})$: Logaritme del nivell  de triglicèrids en plasma d'un nadó de 2 setmanes, de mitjana $\mu_{logcf}$

* *Contrast*:
$$
\left\{\begin{array}{l}
H_{0}:\mu_{logcu}=\mu_{logds}\\
H_{1}:\mu_{logcu}< \mu_{logds}
\end{array}
\right.
$$

Prenem com a mostres de $\log(X_{cu})$ i $\log(X_{ds})$ els vectors de logaritmes `LogCU` i `LogDS` de la nostra mostra original, que podem acceptar que provenen de distribucions normals, i els aplicam la funció `t.test` amb `paired=TRUE`, perquè són mostres aparellades, i `alternative="less"`.

```{r}
t.test(LogCU, LogDS, paired=TRUE, alternative="less")
```

Obtenim evidència estadísticament significativa que el valor mitjà del logaritme del nivell de triglicèrids a la sang del cordó umbilical d'un nadó és més petit que el valor mitjà del logaritme del nivell de triglicèrids a la sang d'un nadó de 2 setmanes 
(p<10^-16^, IC 95% per a la diferència $-\infty$ a -0.84).

### Tests no paramètrics

Si les variables aleatòries d'interès no són (aproximadament) normals i alguna mostra és petita, no podem usar un test t per comparar mitjanes. En aquest cas, una possibilitat és provar de transformar les dades com a l'Exemple \@ref(exm:sangumbil) per veure si la transformació esdevé normal, i si és el cas, plantejar el contrast en termes de mitjanes de logaritmes.

Una altra possibilitat és emprar un **test no paramètric**, que no necessiti que les variables aleatòries siguin normals per que la conclusió sigui vàlida.


La majoria de tests no paramètrics  per comparar mitjanes en realitat comparen **medianes**, però sovint cometem l'abús de llenguatge de dir que són per contrastar mitjanes: a més, si les variables aleatòries són simètriques, les mitjanes coincideixen amb les medianes. 
Els més populars són: 

* **Test de Wilcoxon** per a una mitjana o dues mitjanes usant mostres aparellades

* **Test de Mann-Whitney** per a dues mitjanes usant mostres independents

Tots tres es calculen amb R amb la funció 
```{r,eval=FALSE}
wilcox.test(x, y, mu=..., alternative=..., conf.level=..., paired=...)
```
amb sintaxi idèntica a la de `t.test` (excepte que no s'hi empra el `var.equal`).

```{block2,type="rmdimportant"}
Els millors tests no paramètrics solen tenir potència inferior als millors tests paramètrics. A més, els tests no paramètrics no solen produir intervals de confiança fiables. Però, per exemple, emprar un test t quan no és adequat pot portar a conclusions equivocades.

**Emprau tests paramètrics sempre que pogueu, però només quan pogueu**
```

Com a exemple, vegem com funciona (una versió simplificada) del test de Wilcoxon d'una mitjana. Sigui $X$ una variable aleatòria contínua simètrica al voltant de la seva mitjana $\mu$ desconeguda. Volem realitzar un contrast
$$
\left\{\begin{array}{l}
H_{0}:\mu=\mu_0\\ 
H_{1}:\mu \neq \mu_0 \text{ o }\mu >\mu_0\text{ o }\mu<\mu_0
\end{array}
\right.
$$

Prenem  una mostra aleatòria simple $x_1,\ldots, x_n$ de $X$. El procediment d'aquest test es basa aleshores en els següents passos, que després il·lustram amb un exemple:

1. Per a cada $i=1,\ldots,n$, sigui $d_i=x_i-\mu_0$; s'eliminen els valors 0

2. Enumeram els valors $d_i$ de menor a major valor absolut; en cas d'empats, a cada un li assignam la mitjana de les posicions (\red{rangs}) que ocuparien. A l'índex assignat d'aquesta manera a cada $d_i$ li diem el seu **rang**.

3. Diem $T_+$ a la suma dels rangs dels $d_i>0$ i $T_{-}$ a la suma dels rangs dels $d_i<0$

4. Si $H_0$ vertadera, és a dir, si $\mu=\mu_0$, per la simetria de $X$ al voltant de $\mu$ esperam que $T_+\approx T_-$. Per tant

    * Si $T_+$ és molt petit, és evidència que $\mu <\mu_0$
    
    *Si $T_+$ és molt gran,  és evidència que $\mu >\mu_0$
    
    *Si $T_+$ és molt petit o gran,  és evidència que $\mu\neq \mu_0$

    I resulta que la distribució de $T_+$ per a cada $n$ quan $X$ és simètrica i $H_0$ vertadera és coneguda, i es pot emprar per calcular el p-valor, que és el que fa la funció `wilcox.test`.

```{example,dietaratolins}
Alimentam amb una dieta especial 13 ratolins des del naixement fins a la setmana 12. Els augments de pes (en grams) varen ser els del vector següent


```

```{r}
pesos=c(69,61,69,65,70,68,69,68,72,67,74,69,76)
```
Podem conclure que l'augment mitjà de pes en aquestes condicions és de menys de 70 g?

* *Variable aleatòria d'interès*: $X$: "Prenem un ratolí alimentat amb aquesta dieta especial i mesuram el seu augment de pes durant les seves primeres 12 setmanes de vida", de mitjana $\mu$.

* *Contrast*:
$$
\left\{\begin{array}{l}
H_{0}:\mu=70\\ 
H_{1}:\mu <70
\end{array}
\right.
$$

Si miram la mostra, veurem que no té pinta de venir d'una distribució normal però sí simètrica:

```{r,eval=FALSE}
par(mfrow=c(1,2))
qqPlot(pesos, distribution="norm", mean=mean(pesos), sd=sd(pesos),
        ylab="Quantils de la mostra", xlab="Quantils de normal", pch=20, id=FALSE)
boxplot(pesos)
```

```{r,echo=FALSE,fig.width=8,fig.asp=0.5}
par(mfrow=c(1,2))
car::qqPlot(pesos, distribution="norm", mean=mean(pesos), sd=sd(pesos),
        ylab="Quantils de la mostra", xlab="Quantils de normal", pch=20, id=FALSE)
boxplot(pesos)
par(mfrow=c(1,1))
```

Per tant, portarem a terme un test de Wilcoxon. Vegem com aniria a mà. 

1. Calculam els $d_i=x_i-70$

$$
\begin{array}{l|cccccccccccccc}
\hline
x_i &     69 &  61 &  69 &  65 &  70 &  68 &  69 &  68 &  72 &  67 &  74 &  69 &  76\\
d_i     & -1 & -9 & -1  &   -5  &  0 &  -2 &  -1 &  -2 &  2 &   -3  &    &   -1 &    6\\
\hline
\end{array}
$$

2. Assignam índexos als $d_i\neq 0$ en ordre creixent al seu valor absolut. En cas d'empat, per ara els assignam els índexos ordenats d'esquerra a dreta.

$$
\begin{array}{l|cccccccccccccc}
\hline
x_i &                       69 &  61 &  69 &  65 &  70 &  68 &  69 &  68 &  72 &  67 &  74 &  69 &  76\\
d_i                        & -1 & -9 & -1  &   -5  &  0 &  -2 &  -1 &  -2 &  2 &   -3  &  4 & -1 &    6\\
\textrm{Rang fals}        &   1 & 12 &   2 &  10  &    &   5 &   3 &   6  &  7 &   8 &  9 & 4 &   11    \\
\hline
\end{array}
$$
    A continuació, substituïm tots els ``rangs falsos'' de valors $d_i$ amb mateix valor absolut per la mitjana de tots els seus ``rangs falsos''. Així, substituïm els ``rangs falsos'' 1, 2, 3 i 4 dels $d_i=-1$ per $(1+2+3+4)/4=2.5$ i els ``rangs falsos'' 5, 6 i 7 dels $d_i=-2$ o 2 per $(5+6+7)/3=6$.

$$
\begin{array}{l|cccccccccccccc}
\hline
x_i &                       69 &  61 &  69 &  65 &  70 &  68 &  69 &  68 &  72 &  67 &  74 &  69 &  76\\
d_i                        & -1 & -9 & -1  &   -5  &  0 &  -2 &  -1 &  -2 &  2 &   -3  &  4 & -1 &    6\\
\textrm{Rang fals}        &   1 & 12 &   2 &  10  &     &   5 &   3 &   6  &  7 &   8 &  9 & 4  &   11    \\
\textrm{Rang}             & 2.5 & 12 & 2.5 & 10 &       & 6   & 2.5  & 6   &  6 &  8 &  9 &  2.5 & 11 \\
\hline
\end{array}
$$

3. Anotam quins $d_i$ són positius i quins negatius:

$$
\begin{array}{l|cccccccccccccc}
\hline
x_i &                       69 &  61 &  69 &  65 &  70 &  68 &  69 &  68 &  72 &  67 &  74 &  69 &  76\\
d_i                        & -1 & -9 & -1  &   -5  &  0 &  -2 &  -1 &  -2 &  2 &   -3  &  4 & -1 &    6\\
\textrm{Rang fals}        &   1 & 12 &   2 &  10  &     &   5 &   3 &   6  &  7 &   8 &  9 & 4  &   11    \\
\textrm{Rang}             & 2.5 & 12 & 2.5 & 10 &       & 6   & 2.5  & 6   &  6 &  8 &  9 &  2.5 & 11 \\
\textrm{Signe} &            -   & - &  -  &  -   &      & - &   - &  -     & +  &  -  & +   & -   & +\\  
\hline
\end{array}
$$

4. Sumam els rangs dels $d_i$ positius, $T_+=6+9+11=26$, i dels negatius, $T_-=2.5+ 12 + 2.5 + 10 + 6   + 2.5  + 6   +  8 +  2.5=52$

5. I ara miraríem si $T_-$ és prou més gran que $T_+$ per que sigui evidència estadísticament significativa de que $\mu <\mu_0$. Això ja no ho podem fer a mà, però fixau-vos que $T_-$ és el doble que $T_+$.

Amb R, simplement faríem
```{r,message=TRUE}
wilcox.test(pesos,mu=70,alternative="less")
```


El test de Wilcoxon per a dues mitjanes emprant mostres aparellades és bàsicament el test anterior aplicat a la diferència dels valors de les dues variables a les parelles.

```{example}
Una alternativa a la transformació logarítmica portada a terme a l'Exemple \@ref(exm:sangumbil) hagués estat emprar el test de Wilcoxon per a mostres aparellades. 


```

El contrast ara seria 
$$
\left\{\begin{array}{l}
H_{0}:\mu_{cu}-\mu_{ds}=0\\
H_{1}:\mu_{cu}- \mu_{ds}<0
\end{array}
\right.
$$
que clarament correspon al contrast original
$$
\left\{\begin{array}{l}
H_{0}:\mu_{cu}=\mu_{ds}\\
H_{1}:\mu_{cu}< \mu_{ds}
\end{array}
\right.
$$
però hem de tenir present que la hipòtesi nul·la en realitat significa que la **mediana** de les diferències dels nivells de triglicèrids en el cordó umbilical menys  els nivells  de triglicèrids al cap de dues setmanes és 0, és a dir

> Si restam el nivell de triglicèrids en la sang del cordó umbilical d'un nadó menys el nivell de triglicèrids en sang al cap de dues setmanes, la meitat de les vegades obtendríem un valor $\geq 0$ i la meitat de les vegades un valor $\leq 0$,

i la hipòtesi alternativa que aquesta mediana és negativa. És a dir, la hipòtesi alternativa és

> Si restam el nivell de triglicèrids en la sang del cordó umbilical d'un nadó menys el nivell de triglicèrids en sang al cap de dues setmanes, més de la meitat de les vegades obtendríem un valor $<0$.

```{r}
wilcox.test(TGN$CU,TGN$DS,alternative="less",paired=TRUE)
```


Com que el p-valor és de l'ordre de 10^-6^, decidim que la hipòtesi alternativa és la vertadera.




## Contrastos de variàncies {#sec:contrvar}

### Test $\chi^2$ d'una variància

Siguin $X$ una variable aleatòria $N(\mu,\sigma)$ i $X_1,\ldots,X_n$ una mostra aleatòria simple de $X$ de mida $n$ qualsevol.

Volem realitzar un contrast
$$
\left\{\begin{array}{l}
H_{0}:\sigma=\sigma_0\\ 
H_{1}:\sigma \neq\sigma_0\text{ o }\sigma >\sigma_0\text{ o }\sigma<\sigma_0
\end{array}
\right.
$$
o equivalentment
$$
\left\{\begin{array}{l}
H_{0}:\sigma^2=\sigma_0^2\\ 
H_{1}:\sigma^2 \neq\sigma_0^2\text{ o }\sigma^2 >\sigma_0^2\text{ o }\sigma^2<\sigma_0^2
\end{array}
\right.
$$


Si $H_0$ és vertadera, sabem que l'*estadístic de contrast*
$$
\chi^2=\frac{(n-1) \widetilde{S}_X^2}{\sigma_{0}^2}
$$

té distribució $\chi_{n-1}^2$, i aleshores ho podem emprar per calcular p-valors, regions crítiques etc.

El que fem és calcular el valor de l'estadístic de contrast 
$$
\chi_0^2=\frac{(n-1) \widetilde{S}_X^2}{\sigma_{0}^2}
$$ 
sobre la mostra i aleshores:


* Si $H_{1}:\sigma>\sigma_{0}$, el p-valor és $P(\chi^2\geq \chi_0^2)$

* Si $H_{1}:\sigma<\sigma_{0}$, el p-valor és $P(\chi^2\leq \chi^2_0)$

* Si $H_{1}:\sigma\neq \sigma_{0}$, el p-valor és  $2\text{min}\big\{P(\chi^2\geq \chi^2_0), P(\chi^2\leq\chi^2_0)\big\}$

```{block2,type="rmdcaution"}
Alerta amb els p-valors dels contrastos bilaterals quan la distribució de l'estadístic no és simètrica!
```

```{example}
Suposem que tenim una mostra aleatòria simple de $X$ normal de mida 25, i ha donat 
$\widetilde{S}_X^2=1.25$. Volem realitzar alguns contrastos amb hipòtesi nul·la $\sigma_X^2=0.8$, i per tant tendrem
$$
\chi_0^2={(25-1)\cdot 1.25}/{0.8}=37.5
$$

  
```

* Si volem realitzar el contrast
$$
\left\{\begin{array}{l}
H_{0}:\sigma_X^2=0.8 \\
H_{1}:\sigma_X^2> 0.8
\end{array}
\right.
$$
    el p-valor és
$$
P(\chi^2_{24} \geq 37.5)=\texttt{1-pchisq(37.5,24)}=0.039
$$
    Amb nivell de confiança $\alpha=0.05$ rebutjam $H_0$ en favor de $H_1$

* Si volem realitzar el contrast
$$
\left\{\begin{array}{l}
H_{0}:\sigma_X^2=0.8 \\
H_{1}:\sigma_X^2\neq  0.8
\end{array}
\right.
$$
    El p-valor és 
$$
\begin{array}{l}
2\min\big\{P(\chi^2_{24}\geq 37.5),P(\chi^2_{24}\leq 37.5)\big\}\\
\qquad=2\min\{\texttt{1-pchisq(37.5,24)},\texttt{pchisq(37.5,24)}\}\\
\qquad=2\min\{`r round(1-pchisq(37.5,24),3)`,`r round(pchisq(37.5,24),3)`\}=
`r 2*min(c(round(1-pchisq(37.5,24),3),round(pchisq(37.5,24),3)))`
\end{array}
$$
    Amb nivell de confiança $\alpha=0.05$, no podem rebutjar $H_0$.




```{example}
S'ha analitzat el líquid amniòtic d'una mostra aleatòria de 15 embarassades de 3er trimestre, i s'han obtingut les mesures següents de proteïnes totals (en grams per 100 ml):


```

```{r}
amnio=c(0.69,1.04,0.39,0.37,0.64,0.73,0.69,1.04,0.83,1.01,0.19,0.61,0.42,0.25,0.79)
```

Podem concloure a partir d'aquestes dades, amb un nivell de significació del 5%, que la desviació típica poblacional (és a dir, la desviació típica  de la quantitat de proteïna total en el líquid amniòtic de les embarassades de 3er trimestre expressada en grams per 100 ml) és diferent de 0.25?

*Variable aleatòria d'interès*: $X$: Quantitat de proteïna total en ...

*Contrast*:
$$
\left\{\begin{array}{l}
H_{0}:\sigma=0.25 \\
H_{1}:\sigma\neq 0.25
\end{array}
\right.
$$
amb $\alpha=0.05$

Per poder aplicar el test $\chi^2$, cal que $X$ sigui normal. Vegem-ho

```{r,eval=FALSE}
qqPlot(amnio, distribution="norm", mean=mean(amnio), sd=sd(amnio),
        ylab="Quantils de la mostra", xlab="Quantils de normal", pch=20, id=FALSE)
```

```{r,echo=FALSE}
car::qqPlot(amnio, distribution="norm", mean=mean(amnio), sd=sd(amnio),
        ylab="Quantils de la mostra", xlab="Quantils de normal", pch=20, id=FALSE)
```

Acceptarem que $X$ és normal.

*Estadístic de contrast*: 
$$
\chi^2=\frac{(n-1) \widetilde{S}_X^2}{\sigma_{0}^2}
$$
que segueix una llei $\chi^2_{n-1}$ si $H_0$ és certa.

*Valor* de l'estadístic de contrast, $\chi^2_0$:
```{r}
n=length(amnio)
khi0=(n-1)*var(amnio)/0.25^2
round(khi0,2)
```

*p-valor*: 
$$
\begin{array}{l}
2\min\big\{P(\chi_{n-1}^2\geq \chi^2_0), P(\chi_{n-1}^2\leq \chi^2_0)\big\}\\
\qquad=2\min\{\texttt{1-pchisq(`r round(khi0,2)`,`r n-1`)},\texttt{pchisq(`r round(khi0,2)`,`r n-1`)}\}\\
\qquad=2\min\{`r round(1-pchisq(round(khi0,2),n-1),3)`,`r round(pchisq(round(khi0,2),n-1),3)`\}=
`r 2*min(c(round(1-pchisq(round(khi0,2),n-1),3),round(pchisq(round(khi0,2),n-1),3)))`
\end{array}
$$

No podem rebutjar la hipòtesi que la desviació típica sigui 0.25 amb un nivell de significació del 5%

En aquest exemple, com que el contrast és bilateral, l'IC 95% seria el del tema anterior (amb $q=1-\alpha=0.95$). El de la variància seria
$$
\begin{array}{l}
\displaystyle \left[ \frac{(n-1)\widetilde{S}_{X}^2}{\chi_{n-1,0.975}^2},
\frac{(n-1)\widetilde{S}_{X}^2}{\chi_{n-1,0.025}^2}
\right]\\
\qquad\displaystyle=\left[ \frac{`r n-1`\cdot `r round(var(amnio),4)`}{`r round(qchisq(0.975,n-1),4)`},
\frac{`r n-1`\cdot `r round(var(amnio),4)`}{`r round(qchisq(0.025,n-1),4)`}\right]\\[3ex]
\qquad\qquad=[`r (n-1)*round(var(amnio),4)/round(qchisq(0.975,n-1),4)`, `r (n-1)*round(var(amnio),4)/round(qchisq(0.025,n-1),4)`]
\end{array}
$$

L'interval de confiança del 95% per a la desviació típica serà aleshores
$$
[\sqrt{`r (n-1)*round(var(amnio),4)/round(qchisq(0.975,n-1),4)`}, \sqrt{`r (n-1)*round(var(amnio),4)/round(qchisq(0.025,n-1),4)`}]=
[`r round(sqrt((n-1)*round(var(amnio),4)/round(qchisq(0.975,n-1),4)),3)`,`r round(sqrt((n-1)*round(var(amnio),4)/round(qchisq(0.025,n-1),4)),3)`]
$$
i conté el valor 0.25 que contrastàvem.


Aquest test $\chi^2$ d'una variància està implementat en la funció `sigma.test` del paquet **TeachingDemos**. La seva sintaxi és similar a la de `t.test`. Per exemple, per realitzar aquest darrer contrast, simplement entraríem
```{r}
library(TeachingDemos)
sigma.test(amnio,sigma=0.25,alternative="two.sided")
```

Ups, què ha passat amb l'interval de confiança? 


```{block2,type="rmdcaution"}
L'interval de confiança que dóna la funció `sigma.test` és el de la variància.
```


### Test F  per a dues variàncies

Siguin $X_1,X_2$ dues variables aleatòries normals de desviacions típiques $\sigma_1$ i $\sigma_2$, respectivament.
En prenem dues mostres aleatòries simples independents de mides $n_1$ i $n_2$ i variàncies mostrals $\widetilde{S}^2_1$ i  $\widetilde{S}^2_2$.

Volem realitzar un contrast
$$
\left\{\begin{array}{l}
H_{0}:\sigma_1^2=\sigma_2^2\\[1ex]
H_{1}:\sigma_1^2\neq \sigma_2^2\text{ o }\sigma_1^2> \sigma_2^2\text{  o }\sigma_1^2< \sigma_2^2
\end{array}
\right.
$$

L'interpretarem
$$
\left\{\begin{array}{l}
H_{0}:\sigma_1^2/\sigma_2^2=1\\[1ex]
H_{1}:\sigma_1^2/\sigma_2^2\neq 1\text{  o }\sigma_1^2/\sigma_2^2>1 \text{  o }\sigma_1^2/\sigma_2^2< 1
\end{array}
\right.
$$


Per realitzar-lo, s'empra l'estadístic de contrast
$$
F={\widetilde{S}_1^2}/{\widetilde{S}_2^2}
$$
que, si les dues poblacions són normals i 
$$
H_0: \sigma_1=\sigma_2
$$
és vertadera, té distribució coneguda: la **F de Fisher-Snedecor** $F_{n_1-1,n_2-1}$ amb $n_1-1$ i $n_2-1$ graus de llibertat. 
Per aquest motiu a aquest contrast se li diu un **test F**.

De la distribució $F_{n,m}$, on $n,m$ són els seus **graus de llibertat**, heu de saber que:

* Els graus de llibertat $n,m$ són els paràmetres dels quals depèn la funció de distribució, i l'ordre és important: si $n\neq m$, la distribució $F_{n,m}$ i la distribució $F_{m,n}$ són diferents.

* Amb R és `f`

* No és simètrica, i per tant els p-valors dels contrastos bilaterals es calculen com en el cas de la $\chi^2$.

El test F està implementat en la funció `var.test` de R: s'aplica a les dues mostres, amb sintaxi similar a la de  `t.test`.


```{example}
Les variables $X_d$ i $X_h$ de l'Exemple \@ref(exm:temphomesdones), tenen la mateixa variància?


```

Suposarem que totes dues són normals (les temperatures ho solen ser) i diguem $\sigma_d^2$ i $\sigma_h^2$ a les seves variàncies.  

*Contrast*:
$$
\left\{\begin{array}{l}
H_{0}:\sigma_d^2=\sigma_h^2\\
H_{1}:\sigma_d^2\neq \sigma_h^2
\end{array}
\right.
$$

*Estadístic de contrast*:
$$
F=\widetilde{S}_h^2/\widetilde{S}_d^2
$$

* *Valor de l'estadístic de contrast* a la nostra mostra, $F_0$:

```{r}
F0=var(X_d)/var(X_h)
F0
```

```{r,include=FALSE}
nd=length(X_d)
nh=length(X_h)
```

Recordem que les mides de les nostres mostres eren $n_d=`r nd`$ i  $n_h=`r nh`$

*p-valor*:
$$
\begin{array}{l}
2\min\big\{P(F_{n_d-1,n_h-1} \geq F0), P(F_{n_d-1,n_h-1}\leq F0)\big\}\\
\qquad =2\min\big\{P(F_{`r nd-1`,`r nh-1`} \geq `r F0`), P(F_{`r nd-1`,`r nh-1`} \leq `r F0`)\big\}\\
\qquad =2\min\{`r round(1-pf(F0,nd-1,nh-1),3)`,`r round(pf(F0,nd-1,nh-1),3)`}=
`r 2*min(c(round(1-pf(F0,nd-1,nh-1),3), round(pf(F0,nd-1,nh-1),3)))``
\end{array}
$$

Per tant, no podem rebutjar que $X_h$ i $X_d$ tenguin la mateixa variància: acceptarem que tenen la mateixa variància.

Amb R entraríem:

```{r}
var.test(X_h, X_d)
```

Obtenim el mateix p-valor que abans. L'interval de confiança que dóna aquesta funció és *per al quocient de les variàncies*. Aleshores, com que l'IC 95% conté l'1, no podem rebutjar amb un nivell de significació del 5% que $\sigma_d^2/\sigma_h^2=1$, és a dir, que $\sigma_d^2=\sigma_h^2$.


Per tant, si els tests t amb `var.equal=TRUE` i `var.equal=FALSE` de l'Exemple \@ref(exm:temphomesdones) haguessin donat conclusions diferents, prendríem la corresponent a variàncies iguals.

Hem emprat un test F per comparar aquestes variàncies, i per que la conclusió sigui fiable, cal que les variables poblacionals siguin normals, no és suficient que les mostres siguin grans (de fet, la seva validesa no depèn per res de la mida de les mostres). Podem suposar que efectivament les variables $X_d$ i $X_h$ són normals?

Vegem els histogrames:
```{r,fig.width=8,fig.asp=0.5}
par(mfrow=c(1,2))
hist(X_d,freq=FALSE, breaks=4,col="light blue",xlab="Temperatures",ylab="Densitat", main="Histograma de temperatures de dones")
lines(density(X_d),lty=2,lwd=2)
curve(dnorm(x,mean(X_d),sd(X_d)),col="red",lwd=2,add=TRUE)
legend("topright",legend=c("Densitat estimada","Normal"),col=c("black","red"),lty=c(2,1),cex=0.5)
hist(X_h,freq=FALSE, breaks=4,col="light blue",xlab="Temperatures",ylab="Densitat", main="Histograma de temperatures d'homes")
lines(density(X_h),lty=2,lwd=2)
curve(dnorm(x,mean(X_h),sd(X_h)),col="red",lwd=2,add=TRUE)
legend("topright",legend=c("Densitat estimada","Normal"),col=c("black","red"),lty=c(2,1),cex=0.5)
```

i els normal-plot:
```{r,fig.width=8,fig.asp=0.5}
par(mfrow=c(1,2))
car::qqPlot(X_d, distribution="norm", mean=mean(X_d), sd=sd(X_d),
        ylab="Quantils de la mostra de dones", xlab="Quantils de normal", pch=20, id=FALSE)
car::qqPlot(X_h, distribution="norm", mean=mean(X_h), sd=sd(X_h),
        ylab="Quantils de la mostra d'homes", xlab="Quantils de normal", pch=20, id=FALSE)
```


Seria millor haver emprat un test no paramètric, per més seguretat.

### Tests no paramètrics

Quan alguna de les variables poblacionals involucrades en un test de dues variàncies no és normal, no es pot fer servir el test F. 

En aquest cas, us recomanam emprar el **test de Fligner-Killeen**, implementat en R en la funció `fligner.test`, que en la pràctica ha mostrat ser més exacte per a variables aleatòries molt diferents de normals.
Aquest test només serveix per a contrastos bilaterals, que en realitat són els únics interessants, i està implementat en la funció `fligner.test` de R. 

Per exemple, per emprar-lo en el contrast bilateral de variàncies de l'exemple anterior, entraríem:


```{r}
fligner.test(list(X_h,X_d))
```

I seguim acceptant que $X_h$ i $X_d$ tenen la mateixa variància.



## Contrastos per a proporcions

### Contrastos per a una proporció

Suposem que la variable poblacional $X$ és Bernoulli de probabilitat d'èxit $p$, i que volem realitzar un contrast 
$$
\left\{\begin{array}{l}
H_{0}:p=p_{0}\\
H_{1}:p\neq p_{0}\text{ o }  p>p_0 \text{ o } p<p_0
\end{array}
\right.
$$

Tenim dues opcions: realitzar un test binomial exacte, que és el que explicàvem a la Secció \@ref(sec:moneda), o un test aproximat basat en l'aproximació d'una distribució binomial per una normal.

#### Test binomial exacte {-}

Suposem que prenem una mostra aleatòria simple de $X$ de mida $n$ qualsevol i que hi obtenim $x_0$ èxits, de manera que $\widehat{p}_X=x_0/n$.

Si $H_0$ és vertadera, el nombre d'èxits en una mostra aleatòria simple segueix una distribució $B(n,p_0)$. Ho podem usar per calcular p-valors de la manera usual:

* Si $H_{1}:p>p_{0}$, el p-valor és $P(B(n,p_0)\geq x_0)$

* Si $H_{1}:p<p_{0}$, el p-valor és $P(B(n,p_0)\leq x_0)$

* Si $H_{1}:p\neq p_{0}$, el p-valor és $2\min\{P(B(n,p_0)\leq x_0),P(B(n,p_0)\geq x_0)\}$

Aquest test binomial exacte està implementat en R en la funció `binom.test`

```{r,eval=FALSE}
binom.test(x, n, p=..., alternative=..., conf.level=...)
```

on `x` indica al nombre d'èxits, `n` la mida de la mostra, `p` la probablitat que es contrasta, i els altres dos paràmetres signifiquen el mateix que a les altres funcions explicades fins ara. L'interval de confiança que dóna en els contrastos bilaterals és el de Clopper-Pearson. 


```{example, esqUIB1}
Ens demanam si la proporció d'estudiants esquerrans a la UIB, és diferent de la de l'estat espanyol, que és del 10%.


```

Prenem un mostra de 30 estudiants de la UIB més o menys a l'atzar i hi trobam  1 esquerrà.

*Variable aleatòria d'interès*: $X$: "Prenem un estudiant de la UIB i miram si és esquerrà", de probabilitat d'èxit $p$

*Contrast*:
$$
\left\{\begin{array}{l}
H_{0}:p=0.1\\
H_{1}:p\neq 0.1
\end{array}
\right.
$$


Emprarem el test binomial exacte

*Estadístic de contrast*: Nombre d'èxits $S$, que si  $H_0$ és vertadera, té distribució $B(n,0.1)$

*Valor*: 1

*p-valor*:
$$
\begin{array}{l}
2\min\big\{P(S\geq 1), P(S\leq 1)\big\}\\
\qquad =2\min\big\{\texttt{1-pbinom(0,30,0.1)}, \texttt{pbinom(1,30,0.1)}\big\}\\
\qquad =2\min\big\{`r round(1-pbinom(0,30,0.1),3)`, `r round(pbinom(1,30,0.1),3)`\big\}
=`r round(2*min(c(round(1-pbinom(0,30,0.1),3),round(pbinom(1,30,0.1),3))),3)`
\end{array}
$$
*Conclusió*: No obtenim evidència estadísticament significativa que el poercentatge d'esquerrans a la UIB sigui diferent del 10%.

Amb R, entraríem:

```{r}
binom.test(1, 30, p=0.1, alternative="two.sided")
```

i a més obtenim l'IC 95% de Clopper-Pearson per a $p$.


#### Test aproximat {-}

Suposem que prenem una mostra aleatòria simple de $X$ de mida $n$ *gran*, posem de 40 subjectes o més, i que hi obtenim una prporció mostral d'èxits  $\widehat{p}_X$.
En aquest cas, si $H_{0}:p=p_{0}$ és vertadera, pel Teorema Central del Límit,
$$
Z=\frac{\widehat{p}_X-p_0}{\sqrt{\frac{p_0(1-p_0)}{n}}}\approx N(0,1)
$$
Ho podem emprar per calcular p-valors i intervals de confiança: si $Z$ pren el valor $z_0$,

* Quan $H_{1}:p>p_{0}$, el p-valor és $P(Z\geq z_0)$

* Quan $H_{1}:p<p_{0}$, el p-valor és $P(Z\leq z_0)$

* Quan $H_{1}:p\neq p_{0}$, el p-valor és $2P(Z\geq |z_0|)$ (recordau que $Z$ és simètrica)


Amb R,  està  implementat en la funció 

```{r,eval=FALSE}
prop.test(x, n, p=...,alternative=..., conf.level=..., correct=...)
```

on els paràmetres tenen el mateix significat que a `binom.test` excepte `correct`, que serveix per especificar si volem que s'apliqui una correcció de continuïtat que millora els resultats. El seu valor per defecte és `TRUE`, i és el que us reconaman que empreu; el que hem explicat aquí correspon a `correct=FALSE`. L'interval de confiança que dóna aquesta funció en un contrast bilateral és el de Wilson (amb o sense correcció de continuïtat, segons el que valgui `correct`).

```{example}
Continuant amb l'Exemple \@ref(exm:esqUIB1), ara hi emprarem  el test aproximat, tot i que no és lo seu.


```


*Estadístic de contrast*:
$$
Z=\frac{\widehat{p}_X-p_0}{\sqrt{\frac{p_0(1-p_0)}{n}}} 
$$
que, si $H_0$ és vertadera, seguiria una distribució (aproximadament) normal estándard.

*Valor sobre la nostra mostra*:
$$
z_0=\frac{\frac{1}{30}-0.1}{\sqrt{\frac{0.1(1-0.1)}{30}}}=-1.22
$$

*p-valor*: $2P(Z\geq 1.22)=\texttt{2*(1-pnorm(1.22))}=`r round(2*(1-pnorm(1.22)),3)`$


*Conclusió*: Un altre cop, no obtenim evidència estadísticament significativa que el percentatge d'esquerrans a la UIB sigui diferent del 10%.

Amb R, entraríem:

```{r,warning=TRUE}
prop.test(1, 30, p=0.1, alternative="two.sided")
```

No dóna el mateix p-valor que abans, perquè, com hem explicat, el nostre test correspon a `correct=FALSE`:

```{r,warning=TRUE}
prop.test(1, 30, p=0.1, alternative="two.sided", correct=FALSE)
```

```{example}
Quina és la potència d'aquest contrast aproximat?


```

Emprarem les funcions del paquet **pwr** per calcular-la. Primer calculam la mida de l'efecte observat amb la funció `ES.h` aplicada a la proporció poblacional contrastada i a la proporció mostral:

```{r}
library(pwr)
ES.h(0.1,0.03)
```
I ara aplicam la funció `pwr.p.test` a la mida de l'efecte observat, `h`, la mida de la mostra, `n`, el nivell de significació, `sig.level`, i el tipus de contrast, `alternative`, i ens donarà la potència:

```{r}
pwr.p.test(h=295, n=30, sig.level=0.05, alternative="two.sided")
```

Què hagués passat si en lloc de 1 esquerrà en una mostra de 30 haguéssim trobat 5 esquerrans en una mostra (aleatòria simple) de 150 estudiants, de manera que la proproció mostral es manté?

```{r}
prop.test(5, 150, p=0.1)
```

Ara podríem rebutjar amb un nivell de significació del 5% que la proporció d'esquerrans a la UIB és del 10%. Quina ha estat la potència d'aquest test?

```{r}
pwr.p.test(h=0.3, n=150, sig.level=0.05, alternative="two.sided")
```

Amb una mostra més gran, la potència és més gran, és més fàcil detectar que la hipòtesi alternativa sigui vertadera.


```{example}
De quina mida hauríem d'haver pres la mostra per obtenir una potència del 90% amb $\alpha=0.05$ i esperant un efecte petit?


```

Per determinar el valor d'un "efecte petit" entram

```{r}
cohen.ES(test="p",size="small")
```

i ara, a l'argument `pwr.p.test`, en lloc d'entrar-hi la mida de la mostra `n`, hi entram la potència desitjada i ens donarà la mida necessària per assolir-la: 
```{r}
pwr.p.test(h=0.2, power=0.9, sig.level=0.05, alternative="two.sided")
```


```{block2,type="rmdnote"}
Com que en un contrast d'una proporció sempre hi podem emprar el test binomial exacte, no hi ha necessitat d'emprar-hi tests no paramètrics.
```

### Contrastos per a 2 proporcions emprant mostres independents

Siguin $X_1$ i $X_2$ dues variables aleatòries Bernoulli de paràmetres poblacionals d'èxit $p_1$ i $p_2$.

Volem realitzar un contrast
$$
\left\{\begin{array}{l}
H_{0}:p_1=p_2\\ 
H_{1}:p_1\neq p_2\text{ o }p_1> p_2\text{ o }p_1< p_2
\end{array}
\right.
$$

Suposem que, per realitzar aquest contrast, prenem una mostra aleatòria simple de cada variable, independents una de l'altra. 
Obtenim la taula de freqüències següent
$$
\begin{array}{r|cc|c }
  & X_1 & X_2 & \textrm{Total}  \\\hline
\textrm{Èxits} & n_{11} & n_{12} & E  \\
\textrm{Fracassos} & n_{21} & n_{22} & F   \\\hline 
\textrm{Total} & n_{1} & n_{2} 
\end{array}
$$

Aleshores tenim dues opcions: realitzar un test $\chi^2$, que empra una aproximació a una normal i requereix que les dues mostres siguin grans, o un test exacte no dóna la informació exactament com la voldríem.


#### Test $\chi^2$ {-}

Suposem que les dues mostres són *grans*, per fixar idees $n_1,n_2\geq 50$, i que els nombres d'èxits i de fracasos a cada mostra *no són molt petits*, per fixar idees tots dos més grans o iguals que 5. Siguin $\widehat{p}_1$ i $\widehat{p}_2$  les proporcions mostrals d'èxits a les dues mostres.

En aquestes condicions, si la hipòtesi nul·la $H_0: p_1=p_2$ és vertadera, l'*estadístic de contrast*
$$
Z=\frac{\widehat{p}_1 -\widehat{p}_2}{
\sqrt{\frac{E}{n_1
+n_2}\cdot \Big(1-\frac{E}{n_1
+n_2}\Big)\cdot \Big(\frac{1}{n_1}+\frac{1}{n_2}
\Big)}}
$$
($E=n_1 \widehat{p}_1 +n_2 \widehat{p}_2$ és el nombre total d'èxits a les dues mostres) té distribució aprosimadament normal estàndard, la qual cosa es pot emprar com sempre per calcular p-valors i intervals de confiança.

Aquest test està implementat en la funció de R

```{r,eval=FALSE}
prop.test(c(x1,x2), c(n1,n2) ,alternative=..., conf.level=..., correct=...)
```

on `x1` i `x2`  són els nombres d'èxits a les dues mostres i `n1`, `n2` les seves mides. Com al cas d'una proporció, la versió que hem explicat correspon a `correct=FALSE`, és més recomanable emprar el valor per defecte de `correct`, que és TRUE i fa que s'hi apliqui una correcció de continuïtat.



```{block2,type="rmdnote"}
Aquest test s'anomena **prop-test**, o també **test** $\chi^2$ perquè és un cas particular d'un test $\chi^2$ que veurem més endavant. En la seva implementació en R no s'hi empra $Z$ sinó $Z^2$, que té distribució aproximadament $\approx\chi^2_1$.
```



```{example,allel1}
Es volgué saber si un determinat al·lel d'un gen és present o no amb la mateixa proporció entre els mallorquins i els menorquins.
Es prengueren una mostra d'ADN de 100 individus amb almenys tres generacions familiars a l'illa de Mallorca, i una altra de 50 individus amb almenys tres generacions familiars a l'illa de  Menorca: les mostres es prengueren de manera independent. A la mostra mallorquina, 20 individus el tengueren, i a la mostra menorquina, 12. La taula de freqüències és, doncs


```

$$
\begin{array}{r|cc }
  & \textrm{Mallorca} & \textrm{Menorca}  \\\hline
\textrm{Present} & 20 & 12 \\
\textrm{Absent} & 80 & 38   \\\hline 
\textrm{Total} & 100 & 50   
\end{array}
$$

*Variables d'interés*: 
* $X_1$: Prenem un mallorquí amb 3 generacions familiars a l'illa i miram si té aquest al·lel. 
* $X_2$: Prenem un menorquí amb 3 generacions familiars a l'illa i miram si té aquest al·lel. 

Són Bernoulli, de  proporcions poblacionals d'èxit $p_1$ i $p_2$, respectivament.


*Contrast*:
$$
\left\{\begin{array}{l}
H_0:p_1=p_2\\
H_1:p_1\neq p_2
\end{array}\right.
$$

Estam les condicions de poder emprar el test $\chi^2$, perquè les dues mostres són prou grans.

*Estadístic de contrast*: 
$$
Z=\frac{\widehat{p}_1 -\widehat{p}_2}{
\sqrt{\frac{n_1 \widehat{p}_1 +n_2 \widehat{p}_2}{n_1
+n_2}\cdot \Big(1-\frac{n_1 \widehat{p}_1 +n_2 \widehat{p}_2}{n_1
+n_2}\Big)\cdot\Big(\frac{1}{n_1}+\frac{1}{n_2}
\Big)}}
$$
que és aproximadament $N(0,1)$ si $H_0$ és vertadera.


*Valor de l'estadístic*: $\widehat{p}_1=0.2$, $\widehat{p}_2=0.24$, $n_1=100$, $n_2=50$, $E=32$ i per tant
$$
z_0=\frac{0.2 -0.24}{
\sqrt{\frac{32}{150}\Big(1-\frac{32}{150}\Big)\Big(\frac{1}{100}+\frac{1}{50}
\Big)}}
=-0.5637
$$

*p-valor*: $2\cdot P(Z\geq 0.5637)=0.573$


*Conclusió*: No hem trobat evidència esatdísticament significativa que les proprocions de mallorquins i menorquins amb aquest al·lel siguin diferents. 

Amb R, entraríem

```{r}
prop.test(c(20,12), c(100,50), alternative="two.sided")
```

Bé, no exactament: com hem explicat, nosaltres hem fet la versió `correct=FALSE`.


```{r}
prop.test(c(20,12), c(100,50), alternative="two.sided", correct=FALSE)
```

#### Test exacte de Fisher {-}

Si no se satisfan les condicions pel test $\chi^2$, sempre es pot aplicar el *test exacte de Fisher*, que es basa en la idea següent.
Tenim la taula de freqüències
$$
\begin{array}{r|cc|c }
  & X_1 & X_2 & \textrm{Total}  \\\hline
\textrm{Èxits} & n_{11} & n_{12} & E  \\
\textrm{Fracassos} & n_{21} & n_{22} & F   \\\hline 
\textrm{Total} & n_{1} & n_{2} 
\end{array}
$$

Si $p_1=p_2$, la probabilitat d'obtenir $n_{11}$ èxits dins $X_1$ és la de:

> Si en una bossa hi tenim $E$ bolles "Èxit" i $F$ bolles "Fracàs", la probabilitat d'obtenir $n_{11}$ bolles "Èxit" si en triam $n_{1}$ de cop.

Per tant, la distribució de $n_{11}$ és hipergeomètrica $H(E,F,n_{1})$. Podem emprar $n_{11}$ com a estadístic de contrast i la distribució hipergeomètrica per calcular p-valors. 

```{example, SIDS1}
Per determinar si la Síndrome de Mort Sobtada del Nadó (SIDS) té component genètic, es consideren els casos de SIDS en parelles de bessons monozigòtics i dizigòtics. Diguem: 
  

```

* $p_1$: proporció de parelles de bessons monozigòtics amb algun cas de SIDS on només un germà la sofrí

* $p_2$: proporció de parelles de bessons dizigòtics amb algun cas de SIDS on només un germà la sofrí

Si la SIDS té component genètic, hauria de passar que $p_1<p_2$: si en una parella de bessons un d'ells mor per SIDS i aquesta síndrome té component genètic, és més probable que l'altre bessó també la sofreixi si els bessons són monozigòtics que si són dizigòtics, i per tant *és menys probable que l'altre bessó no la sofreixi si els bessons són monozigòtics que si són dizigòtics*. 

Per tant  el contrast que volem realitzar és
$$
\left\{\begin{array}{l}
H_0:p_1=p_2\\
H_1:p_1< p_2
\end{array}\right.
$$


En un estudi s'obtingueren les dades següents:
$$
\begin{array}{c}
\hphantom{Monozigotic} \textbf{Tipus de bessons} \\  
\begin{array}{lr|cc|c}
 & & \textrm{Monozigòtics} & \textrm{Dizigòtics} & \textrm{Total} \\ \hline
 \textbf{Casos} & \textrm{Un}  & 23 & 35 & 58\\
 \textbf{de SIDS} & \textrm{Dos} & 1 & 2 & 3\\\hline
 & \textrm{Total}  & 24 & 37 & 
\end{array}
\end{array}
$$

Emprarem el test de Fisher, ja que ni les mostres ni els nombres de "fracassos" no són prou grans per poder emprar el test $\chi^2$. 

*p-valor*:
$$
P(H(58,3,24)\leq 23) =\texttt{phyper(23,58,3,24)}=0.7841
$$

*Conclusió*: No podem rebutjar la hipòtesi nul·la, i per tant no hem trobat evidència estadísticament significativa que la SIDS tengui un component genètic.


Amb R el test de Fisher està implementat en la funció 
```{r,eval=FALSE}
fisher.test(M,alternative=...,conf.level=...)
``` 
on `M` és la matriu de freqüències de la mostra tal i com l'hem donada: fileres Èxits i Fracassos (en aquest ordre) i columnes $X_1$ i $X_2$.

En el nostre exemple, entraríem
```{r}
M=matrix(c(23,35,1,2), nrow=2, byrow=TRUE)
fisher.test(M,alternative="less")
```

```{block2,type="rmdcaution"}
La funció `fisher.test` no compara $p_1$ i $p_2$, sinó les seves **odds** (**oportunitats**; en castellà, també *momios*)
$$
\frac{p_1}{1-p_1}\text{ i }\frac{p_2}{1-p_2}
$$
i l'interval de confiança que dóna és per al quocient d'aquestes *odds*: la seva **odds ratio** (**OR**, **raó d'oportunitats**; en castellà, també *razón de momios*).
```

Fem un incís sobre les *odds*. Les **odds** d'un esdeveniment $A$ són
$$
\text{Odds}(A)=\frac{P(A)}{P(A^c)}=\frac{P(A)}{1-P(A)}
$$
i indiquen quantes vegades és més probable $A$ que "no $A$".

Per exemple:

* Si $P(A)=0.3$, $\text{Odds}(A)=0.3/0.7=0.43$

* Si $P(A)=0$, $\text{Odds}(A)=0$

* Si $P(A)=0.5$, $\text{Odds}(A)=1$

* Si $P(A)=1$, $\text{Odds}(A)=\infty$

Fixau-vos que si coneixeu $\text{Odds}(A)$, podeu aïllar $P(A)$. Per exemple si $\text{Odds}(A)=0.6$
$$
\begin{array}{l}
0.6=\dfrac{P(A)}{1-P(A)}\Rightarrow 0.6-0.6P(A)=P(A)\\
\qquad \Rightarrow 0.6=1.6P(A)\Rightarrow P(A)=\dfrac{0.6}{1.6}=0.375
\end{array}
$$
En general
$$
P(A)=\dfrac{\text{Odds}(A)}{1+\text{Odds}(A)}
$$

D'aquí podeu deduir fàcilment que
$$
\begin{array}{c}
\text{Odds}(A)<\text{Odds}(B)\Longleftrightarrow P(A)<P(B)\\ 
\text{Odds}(A)=\text{Odds}(B)\Longleftrightarrow P(A)=P(B)
\end{array}
$$
i per tant comparant les probabilitats o les *odds* de dos esdeveniments obteniu la mateixa informació sobre quin és més probable.

```{blok2,type="rmdcaution"}
Si, per exemple, la *odds ratio* de $A$ i $B$ és
$$
  \text{OR}(A,B)=\frac{\text{Odds}(A)}{\text{Odds}(B)}=1.5
$$
i per tant $\text{Odds}(A)=1.5\text{Odds}(B)$:

* Com que en particular $\text{Odds}(A)> \text{Odds}(B)$, podeu concloure que $P(A)>P(B)$

* Però el fet que $\text{Odds}(A)=1.5\text{Odds}(B)$ **no implica** que $P(A)=1.5P(B)$. De fet, de $OR(A,B)$ no podeu deduir el valor de $P(A)/P(B)$. Intentau-ho si no ens creieu.

```

```{example}
Si realitzam el contrast de l'Exemple \@ref(exmallel1) amb el test $\chi^2$, obtenim


```

```{r}
prop.test(c(20,12),c(100,50),alternative="two.sided",correct=FALSE)
```


* El p-valor 0.5729 no ens permet rebutjar que les proporcions de mallorquins i menorquins amb l'al·lel objecte d'estudi siguin diferents

* L'IC 95% per a la diferència de proporcions va de -0.18 a 0.1: com que conté el 0, no podem rebutjar amb aquest nivell de confiança que les proporcions siguin iguals

* La diferència de proporcions mostrals $p_1-p_2$ ha estat $0.2-0.24=-0.04$: la proporció de menorquins amb l'al·lel a la nostra mostra ha estat 4 punts percentuals més gran que la dels mallorquins


Si ara l'efectuam amb el test de Fisher:

```{r}
M.A=matrix(c(20,12,80,38), nrow=2, byrow=T)
fisher.test(M.A.G)
```


* El p-valor 0.673 no ens permet rebutjar que les **odds** de tenir aquest al·lel entre els mallorquins i els menorquins siguin la mateixa; com que igualtat d'*odds* és equivalent a igualtat de probabilitats, no podem rebutjar que els mallorquins i menorquins tenguin probabilitats diferents de tenir l'al·lel objecte d'estudi

* L'IC 95% per a la **odds ratio**  (per al quocient de les *odds*) va de 0.33 a 1.97: com que conté el 1, no podem rebutjar amb aquest nivell de confiança que la *odds ratio* sigui 1 i que per tant les *odds* (i per tant les proporcions) siguin iguals

* El *quocient d'odds mostrals* (la **odds ratio mostral**) ha estat 0.79: a la nostra mostra, les *odds* que un mallorquí tengués l'al·lel han estat 0.79 vegades (un 21% més petites que) les d'un menorquí; però això no ens dóna cap relación numèrica entre les proporcions mostrals de mallorquins i menorquins amb l'al·lel.


### Contrastos per a 2 proporcions emprant mostres aparellades

Siguin  una altra vegada $X_1$ i $X_2$ dues variables aleatòries Bernoulli de paràmetres poblacionals $p_1$ i $p_2$.
Seguim volent  realitzar un contrast
$$
\left\{\begin{array}{l}
H_{0}:p_1=p_2\\ 
H_{1}:p_1\neq p_2\text{ o }p_1> p_2\text{ o }p_1< p_2
\end{array}
\right.
$$
però ara les mesuram sobre els subjectes d'una mateixa mostra, o sobre els subjectes de dues mostres aparellades, de mida $n$.
Suposem que tenim els resultats en una taula

$$
\begin{array}{c}
\text{Variable $X_2$}\\
\begin{array}{l|r|c|c|}
 &\text{Èxit} & \text{Fracàs} \\ \cline{2-4}
\text{Variable} & \text{Èxit} & a & b \\\cline{2-4}
X_1 & \text{Fracàs} & c & d\\ \cline{2-4}
\end{array}
\end{array}
$$



<!--


\frametitle{2 props., mostres aparellades}

Quan el test és \red{bilateral}, si  $n$ és prou gran ($\geq 100$) i si el nombre de \emph{casos discordants} ($b+c$ en la taula anterior) és grandet ($\geq 20$), es pot emprar el \emph{test de McNemar}, que empra l'estadístic
$$
Z^2=\frac{(b-c)^2}{b+c}
$$
que és aproximadament $\chi^2_1$ si $H_0$ és vertadera

Està implementat en la funció \red{\texttt{mcnemar.test}}: s'aplica a la taula de freqüències absolutes anterior




\frametitle{Exemple 8}\vspace*{-2ex}

Es volgué comparar l'efectivitat d'un fàrmac nou contra la migranya amb la d'un placebo

Es prengué una mostra de $500$ persones afectades per migranya. A cada una, a l'atzar, se li administrà el fàrmac o el placebo. Se'ls demanà si havien notat alleujament en el dolor.


Al cap d'un temps, als mateixos individus se'ls subministrà l'altre tractament (fàrmac als que havien rebut placebo, 
placebo als que havien rebut fàrmac) i se'ls tornà a demanar si havien notat o no milloria

Els resultats varen ser:
$$
\begin{tabular}{c|c|cc|}
\multicolumn{2}{c}{}& \multicolumn{2}{c} {Placebo}\\\cline{3-4}
\multicolumn{2}{c|}{} & Sí & No \\\hline
Fàrmac & Sí & 150 & 41 \\
& No & 19 & 285
\\\hline
\end{tabular}
$$





\frametitle{Exemple 8} 

\red{Variables d'interès:}

*$X_1$: Trobar  milloria amb el fàrmac, de proporció poblacional $p_1$

*$X_2$: Trobar  milloria amb el placebo, de proporció poblacional $p_2$



\red{Contrast}: Volem emprar el test de McNemar, per tant ha de ser bilateral
$$
\left\{\begin{array}{l}
H_0:p_1=p_2\\
H_1:p_1\neq  p_2
\end{array}\right.
$$





\frametitle{Exemple 8} 

```{r}
Dades.M=matrix(c(150,41,19,285), nrow=2,
     byrow=T)
mcnemar.test(Dades.M)
```

Podem rebutjar que tenen la mateixa taxa d'efectivitat, i com que la taxa d'efectivitat del fàrmac ha estat superior a la del placebo 
($191/500$ contra $169/500$) concloem que la diferència és perquè el fàrmac es més efectiu






\frametitle{Test binomial exacte}\vspace*{-2ex}

Si no podeu emprar el test de McNemar, sempre podeu emprar un \emph{test binomial exacte}

Considerau la taula de probabilitats
\begin{center}
\begin{tabular}{l|l|c|c|}
\multicolumn{2}{c}{\ } & \multicolumn{2}{c}{Variable $X_2$}\\ \cline{3-4}
\multicolumn{2}{c|}{\ } &Èxit & Fracàs \\ \cline{2-4}
Variable & Èxit & $p_{11}$ & $p_{10}$ \\
$X_1$ & Fracàs & $p_{01}$ & $p_{00}$\\ \cline{2-4}
\end{tabular}
\end{center}
Llavors
$$
p_1=p_{11}+p_{01},\ p_2=p_{11}+p_{10}
$$
i per tant
$$
\begin{array}{l}
p_1=p_2\Longleftrightarrow   p_{10}=p_{01}\\
p_1\neq p_2\Longleftrightarrow   p_{10}\neq p_{01}\\
p_1< p_2\Longleftrightarrow   p_{10}< p_{01}\\
p_1> p_2\Longleftrightarrow   p_{10}> p_{01}
\end{array}
$$






\frametitle{Test binomial exacte}

Això permet traduir un contrast sobre $p_1$ i $p_2$ en el mateix  contrast sobre $p_{01}$ i $p_{10}$ i al final en un contrast d'una proporció

Per exemple:
$$
\begin{array}{rl}
\left\{\begin{array}{l}
H_0: p_1=p_2\\
H_1: p_1> p_2
\end{array}\right. & 
\Longleftrightarrow
\left\{\begin{array}{l}
H_0: p_{10}=p_{01}\\
H_1: p_{10}>p_{01}
\end{array}\right.\\[3ex]
 & \Longleftrightarrow
\left\{\begin{array}{l}
H_0: \dfrac{p_{10}}{p_{10}+p_{01}}=0.5\\[2ex]
H_1:  \dfrac{p_{10}}{p_{10}+p_{01}}>0.5
\end{array}\right.
\end{array}
$$



\frametitle{Test binomial exacte}\vspace*{-2ex}
$$
\left\{\begin{array}{l}
H_0:  p_{10}/(p_{10}+p_{01})=0.5\\
H_1:   p_{10}/(p_{10}+p_{01})>0.5
\end{array}\right.
$$

\red{$p_{10}/(p_{10}+p_{01})$} és la proporció poblacional de (Èxit,Fracàs) dins la població de casos discordants

Aquest darrer contrast el podem efectuar amb un test binomial exacte amb:


*\blue{Mostra}: Casos discordants, de mida $b+c$
*\blue{Èxits}: Èxit a $X_1$ i Fracàs a $X_2$, de mida  $b$
*\blue{Proporció a contrastar}:  $p=0.5$


Mirau només el p-valor (l'IC serà per a $p_{10}/(p_{10}+p_{01})$, no té res a veure amb $p_1-p_2$ o $p_1/p_2$)






\frametitle{Exemple 8}\vspace{-6ex}
{\small 
$$
\begin{tabular}{c|c|cc|}
\multicolumn{2}{c}{}& \multicolumn{2}{c} {Placebo}\\\cline{3-4}
\multicolumn{2}{c|}{} & Sí & No \\\hline
Fàrmac & Sí & 150 & 41 \\
& No & 19 & 285
\\\hline
\end{tabular}
$$

}
```{r}
binom.test(41, 60, p=0.5, alt="greater")
```






-->

<!--chapter:end:05-Contrastos2.Rmd-->

