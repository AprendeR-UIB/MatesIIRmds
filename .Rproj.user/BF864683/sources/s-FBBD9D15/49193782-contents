# Contrastos d'independència i homogeneïtat

En els contrastos d'independència, la hipòtesi nul·la és que dues variables són independents, és a dir, que la distribució d'una no depèn dels valors que prengui l'altra. Aquí només considerarem contrastos d'independència de parells de variables que només puguin prendre un nombre finit de  valors possibles. En aquest cas, traduint la independència de dues variables en termes de "la probabilitat de la intersecció és el producte de probabilitats", resultarà que un contrast d'independència és un tipus concret de contrast de bondat d'ajust i podrem emprar-hi un test $\chi^2$ (al pitjor dels casos, de Montecarlo si les mostres no satisfan les condicions necessàries per poder aplicar el Teorema \@ref(thm:khi2BA)).

## Test $\chi^2$ d'independència

Suposem que tenim dues variables aleatòries $X$ i $Y$ que només poden prendre valors $X_{1},\ldots,X_{s}$ i $Y_{1},\ldots,Y_{t}$, respectivament. Les considerarem qualitatives, i aleshores aquests $X_i$ i $Y_j$ seran els seus nivells, però poden ser ordinals o quantitatives discretes. L'inportant és que només poden prendre un conjunt finit de valors cadascuna.

Volem contrastar si $X$ i $Y$ són independents, és a dir
$$
\begin{array}{l}
\hspace{-2ex}P(X=X_i\mid Y=Y_j)=P(X=X_i\mid Y=Y_{j'})=P(X=X_i)\text{ per a tots $i,j,j'$}\\ 
\hspace{-2ex}P(Y=Y_j\mid X=X_i)=P(Y=Y_j\mid X=X_{i'})=P(Y=Y_j)\text{ per a tots $i,i',j$}
\end{array}
$$
o equivalentment
$$
P(X=X_i,Y=Y_j)=P(X=X_i)P(Y=Y_j)\text{ per a tots $i,j$}
$$


El contrast serà
$$
\left\{\begin{array}{l}
H_0: \mbox{$X$ i $Y$ són independents}\\
H_1: \mbox{$X$ i $Y$ són dependents}
\end{array}
\right.
$$

Sovint en lloc de dir que "$X$ i $Y$ són dependents", direm que "hi ha **associació** entre $X$ i $Y$".

Fixem-nos ara que la caracterització de la independència com a 
$$
P(X=X_i,Y=Y_j)=P(X=X_i)P(Y=Y_j)\text{ per a tots $i,j$}
$$
ens permet entendre el contrast d'independència com un contrast de bondat d'ajust, amb hipòtesi nul·la
$$
H_0: P(X=X_i,Y=Y_j)=P(X=X_i)P(Y=Y_j)\text{ per a tots $i,j$}
$$
Hi farem servir un test $\chi^2$.

```{block2,type="rmdnote"}
El contrast d'igualtat de dues proporcions és un cas particular de contrast d'independència: que l'esdeveniment "Èxit" sigui independent de la variable.
```

```{example,tosfumar1}
En un estudi es volgué determinar si hi ha associació entre l'hàbit de fumar i patir tos nocturna entre els nins.


```

S'entrevistà una mostra de 2847 nens de 12 anys i es recollí informació sobre el seu estatus de fumador i si patien de tos nocturna o no. S'obtingueren els resultats següents:
$$
\begin{array}{l}
\hphantom{No fumador ocasional un }\text{Fumador}\\
\begin{array}{l|ccc|c}
& \text{No fumador} & \text{Ocasional} & \text{Regular} & \text{Total} \\\hline
\text{Tos} & 266 & 395 & 80 & 741\\
\text{No tos}& 1037 & 977 & 92 & 2106\\\hline
\text{Total} &1303 & 1372 & 172 & 2847\\\hline
\end{array}
\end{array}
$$

En aquesta situació:

*Variables aleatòries  d'interès*: 
    * $X$: "Prenem un nin i avaluam el seu estatus de fumador"
    * $Y$: "Prenem un nin i miram si té tos nocturna o no"

*Contrast*:
$$
\left\{\begin{array}{l}
H_0: \mbox{$X$ i $Y$ són independents}\\
H_1: \mbox{Hi ha associació entre $X$ i $Y$}
\end{array}
\right.
$$

Anem a traduir ara un contrast d'independència com l'anterior en un contrast d'igualtat de distribucions de probabilitat. Diguem
$$
\begin{array}{c}
p_{ij}=P(X=X_i, Y=Y_j)\\
p_i=P(X=X_i)\quad
q_{j}=P(Y=Y_j)
\end{array}
$$
El test d'independència equival a contrastar
$$
\left\{
\begin{array}{ll}
H_0: p_{ij}=p_i \cdot q_j \text{ per a tots } 1\leq i \leq s,\ 1\leq j\leq t \\
H_1: \mbox{no totes aquestes igualtats són vertaderes}
\end{array}
\right.
$$
i per tant hi podem fer servir un test $\chi^2$. Els passos concrets seran els següents:


1. Mesuram les variables aleatòries sobre una mostra aleatòria simple de $n$ subjectes, i obtenim una taula de contingència de freqüències absolutes com la següent (on $n_{i,j}$ indica nombre de subjectes amb $X=X_i$ i $Y=Y_j$; $n_{i\bullet}$  indica nombre de subjectes amb $X=X_i$; i $n_{\bullet j}$  indica nombre de subjectes amb $Y=X_j$):

$$
\begin{array}{|c|cccccc|c|}
\hline X\backslash Y & Y_1 & Y_2 & \ldots & Y_j & \ldots
& Y_t & n_{i \bullet} \\
\hline X_1 & n_{11} & n_{12} & \ldots & n_{1j} & \ldots & n_{1t} &
n_{1
\bullet} \\ X_2 & n_{21} & n_{22} & \ldots & n_{2j} & \ldots &
n_{2t} &
n_{2 \bullet} \\ \vdots & \vdots & \vdots & \vdots & \vdots &
\vdots &
\vdots & \vdots \\ X_i & n_{i1} & n_{i2} & \ldots & n_{ij} &
\ldots &
n_{it} & n_{i \bullet} \\ \vdots & \vdots & \vdots & \vdots &
\vdots &
\vdots & \vdots & \vdots \\ X_s & n_{s1} & n_{s2} & \ldots &
n_{sj} &
\ldots & n_{st} & n_{s \bullet} \\ \hline n_{\bullet j} & n_{\bullet
1} &
n_{\bullet 2} & \ldots & n_{\bullet j} & \ldots & n_{\bullet t} &
n \\ 
\hline
\end{array}
$$

2. Estimam cada $p_i$ amb ${n_{i\bullet}}/{n}$ i cada $q_j$ amb ${n_{\bullet j}}/{n}$

3. Si les variables aleatòries fossin independents, tendríem les probabilitats teòriques
$$
p_{ij}=\frac{n_{i\bullet}}{n}\cdot \frac{n_{\bullet j}}{n}
$$
    i per tant la freqüència esperada de cada parell $(X_i,Y_j)$ és
$$
p_{ij}\cdot n=\dfrac{n_{i\bullet}}{n}\cdot \dfrac{n_{\bullet j}}{n}\cdot n=\dfrac{n_{i\bullet}\cdot n_{\bullet j}}{n}
$$ 

4. L'estadístic del test $\chi^2$ és doncs
$$
X^2=\sum\limits_{i=1}^s\sum\limits_{j=1}^t \frac{ \left( n_{ij}- \frac{n_{i\bullet}\cdot n_{\bullet j} }{n}
\right)^2 } {\frac{n_{i\bullet} \cdot n_{\bullet j}}{n}}
$$

    Si $n$ és gran (diguem $n\geq 30$) i cada freqüència esperada $n_{i\bullet}\cdot n_{\bullet j}/{n}$ és $\geq 5$,  aquest estadístic segueix aproximadament una llei $\chi^2$ amb $(s-1) \cdot (t -1)$ graus de llibertat.
    
```{block2,type="rmdimportant"}    
Hem estimat les $p_i$ i les $q_j$, i per tant hem estimat $s+t-2$ paràmetres (fixau-vos que en realitat només hem estimat $p_1,\ldots,p_{s-1}$ i $q_1,\ldots,q_{t-1}$, ja que $p_s$ i $q_t$ queden fixats per la regla "suma de probabilitats igual a 1"); per tant
el nombre de graus de lliberta és el nombre de classes, $st$ (una per cada combinació de possible valor de $X$ i possible valor de $Y$) menys 1 i menys el nombre de paràmetres estimats:
$$
\mbox{graus de llibertat}=st-1-(s+t-2)=(s-1)(t-1)
$$
```

5.  Si $X_0^2$ és el valor que pren l'estadístic de contrast a la nostra mostra, el p-valor del contrast és
$$
\text{p-valor}=P(\chi_{(s-1) \cdot (t -1)}^2\geq X_0^2)
$$

```{example,tosfumar2}
Continuem amb l'Exemple \@ref(exm:tosfumar). Ja teníem les variables i el contrast. Les freqüències observades són


```

$$
\begin{array}{l}
\hphantom{No fumador ocasional un }\text{Fumador}\\
\begin{array}{l|ccc|c}
& \text{No fumador} & \text{Ocasional} & \text{Regular} & \text{Total} \\\hline
\text{Tos} & 266 & 395 & 80 & 741\\
\text{No tos}& 1037 & 977 & 92 & 2106\\\hline
\text{Total} &1303 & 1372 & 172 & 2847\\\hline
\end{array}
\end{array}
$$

La mida de la mostra és gran. Calculem les freqüències esperades, per veure si són totes més grans o iguals que 5.


$$
\begin{array}{l|ccc}
& \text{No fumador} & \text{Ocasional} & \text{Regular} & \text{Total} \\\hline
\text{Tos} & $741\cdot 1303/2847$ & $741\cdot 1372/2847$ & $741\cdot 172/2847$  \\
\text{No tos}& $2106\cdot 1303/2847$ & $2106\cdot 1372/2847$ & $2106\cdot 172/2847$  \\\hline
\end{array}
$$
Operant:
$$
\begin{array}{l|ccc}
& \text{No fumador} & \text{Ocasional} & \text{Regular}  \\\hline
\text{Tos} & 339.14 &  357.1 & 44.77  \\
\text{No tos}& 963.86 & 1014.9 & 127.23  \\\hline
\end{array}
$$

Són totes prou grans. Per tant l'estadístic de contrast
$$
X^2=\sum_{i=1}^s\sum_{j=1}^t \frac{(obs_{ij}-esp_{ij})^2}{esp_{ij}}
$$

(on $s=2$ i $t=3$) seguirá una distribució $\chi^2_{(s-1)(t-1)}=\chi^2_2$.

*Valor de l'estadístic de contrast*:



$$
X_0^2=\frac{(266-339.14)^2}{339.14}+\frac{(395-357.1)^2}{357.1}+\cdots=64.24
$$

*p-valor*: $P(\chi^2_2\geq 64.24)=\texttt{1-pchisq(64.24,2)}=1.1\cdot 10^{-14}$

*Conclusió*: Hem trobat evidència estadísticament significativa que hi ha associació entre l'estatus de fumdaor d'un nin i patir tos nocturna (test $\chi^2$, p-valor 10^-14^).

Podem efectuar aquest contrast d'independència aplicant la funció \texttt{chisq.test} a la taula de freqüències absolutes:

```{r}
Taula=matrix(c(266,395,80,1037,977,92),nrow=2,byrow=TRUE)
Taula
chisq.test(Taula)
```

```{example,CCV}
Volem contrastar si hi ha associació entre el grau de compliment del calendari de vacunacions (CCV) dels nins i el nivell sociocultural dels  pares.


```

La taula següent mostra la classificació de  444 nens segons el seu CCV  i el nivell sociocultural dels pares
$$
\begin{array}{l}
\hphantom{CCV BaixBB}\text{Nivell sociocultural}\\
\begin{array}{l|ccc|}
\text{CCV} &\text{Baix}& \text{Mitjà} &\text{Alt}\\ \hline
\text{Baix} &38 &76 &79\\
\text{Mitjà-baix}& 2& 41& 92\\
\text{Mitjà-alt}& 2& 21& 50\\
\text{Alt}& 0 &12& 31
\end{array}
\end{array}
$$

*Variable aleatòries  d'interès*: 
    * $X$: "Prenem un nin i avaluam el seu CCV"
    * $Y$: "Prenem un nin i avaluam el nivell sociocultural dels pares"

*Contrast*:
$$
\left\{\begin{array}{l}
H_0: \mbox{$X$ i $Y$ són independents}\\
H_1: \mbox{Hi ha associació entre $X$ i $Y$}
\end{array}
\right.
$$

Fem un test $\chi^2$ amb R:

```{r,warning=TRUE}
TaulaCCV=matrix(c(38,76,79,2,41,92,2,21,50,0,12,31), 
                nrow=4, byrow=TRUE)
chisq.test(TaulaCCV)
```

R ens avisa que no es compleixen les condicions per usar el test $\chi^2$: segurament hi ha freqüències esperades petites.

Farem servir el mètode de Montecarlo

```{r}
set.seed(42)
chisq.test(TaulaCCV,simulate.p.value=TRUE,B=5000)
```

*Conclusió*: Hem trobat evidència estadísticament significativa que hi ha associació entre el grau de compliment del
calendari de vacunacions d'un nin i el nivell sociocultural dels seus pares (test $\chi^2$ de Montecarlo, p-valor 0.0002).


## Test $\chi^2$ d'homogeneïtat

Suposem ara que tenim $k$ variables aleatòries Bernoulli  $X_1,\ldots,X_k$, de probabilitats poblacionals $p_1,\ldots,p_k$. 
Volem contrastar si aquestes probabilitats poblacionals són iguals.

El contrast és
$$
\left\{
\begin{array}{ll}
H_0: \text{ $p_1=\cdots=p_k$}\\
H_1: \text{ Hi ha $i,j$ tals que $p_i \neq p_j$}
\end{array} 
\right.
$$

Triam una mostra aleatòria simple independent de cada $X_i$, $i=1,\ldots,k$,  per realitzar el contrast




Formalment, és exactament el mateix test que el d'independència, prenent
\begin{itemize}
\item una v.a.\ $X$ que tengui nivells $X_1,\ldots,X_k$
\item una  v.a.\ $Y$ binària de nivells ``Èxit'' i ``Fracàs''
\end{itemize}
Aquestes variables seran independents si, i només si, les probabilitats poblacionals $p_1,\ldots,p_k$ són iguals

Però el disseny de l'experiment és diferent:\smallskip

\begin{itemize}
\item \blue{Test d'independència}: prenem una sola mostra  \emph{transversal}, no controlam el nombre de subjectes de cada nivell $X_i$

\item \blue{Test d'homogeneïtat}: prenem una mostra \emph{estratificada}: una mostra de cada nivell, triant \textsl{a priori} el nombre de subjectes de cada nivell 
\end{itemize}




\frametitle{Exemple 7}
Volem comparar 3 tractaments (A,B,C) per baixar el nivell de colesterol. En un estudi, aplicam cada tractament a 100 pacients amb colesterol alt, i anotam si ha tengut èxit (baixat de 240 mg/dl) a les 5 setmanes. Resultats:

$$
\begin{array}{l|ccc|c}
\multicolumn{1}{c}{ }&\multicolumn{3}{c}{Tractament} & \\ 
& A & B & C & Total \\\hline
Èxit & 43 & 61 & 53 & 157\\
Fracàs& 57 & 39 & 47 & 143\\\hline
Total & 100 & 100 & 100 & 300\\\hline
\end{array}
$$
S'observen diferències en les taxes d'èxit?





\frametitle{Exemple 7}

\emph{Variables}:\smallskip

\begin{itemize}
\item $A$: tractam un pacient amb $A$ i miram si baixa de 240 mg/dl, de probabilitat poblacional $p_A$\smallskip

\item $B$, $C$ \ldots
\end{itemize}

\emph{Contrast}:
$$
\left\{\begin{array}{l}
H_0: p_A=p_B=p_C\\
H_1: \mbox{no és veritat que $p_A=p_B=p_C$}
\end{array}\right.
$$

És un test d'\emph{homogeneïtat}, farem servir un test $\chi^2$










\frametitle{Exemple 7}

```{r}
TaulaC=matrix(c(43,61,53,57,39,47), nrow=2,byrow=TRUE)
TaulaC
chisq.test(TaulaC)
```
El p-valor 0.04 indica que hi ha evidència significativa de diferència en algunes taxes de curació. Seria necessari comparar per parelles per trobar quines són diferents.




\frametitle{Test $\chi^2$ d'homogeneïtat}

Es pot contrastar l'homogeneïtat d'una situació més general

Tenim una v.a. $X$ de nivells $X_1,\ldots,X_k$, i una v.a. qualitativa $Y$ (no necessàriament binària)

Volem contrastar si la distribució de $Y$ sobre cada subpoblació definida per $X=X_j$ és la mateixa




\frametitle{Exemple 8}
Volem comparar 3 tractaments (A,B,C) per baixar el nivell de colesterol. En un estudi, aplicam cada tractament a 100 pacients amb colesterol alt, i anotam els nivells de colesterol a les 5 setmanes. Resultats 

$$
\begin{array}{l|ccc|c}
\multicolumn{1}{c}{ }&\multicolumn{3}{c}{Tractament} & \\ 
& A & B & C & Total \\\hline
$\leq 200$ & 12 & 21 & 13 & 46\\
200--240 & 31 & 40 & 40 & 111\\
$\geq 240$ & 57 & 39 & 47 & 143
\\\hline
Total & 100 & 100 & 100 & 300\\\hline
\end{array}
$$
S'observen diferències en les distribucions finals dels tres nivells de colesterol? 






\frametitle{Exemple 8}

\emph{Variables}:\smallskip

\begin{itemize}
\item $A$: tractam un pacient amb $A$ i anotam el nivell de colesterol on queda  (<<$\leq 200$>>, <<200--240>>, <<$\geq 240$>>)\smallskip

\item $B$, $C$ \ldots
\end{itemize}

\emph{Contrast}:
$$
\left\{\begin{array}{l}
H_0: \mbox{$A,B,C$ tenen les mateixes densitats}\\
H_1: \mbox{no és veritat que $A,B,C$ tenguin}\\
\hphantom{H_0: } \text{ les mateixes densitats}
\end{array}\right.
$$

És un test d'\emph{homogeneïtat}, farem servir un test $\chi^2$







\frametitle{Exemple 8}\vspace*{-2ex}

```{r}
TaulaC2=matrix(c(12,21,13,31,40,40,57,39,47), nrow=3, byrow=TRUE)
TaulaC2
```
En tenir més detall de l'efecte dels tractaments, obtenim un p-valor 0.09 que no ens permet rebutjar (a un nivell de confiança 0.05) que tenguin el mateix efecte

## Test $\chi^2$ de tendència


Es tracta d'una variant del test d'homogeneïtat de proporcions

Tenim una v.a. \red{ordinal} $X$ de nivells $X_1<\cdots< X_k$, i una v.a. Bernoulli $Y$

Volem contrastar si la probabilitat d'Èxit de $Y$ creix amb els nivells de $X$

Siguin $p_i=P(Y=1\mid X=X_i)$. El contrast és
$$
\left\{
\begin{array}{ll}
H_0: \text{ $p_1=\cdots=p_k$}\\
H_1: \text{ $p_1\leq\cdots \leq p_k$ i $p_1<p_k$}
\end{array} 
\right.
$$



\frametitle{Test $\chi^2$ de tendència}


Es duu a terme amb el \red{test $\chi^2$ de Cochran--Armitage}, una variant del test $\chi^2$ explicat fins ara

Per utilitzar-ho, basta que la mostra total sigui gran ($\geq 30$), no cal la condició de Cochran

Amb \texttt{R} s'efectua amb la funció \red{\tt prop.trend.test}, aplicada al vector de freqüències d'èxits i el vector de freqüències de cada nivell de $X$



\frametitle{Exemple 5 (revisitat)}
En un estudi es volgué determinar si hi ha associació entre l'hàbit de fumar i patir tos nocturna entre els nins, o si són independents.

S'entrevistà una mostra de 2847 nens de 12 anys i es recollí informació sobre el seu estatus de fumador i si patien de tos nocturna o no. Resultats:
$$
\begin{array}{l|ccc|c}
\multicolumn{1}{c}{ } &\multicolumn{3}{c}{Fumador} & \\ 
& No fumador & Ocasional & Regular & Total \\\hline
Tos & 266 & 395 & 80 & 741\\
No tos& 1037 & 977 & 92 & 2106\\\hline
Total &1303 & 1372 & 172 & 2847\\\hline
\end{array}
$$
És la tos nocturna independent de l'hàbit de fumar?

\red{L'estatus de fumador és una v.a. ordinal, i volem contrastar si la la probabilitat de tos creix amb el fumar}




\frametitle{Exemple 5 (revisitat)}

És adequat usar un test de tendència

```{r}
> Tos=c(266,395,80)
> Fum=c(1303,1372,172)
> prop.trend.test(Tos,Fum)

Chi-squared Test for Trend in

Proportions data: Tos out of Fum ,
using scores: 1 2 3
X-squared = 59.47, df = 1, 
p-value = 1.242e-14
```

El $p$-valor torna a pràcticament 0, rebutjam la hipòtesi nul·la




\end{document}