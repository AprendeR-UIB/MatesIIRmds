# Contrastos d'hipòtesis d'un i dos paràmetres

```{block2,type="rmdimportant"}
Per adquirir un poc de disciplina en la realització de contrastos d'hipòtesis, procurau, almenys per ara, dividir-los en els apartats següents:

1. Variables aleatòries d'interès i els paràmetres poblacionals involucrats en el contrast
  
2. Contrast
$$
\left\{\begin{array}{l}
H_{0}: ...\\
H_{1}: ... 
\end{array}
\right.
$$

I a partir d'aquí, si el feu "a mà":


3. Estadístic de contrast i distribució si la hipòtesi nul·la és vertadera

4. Valor de l'estadístic sobre la mostra

5. p-valor i si pot ser interval de confiança del nivell de significació demanat (0.05 per defecte)

6. Conclusió

I si el feu amb R:

3. L'efectuau amb R

4. Conclusió

Per a la conclusió, emprau la plantilla següent

> Hem obtingut evidència estadísticament significativa que passa tal cosa   (test realitzat, p-valor ..., IC 95% ...).
> No hem obtingut evidència estadísticament significativa que passa tal cosa  (test realitzat, p-valor ..., IC 95% ...).

```


## Contrastos de mitjanes

### Test t per a una mitjana

Si estam en una de les dues situacions següents: 

* $X$ una variable aleatòria normal amb mitjana $\mu$ i en prenem una mostra aleatòria simple de mida $n$ qualsevol

* $X$ una variable aleatòria qualsevol amb mitjana $\mu$ i en prenem una mostra aleatòria simple de mida $n$ gran (diguem que de mida com a mínim 30)

i volem realitzar un contrast
$$
\left\{\begin{array}{l}
H_{0}:\mu=\mu_0\\ 
H_{1}:\mu \neq\mu_0\text{ o }\mu >\mu_0\text{ o }\mu<\mu_0
\end{array}
\right.
$$
podem emprar el **test t** que ja hem explicat a la Secció \@ref(sec:exttest), basat en l'estadístic de contrast
$$
T= \frac{\overline{X}-\mu_{0}}{{\widetilde{S}_X}/{\sqrt{n}}}
$$
que, en les condicions donades i si $\mu=\mu_0$, té una distribució (aproximadament, si $X$ no és normal però $n$ és gran) $t_{n-1}$.

```{example, ttest1}
Una organització ecologista afirma que el pes  mitjà dels individus adults d'una espècie  ha disminuït dràsticament.
Se sap per les dades històriques que el pes mitjà poblacional era de 460 g.

```

Una mostra aleatòria de 50 individus d'aquesta espècie ha donat una mitjana mostral de 428 g i una desviació típica mostral de 119 g. Amb aquestes dades, podem afirmar  amb un nivell de significació del 5%  que el pes mitjà és inferior a 460 g?


*Variable aleatòria d'interès*: $X$: "Prenem un animaló d'aquests i mesuram el seu pes, en grams",  amb mitjana $\mu$

*Contrast*:
$$
\left\{\begin{array}{l}
H_{0}:\mu=460\\
H_{1}:\mu<460
\end{array}
\right.
$$

Prenem  nivell de significació $\alpha=0.05$.

*Estadístic de contrast*: Com que $n=50$ és  gran, podem usar
$$
T=\frac{\overline{X}-\mu_0}{{\widetilde{S}_X}/{\sqrt{n}}}
$$
que sí $H_0$ és vertadera serà (aproximadament) t de Student amb $n-1=49$ graus de llibertat

*Valor de l'estadístic*:
$$
\dfrac{428-460}{{119}/{\sqrt{50}}}=-1.9
$$

*p-valor*:
$$
P(T\leq -1.9)=\texttt{pt(-1.9,49)}=0.032
$$

*Interval de confiança del 95%*:
$$
\left(-\infty, \overline{X}+t_{n-1,1-\alpha}\cdot \frac{\widetilde{S}_X}{\sqrt{n}}\right]=(-\infty, 456.2]
$$


*Conclusió*: Com que el p-valor és més petit que 0.05,  concloem (amb $\alpha=0.05$) que el pes mitjà actual és més petit que 460 g. De fet, amb un 95% de confiança podem afirmar que el pes mitjà actual és inferior a 456.2 g, que està per davall dels 460 g.

Amb la plantilla que us hem donat:

> Hem obtingut evidència estadísticament significativa que el pes mitjà actual és menor que 460 g   (test t, p-valor 0.03, IC 95% de $-\infty$ a 456.2) i que per tant ha minvat en els darrers anys.


### Test t per a dues mitjanes

Si estam en una de les situacions següents:


* $X_1,X_2$ dues variables aleatòries normals de mitjanes $\mu_1$, $\mu_2$ i en prenem mostres aleatòries simples de mides $n_1$, $n_2$ qualssevol

* $X_1,X_2$ dues variables aleatòries qualssevol de mitjanes $\mu_1$, $\mu_2$ i en prenem mostres aleatòries simples de mides $n_1$, $n_2$ grans (diguem que cadascuna de mida com a mínim 30)

i volem realitzar un contrast
$$
\left\{\begin{array}{l}
H_{0}:\mu_1=\mu_2\\ 
H_{1}:\mu_1 \neq\mu_2\text{ o }\mu_1 >\mu_2\text{ o }\mu_1<\mu_2
\end{array}
\right.
$$
podem usar un **test t**, basat en un estadístic de contrast $T$ adequat que segueix una llei t de Student.

L'estadístic de contrast concret i els graus de llibertat de la seva distribució t de Student depenen:


* De si les dues mostres són **independents** (hem mesurat $X_1$ i $X_2$ sobre dues mostres obtingudes de manera independent una de l'altra) o **aparellades** (hem mesurat $X_1$ i $X_2$ sobre els subjectes d'una mateixa mostra o hi ha un aparellament natural entre els subjectes de les dues mostres)

* Quan les mostres són independents, també depenen de si $X_1$ i $X_2$ **tenen la mateixa variància o no** (la qual cosa es pot decidir amb un altre contrast: vegeu la Secció \@ref(sec:contrvar)); per a mostres de la mateixa mida de variables normals, la conclusió sol ser la mateixa

Quan les mostres són **aparellades**, podem entendre que tenim una sola mostra, formada per les diferències dels valors de $X_1$ i $X_2$ sobre les parelles. En aquest cas, traduïm
$$
\left\{\begin{array}{l}
H_{0}:\mu_1=\mu_2\\ 
H_{1}:\mu_1 \neq\mu_2\text{ o }\mu_1 >\mu_2\text{ o }\mu_1<\mu_2
\end{array}
\right.
$$
en
$$
\left\{\begin{array}{l}
H_{0}:\mu_1-\mu_2=0\\ 
H_{1}:\mu_1-\mu_2 \neq0\text{ o }\mu_1-\mu_2 >0\text{ o }\mu_1-\mu_2<0
\end{array}
\right.
$$
on $\mu_1-\mu_2$ és la mitjana de $X_1-X_2$, i el consideram un contrast d'una sola mitjana, emprant com a mostra les diferències $X_1-X_2$ a les parelles.

Per tant, quan les mostres són aparellades, si diem $\overline{D}$ a la mitjana mostral de $X_1-X_2$ i $\widetilde{S}_D$ a la desviació típica mostral de $X_1-X_2$ sobre la mostra de parelles i diem $n$ a la mida de la mostra de parelles,  l'estadístic de contrast és
$$
T=\frac{\overline{D}}{\widetilde{S}_D/\sqrt{n}}
$$
que, quan $\mu_1-\mu_2=0$, té (aproximadament, en el cas que $X_1,X_2$ no siguin normals però la $n$ sigui gran) distribució $t_{n-1}$.


Quan les mostres són **independents**, siguin $\overline{X}_1$ i $\widetilde{S}^2_1$ la mitjana mostral i la variància mostral de la mostra de $X_1$ i $\overline{X}_2$ i $\widetilde{S}^2_2$ la mitjana mostral i la variància mostral de la mostra de $X_2$. Diguem, a més, $\sigma_1^2$ i $\sigma_2^2$ a les variàncies (poblacionals) de $X_1$ i $X_2$. Aleshores:


* Si $\sigma_1^2=\sigma_2^2$, l'estadístic de contrast és
$$
T=\frac{\overline{X}_1-\overline{X}_2}{\sqrt{(\frac{1}{n_1}+\frac{1}{n_2})\cdot 
\frac{(n_1-1)\widetilde{S}_1^2+(n_2-1)\widetilde{S}_2^2}{n_1+n_2-2}}}
$$
que, quan $\mu_1=\mu_2$, té distribució (aproximadament, en el cas que $X_1,X_2$ no siguin normals però $n_1$ i $n_2$ siguin grans) $t_{n_1+n_2-2}$


* Si $\sigma_1^2\neq \sigma_2^2$, l'estadístic de contrast és
$$
T=\frac{\overline{X}_1-\overline{X}_2}{\sqrt{\frac{\widetilde{S}_1^2}{n_1}+\frac{\widetilde{S}_2^2}{n_2}}}
$$
que, quan $\mu_1=\mu_2$, té distribució (aproximadament, en el cas que $X_1,X_2$ no siguin normals però $n_1$ i $n_2$ siguin grans) $t_{\nu}$ amb
$$
\nu=\frac{\displaystyle \left( \frac{\widetilde{S}_1^2}{n_1}+\frac{\widetilde{S}_2^2}{n_2}\right)^2}
{\displaystyle \frac{1}{n_1-1}\left(\frac{\widetilde{S}_1^2}{n_1}\right)^2+\frac{1}{n_2-1}\left(\frac{\widetilde{S}_2^2}{n_2}\right)^2}
$$

```{block2,type="rmdmercifulgod"}
No cal que sapigueu aquestes fórmules per a mostres independents, només que l'estadístic de contrast i la seva distribució depenen de si les variàncies poblacionals són iguals o diferents.
```

El nombre de graus de llibertat de la distribució t de Student usada en un contrast sobre dues mostres de mida $n$:

* Si les mostres són aparellades, és $n-1$

* Si les mostres són independents, és aproximadament $2(n-1)$

Això fa que la probabilitat d'error de Tipus I del contrast amb mostres aparellades (a igualtat de la resta de valors) sigui més petita. Per exemple, suposem que volem realitzar el contrast
$$
\left\{
\begin{array}{l}
H_0: \mu_1=\mu_2\\
H_1: \mu_1>\mu_2
\end{array}
\right.
$$
i que l'estadístic de contrast $T$ sobre dues mostres de mides $n_1=n_2=20$ dóna 1.7. Aleshores

* Si les mostres són independents,
$$
\text{p-valor}=P(T>1.7)\approx \texttt{1-pt(1.7,38)}=0.0487
$$

* Si les mostres són aparellades,
$$
\text{p-valor}=P(T>1.7)=\texttt{1-pt(1.7,19)}=0.0527
$$

Per tant, amb nivell de significació $\alpha=0.05$, rebutjaríem la hipòtesi nul·la amb les mostres independents i l'acceptaríem amb les mostres aparellades.

### Tests t amb R

Tots aquests tests t estan implementats en la funció de R
```{r,eval=FALSE}
t.test(x, y, mu=..., alternative=..., paired=...,
       var.equal=..., conf.level=...)
```

on:

* Entram com a `x` una mostra i a `mu` el valor amb el qual volem contrastar $\mu$, o entram com a `x` i `y` les
mostres de $X_1$ i  de $X_2$

* A `alternative` hi hem d'indicar el tipus de contrast segons la hipòtesi alternativa:

    * `alternative="two.sided"` ($\neq$, el valor per defecte)
    * `alternative="less"` ($<$)
    * `alternative="greater"` ($>$)  

* En el cas d'un contrast de dues mitjanes, a `paired` hi hem d'indicar si les mostres són independents, amb `paired=FALSE` (el valor per defecte), o aparellades, amb `paired=TRUE`

* En el cas d'un contrast de dues mitjanes amb mostres independents, a `var.equal`  hi hem d'indicar si les variàncies són iguals,  amb `var.equal=TRUE`, o diferents, amb `var.equal=FALSE` (el valor per defecte)

* A `conf.level` hi hem d'especificar el nivell de confiança $1-\alpha$: el seu valor per defecte és 0.95, que correspon al nivell de significació $\alpha=0.05$ usual 

### Exemples


```{example, temphomes1}
La temperatura mitjana del cos humà, és el valor usualment acceptat de 98.6^o^ F (37^o^ C)?

```

Per contrastar-ho, emprarem la taula de dades **Body_Temperature.txt**, construïda per P.A. Mackowiak, S. S. Wasserman i M.M. Levine en 1992 precisament per realitzar aquest contrast i que trobareu a l'Aula Digital. 

*Variable aleatòria d'interès*: $X$: "Prenem una persona i li miram la temperatura, en graus F", amb mitjana $\mu$

*Contrast*:
$$
\left\{\begin{array}{l}
H_{0}:\mu=98.6\\
H_{1}:\mu \neq 98.6
\end{array}
\right.
$$

Realitzarem aquest contrast amb R. Carregam la taula de temperatures, que prèviament hem guardat en el directori de treball de R, en un dataframe que anomenarem `BT`.

```{r}
BT=read.table("Body_Temperature.txt")
head(BT)
str(BT)
```

Veiem que la taula `BT` consta de 230 individus i 3 variables mesurades sobre cadascun d'ells: el sexe (variable `Gender`, amb nivells `F` per a dona i `M` per a home), les pulsacions per minut (variable `HeartRate`) i la temperatura en graus F (variable `Temperature`).

Com que la mostra és gran, $n=230$, podem emprar un test t. Emprarem la funció `t.test`, aplicant-la al vector de temperatures i al valor que contrastam, 98.6, entrat amb el parametre `mu`. El paràmetre `alternative="two.sided"` indica que el test serà bilateral.

```{r}
t.test(BT$Temperature, mu=98.6, alternative="two.sided")
```

Del resultat cal destacar:

* El p-valor, `p-value`, en el nostre cas $`r round(t.test(BT$Temperature, mu=98.6, alternative="two.sided")$p.value,11)`$ (R l'ha escrit en notació científica: `r sprintf("%.3e", t.test(BT$Temperature, mu=98.6, alternative="two.sided")$p.value)`).

* L'IC 95%, `95 percent confidence interval`, per al valor que contrastam (aquí, la temperatura mitjana poblacional), en el nostre cas [`r round(t.test(BT$Temperature, mu=98.6, alternative="two.sided")$conf.int,5)`].

* La mitjana mostral de la mostra, `sample of x`, en el nostre cas `r round(t.test(BT$Temperature, mu=98.6, alternative="two.sided")$estimate,5)`.

Per tant:
 
* El p-valor és $3\times 10^{-8}$, per la qual cosa amb les dades d'aquesta taula obtenim evidència estadísticament significativa que la temperatura mitjana del cos humà no és de 98.6^o^ F (37^o^ C)

* A més, com que l'IC 95% per a la temperatura mitjana del cos humà que hem obtingut  va de 98.2 a 98.4 (36.78 a 36.89^o^ C), hem trobat evidència amb aquest nivell de confiança que aquesta temperatura mitjana és (lleugerament) inferior 98.6^o^ F

*Conclusió*:  Hem obtingut evidència estadísticament significativa que la temperatura mitjana del cos humà no és de 98.6^o^ F  (test t, p-valor 3·10^-8^, IC 95% de 98.2 a 98.4).



```{example, temphomesdones}
La temperatura dels homes, és més alta que la de les dones?
  

```

Per resoldre aquesta qüestió, emprarem la mateixa taula de dades que abans. 

*Variables aleatòries d'interès*:

* $X_d$: "Prenem una dona i li miram la temperatura, en graus F", amb mitjana $\mu_d$
* $X_h$: "Prenem un home i li miram la temperatura, en graus F", amb mitjana $\mu_h$


*Contrast*: Plantejarem el contrast en termes de temperatures mitjanes:
$$
\left\{\begin{array}{l}
H_{0}:\mu_d=\mu_h\\
H_{1}:\mu_d< \mu_h
\end{array}
\right.
$$

Per poder emprar un t test, primer ens cal saber si hi ha nombres suficientment grans d'homes i dones a la nostra mostra per emprar-lo. Per això calcularem la taula de freqüències dels sexes, aplicant la funció `table` al vector `BT$Gender` dels sexes:

```{r}
table(BT$Gender)
```

Són prou grans.

Anam a crear uns vectors amb les temperatures d'homes i de dones. Recordau que per extreure d'un dataframe el vector de valors d'una variable `V1` per als individus que prenen un valor concret `X` en una altra variable `V2` s'empra la construcció `dataframe[V2==X,V1]`. Així, les temperatures dels homes (individus on la variable `Gender` és igual a `M`) són

```{r}
BT$Temperature[BT$Gender=="M"]
```

Bé, cream els vectors $X_d$ (dones) i $X_h$ (homes)

```{r}
X_d=BT[BT$Gender=="F","Temperature"]  #temperatures de dones
X_h=BT[BT$Gender=="M","Temperature"]  #temperatures d'homes
```

Per portar a terme un test t per comparar dues mitjanes, aplicam la funció `t.test` als vectors `X_d`i `X_h` amb paràmetre `alternative="less"` per indicar que el test és unilateral: la hipòtesi alternativa és que la mitjana de la primera població (dones) és més petita que la de la segona (homes). En aquest exemple, a més, especificarem que les mostres són independents amb `paired=FALSE` (no caldria, ja que és el valor per defecte) i a més hem d'especificar si les variàncies poblacionals són iguals (`var.equal=TRUE`) o diferents (`var.equal=FALSE`). El que farem aquí serà provar els dos casos: amb les variàncies  iguals i amb les variàncies diferents. Si les dues conclusions són la mateixa, aquesta serà la conclusió que prendrem. Si dóna diferent, haurem de realitzar un contrast previ per decidir si podem suposar que les variàncies són iguals o diferents.


```{r}
t.test(X_d, X_h, alternative="less",paired=FALSE, var.equal=TRUE)
t.test(X_d, X_h, alternative="less",paired=FALSE, var.equal=FALSE)
```

En tots dos casos obtenim un p-valor (`p-value`) gran. L'IC 95 % (`95 percent confidence interval`) que ens dóna és per a la diferència de les mitjanes. Com que conté el 0, no podem descartar que les dues mitjanes siguin iguals.  

*Conclusió*:  No hem obtingut evidència estadísticament significativa que la temperatura mitjana de les dones sigui més baixa que la dels homes (test t, p-valor 0.99, IC 95%  per a la diferència de les mitjanes de  $-\infty$ a 0.46).


```{block2,type="rmdnote"}
Vegem, si  $\overline{X_d}=98.42$ i $\overline{X_h}=98.14$, com volíeu que obtinguéssim evidència que $\mu_d<\mu_h$? **Mirau sempre les dades primer!**
```

Si haguéssim dibuixat abans del contrast un diagrama de caixes de les temperatures separades per sexe, hauríem vist que era impossible obtenir evidència que les dones tenen temperatura mitjana inferior als homes, i no hauria fet falta continuar.

```{r}
boxplot(Temperature~Gender,data=BT,names=c("Dones","Homes"),xlab="",ylab="Temperatura")
```



**Exercici**: Emprant les mateixes dades, trobau evidència que $\mu_h<\mu_d$? I que $\mu_h\neq \mu_d$? Spoiler:

```{r, echo=FALSE,out.width="50%"}
knitr::include_graphics("Bioestadistica-II_files/figure-html/tempcorp3.png")
```



```{example,oatbran}
Desdijunar segó de civada (*oat bran*) en lloc de flocs de blat de moro (*corn flakes*), ajuda a reduir el nivell de colesterol?


```

Per resoldre aquesta qüestió, emprarem la taula de dades **oatbran.txt**, que trobareu a l'Aula Digital. Aquestes dades es recolliren en un assaig creuat sobre 14 individus. A cada un d'ells se li assignà un dels dos desdijunis de manera aleatòria i el prengueren durant  15 dies. Al final d'aquest període, se'ls mesurà el nivell de colesterol en sang. Passat un mes de descans, cada participant va desdijunar durant 15 dies  l'altre producte, i al final se'ls tornà a mesurar el nivell de colesterol en sang.

<!-- (J. Anderson \textsl{et a el}, ``Oat-bran cereal lowers serum total and LDL cholesterol in hypercholesterolemic men.'' \textsl{The American journal of clinical nutrition} 52 (1990), 495--499)
-->

*Variables aleatòries d'interès*:

* $X_{ob}$: "Prenem una persona que desdijuna  *oat bran* i li mesuram el nivell de colesterol", amb mitjana $\mu_{ob}$
* $X_{cf}$: "Prenem una persona que desdijuna  *corn flakes* i li mesuram el nivell de colesterol", amb mitjana $\mu_{cf}$

*Contrast*: El plantejarem en termes de nivells mitjans de colesterol:
$$
\left\{\begin{array}{l}
H_{0}:\mu_{ob}=\mu_{cf}\\
H_{1}:\mu_{ob}< \mu_{cf}
\end{array}
\right.
$$


Carregam la taula de dades, que prèviament hem guardat en el directori de treball de R, en un dataframe al que anomenam `OBR` i consultam la seva estructura:

```{r}
OBR=read.table("oatbran.txt",header=TRUE)
head(OBR)
str(OBR)
```

N'extraiem les dues variables en forma de vectors:

```{r}
OAT=OBR$OATBRAN
CFL=OBR$CORNFLK
```

Com que 14 dades són poques, si volem aplicar un test t necessitam que provinguin d'una distribució normal. Per decidir si és veritat o no, més endavant explicarem contrastos de bondat d'ajust, amb hipòtesi nul·la "Aquesta mostra prové d'una variable aleatòria amb tal distribució" i hipòtesi alternativa "No és veritat que aquesta mostra provengui d'una variable aleatòria amb tal distribució". Per ara ens conformarem amb decidir-ho a partir d'un gràfic.

A Matemàtiques I us explicàvem que podeu dibuixar un histograma d'una mostra afegint-hi la densitat estimada, a partir de la mostra, de la variable poblacional i la densitat d'una distribució normal amb mitjana i desviació típica les de la mostra, i mirar si sembla que les dades segueixen aquesta distribució normal. Però amb poques dades això és mal de veure:

```{r,eval=FALSE}
hist(OAT,freq=FALSE, breaks=4,col="light blue",xlab="Colesterol",
     ylab="Densitat", main="Histograma de OATBRAN",ylim=c(0,max(density(OAT)$y)))
lines(density(OAT),lty=2,lwd=2)
curve(dnorm(x,mean(OAT),sd(OAT)),col="red",lwd=2,add=TRUE)
legend("topright",legend=c("Densitat estimada","Normal"),
       col=c("black","red"),lty=c(2,1),cex=0.75)
#
hist(CFL,freq=FALSE, breaks=4,col="light blue",xlab="Colesterol",
     ylab="Densitat", main="Histograma de CORNFLK",,ylim=c(0,max(density(CFL)$y)))
curve(dnorm(x,mean(CFL),sd(CFL)),col="red",lwd=2,add=TRUE)
lines(density(CFL),lty=2,lwd=2)
legend("topright",legend=c("Densitat estimada","Normal"),
       col=c("black","red"),lty=c(2,1),cex=0.75)
```

```{r,echo=FALSE,fig.width=10,fig.asp=0.5}
par(mfrow=c(1,2))
hist(OAT,freq=FALSE, breaks=4,col="light blue",xlab="Colesterol",ylab="Densitat", main="Histograma de OATBRAN",ylim=c(0,max(density(OAT)$y)))
lines(density(OAT),lty=2,lwd=2)
curve(dnorm(x,mean(OAT),sd(OAT)),col="red",lwd=2,add=TRUE)
legend("topright",legend=c("Densitat estimada","Normal"),col=c("black","red"),lty=c(2,1),cex=0.75)
hist(CFL,freq=FALSE, breaks=4,col="light blue",xlab="Colesterol",ylab="Densitat", main="Histograma de CORNFLK",ylim=c(0,max(density(CFL)$y)))
curve(dnorm(x,mean(CFL),sd(CFL)),col="red",lwd=2,add=TRUE)
lines(density(CFL),lty=2,lwd=2)
legend("topright",legend=c("Densitat estimada","Normal"),col=c("black","red"),lty=c(2,1),cex=0.75)
```

En aquest cas, una opció millor és dibuixar un *q-q-plot*.  Un **q-q-plot** d'una mostra i una distribució teòrica és el gràfic dels  **q-q-punts**: els punts de la forma  *(q-quantil de la distribució, q-quantil de la mostra)*, per a tots els valors de q que tengui sentit donada la mida de la mostra.  Quan la distribució amb la que comparam la mostra és una normal, se'n diu un **normal-plot**.

Si la mostra prové de la distribució emprada en el q-q-plot, és d'esperar que el q-quantil de la mostra sigui aproximadament igual al q-quantil de la distribució i per tant que aquests q-q-punts estiguin prop de la diagonal principal $y=x$.

La funció `qqPlot` del paquet **car** produeix uns *q-q-plots* que contenen una regió de confiança del 95% que especifica què vol dir això que "els q-q-punts estiguin prop de la diagonal principal $y=x$", amb el significat usual de nivell de confiança. L'explicam amb detall a la lliçó de R sobre contrastos de bondat d'ajust. 

```{r,eval=FALSE}
library(car)
qqPlot(OAT, distribution="norm", mean=mean(OAT), sd=sd(OAT),
        ylab="Quantils de OATBRAN", xlab="Quantils de normal", pch=20, id=FALSE)
qqPlot(CFL, distribution="norm", mean=mean(CFL),sd=sd(CFL),
       ylab="Quantils de CORNFLK", xlab="Quantils de normal", pch=20, id=FALSE)
```

```{r,echo=FALSE,fig.width=10,fig.asp=0.5}
par(mfrow=c(1,2))
library(car)
car::qqPlot(OAT, distribution="norm", mean=mean(OAT), sd=sd(OAT),
        ylab="Quantils de OATBRAN", xlab="Quantils de normal", pch=20, id=FALSE)
car::qqPlot(CFL, distribution="norm", mean=mean(CFL),sd=sd(CFL),
       ylab="Quantils de CORNFLK", xlab="Quantils de normal", pch=20, id=FALSE)
```


Aceptarem per tant que les nostres dades provenen de dues distribucions normals: podem fer servir la funció `t.test`.

En aquest cas, el test t és de mostres aparellades (hem mesurat les dues variable aleatòries sobre els mateixos individus), per la qual cosa hem d'especificar `paired=TRUE` i no hem  d'especificar el paràmetre `var.equal`. Emprarem el paràmetre `alternative="less"` per indicar que el test és unilateral: la mitjana de la primera població és més petita que la de la segona.


```{r}
t.test(OAT,CFL,alternative="less", paired=TRUE)
```

Com abans, el resultat inclou el p-valor, l'IC 95% per a la mitjana de les diferències (que és igual a la diferència de les mitjanes: recordau que $E(X-Y)=E(X)-E(Y)$) i ara, com a novetat, la mitjana de les diferències (`mean of the differences`) en comptes de les dues mitjanes.

*Conclusió*: Hem obtingut evidència estadísticament significativa que desdijunar *oatbran* redueix el nivell mitjà de colesterol respecte de desdijunar *corn flakes* (test t, p-valor 0.003, IC 95%  per a la diferència de les mitjanes de  $-\infty$ a -0.163).

```{example,sangumbil}
Volem contrastar si el nivell de triglicèrids als nadons de 2 setmanes és més alt que el del seu cordó umbilical. Per fer-ho, emprarem les dades d'una mostra de 25 nadons als quals els mesuraren els nivells de triglicèrids en plasma a la sang del seu cordó umbilical i en la seva sang al cap de 2 setmanes de néixer. Tenim les dades a la taula **trignadons.txt** que trobareu a l'Aula Digital. Les seves variables són `CU`, les mesures del cordó umbilical, `DS`, les mesures al cap de dues setmanes, i `Nin`, que identifica el nadó.

```


*Variables aleatòries d'interès*:

* $X_{cu}$: "Prenem un recent nat i mesuram el nivell de triglicèrids en plasma a la sang del seu cordó umbilical", amb mitjana $\mu_{cu}$
* $X_{ds}$: "Prenem un nadó de 2 setmanes i mesuram el seu nivell de triglicèrids en plasma", amb mitjana $\mu_{cf}$

*Contrast*: Plantejarem el contrast en termes dels nivells mitjans de triglicèrids:
$$
\left\{\begin{array}{l}
H_{0}:\mu_{cu}=\mu_{ds}\\
H_{1}:\mu_{cu}< \mu_{ds}
\end{array}
\right.
$$

Carregam la taula de dades, que prèviament hem guardat en el directori de treball de R, en un dataframe al que anomenam `TGN` i consultam la seva estructura:

```{r}
TGN=read.table("trignadons.txt",header=TRUE)
head(TGN)
str(TGN)
```

Com que 25 dades són poques, miram si segueixen distribucions normals amb els seus normal-plots:


```{r,eval=FALSE}
qqPlot(TGN$CU, distribution="norm", mean=mean(TGN$CU), sd=sd(TGN$CU),
        ylab="Quantils de la mostra", xlab="Quantils de normal", 
       pch=20, id=FALSE)
qqPlot(TGN$DS,  distribution="norm", mean=mean(TGN$DS), sd=sd(TGN$DS),
       ylab="Quantils de la mostra", xlab="Quantils de normal", 
       pch=20,id=FALSE)
```

```{r,echo=FALSE,fig.width=10,fig.asp=0.5}
par(mfrow=c(1,2))
car::qqPlot(TGN$CU, distribution="norm", id=FALSE, mean=mean(TGN$CU), sd=sd(TGN$CU),
        ylab="Quantils de la mostra", xlab="Quantils de normal", pch=20)
car::qqPlot(TGN$DS,  distribution="norm", mean=mean(TGN$DS), sd=sd(TGN$DS),
       ylab="Quantils de la mostra", xlab="Quantils de normal", pch=20,id=FALSE)
```

Vaja, no sembla que segueixin una distribució normal. Vegem els seus histogrames

```{r,eval=FALSE}
hist(TGN$CU, freq=FALSE, main="Histograma de TGN$CU", 
     xlab="",ylab="",col="light blue")
lines(density(TGN$CU),lty=2,lwd=2)
curve(dnorm(x,mean(TGN$CU),sd(TGN$CU)),col="red",lwd=2,add=TRUE)
legend("topright",legend=c("Densitat estimada","Normal"),col=c("black","red"),
       lty=c(2,1),cex=0.5)
#
hist(TGN$DS, freq=FALSE, main="Histograma de TGN$DS", 
     xlab="",ylab="",col="light blue")
lines(density(TGN$DS),lty=2,lwd=2)
curve(dnorm(x,mean(TGN$DS),sd(TGN$DS)),col="red",lwd=2,add=TRUE)
legend("topright",legend=c("Densitat estimada","Normal"),col=c("black","red"),
       lty=c(2,1),cex=0.5)
```


```{r,echo=FALSE,fig.width=10,fig.asp=0.5}
par(mfrow=c(1,2))
hist(TGN$CU, freq=FALSE, main="Histograma de TGN$CU", 
     xlab="",ylab="",col="light blue")
lines(density(TGN$CU),lty=2,lwd=2)
curve(dnorm(x,mean(TGN$CU),sd(TGN$CU)),col="red",lwd=2,add=TRUE)
legend("topright",legend=c("Densitat estimada","Normal"),col=c("black","red"),lty=c(2,1),cex=0.5)
hist(TGN$DS, freq=FALSE, main="Histograma de TGN$DS", 
     xlab="",ylab="",col="light blue")
lines(density(TGN$DS),lty=2,lwd=2)
curve(dnorm(x,mean(TGN$DS),sd(TGN$DS)),col="red",lwd=2,add=TRUE)
legend("topright",legend=c("Densitat estimada","Normal"),col=c("black","red"),lty=c(2,1),cex=0.5)
```

Les dues mostres presenten una cua a la dreta, com podem veure als diagrames de caixa:

```{r}
boxplot(TGN$CU,TGN$DS,names=c("CU","DS"),xlab="",ylab="Nivell triglicèrids")
```



En casos així, **de vegades els logaritmes seguexen aproximadament una distribució normal**. Vegem si hi ha sort.

```{r,eval=FALSE}
LogCU=log(TGN$CU)
qqPlot(LogCU, distribution="norm", mean=mean(LogCU), sd=sd(LogCU),
        ylab="Quantils dels logaritmes", xlab="Quantils de normal", 
       pch=20, id=FALSE)
#
LogDS=log(TGN$DS)
qqPlot(LogDS, distribution="norm", mean=mean(LogDS), sd=sd(LogCU),
        ylab="Quantils dels logaritmes", xlab="Quantils de normal", 
       pch=20, id=FALSE)
```

```{r,echo=FALSE,fig.width=10,fig.asp=0.5}
par(mfrow=c(1,2))
LogCU=log(TGN$CU)
car::qqPlot(LogCU, distribution="norm", mean=mean(LogCU), sd=sd(LogCU),
        ylab="Quantils dels logaritmes", xlab="Quantils de normal", pch=20, id=FALSE)
LogDS=log(TGN$DS)
car::qqPlot(LogDS, distribution="norm", mean=mean(LogDS), sd=sd(LogCU),
        ylab="Quantils dels logaritmes", xlab="Quantils de normal", pch=20, id=FALSE)
```

Aquests logaritmes ja poden passar per normals. Per tant, el que farem serà, en lloc de comparar les mitjanes dels nivells de triglicèrids, comparar les mitjanes dels seus logaritmes. Aquest tipus de transformació és molt usual en Bioestadística.

```{block2,type="rmdcaution"}
No són contrastos equivalents, perquè el logaritme de la mitjana no és la mitjana del logaritme. Però en realitat la pregunta que originava aquesta investigació era si el **nivell de triglicèrids augmenta** en les dues primeres setmanes de vida dels nadons, i ho plantejàvem en termes de si és veritat que **el  nivell mitjà de triglicèrids augmenta** en les dues primeres setmanes de vida dels nadons. 

Ara, demanar-nos si "el nivell de triglicèrids augmenta en les dues primeres setmanes de vida dels nadons" sí que és equivalent a demanar-nos si "el logaritme del nivell de triglicèrids augmenta en les dues primeres setmanes de vida dels nadons". I el que fem és plantejar aquesta pregunta en termes de si és veritat que **el valor mitjà del logaritme del nivell de triglicèrids augmenta** en les dues primeres setmanes de vida dels nadons
```



*Noves variables aleatòries d'interès*:

* $\log(X_{cu})$: "Prenem un recent nat i calculam el logaritme del nivell de triglicèrids en plasma a la sang del seu cordó umbilical", amb mitjana $\mu_{logcu}$
* $\log(X_{ds})$: "Prenem un nadó de 2 setmanes i  calculam el logaritme del seu nivell de triglicèrids en plasma", amb mitjana $\mu_{logcf}$


*Nou contrast*:
$$
\left\{\begin{array}{l}
H_{0}:\mu_{logcu}=\mu_{logds}\\
H_{1}:\mu_{logcu}< \mu_{logds}
\end{array}
\right.
$$

Prenem com a mostres de $\log(X_{cu})$ i $\log(X_{ds})$ els vectors de logaritmes `LogCU` i `LogDS` de la nostra mostra original, que podem acceptar que provenen de distribucions normals, i els aplicam la funció `t.test` amb `paired=TRUE`, perquè són mostres aparellades, i `alternative="less"`.

```{r}
t.test(LogCU, LogDS, paired=TRUE, alternative="less")
```

*Conclusió*: Hem obtingut evidència estadísticament significativa  que el valor mitjà del logaritme del nivell de triglicèrids a la sang del cordó umbilical d'un nadó és més petit que el valor mitjà del logaritme del nivell de triglicèrids a la sang d'un nadó de 2 setmanes (test t, p-valor<10^-16^, IC 95% per a la diferència de les mitjanes de $-\infty$ a -0.84). Concloem, per tant, que tenim evidència estadísticament significativa que el nivell de triglicèrids als nadons de 2 setmanes és més alt que el del seu cordó umbilical.


### Tests no paramètrics

Si les variables aleatòries d'interès no són (aproximadament) normals i alguna mostra és petita, no podem usar un test t per comparar mitjanes. En aquest cas, una possibilitat és provar de transformar les dades com a l'Exemple \@ref(exm:sangumbil) per veure si la transformació esdevé normal, i si és el cas, plantejar el contrast en termes de mitjanes de logaritmes.

Una altra possibilitat és emprar un **test no paramètric**, que no necessiti que les variables aleatòries siguin normals per que la conclusió sigui vàlida.


La majoria de tests no paramètrics  per comparar mitjanes en realitat comparen **medianes**, però normalment cometem l'abús de llenguatge de dir que són per contrastar mitjanes. A més, si les variables aleatòries són simètriques, les mitjanes coincideixen amb les medianes. 

Els més populars són: 

* **Test de Wilcoxon** per a una mitjana o dues mitjanes usant mostres aparellades

* **Test de Mann-Whitney** per a dues mitjanes usant mostres independents

Tots tres es calculen amb R amb la funció 
```{r,eval=FALSE}
wilcox.test(x, y, mu=..., alternative=...,
            paired=..., conf.level=...)
```
amb sintaxi idèntica a la de `t.test` (excepte que no s'hi empra el `var.equal`).

```{block2,type="rmdimportant"}
Els millors tests no paramètrics solen tenir potència inferior als millors tests paramètrics. A més, els tests no paramètrics no solen produir intervals de confiança fiables. Però, per exemple, emprar un test t quan no és adequat pot portar a conclusions equivocades.

**Emprau tests paramètrics sempre que pogueu, però només quan pogueu.**
```

Com a exemple, vegem com funciona (una versió simplificada) del test de Wilcoxon d'una mitjana. Sigui $X$ una variable aleatòria contínua simètrica al voltant de la seva mitjana $\mu$ desconeguda. Volem realitzar un contrast
$$
\left\{\begin{array}{l}
H_{0}:\mu=\mu_0\\ 
H_{1}:\mu \neq \mu_0 \text{ o }\mu >\mu_0\text{ o }\mu<\mu_0
\end{array}
\right.
$$

Prenem  una mostra aleatòria simple $x_1,\ldots, x_n$ de $X$. El procediment d'aquest test es basa aleshores en els següents passos, que després il·lustram a l'Exemple \@ref(exm:dietaratolins):

1. Per a cada $i=1,\ldots,n$, sigui $d_i=x_i-\mu_0$; s'eliminen els valors 0

2. Enumeram els valors $d_i$ de menor a major valor absolut; en cas d'empats, a cada un li assignam la mitjana de les posicions que ocuparien. A l'índex assignat d'aquesta manera a cada $d_i$ li diem el seu **rang**. Per exemple, a l'Exemple \@ref(exm:dietaratolins) hi ha quatre $i$ amb valors $d_i=\pm 1$, i els tocarien les posicions 1, 2, 3 i 4: aleshores el rang de cada un d'aquests quatre $d_i$ és 2.5.

3. Diem $T_+$ a la suma dels rangs dels $d_i>0$ i $T_{-}$ a la suma dels rangs dels $d_i<0$

4. Si $H_0$ vertadera, és a dir, si $\mu=\mu_0$, per la simetria de $X$ al voltant de $\mu$ esperam que $T_+\approx T_-$. Per tant:

    * Si $T_+$ és molt petit, és evidència que $\mu <\mu_0$  
    
        En efecte, si $T_+$ és molt més petit que $T_-$, bàsicament significa que hi ha més valors a l'esquerra de $\mu_0$ que a la dreta, i per tant la mediana (és a dir, el valor que deixa la meitat dels valors a l'esquerra i l'altra meitat a la dreta) ha d'estar a l'esquerra de $\mu_0$.
    
    * Si $T_+$ és molt gran,  és evidència que $\mu >\mu_0$  
    
        En efecte, si $T_+$ és molt més gran que $T_-$, bàsicament significa que hi ha més valors a la dreta de $\mu_0$ que a l'esquerra, i per tant la mediana ha d'estar a la dreta de $\mu_0$.
    
    * Si $T_+$ és molt petit o gran,  és evidència que $\mu\neq \mu_0$

    I resulta que, quan $X$ és simètrica i $H_0$ vertadera, la distribució de $T_+$, per a cada $n$, és coneguda, i es pot emprar per calcular el p-valor, que és el que fa la funció `wilcox.test`.

```{example,dietaratolins}
Alimentàrem amb una dieta especial 13 ratolins des del naixement fins a la setmana 12. Els augments de pes (en grams) varen ser els del vector següent


```

```{r}
pesos=c(69,61,69,65,70,68,69,68,72,67,74,69,76)
```
Podem conclure que l'augment mitjà de pes en aquestes condicions és de menys de 70 g?

*Variable aleatòria d'interès*: $X$: "Prenem un ratolí alimentat amb aquesta dieta especial i mesuram el seu augment de pes durant les seves primeres 12 setmanes de vida", amb mitjana $\mu$.

*Contrast*:
$$
\left\{\begin{array}{l}
H_{0}:\mu=70\\ 
H_{1}:\mu <70
\end{array}
\right.
$$

Si miram la mostra, veurem que no té pinta de venir d'una distribució normal però sí simètrica:

```{r,eval=FALSE}
qqPlot(pesos, distribution="norm", mean=mean(pesos), sd=sd(pesos),
        ylab="Quantils de la mostra", xlab="Quantils de normal", pch=20, id=FALSE)
boxplot(pesos)
```

```{r,echo=FALSE,fig.width=10,fig.asp=0.5}
par(mfrow=c(1,2))
car::qqPlot(pesos, distribution="norm", mean=mean(pesos), sd=sd(pesos),
        ylab="Quantils de la mostra", xlab="Quantils de normal", pch=20, id=FALSE)
boxplot(pesos)
par(mfrow=c(1,1))
```

Per tant, emprarem un test de Wilcoxon. Vegem com aniria a mà. 

1. Calculam els $d_i=x_i-70$

$$
\begin{array}{l|cccccccccccccc}
\hline
x_i &     69 &  61 &  69 &  65 &  70 &  68 &  69 &  68 &  72 &  67 &  74 &  69 &  76\\
d_i     & -1 & -9 & -1  &   -5  &  0 &  -2 &  -1 &  -2 &  2 &   -3  &  4  &   -1 &    6\\
\hline
\end{array}
$$

2. Assignam índexos als $d_i\neq 0$ en ordre creixent al seu valor absolut. En cas d'empat, per ara els assignam els índexos ordenats d'esquerra a dreta.

$$
\begin{array}{l|cccccccccccccc}
\hline
x_i &                       69 &  61 &  69 &  65 &  70 &  68 &  69 &  68 &  72 &  67 &  74 &  69 &  76\\
d_i                        & -1 & -9 & -1  &   -5  &  0 &  -2 &  -1 &  -2 &  2 &   -3  &  4 & -1 &    6\\
\textrm{Rang fals}        &   1 & 12 &   2 &  10  &    &   5 &   3 &   6  &  7 &   8    &  9 & 4 &   11    \\
\hline
\end{array}
$$
    A continuació, assignam com a "rang vertader" de cada $d_i$ la mitjana de tots els "rangs falsos" dels $d_i$ amb el seu mateix valor absolut. Així, el rang de tots els $d_i=-1$ és $(1+2+3+4)/4=2.5$ i el rang dels $d_i=-2$ o 2 és $(5+6+7)/3=6$.

$$
\begin{array}{l|cccccccccccccc}
\hline
x_i &                       69 &  61 &  69 &  65 &  70 &  68 &  69 &  68 &  72 &  67 &  74 &  69 &  76\\
d_i                        & -1 & -9 & -1  &   -5  &  0 &  -2 &  -1 &  -2 &  2 &   -3  &  4 & -1 &    6\\
\textrm{Rang fals}        &   1 & 12 &   2 &  10  &     &   5 &   3 &   6  &  7 &   8 &  9 & 4  &   11    \\
\textrm{Rang}             & 2.5 & 12 & 2.5 & 10 &       & 6   & 2.5  & 6   &  6 &  8  &  9 &  2.5 & 11 \\
\hline
\end{array}
$$

3. Anotam quins $d_i$ són positius i quins negatius:

$$
\begin{array}{l|cccccccccccccc}
\hline
x_i &                       69 &  61 &  69 &  65 &  70 &  68 &  69 &  68 &  72 &  67 &  74 &  69 &  76\\
d_i                        & -1 & -9 & -1  &   -5  &  0 &  -2 &  -1 &  -2 &  2 &   -3  &  4 & -1 &    6\\
\textrm{Rang fals}        &   1 & 12 &   2 &  10  &     &   5 &   3 &   6  &  7 &   8 &  9 & 4  &   11    \\
\textrm{Rang}             & 2.5 & 12 & 2.5 & 10 &       & 6   & 2.5  & 6   &  6 &  8 &  9 &  2.5 & 11 \\
\textrm{Signe} &            -   & - &  -  &  -   &      & - &   - &  -     & +  &  -  & +   & -   & +\\  
\hline
\end{array}
$$

4. Sumam, d'una banda, els rangs dels $d_i$ positius i de l'altra, els dels negatius:
$$
\begin{array}{l}
T_+=6+9+11=26\\
T_-=2.5+ 12 + 2.5 + 10 + 6   + 2.5  + 6   +  8 +  2.5=52
\end{array}
$$


5. I ara miraríem si $T_+$ és prou més petit que $T_-$ per que sigui evidència estadísticament significativa de que $\mu <\mu_0$. Això ja no ho podem fer a mà.

Amb R, simplement entraríem
```{r}
wilcox.test(pesos,mu=70,alternative="less")
```

*Conclusió*: No hem obtingut evidència estadísticament significativa que l'augment mitjà de pes en aquestes condicions sigui més petit que 70 g  (test de Wilcoxon, p-valor 0.16).


El test de Wilcoxon per a dues mitjanes emprant mostres aparellades és bàsicament el test anterior aplicat a la diferència dels valors de les dues variables a les parelles.

```{example}
Una alternativa a la transformació logarítmica portada a terme a l'Exemple \@ref(exm:sangumbil) hagués estat emprar el test de Wilcoxon per a mostres aparellades. 


```

El contrast ara seria 
$$
\left\{\begin{array}{l}
H_{0}:\mu_{cu}-\mu_{ds}=0\\
H_{1}:\mu_{cu}- \mu_{ds}<0
\end{array}
\right.
$$
que clarament correspon al contrast original
$$
\left\{\begin{array}{l}
H_{0}:\mu_{cu}=\mu_{ds}\\
H_{1}:\mu_{cu}< \mu_{ds}
\end{array}
\right.
$$
però hem de tenir present que la hipòtesi nul·la en realitat significa que la **mediana** de les diferències dels nivells de triglicèrids en el cordó umbilical menys  els nivells  de triglicèrids al cap de dues setmanes és 0, és a dir

> Si restam del nivell de triglicèrids en la sang del cordó umbilical d'un nadó el seu nivell de triglicèrids en sang al cap de dues setmanes, la meitat de les vegades obtenim un valor $\geq 0$ i l'altra meitat de les vegades un valor $\leq 0$,

o, equivalentment,

> La meitat dels nadons tenen el nivell de triglicèrids en la sang del cordó umbilical més alt o igual que el seu nivell de triglicèrids en sang al cap de dues setmanes, i l'altra meitat tenen el nivell de triglicèrids en la sang del cordó umbilical més petit o igual que el seu nivell de triglicèrids en sang al cap de dues setmanes.

La hipòtesi alternativa que aquesta mediana és negativa. És a dir, la hipòtesi alternativa és

> Si restam el nivell de triglicèrids en la sang del cordó umbilical d'un nadó menys el nivell de triglicèrids en sang al cap de dues setmanes, més de la meitat de les vegades obtendríem un valor $<0$

o, equivalentment,

> Més de la meitat dels nadons tenen el nivell de triglicèrids en la sang del cordó umbilical més petit que el seu nivell de triglicèrids en sang al cap de dues setmanes.



```{r}
wilcox.test(TGN$CU,TGN$DS,alternative="less",paired=TRUE)
```


Com que el p-valor és de l'ordre de 10^-6^, rebutjam la hipòtesi nul·la  en favor de la alternativa, i cometem l'abús de llenguatge d'expressar-ho en termes de mitjanes:

*Conclusió*: Hem obtingut evidència estadísticament significativa que el nivell mitjà de triglicèrids a la sang del cordó umbilical dels nadons és més petit que al cap de dues setmanes  (test de Wilcoxon, p-valor 6.4·10^-6^).




## Contrastos de variàncies {#sec:contrvar}

### Test $\chi^2$ d'una variància

Siguin $X$ una variable aleatòria $N(\mu,\sigma)$ i $X_1,\ldots,X_n$ una mostra aleatòria simple de $X$ de mida $n$ qualsevol.

Volem realitzar un contrast
$$
\left\{\begin{array}{l}
H_{0}:\sigma=\sigma_0\\ 
H_{1}:\sigma \neq\sigma_0\text{ o }\sigma >\sigma_0\text{ o }\sigma<\sigma_0
\end{array}
\right.
$$
o equivalentment
$$
\left\{\begin{array}{l}
H_{0}:\sigma^2=\sigma_0^2\\ 
H_{1}:\sigma^2 \neq\sigma_0^2\text{ o }\sigma^2 >\sigma_0^2\text{ o }\sigma^2<\sigma_0^2
\end{array}
\right.
$$


Si $H_0$ és vertadera, sabem que l'*estadístic de contrast*
$$
\chi^2=\frac{(n-1) \widetilde{S}_X^2}{\sigma_{0}^2}
$$

té distribució $\chi_{n-1}^2$, i aleshores ho podem emprar per calcular p-valors, regions crítiques etc. En concret, si 
el valor d'aquest estadístic de contrast sobre la mostra és $\chi_0^2$, aleshores:


* Si $H_{1}:\sigma>\sigma_{0}$, el p-valor és $P(\chi^2\geq \chi_0^2)$

* Si $H_{1}:\sigma<\sigma_{0}$, el p-valor és $P(\chi^2\leq \chi^2_0)$

* Si $H_{1}:\sigma\neq \sigma_{0}$, el p-valor es pren, per conveni, igual a  $2\text{min}\big\{P(\chi^2\geq \chi^2_0), P(\chi^2\leq\chi^2_0)\big\}$

```{block2,type="rmdcaution"}
Alerta amb els p-valors dels contrastos bilaterals relacionats amb variàncies, ja que per motius històrics no es calculen com "la probabilitat d'obtenir un valor de $\chi^2$ tant o més extrem que $\chi_0^2$ en el sentit de la hipòtesi alternativa", sinó per mitjà de la fórmula que us hem donat.
```

```{example}
Suposem que tenim una mostra aleatòria simple de $X$ normal de mida 25, i ha donat 
$\widetilde{S}_X^2=1.25$. Volem realitzar alguns contrastos amb hipòtesi nul·la $\sigma_X^2=0.8$, i per tant tendrem
$$
\chi_0^2=\frac{(25-1)\cdot 1.25}{0.8}=37.5
$$

  
```

* Si volem realitzar el contrast
$$
\left\{\begin{array}{l}
H_{0}:\sigma_X^2=0.8 \\
H_{1}:\sigma_X^2> 0.8
\end{array}
\right.
$$
    el p-valor és
$$
P(\chi^2_{24} \geq 37.5)=\texttt{1-pchisq(37.5,24)}=0.039
$$
    Amb nivell de confiança $\alpha=0.05$ rebutjam $H_0$ en favor de $H_1$

* Si volem realitzar el contrast
$$
\left\{\begin{array}{l}
H_{0}:\sigma_X^2=0.8 \\
H_{1}:\sigma_X^2\neq  0.8
\end{array}
\right.
$$
    El p-valor és 
$$
\begin{array}{l}
2\min\big\{P(\chi^2_{24}\geq 37.5),P(\chi^2_{24}\leq 37.5)\big\}\\
\qquad=2\min\{\texttt{1-pchisq(37.5,24)},\texttt{pchisq(37.5,24)}\}\\
\qquad=2\min\{`r round(1-pchisq(37.5,24),3)`,`r round(pchisq(37.5,24),3)`\}=
`r 2*min(c(round(1-pchisq(37.5,24),3),round(pchisq(37.5,24),3)))`
\end{array}
$$
    Amb nivell de confiança $\alpha=0.05$, no podem rebutjar $H_0$.

En resum: amb la nostra mostra trobam evidència estadísticament significativa que $\sigma>\sigma_0$, però no trobam evidència estadísticament significativa que $\sigma\neq \sigma_0$. No us ha de venir de nou, ja ens hi hem trobat en altres ocasions (recordau els Exemples \@ref(exm:ttestmu20) i \@ref(exm:ttest1bis)): per rebutjar la hipòtesi nul·la en un contrast bilateral cal més evidència que en un contrast unilateral, perquè al contrast bilateral tenim dues fonts d'error de tipus I i al contrast unilateral només una. 


```{example}
S'ha analitzat el líquid amniòtic d'una mostra aleatòria de 15 embarassades de 3er trimestre, i s'han obtingut les mesures següents de proteïnes totals (en grams per 100 ml):


```

```{r}
amnio=c(0.69,1.04,0.39,0.37,0.64,0.73,0.69,1.04,0.83,1.01,
        0.19,0.61,0.42,0.25,0.79)
```

Podem concloure a partir d'aquestes dades, amb un nivell de significació del 5%, que la desviació típica poblacional (és a dir, la desviació típica  de la quantitat de proteïna total en el líquid amniòtic de les embarassades de 3er trimestre expressada en grams per 100 ml) és diferent de 0.25?

*Variable aleatòria d'interès*: $X$: "Prenem una embarassada i li mesuram la uantitat de proteïna total en ..." de desviació típica $\sigma$.

*Contrast*:
$$
\left\{\begin{array}{l}
H_{0}:\sigma=0.25 \\
H_{1}:\sigma\neq 0.25
\end{array}
\right.
$$
amb $\alpha=0.05$

Per poder aplicar el test $\chi^2$, cal que $X$ sigui normal. Vegem-ho

```{r,eval=FALSE}
qqPlot(amnio, distribution="norm", mean=mean(amnio), sd=sd(amnio),
        ylab="Quantils de la mostra", xlab="Quantils de normal", 
       pch=20, id=FALSE)
```

```{r,echo=FALSE}
car::qqPlot(amnio, distribution="norm", mean=mean(amnio), sd=sd(amnio),
        ylab="Quantils de la mostra", xlab="Quantils de normal", pch=20, id=FALSE)
```

Acceptarem que $X$ és normal.

*Estadístic de contrast*: 
$$
\chi^2=\frac{(n-1) \widetilde{S}_X^2}{\sigma_{0}^2}
$$
que segueix una llei $\chi^2_{n-1}$ si $H_0$ és certa.

*Valor de l'estadístic de contrast*, $\chi^2_0$:
```{r}
n=length(amnio)
n
var(amnio)
khi0=(n-1)*var(amnio)/0.25^2
round(khi0,2)
```

*p-valor*: 
$$
\begin{array}{l}
2\min\big\{P(\chi_{n-1}^2\geq \chi^2_0), P(\chi_{n-1}^2\leq \chi^2_0)\big\}\\
\qquad=2\min\{\texttt{1-pchisq(`r round(khi0,2)`,`r n-1`)},\texttt{pchisq(`r round(khi0,2)`,`r n-1`)}\}\\
\qquad=2\min\{`r round(1-pchisq(round(khi0,2),n-1),3)`,`r round(pchisq(round(khi0,2),n-1),3)`\}=
`r 2*min(c(round(1-pchisq(round(khi0,2),n-1),3),round(pchisq(round(khi0,2),n-1),3)))`
\end{array}
$$


En aquest exemple, com que el contrast és bilateral, l'IC 95% seria el del tema anterior (amb $q=1-\alpha=0.95$). El de la variància seria
$$
\begin{array}{l}
\displaystyle \left[ \frac{(n-1)\widetilde{S}_{X}^2}{\chi_{n-1,0.975}^2},
\frac{(n-1)\widetilde{S}_{X}^2}{\chi_{n-1,0.025}^2}
\right]\\
\qquad\displaystyle=\left[ \frac{`r n-1`\cdot `r round(var(amnio),4)`}{`r round(qchisq(0.975,n-1),4)`},
\frac{`r n-1`\cdot `r round(var(amnio),4)`}{`r round(qchisq(0.025,n-1),4)`}\right]=[`r round((n-1)*round(var(amnio),4)/round(qchisq(0.975,n-1),4),4)`, `r round((n-1)*round(var(amnio),4)/round(qchisq(0.025,n-1),4),4)`]
\end{array}
$$

L'interval de confiança del 95% per a la desviació típica serà aleshores
$$
[\sqrt{`r round((n-1)*round(var(amnio),4)/round(qchisq(0.975,n-1),4),4)`}, \sqrt{`r round((n-1)*round(var(amnio),4)/round(qchisq(0.025,n-1),4),4)`}]=
[`r round(sqrt((n-1)*round(var(amnio),4)/round(qchisq(0.975,n-1),4)),3)`,`r round(sqrt((n-1)*round(var(amnio),4)/round(qchisq(0.025,n-1),4)),3)`]
$$
i conté el valor 0.25 que contrastàvem.

*Conclusió*: No hem obtingut evidència estadísticament significativa que la desviació típica (de la quantitat de proteïna total ...) sigui diferent de 0.25  (test $\chi^2$, p-valor 0.504, IC 95% de 0.202 a 0.435).



Aquest test $\chi^2$ d'una variància està implementat en la funció `sigma.test` del paquet **TeachingDemos**. La seva sintaxi és similar a la de `t.test`. Per exemple, per realitzar aquest darrer contrast, simplement entraríem
```{r}
library(TeachingDemos)
sigma.test(amnio,sigma=0.25,alternative="two.sided")
```

Ups, què ha passat amb l'interval de confiança? No res: fixau-vos que és el de la variància.


```{block2,type="rmdcaution"}
L'interval de confiança que dóna la funció `sigma.test` és el de la variància, tant si contrastam la desviació típica (amb el paràmetre `sigma`)  com si contrastam la variància  (amb el paràmetre `sigmasq`).
```


### Test F  per a dues variàncies

Siguin $X_1,X_2$ dues variables aleatòries normals de desviacions típiques $\sigma_1$ i $\sigma_2$, respectivament.
En prenem dues mostres aleatòries simples independents de mides $n_1$ i $n_2$ i variàncies mostrals $\widetilde{S}^2_1$ i  $\widetilde{S}^2_2$.

Volem realitzar un contrast
$$
\left\{\begin{array}{l}
H_{0}:\sigma_1^2=\sigma_2^2\\[1ex]
H_{1}:\sigma_1^2\neq \sigma_2^2\text{ o }\sigma_1^2> \sigma_2^2\text{  o }\sigma_1^2< \sigma_2^2
\end{array}
\right.
$$

L'interpretarem
$$
\left\{\begin{array}{l}
H_{0}:\sigma_1^2/\sigma_2^2=1\\[1ex]
H_{1}:\sigma_1^2/\sigma_2^2\neq 1\text{  o }\sigma_1^2/\sigma_2^2>1 \text{  o }\sigma_1^2/\sigma_2^2< 1
\end{array}
\right.
$$


Per realitzar-lo, s'empra l'estadístic de contrast
$$
F={\widetilde{S}_1^2}/{\widetilde{S}_2^2}
$$
que, si les dues poblacions són normals i 
$$
H_0: \sigma_1=\sigma_2
$$
és vertadera, té distribució coneguda: la **F de Fisher-Snedecor** $F_{n_1-1,n_2-1}$ amb $n_1-1$ i $n_2-1$ graus de llibertat. 
Per aquest motiu a aquest contrast se li diu un **test F**.

De la distribució $F_{n,m}$, on $n,m$ són els seus **graus de llibertat**, heu de saber que:

* Els graus de llibertat $n,m$ són els paràmetres dels quals depèn la funció de distribució, i l'ordre és important: si $n\neq m$, la distribució $F_{n,m}$ i la distribució $F_{m,n}$ són diferents.

* Amb R és `f`

* No és simètrica, té cua a la dreta i per tant els p-valors dels contrastos bilaterals es calculen com al test $\chi^2$ d'una variància. El gràfic següent mostra les gràfiques de les densitats de les distribucions $F_{n,m}$ per a $n=3,4$ i $m=3,4,5$. Es pot observar a cada una d'elles una cua a la dreta ben marcada, i també hi podeu observar que les distribucions $F_{3,4}$ i $F_{4,3}$ tenen densitats diferents.

```{r,echo=FALSE}
curve(df(x,3,3),col="black",xlim=c(0,5),lwd=1.5)
curve(df(x,3,4),col="red",lwd=1.5,add=TRUE)
curve(df(x,3,5),col="blue",lwd=1.5,add=TRUE)
curve(df(x,4,3),col="green",lwd=1.5,add=TRUE)
curve(df(x,4,4),col="purple",lwd=1.5,add=TRUE)
curve(df(x,4,5),col="brown",lwd=1.5,add=TRUE)
legend("topright",lty=rep(1,6),col=c("black","red","blue","green","purple","brown"),lwd=rep(1.5,6),
       legend=c(expression(F["3,3"]),expression(F["3,4"]),expression(F["3,5"]),expression(F["4,3"]),expression(F["4,4"]),expression(F["4,5"])))
```

Per tant, si diem $F_0$ al valor que pren l'estadístic $F$ sobre la nostra mostra


* Si $H_{1}:\sigma_1^2>\sigma_2^2$, el p-valor del constrast és $P(F\geq F_0)$

* Si $H_{1}:\sigma_1^2<\sigma_2^2$, el p-valor del constrast és $P(F\leq F_0)$

* Si $H_{1}:\sigma_1^2\neq \sigma_2^2$, el p-valor es pren, per conveni, igual a  $2\text{min}\big\{P(F\geq F_0), P(F\leq F_0)\big\}$


El test F està implementat en la funció `var.test` de R: s'aplica a les dues mostres, amb sintaxi similar a la de  `t.test`.


```{example}
Les variables $X_d$ i $X_h$ de l'Exemple \@ref(exm:temphomesdones), tenen la mateixa variància?


```

Suposarem que totes dues són normals (les temperatures ho solen ser) i diguem $\sigma_d^2$ i $\sigma_h^2$ a les seves variàncies.  

*Contrast*:
$$
\left\{\begin{array}{l}
H_{0}:\sigma_d^2=\sigma_h^2\\
H_{1}:\sigma_d^2\neq \sigma_h^2
\end{array}
\right.
$$

*Estadístic de contrast*:
$$
F=\widetilde{S}_d^2/\widetilde{S}_h^2
$$

* *Valor de l'estadístic de contrast* a la nostra mostra, $F_0$:

```{r}
F0=var(X_d)/var(X_h)
round(F0,4)
```

```{r,include=FALSE}
nd=length(X_d)
nh=length(X_h)
```

Recordem que les mides de les nostres mostres eren $n_d=`r nd`$ i  $n_h=`r nh`$

*p-valor*:
$$
\begin{array}{l}
2\min\big\{P(F_{n_d-1,n_h-1} \geq F0), P(F_{n_d-1,n_h-1}\leq F_0)\big\}\\
\qquad =2\min\big\{P(F_{`r nd-1`,`r nh-1`} \geq 0.8322), P(F_{`r nd-1`,`r nh-1`} \leq 0.8322)\big\}\\
\qquad =2\min\{\texttt{1-pf(0.8322,115,113)},\texttt{pf(0.8322,115,113)}\} \\
\qquad =2\min\{`r round(1-pf(0.8322,nd-1,nh-1),3)`,`r round(pf(0.8322,nd-1,nh-1),3)`\}=
`r 2*min(c(round(1-pf(0.8322,nd-1,nh-1),3), round(pf(0.8322,nd-1,nh-1),3)))`
\end{array}
$$


*Conclusió*: No hem trobat evidència estadísticament significativa que les variables $X_h$ i $X_d$ tenguin variància diferent  (test F, p-valor 0.33). Acceptarem que tenen la mateixa variància.

Amb R entraríem:

```{r}
var.test(X_d, X_h)
```

Obtenim el mateix p-valor que abans. L'interval de confiança que dóna aquesta funció és *per al quocient de les variàncies*. Aleshores, com que l'IC 95% conté l'1, no podem rebutjar amb un nivell de significació del 5% que $\sigma_d^2/\sigma_h^2=1$, és a dir, que $\sigma_d^2=\sigma_h^2$. És a dir:

*Conclusió*: No hem trobat evidència estadísticament significativa que les variables $X_h$ i $X_d$ tenguin variància diferent  (test F, p-valor 0.33, IC 95% per al quocient de les variàncies de 0.83 a 1.74). Acceptarem que tenen la mateixa variància.


Per tant, si els tests t amb `var.equal=TRUE` i `var.equal=FALSE` de l'Exemple \@ref(exm:temphomesdones) haguessin donat conclusions diferents, prendríem la corresponent a variàncies iguals.

Hem emprat un test F per comparar aquestes variàncies, i **per que la conclusió sigui fiable, cal que les variables poblacionals siguin normals, no és suficient que les mostres siguin grans; de fet, la seva validesa no depèn per res de la mida de les mostres**. Podem suposar que efectivament les variables $X_d$ i $X_h$ són normals?

Vegem els histogrames:
```{r,eval=FALSE}
hist(X_d,freq=FALSE, breaks=4,col="light blue",xlab="Temperatures",
     ylab="Densitat",main="Histograma de temperatures de dones")
lines(density(X_d),lty=2,lwd=2)
curve(dnorm(x,mean(X_d),sd(X_d)),col="red",lwd=2,add=TRUE)
legend("topright",legend=c("Densitat estimada","Normal"),
       col=c("black","red"),lty=c(2,1),cex=0.5)
#
hist(X_h,freq=FALSE, breaks=4,col="light blue",xlab="Temperatures",
     ylab="Densitat",main="Histograma de temperatures d'homes")
lines(density(X_h),lty=2,lwd=2)
curve(dnorm(x,mean(X_h),sd(X_h)),col="red",lwd=2,add=TRUE)
legend("topright",legend=c("Densitat estimada","Normal"),
       col=c("black","red"),lty=c(2,1),cex=0.5)
```
```{r,echo=FALSE,fig.width=10,fig.asp=0.5}
par(mfrow=c(1,2))
hist(X_d,freq=FALSE, breaks=4,col="light blue",xlab="Temperatures",ylab="Densitat", main="Histograma de temperatures de dones")
lines(density(X_d),lty=2,lwd=2)
curve(dnorm(x,mean(X_d),sd(X_d)),col="red",lwd=2,add=TRUE)
legend("topright",legend=c("Densitat estimada","Normal"),col=c("black","red"),lty=c(2,1),cex=0.5)
hist(X_h,freq=FALSE, breaks=4,col="light blue",xlab="Temperatures",ylab="Densitat", main="Histograma de temperatures d'homes")
lines(density(X_h),lty=2,lwd=2)
curve(dnorm(x,mean(X_h),sd(X_h)),col="red",lwd=2,add=TRUE)
legend("topright",legend=c("Densitat estimada","Normal"),col=c("black","red"),lty=c(2,1),cex=0.5)
```


i els normal-plot:
```{r,eval=FALSE}
qqPlot(X_d, distribution="norm", mean=mean(X_d), sd=sd(X_d),
       ylab="Quantils de la mostra de dones", xlab="Quantils de normal", 
       pch=20, id=FALSE)
qqPlot(X_h, distribution="norm", mean=mean(X_h), sd=sd(X_h),
       ylab="Quantils de la mostra d'homes", xlab="Quantils de normal", 
       pch=20, id=FALSE)
```
```{r,echo=FALSE,fig.width=10,fig.asp=0.5}
par(mfrow=c(1,2))
car::qqPlot(X_d, distribution="norm", mean=mean(X_d), sd=sd(X_d),
        ylab="Quantils de la mostra de dones", xlab="Quantils de normal", pch=20, id=FALSE)
car::qqPlot(X_h, distribution="norm", mean=mean(X_h), sd=sd(X_h),
        ylab="Quantils de la mostra d'homes", xlab="Quantils de normal", pch=20, id=FALSE)
```

Seria millor haver emprat un test no paramètric, per més seguretat.

### Tests no paramètrics

Quan alguna de les variables poblacionals involucrades en un test de dues variàncies no és normal, no es pot fer servir el test F. 

En aquest cas, us recomanam emprar el **test de Fligner-Killeen**, implementat en R en la funció `fligner.test`, que en la pràctica ha mostrat ser més exacte per a variables aleatòries molt diferents de normals.
**Aquest test només serveix per a contrastos bilaterals**, que en realitat són els únics interessants, i està implementat en la funció `fligner.test` de R. S'aplica a una `list` formada per les dues mostres o a una fórmula que separi una variable numèrica en dos grups.

Per exemple, per emprar-lo en el contrast bilateral de variàncies de l'exemple anterior, entraríem:


```{r}
fligner.test(list(X_h,X_d))
```

Seguim acceptant que $X_h$ i $X_d$ tenen la mateixa variància.



## Contrastos per a proporcions

### Contrastos per a una proporció

Suposem que la variable poblacional $X$ és Bernoulli de probabilitat d'èxit $p$ i que volem realitzar un contrast 
$$
\left\{\begin{array}{l}
H_{0}:p=p_{0}\\
H_{1}:p\neq p_{0}\text{ o }  p>p_0 \text{ o } p<p_0
\end{array}
\right.
$$

Tenim dues opcions: 

* Realitzar un test binomial exacte, que és el que explicàvem a la Secció \@ref(sec:moneda)
* Realitzar un test aproximat basat en l'aproximació d'una distribució binomial per una normal, i que per tant només podem emprar si la mostra és gran

#### Test binomial exacte {-}

Suposem que prenem una mostra aleatòria simple de $X$ de mida $n$ qualsevol i que hi obtenim $S_0$ èxits, de manera que $\widehat{p}_X=S_0/n$.

Si $H_0$ és vertadera, el nombre d'èxits $S$ en una mostra aleatòria simple segueix una distribució $B(n,p_0)$. Ho podem usar per calcular p-valors de la manera usual:

* Si $H_{1}:p>p_{0}$, el p-valor és $P(S\geq S_0)$

* Si $H_{1}:p<p_{0}$, el p-valor és $P(S\leq S_0)$

* Si $H_{1}:p\neq p_{0}$, el p-valor és la probabilitat que $S$ estigui tan o més allunyada que $S_0$ del nombre d'èxits qe esperaríem si $H_0$ fos vertadera, que és $p_0\cdot n$. Per tant, és
$$
\text{p-valor}=P(S\leq p_0\cdot n-|p_0\cdot n-S_0|)+P(S\geq p_0\cdot n+|p_0\cdot n-S_0|)
$$
Aquesta probabilitat també es pot calcular com la probabilitat que $S$ prengui un valor de probabilitat més petita o igual que la de $S_0$:
$$
\text{p-valor}=\sum_{k\atop P(S=k)\leq P(S=S_0)} P(S=k)
$$

```{block2,type="rmdcaution"}
Una distribució binomial $B(n,p_0)$ només és simètrica quan $p_0= 0.5$.
```

Aquest test binomial exacte està implementat en R en la funció `binom.test`

```{r,eval=FALSE}
binom.test(x, n, p=..., alternative=..., conf.level=...)
```

on `x` indica al nombre d'èxits, `n` la mida de la mostra, `p` la probablitat que es contrasta, i els altres dos paràmetres signifiquen el mateix que a les altres funcions explicades fins ara. L'interval de confiança que dóna en els contrastos bilaterals és el de Clopper-Pearson. 


```{example, esqUIB1}
Ens demanam si la proporció d'estudiants esquerrans a la UIB, és diferent de la de l'estat espanyol, que és del 10%.


```

Prenem un mostra de 30 estudiants de la UIB més o menys a l'atzar i hi trobam  1 esquerrà.

*Variable aleatòria d'interès*: $X$: "Prenem un estudiant de la UIB i miram si és esquerrà", de probabilitat d'èxit $p$

*Contrast*:
$$
\left\{\begin{array}{l}
H_{0}:p=0.1\\
H_{1}:p\neq 0.1
\end{array}
\right.
$$

Emprarem el test binomial exacte

*Estadístic de contrast*: Nombre d'èxits $S$, que si  $H_0$ és vertadera, té distribució $B(n,0.1)$

*Valor de l'estadístic de contrast*: 1

*p-valor*: Si la hipòtesi nul·la $p=0.1$ fos vertadera, en una mostra aleatòria de 30 estudiants esperaríem 3 esquerrans, i n'hem trobat 1. Per tant el p-valor és la probabilitat que $S$ sigui més petit o igual que 1 o més gran o igual que 5:


$$
P(S\leq 1)+P(S\geq 5)=\texttt{pbinom(1,30,0.1)+1-pbinom(4,30,0.1)}=`r round(pbinom(1,30,0.1)+1-pbinom(4,30,0.1),3)`
$$

*Conclusió*: No hem obtingut evidència estadísticament significativa que el percentatge d'esquerrans a la UIB sigui diferent del 10%  (test binomial, p-valor 0.36).

Amb R, entraríem:

```{r}
binom.test(1, 30, p=0.1, alternative="two.sided")
```

i a més obtenim l'IC 95% de Clopper-Pearson per a $p$, per tant podem refinar la nostra conclusió:

*Conclusió*: No hem obtingut evidència estadísticament significativa que el percentatge d'esquerrans a la UIB sigui diferent del 10%  (test binomial, p-valor 0.37, IC 95% de 0.001 a 0.172).



#### Test aproximat {-}

Suposem que prenem una mostra aleatòria simple de $X$ de mida $n$ *gran*, posem de 40 subjectes o més, i que hi obtenim una proporció mostral d'èxits  $\widehat{p}_X$.
En aquest cas, si $H_{0}:p=p_{0}$ és vertadera, pel Teorema Central del Límit, la distribució de
$$
Z=\frac{\widehat{p}_X-p_0}{\sqrt{\frac{p_0(1-p_0)}{n}}}
$$
és aproximadament la d'una variable $N(0,1)$. Ho podem emprar per calcular p-valors i intervals de confiança. Si $Z$ pren el valor $z_0$,

* Quan $H_{1}:p>p_{0}$, el p-valor és $P(Z\geq z_0)$

* Quan $H_{1}:p<p_{0}$, el p-valor és $P(Z\leq z_0)$

* Quan $H_{1}:p\neq p_{0}$, el p-valor és $2P(Z\geq |z_0|)$ (recordau que $Z$ és simètrica)


Amb R,  està  implementat en la funció 

```{r,eval=FALSE}
prop.test(x, n, p=...,alternative=..., conf.level=..., 
          correct=...)
```

on els paràmetres tenen el mateix significat que a `binom.test` excepte `correct`, que serveix per especificar si volem que s'apliqui una correcció de continuïtat (que és recomanable quan s'aproxima una variable discreta per una contínua però que nosaltres no aplicarem en realitzar contrastos "a mà" per no complicar-los) que millora els resultats. El seu valor per defecte és `TRUE`, i és el que us recomanan que empreu; el que hem explicat aquí correspon a `correct=FALSE`. L'interval de confiança que dóna aquesta funció en un contrast bilateral és el de Wilson (amb o sense correcció de continuïtat, segons el que valgui `correct`).

```{example}
Continuant amb l'Exemple \@ref(exm:esqUIB1), ara hi emprarem  el test aproximat, tot i que no és lo seu.


```


*Estadístic de contrast*:
$$
Z=\frac{\widehat{p}_X-p_0}{\sqrt{\frac{p_0(1-p_0)}{n}}} 
$$
que, si $H_0$ és vertadera, seguiria una distribució (aproximadament) normal estándard.

*Valor sobre la nostra mostra*:
$$
z_0=\frac{\frac{1}{30}-0.1}{\sqrt{\frac{0.1(1-0.1)}{30}}}=-1.22
$$

*p-valor*: $2P(Z\geq |-1.22|)=\texttt{2*(1-pnorm(1.22))}=`r round(2*(1-pnorm(1.22)),3)`$


*Conclusió*: Un altre cop, no obtenim evidència estadísticament significativa que el percentatge d'esquerrans a la UIB sigui diferent del 10%  (prop-test, p-valor 0.22).

Amb R, entraríem:

```{r,warning=TRUE}
prop.test(1, 30, p=0.1, alternative="two.sided")
```

No dóna el mateix p-valor que abans, perquè, com hem explicat, el nostre test correspon a `correct=FALSE`:

```{r,warning=TRUE}
prop.test(1, 30, p=0.1, alternative="two.sided", correct=FALSE)
```

```{block2,type="rmdncorbes"}
Si llegiu amb cura la sortida del `prop.test`, veureu que no empra un estadístic de contrast que té una distribució normal, sinó un que té  distribució $\chi^2$ amb 1 grau de llibertat: `X-squared=..., df=1`. El que passa és que R no empra l'estadístic $Z$ que hem explicat, sinó el seu quadrat, $Z^2$, que té distribució $\chi_1^2$ perquè $Z$ és normal estàndard.
```


```{block2,type="rmdnote"}
El missatge d'advertència que ens ha donat R en aquestes dues execucions de la funció `prop.test` ens diu que no se satisfan les condicions necessàries per que el resultat d'aquest contrast sigui vàlid.
```

```{example}
Quina és la potència del contrast realitzat a l'exemple anterior?


```

Emprarem les funcions del paquet **pwr** per calcular-la. Primer calculam la mida de l'efecte observat amb la funció `ES.h` aplicada a la proporció poblacional contrastada i a la proporció mostral:

```{r}
library(pwr)
ES.h(0.1,0.03)
```
I ara aplicam la funció `pwr.p.test` a la mida de l'efecte observat, `h`, la mida de la mostra, `n`, el nivell de significació, `sig.level`, i el tipus de contrast, `alternative`, i ens donarà la potència:

```{r}
pwr.p.test(h=0.3, n=30, sig.level=0.05, alternative="two.sided")
```

Què hagués passat si, en lloc d'1 esquerrà en una mostra de 30, haguéssim trobat 5 esquerrans en una mostra (aleatòria simple) de 150 estudiants, de manera que la proporció mostral fos la mateixa?

```{r}
prop.test(5, 150, p=0.1)
```

Ara podríem rebutjar amb un nivell de significació del 5% que la proporció d'esquerrans a la UIB és del 10%. Quina ha estat la potència d'aquest test?

```{r}
pwr.p.test(h=0.3, n=150, sig.level=0.05, alternative="two.sided")
```

**Amb una mostra més gran, la potència és més gran, és més fàcil detectar que la hipòtesi alternativa sigui vertadera.**


```{example}
De quina mida hauríem d'haver pres la mostra per obtenir una potència del 90% amb $\alpha=0.05$ i esperant un efecte petit?


```

Per determinar el valor d'un "efecte petit" entram

```{r}
cohen.ES(test="p",size="small")
```

i ara, a l'argument `pwr.p.test`, en lloc d'entrar-hi la mida de la mostra `n`, hi entram la potència desitjada i ens donarà la mida necessària per assolir-la: 
```{r}
pwr.p.test(h=0.2, power=0.9, sig.level=0.05, alternative="two.sided")
```

Ens caldria una mostra aleatòria simple de `r library(pwr); ceiling(pwr.p.test(h=0.2, power=0.9, sig.level=0.05, alternative="two.sided")$n)` estudiants.

```{block2,type="rmdnote"}
Com que en un contrast d'una proporció sempre hi podem emprar el test binomial exacte, no hi ha necessitat d'emprar-hi tests no paramètrics.
```

### Contrastos per a 2 proporcions emprant mostres independents

Siguin $X_1$ i $X_2$ dues variables aleatòries Bernoulli de paràmetres poblacionals d'èxit $p_1$ i $p_2$.

Volem realitzar un contrast
$$
\left\{\begin{array}{l}
H_{0}:p_1=p_2\\ 
H_{1}:p_1\neq p_2\text{ o }p_1> p_2\text{ o }p_1< p_2
\end{array}
\right.
$$

Suposem que, per realitzar aquest contrast, prenem una mostra aleatòria simple de cada variable, independents una de l'altra. 
Obtenim la taula de freqüències següent
$$
\begin{array}{r|cc|c }
  & X_1 & X_2 & \textrm{Total}  \\\hline
\textrm{Èxits} & n_{11} & n_{12} & E  \\
\textrm{Fracassos} & n_{21} & n_{22} & F   \\\hline 
\textrm{Total} & n_{1} & n_{2} 
\end{array}
$$

Aleshores tenim dues opcions: 

* Realitzar un test $\chi^2$, que es basa en una aproximació a una normal i requereix algunes condicions sobre les dues mostres
* Realitzar un test de Fisher, que es pot emprar sempre però no dóna la informació exactament com la voldríem


#### Test $\chi^2$ {-}

Suposem que les dues mostres són *grans*, per fixar idees $n_1,n_2\geq 50$, i que els nombres d'èxits i de fracasos a cada mostra *no són molt petits*, per fixar idees tots dos més grans o iguals que 5. Siguin $\widehat{p}_1$ i $\widehat{p}_2$  les proporcions mostrals d'èxits a les dues mostres.

En aquestes condicions, si la hipòtesi nul·la $H_0: p_1=p_2$ és vertadera, l'*estadístic de contrast*
$$
Z=\frac{\widehat{p}_1 -\widehat{p}_2}{
\sqrt{\frac{E}{n_1
+n_2}\cdot \Big(1-\frac{E}{n_1
+n_2}\Big)\cdot \Big(\frac{1}{n_1}+\frac{1}{n_2}
\Big)}}
$$
($E=n_1 \widehat{p}_1 +n_2 \widehat{p}_2$ és el nombre total d'èxits a les dues mostres) té distribució aproximadament normal estàndard, la qual cosa es pot emprar com sempre per calcular p-valors i intervals de confiança.

Aquest test està implementat en la funció de R

```{r,eval=FALSE}
prop.test(c(x1,x2), c(n1,n2) ,alternative=..., 
          conf.level=..., correct=...)
```

on `x1` i `x2`  són els nombres d'èxits a les dues mostres i `n1`, `n2` les seves mides. Com al cas d'una proporció, la versió que hem explicat correspon a `correct=FALSE`, però és més recomanable emprar el valor per defecte de `correct`, que és TRUE i fa que s'hi apliqui una correcció de continuïtat.



```{block2,type="rmdnote"}
Aquest test s'anomena **prop-test**, o també **test** $\chi^2$ perquè és un cas particular d'un test $\chi^2$ que veurem al proper tema. Det fet, en la seva implementació en R no s'hi empra $Z$ sinó $Z^2$, que té distribució aproximadament $\chi^2_1$.
```



```{example,allel1}
En un estudi es volgué saber si un determinat al·lel d'un gen és present o no amb la mateixa proporció entre els mallorquins i els menorquins.
Es prengueren una mostra d'ADN de 100 individus amb almenys tres generacions familiars a l'illa de Mallorca, i una altra de 50 individus amb almenys tres generacions familiars a l'illa de  Menorca: les mostres es prengueren de manera independent. A la mostra mallorquina, 20 individus tengueren l'al·lel, i a la mostra menorquina, 12. La taula de freqüències és, doncs


```

$$
\begin{array}{r|cc }
  & \textrm{Mallorca} & \textrm{Menorca}  \\\hline
\textrm{Present} & 20 & 12 \\
\textrm{Absent} & 80 & 38   \\\hline 
\textrm{Total} & 100 & 50   
\end{array}
$$

*Variables d'interés*: 

* $X_1$: "Prenem un mallorquí amb 3 generacions familiars a l'illa i miram si té aquest al·lel" 
* $X_2$: "Prenem un menorquí amb 3 generacions familiars a l'illa i miram si té aquest al·lel"

Totes dues són Bernoulli, de  proporcions poblacionals d'èxit $p_1$ i $p_2$, respectivament.


*Contrast*:
$$
\left\{\begin{array}{l}
H_0:p_1=p_2\\
H_1:p_1\neq p_2
\end{array}\right.
$$

Estam les condicions de poder emprar el test $\chi^2$, perquè les dues mostres i els seus nombres d'èxits (individus amb l'al·lel) i fracassos (individus sense l'al·lel) són prou grans.

*Estadístic de contrast*: 
$$
Z=\frac{\widehat{p}_1 -\widehat{p}_2}{
\sqrt{\frac{n_1 \widehat{p}_1 +n_2 \widehat{p}_2}{n_1
+n_2}\cdot \Big(1-\frac{n_1 \widehat{p}_1 +n_2 \widehat{p}_2}{n_1
+n_2}\Big)\cdot\Big(\frac{1}{n_1}+\frac{1}{n_2}
\Big)}}
$$
que és aproximadament $N(0,1)$ si $H_0$ és vertadera.


*Valor de l'estadístic*: Teim que $\widehat{p}_1=0.2$, $\widehat{p}_2=0.24$, $n_1=100$, $n_2=50$, $E=32$ i per tant
$$
z_0=\frac{0.2 -0.24}{
\sqrt{\frac{32}{150}\Big(1-\frac{32}{150}\Big)\Big(\frac{1}{100}+\frac{1}{50}
\Big)}}
=-0.5637
$$

*p-valor*: $2\cdot P(Z\geq |-0.5637|)=0.573$


*Conclusió*: No hem trobat evidència estadísticament significativa que les proporcions de mallorquins i menorquins amb aquest al·lel siguin diferents  (test $\chi^2$, p-valor 0.57). 

Amb R, entraríem

```{r}
prop.test(c(20,12), c(100,50), alternative="two.sided")
```

Bé, no exactament: com hem explicat, nosaltres hem fet la versió `correct=FALSE`.


```{r}
prop.test(c(20,12), c(100,50), alternative="two.sided", correct=FALSE)
```

L'interval de confiança que dóna la funció `prop.test` en un contrast de dues proporcions és per a la diferència de les proporcions,  $p_1-p_2$.

#### Test exacte de Fisher {-}

Si no se satisfan les condicions pel test $\chi^2$, sempre es pot aplicar el *test exacte de Fisher*, que es basa en la idea següent.
Tenim la taula de freqüències
$$
\begin{array}{r|cc|c }
  & X_1 & X_2 & \textrm{Total}  \\\hline
\textrm{Èxits} & n_{11} & n_{12} & E  \\
\textrm{Fracassos} & n_{21} & n_{22} & F   \\\hline 
\textrm{Total} & n_{1} & n_{2} 
\end{array}
$$

Si $p_1=p_2$, les dues variables $X_1$ i $X_2$ tenen la mateixa probabilitat d'èxit, i per tant les dues mostres podrien considerar-se com a  dues mostres independents de la mateixa variable $X_1$. Llavors, la probabilitat d'obtenir $n_{11}$ èxits dins la mostra de $X_1$ és la de:

> Si en una bossa hi tenim $E$ bolles "Èxit" i $F$ bolles "Fracàs", la probabilitat d'obtenir $n_{11}$ bolles "Èxit" si en triam $n_{1}$ de cop.

Per tant, la distribució de $n_{11}$ és hipergeomètrica $H(E,F,n_{1})$. Podem emprar $n_{11}$ com a estadístic de contrast i la distribució hipergeomètrica per calcular p-valors. 

```{example, SIDS1}
Per determinar si la Síndrome de Mort Sobtada del Nadó (SIDS) té component genètic, es consideren els casos de SIDS en parelles de bessons monozigòtics i dizigòtics. Diguem: 
  

```

* $p_1$: proporció de parelles de bessons monozigòtics amb algun cas de SIDS on només un germà la sofrí

* $p_2$: proporció de parelles de bessons dizigòtics amb algun cas de SIDS on només un germà la sofrí

Si la SIDS té component genètic, hauria de passar que $p_1<p_2$. En efecte, si aquesta síndrome té component genètic i en una parella de bessons un d'ells mor per SIDS, és més probable que l'altre bessó també la sofreixi si els bessons són monozigòtics que si són dizigòtics, ja que els genomes dels monozigòtics són pràcticament idèntics i els dels dizigòtics no. És a dir, és més probable que l'altre bessó també mori per SIDS si els bessons són monozigòtics que si són dizigòtics, o el que és el mateix, 
*és MENYS probable que l'altre bessó NO mori per SIDS si els bessons són monozigòtics que si són dizigòtics*. 



Per tant  el contrast que volem realitzar és
$$
\left\{\begin{array}{l}
H_0:p_1=p_2\\
H_1:p_1< p_2
\end{array}\right.
$$


En un estudi s'obtingueren les dades següents:
$$
\begin{array}{c}
\hphantom{Monozigotic} \textbf{Tipus de bessons} \\  
\begin{array}{lr|cc|c}
 & & \textrm{Monozigòtics} & \textrm{Dizigòtics} & \textrm{Total} \\ \hline
 \textbf{Casos} & \textrm{Un}  & 23 & 35 & 58\\
 \textbf{de SIDS} & \textrm{Dos} & 1 & 2 & 3\\\hline
 & \textrm{Total}  & 24 & 37 & 
\end{array}
\end{array}
$$

Emprarem el test de Fisher, ja que ni les mostres ni els nombres de "fracassos" no són prou grans per poder emprar el test $\chi^2$. 

*p-valor*:
$$
P(H(58,3,24)\leq 23) =\texttt{phyper(23,58,3,24)}=0.7841
$$

*Conclusió*: No hem obtingut evidència estadísticament significativa que la SIDS tengui un component genètic  (test de Fisher, p-valor 0.78).


Amb R el test de Fisher està implementat en la funció 
```{r,eval=FALSE}
fisher.test(M,alternative=...,conf.level=...)
``` 
on `M` és la matriu de freqüències de la mostra tal i com l'hem donada: fileres Èxits i Fracassos (en aquest ordre) i columnes $X_1$ i $X_2$.

En el nostre exemple, entraríem
```{r}
M=matrix(c(23,35,1,2), nrow=2, byrow=TRUE)
fisher.test(M,alternative="less")
```

Obtenim el mateix p-valor, i un interval de confiança del 95% que va de 0 a 39.7. Ja us podeu imaginar que aquest interval de confiança no pot ser per a $p_1-p_2$.


```{block2,type="rmdcaution"}
En realitat, la funció `fisher.test` no compara $p_1$ i $p_2$, sinó les seves **odds** (**oportunitats**; en castellà, també *momios*)
$$
\frac{p_1}{1-p_1}\text{ i }\frac{p_2}{1-p_2}.
$$
L'interval de confiança que dóna és per al quocient d'aquestes *odds*: la seva **odds ratio** (**OR**, **raó d'oportunitats**; en castellà, també *razón de momios*).
```

Fem un incís sobre les *odds*. Les **odds** d'un esdeveniment $A$ són
$$
\text{Odds}(A)=\frac{P(A)}{P(A^c)}=\frac{P(A)}{1-P(A)}
$$
i indiquen **quantes vegades és més probable $A$ que "no $A$"**.

Per exemple:

* Si $P(A)=0.3$, $\text{Odds}(A)=0.3/0.7=0.43$

* Si $P(A)=0$, $\text{Odds}(A)=0$

* Si $P(A)=0.5$, $\text{Odds}(A)=1$

* Si $P(A)=1$, $\text{Odds}(A)=\infty$

```{block2,type="rmdnote"}
Les *odds* d'$A$ se solen interpretar en termes d'apostes. Per desgràcia, si no estau acostumats a apostar, per exemple, a les carreres de trotons, aquesta interpretació no us aclarirà gaire. Però ho intentarem.

Suposem que $\text{Odds}(A)=m$, és a dir, que $P(A)=m\cdot P(A^c)$, i suposem que: 

* Per cada euro que jugueu a $A^c$, la casa d'apostes us en paga 1 si passa $A^c$ i 0 si passa $A$

* Per cada euro que jugueu a $A$, la casa d'apostes us en paga $R$ si passa $A$ i 0 si passa $A^c$

Això se sol abreviar dient que **les apostes a favor d'$A$ es paguen $R$ a 1**: per cada euro que es paga si "guanya" $A^c$, es paguen $R$ euros si "guanya" $A$.

Què ha de valer  $R$ per que si jugau 1 euro a $A$, el que esperau guanyar sigui el mateix que si jugau 1 euro a $A^c$? (Es diu en aquest cas que les apostes estan **equilibrades**.)

Vegem. Si jugau 1 euro a $A$, esperau guanyar $R\cdot P(A)=R\cdot m\cdot P(A^c)$, i jugau 1 euro a $A^c$ esperau guanyar $1\cdot P(A^c)$. Per tant, si aquests guanys esperats han de ser iguals, ha de passar $R\cdot m=1$, és a dir $R=1/m$. 

Així, per exemple, si $\text{Odds}(A)=2$ (la probabilitat que passi $A$ és 2 vegades la de que passi $A^c$), per que les apostes estiguin equilibrades s'han de pagar  0.5 a 1 a favor d'$A$: per cada euro que es paga si guanya $A^c$, s'ha de pagar mig euro si guanya $A$.
```

Fixau-vos que si coneixeu $\text{Odds}(A)$, podeu aïllar $P(A)$. Per exemple si $\text{Odds}(A)=0.6$
$$
\begin{array}{l}
0.6=\dfrac{P(A)}{1-P(A)}\Rightarrow 0.6-0.6P(A)=P(A)\\
\qquad \Rightarrow 0.6=1.6P(A)\Rightarrow P(A)=\dfrac{0.6}{1.6}=0.375
\end{array}
$$
En general
$$
P(A)=\dfrac{\text{Odds}(A)}{1+\text{Odds}(A)}
$$

D'aquí podeu deduir fàcilment que
$$
\begin{array}{c}
\text{Odds}(A)<\text{Odds}(B)\Longleftrightarrow P(A)<P(B)\\ 
\text{Odds}(A)>\text{Odds}(B)\Longleftrightarrow P(A)>P(B)\\ 
\text{Odds}(A)=\text{Odds}(B)\Longleftrightarrow P(A)=P(B)
\end{array}
$$
i per tant comparant les probabilitats o les *odds* de dos esdeveniments obteniu la mateixa informació sobre quin és més probable.

La *odds ratio* de $A$ i $B$ és
$$
  \text{OR}(A,B)=\frac{\text{Odds}(A)}{\text{Odds}(B)}
$$

Aquest quocient sol ser mal d'interpretar, i per això precisament sempre que poguem evitarem el test exacte de Fisher. 

```{block2,type="rmdnote"}
En tot cas, fixau-vos que si $\text{OR}(A,B)=r$, és a dir, $\text{Odds}(A)=r\cdot \text{Odds}(B)$, i les apostes a favor de $A$ es paguen $R_A$ a 1 i les de $B$ es paguen $R_B$ a 1 i les dues estan equilibrades, aleshores
$$
\frac{1}{R_A}=r\cdot \frac{1}{R_B}\Longrightarrow R_B=r\cdot R_A
$$

Per tant, si $\text{OR}(A,B)=r$ i les apostes a favor de $B$ es paguen $R_B$ a 1, les apostes a favor d'$A$ s'han de pagar $rR_B$ a 1.
```

```{block2,type="rmdimportant"}
$\text{OR}(A,B)=1$ si, i només si, $\text{Odds}(A)=\text{Odds}(B)$ i per tant, pel que acabam de dir, si, i només si, $P(A)=P(B)$.

Per tant, si l'interval de confiança per a la *odds ratio* que dóna la funció `fisher.test` conté l'1, no podem rebutjar que les dues proporcions poblacionals d'èxit siguin iguals.
```



```{example}
Si, per exemple, la *odds ratio* de $A$ i $B$ és
$$
  \text{OR}(A,B)=\frac{\text{Odds}(A)}{\text{Odds}(B)}=1.5
$$
i per tant $\text{Odds}(A)=1.5\cdot \text{Odds}(B)$:
  

```

* Com que en particular $\text{Odds}(A)> \text{Odds}(B)$, podeu concloure que $P(A)>P(B)$

* Però el fet que $\text{Odds}(A)=1.5\cdot \text{Odds}(B)$ **no implica** que $P(A)=1.5P(B)$. De fet, d'aquest de $OR(A,B)$ no podeu deduir el valor de $P(A)/P(B)$. Intentau-ho si no ens creieu.



```{example}
Si realitzam el contrast de l'Exemple \@ref(exm:allel1) amb el test $\chi^2$, obtenim


```

```{r}
prop.test(c(20,12),c(100,50),alternative="two.sided",correct=FALSE)
```


* El p-valor 0.5729 no ens permet rebutjar que les proporcions de mallorquins i menorquins amb l'al·lel objecte d'estudi siguin iguals

* L'IC 95% per a la diferència de proporcions va de -0.18 a 0.1: com que conté el 0, no podem rebutjar amb aquest nivell de confiança que les proporcions siguin iguals

* La diferència de proporcions mostrals $p_1-p_2$ ha estat $0.2-0.24=-0.04$: la proporció de menorquins amb l'al·lel a la nostra mostra ha estat 4 punts percentuals més gran que la dels mallorquins


Si ara l'efectuam amb el test de Fisher:

```{r}
M.A=matrix(c(20,12,80,38), nrow=2, byrow=TRUE)
fisher.test(M.A,alternative="two.sided")
```


* El p-valor 0.673 no ens permet rebutjar que les **odds** de tenir aquest al·lel entre els mallorquins i els menorquins siguin iguals; com que igualtat d'*odds* és equivalent a igualtat de probabilitats, no podem rebutjar que els mallorquins i menorquins tenguin la mateixa probabilitat de tenir l'al·lel objecte d'estudi

* L'IC 95% per a la **odds ratio**  (per al quocient de les *odds*) va de 0.33 a 1.97: com que conté l'1, no podem rebutjar amb aquest nivell de confiança que la *odds ratio* sigui 1; és a dir, no podem rebutjar que les *odds* siguin iguals; és a dir, no podem rebutjar que les proporcions siguin iguals

* El *quocient d'odds mostrals* (la **odds ratio mostral**) ha estat 0.79: a la nostra mostra, les *odds* que un mallorquí tengués l'al·lel han estat 0.79 vegades (un 21% més petites que) les d'un menorquí; però això no ens dóna cap relació numèrica entre les proporcions mostrals de mallorquins i menorquins amb l'al·lel.


### Contrastos per a 2 proporcions emprant mostres aparellades

Siguin  una altra vegada $X_1$ i $X_2$ dues variables aleatòries Bernoulli de paràmetres poblacionals $p_1$ i $p_2$.
Seguim volent  realitzar un contrast
$$
\left\{\begin{array}{l}
H_{0}:p_1=p_2\\ 
H_{1}:p_1\neq p_2\text{ o }p_1> p_2\text{ o }p_1< p_2
\end{array}
\right.
$$
però ara les mesuram sobre els subjectes d'una mateixa mostra, o sobre els subjectes de dues mostres aparellades, de mida $n$.
Suposem que tenim els resultats en una taula


$$
\begin{array}{c}
\hphantom{Variablesssss}  \text{Variable $X_2$}\\
\begin{array}{r|cc}
\text{Variable $X_1$} &\text{Èxit} & \text{Fracàs} \\  \hline
\text{Èxit} & a & b \\
\text{Fracàs} & c & d\\ 
\end{array}
\end{array}
$$
on cada entrada representa el nombre de subjectes (o parelles) que satisfan les condicions de la filera i la columna.

En aquest cas tenim dues opcions: 

* Realitzar un test de McNemar, que només serveix per a contrastos bilaterals i a més requereix algunes condicions sobre les dues mostres
* Realitzar un test binomial, que es pot emprar sempre però no dóna la informació exactament com la voldríem


#### Test de McNemar {-}

Quan el test és **bilateral**, si  $n$ és prou gran (posem, a partir de 100) i si el nombre de **casos discordants** ($b+c$ en la taula anterior) és grandet (posem, més gran o igual que 20), es pot emprar el **test de McNemar**, que empra l'estadístic de contrast
$$
Z^2=\frac{(b-c)^2}{b+c}
$$
el qual, si se satisfan les condicions esmentades, segueix aproximadament una distribució $\chi^2_1$ si $H_0$ és vertadera. 

En aquest test se rebutja la hipòtesi nul·la si $b$ i $c$ són prou diferents i per tant, malgrat ser un contrast bilateral, es pren com a p-valor $P(Z^2\geq Z_0^2)$, on $Z_0^2$ és el valor de l'estadístic a la nostra mostra i $Z^2$ té distribució $\chi_1^2$.



Aquest test està implementat en R en la funció `mcnemar.test`, que s'aplica a la taula de freqüències absolutes de la mostra tal i com l'hem donada.

```{example,migranya}
En un assaig clínic es volgué comparar l'efectivitat d'un fàrmac nou contra la migranya amb la d'un placebo.
Es prengué una mostra de 500 persones afectades per migranya. A cada una, a l'atzar, se li administrà el fàrmac o el placebo. Se'ls demanà si havien notat alleujament en el dolor. Al cap d'un temps, als mateixos individus se'ls subministrà l'altre tractament (fàrmac als que havien rebut placebo, placebo als que havien rebut fàrmac) i se'ls tornà a demanar si havien notat o no millora.


```

Els resultats varen ser:
$$
\begin{array}{c}
\hphantom{Variables}  \text{Placebo}\\
\begin{array}{r|cc}
\text{Fàrmac} &\text{Sí} & \text{No} \\  \hline
\text{Sí} & 150 & 41  \\
\text{No} & 19 & 285\\ 
\end{array}
\end{array}
$$
on "Sí" indica que el malalt va dir que sí que havia notat alleujament en el dolor.

*Variables d'interès*:

* $X_1$: "Prenem un malalt, li administram el fàrmac  i li demanam si nota millora del dolor". És Bernoulli de proporció poblacional $p_1$

* $X_2$: "Prenem un malalt, li administram el placebo i li demanam si nota millora del dolor". És Bernoulli de proporció poblacional $p_2$

*Contrast*: Com que la mostra i el nombre de casos discordants són prou grans, podem emprar el test de McNemar, però aleshores el contrast ha de ser bilateral
$$
\left\{\begin{array}{l}
H_0:p_1=p_2\\
H_1:p_1\neq  p_2
\end{array}\right.
$$

*Estadístic de contrast*:
$$
Z^2=\frac{(b-c)^2}{b+c}
$$
que segueix una distribució aproximadament $\chi_1^2$ si $p_1=p_2$.

*Valor sobre la nostra mostra*: $Z_0^2=(41-19)^2/(41+19)=8.067$

*p-valor*: $P(Z^2\geq 8.067)=\texttt{1-pchisq(8.067,1)}=`r round(1-pchisq(8.067,1),4)`$

*Conclusió*: Hem obtingut evidència estadísticament significativa que la taxa d'efectivitat del placebo i del fàrmac són diferents  (test de McNemar, p-valor `r round(1-pchisq(8.067,1),4)`).  

I ara, com que la taxa d'efectivitat del fàrmac ha estat superior a la del placebo  (191/500 contra 169/500), faríem la petita trampa de concloure que la diferència entre aquestes taxes d'efectivitat és perquè el fàrmac es més efectiu. 

Amb R, entraríem

```{r}
Dades.M=matrix(c(150,41,19,285), nrow=2, byrow=TRUE)
mcnemar.test(Dades.M)
```

Ups! No ha donat el mateix estadístic ni el mateix p-valor. Això passa perquè R també aplica per defecte una correcció de continuïtat al test de McNemar. El que nosaltres hem explicat correspon a

```{r}
mcnemar.test(Dades.M,correct=FALSE)
```


#### Test binomial exacte {-}

Si no podeu emprar el test de McNemar, sempre podeu emprar el **test binomial exacte** següent.

Considerau la taula de probabilitats poblacionals

$$
\begin{array}{c}
\hphantom{Variablesssss}  \text{Variable $X_2$}\\
\begin{array}{r|cc}
\text{Variable $X_1$} &\text{Èxit} & \text{Fracàs} \\  \hline
\text{Èxit} & p_{11} & p_{10} \\
\text{Fracàs} & p_{01} & p_{00}
\end{array}
\end{array}
$$

Llavors
$$
p_1=p_{11}+p_{10},\ p_2=p_{11}+p_{01}
$$
i per tant
$$
\begin{array}{l}
p_1=p_2\Longleftrightarrow   p_{10}=p_{01}\\
p_1\neq p_2\Longleftrightarrow   p_{10}\neq p_{01}\\
p_1< p_2\Longleftrightarrow   p_{10}< p_{01}\\
p_1> p_2\Longleftrightarrow   p_{10}> p_{01}
\end{array}
$$


Això permet traduir un contrast sobre $p_1$ i $p_2$ en el mateix  contrast sobre $p_{01}$ i $p_{10}$, i al final en un contrast d'una proporció.

Per exemple:
$$
\left\{\begin{array}{l}
H_0: p_1=p_2\\
H_1: p_1< p_2
\end{array}\right. 
$$
és equivalent a
$$
\left\{\begin{array}{l}
H_0: p_{10}=p_{01}\\
H_1: p_{10}<p_{01}
\end{array}\right.
$$
i això és equivalent a
$$
\left\{\begin{array}{l}
H_0: \dfrac{p_{10}}{p_{10}+p_{01}}=0.5\\
H_1:  \dfrac{p_{10}}{p_{10}+p_{01}}<0.5
\end{array}\right.
$$


Ara fixau-vos que
$$
\frac{p_{10}}{p_{10}+p_{01}}
$$
és la proporció poblacional de parelles (Èxit,Fracàs) dins la població de casos discordants.

En general, el contrast
$$
\left\{\begin{array}{l}
H_0: p_1=p_2\\
H_1: p_1< p_2\text{ o }p_1> p_2\text{ o }p_1\neq p_2
\end{array}\right. 
$$
es tradueix en el contrast
$$
\left\{\begin{array}{l}
H_0: \dfrac{p_{10}}{p_{10}+p_{01}}=0.5\\
H_1:  \dfrac{p_{10}}{p_{10}+p_{01}}<0.5\text{ o }\dfrac{p_{10}}{p_{10}+p_{01}}>0.5\text{ o }\dfrac{p_{10}}{p_{10}+p_{01}}\neq 0.5
\end{array}\right.
$$
i el podem efectuar amb un test binomial exacte prenent:


* Com a mostra, els casos discordants, de mida $b+c$

* Com a èxits, tenir Èxit a $X_1$ i Fracàs a $X_2$: a la mostra n'hi ha $b$

* Com a proporció a contrastar:  $p=0.5$

L'inconvenient d'aquest test és  que l'interval de confiança que donarà és per a $p_{10}/(p_{10}+p_{01})$, i no té res a veure amb $p_1-p_2$ o $p_1/p_2$. Per tant només ens hi podem fixar en el p-valor.

```{example}
Tornem a la situació de l'Exemple \@ref(exm:migranya). Ara volem fer el contrast que realment ens interessa, que és si la taxa d'efectivitat del fàrmac és més gran que la del placebo:


```

$$
\left\{\begin{array}{l}
H_0:p_1=p_2\\
H_1:p_1>p_2
\end{array}\right.
$$



Dient $p=p_{10}/(p_{10}+p_{01})$, el traduïm en
$$
\left\{\begin{array}{l}
H_0:p=0.5\\
H_1:p> 0.5
\end{array}\right.
$$

Les dades eren
$$
\begin{array}{c}
\hphantom{Variables}  \text{Placebo}\\
\begin{array}{r|cc}
\text{Fàrmac} &\text{Sí} & \text{No} \\  \hline
\text{Sí} & 150 & 41  \\
\text{No} & 19 & 285
\end{array}
\end{array}
$$

I per tant al contrast sobre $p$ emprarem la mostra de 60 casos discordants on 41 són Èxits. Ho fen directament amb R:

```{r}
binom.test(41, 60, p=0.5, alternative="greater")
```

*Conclusió*: Hem obtingut evidència estadísticament significativa que la taxa d'efectivitat del placebo i del fàrmac són diferents  (test binomial, p-valor 0.003).  


