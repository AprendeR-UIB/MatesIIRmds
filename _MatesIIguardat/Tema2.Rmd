---
title: "Intervals de confiança"
output: html_document

---

```{r global_options, include=FALSE}
library(knitr)
opts_chunk$set(fig.width=6, fig.height=6, fig.align="center", echo=TRUE, warning=FALSE, message=FALSE)
library(printr)
```

```{r}
set.seed(42)
library(epitools)
```

#### L'experiment per veure quantes vegades encerta un IC 95%

Generam una **Població** de $10^7$ "individus" que segueixen una llei normal estàndard. Definim una funció **IC** que calcula l'IC 95% explicat a classe per a la mitjana. Llavors, prenem 200 mostres aleatòries simples de mida 50 de la nostra població i les aplicam aquesta funció. Finalment miram quantes vegades hem encertat, és a dir, quantes vegades hem obtingut un interval que conté la mitjana poblacional. 

```{r}
Poblacio=rnorm(10^7) #Població N(0,1)
mu=mean(Poblacio)
IC=function(x){
  n=length(x)
  mean(x)+qt(0.975,n-1)*sd(x)/sqrt(n)*c(-1,1)}
M=replicate(200,
  IC(sample(Poblacio,50,replace=TRUE)))
Encerts=length(which((mu<M[1,]) | (mu>M[2,])))
```

Hem encertat `r Encerts` vegades, és a dir, un `r round(100*Encerts/200,1)`% de les vegades

Per veure millor els encerts, dibuixam els intervals en un gràfic, on apareixeran en gris els que encerten i en vermell els que no encerten.

```{r,results="hide"}
plot(1,type="n",xlim=c(-0.8,0.8),ylim=c(0,200),
  xlab="Valors",ylab="Repeticions",
  main="200 IC 95%")
seg.int=function(i){color="grey";
  if((mu<M[1,i]) | (mu>M[2,i])){color = "red"}
  segments(M[1,i],i,M[2,i],i,col=color,lwd=2)}
sapply(1:200,FUN=seg.int)
abline(v=mu,lwd=2)
```

11 errors de 200 és aproximadament el que esperàvem, però us hauríeu de fixar que a la nostra mostra els errors no es distribueixen per igual als dos costats, mentre que, en teoria, esperam que un 2.5% de les vegades la mitjana poblacional estigui a l'esquerra de l'interval calculat i un 2.5% de les vegades estigui a la dreta. Coses de l'aleatorietat. Si ho provau amb altres llavors d'aleatorietat obtendreu altres resultats, de vegades millors, de vegades pitjors.


#### Gràfic de les probabilitats d'error amb nivell de confiança del 95%

Un 5% de les vegades que calculam un IC 95%, el paràmetre poblacional no pertany a l'interval obtingut. Per tant, si calculam *n* IC 95% sobre mostres aleatòries simples independents, el nombre de vegades que l'interval resultant no contendrà el paràmetre poblacional seguirà una distribució binomial $B(n,0.05)$. El gràfic següent dóna $P(X\geq 1)$ per a una v.a. $X\sim B(n,0.05)$, $n=0,\ldots,100$, i per tant la probabilitat que si calculam *n* IC 95% sobre mostres aleatòries simples independents, almenys un no contengui el paràmetre poblacional desitjat.

```{r}
plot(1-dbinom(0,0:100,0.05),pch=20,xlab="n",ylab="Probabilitat",main="Probabilitat de qualque èxit en una B(n,0.05)")
```


#### Càlcul d'un IC amb t.test

La funció **t.test** aplicada a un vector calcula, entre altres coses, l'interval de confiança per a la mitjana de la v.a. de la que el vector n'és una mostra, emprant la fórmula basada en la distribució t de Student explicada a classe. El paràmetre **conf.level** permet especificar el nivell de confiança (en tant per u). El seu valor per defecte és 0.95, així que per calcular un IC 95% no cal especificar-lo.

Com a exemple, generarem una mostra aleatòria de 100 nombres amb distribució normal estàndard i calcularem un IC 95% i un IC 99% de la mitjana de la v.a. que els ha produit:

```{r}
x=rnorm(100)
t.test(x,conf.level=0.95)
t.test(x,conf.level=0.99)
```

Sota el text **... percent confidence interval:** apareix l'interval de confiança desitjat. Observareu que l'IC 95% és més estret que l'IC 99%, com hem anunciat a classe. I que en aquest cas (amb el **set.seed(42)** al preamble) no ha encertat: els IC no contenen el la mitjana poblacional vertadera, que és 0!

Si, per qualque motiu, voleu només els extrems de l'interval de confiança obtingut d'aquesta manera, s'obtenen amb el sufix **$conf.int**

```{r}
round(t.test(x,conf.level=0.95)$conf.int,3)
round(t.test(x,conf.level=0.99)$conf.int,3)
```

#### Exemple de bootstrap

Tenim les 25 dades en un fitxer **Dades.txt**. 

* El llegim 
* Prenem 5000 m.a.s.(amb repetició!) de mida 25 (la mida del vector) d'aquest vector
* Calculam la mitjana de cada una
* Prenem com a IC 90% l'interval que va del quantil 0.05 al quantil 0.95 d'aquest vector de mitjanes

```{r}
Dades=scan("Dades.txt")
mean(Dades)
sd(Dades)
Simulacions=replicate(5000,mean(sample(Dades,25,rep=TRUE)))
quantile(Simulacions,0.05)
quantile(Simulacions,0.95)
```

Obtenim en aquesta execució l'interval (`r round(quantile(Simulacions,0.05),2)`, `r round(quantile(Simulacions,0.95),2)`). Amb la fórmula basada amb la t de Student obteníem l'interval (`r round(t.test(Dades,conf.level=0.9)$conf.int[1],2)`, `r round(t.test(Dades,conf.level=0.9)$conf.int[2],2)`):

```{r}
round(t.test(Dades,conf.level=0.9)$conf.int,2)
```



#### Alguns càlculs d'intervals de confiança per a proporcions

IC 95% de Clopper-Pearson a partir d'una mostra de mida 10 amb 2 èxits:

```{r}
# Ja hem carregat al preamble el paquet epitools
round(binom.exact(2,10,0.95),3)  #Clopper-Pearson
```

IC 95% de Clopper-Pearson, de Wilson i de Laplace a partir d'una mostra de mida 500 amb 340 èxits:

```{r}
round(binom.exact(340,500,0.95),3)  #Clopper-Pearson
round(binom.wilson(340,500,0.95),3) #Wilson
round(binom.approx(340,500,0.95),3) #Laplace
```

IC 95% de Clopper-Pearson, de Wilson i de Laplace a partir d'una mostra de mida 100 amb 25 èxits:

```{r}
round(binom.exact(25,100),4)  #Clopper-Pearson
round(binom.wilson(25,100),4) #Wilson
round(binom.approx(25,100),4) #Laplace
```

IC 95% de Wilson a partir de la mostra anterior emprant **prop.test**:

```{r}
prop.test(25,100)  #Wilson amb correcció de continuitat
prop.test(25,100,correct=FALSE) #Wilson
```


#### Els gràfic de la regla del 3

Comparació gràfica de $3/n$ amb l'extrem superior de l'IC 95% de Clopper-Pearson a partir d'una mostra de mida $n$ amb 0 èxits:

```{r}
f=function(n){binom.exact(0,n)$upper}
plot(1:100,sapply(1:100,f),pch=20,cex=0.7,xlab="n",ylab="Extrem superior",main="Extrem superior d'un IC 95% en cas de 0 èxits")
curve(3/x,col="red",lwd=2,add=TRUE)
legend("topright",lty=c(NA,1),pch=c(20,NA),legend=c("Clopper-Pearson","Regla del 3"),col=c("black","red"),cex=0.7)
```

Comparació gràfica de les fraccions $3/n$ amb l'extrem superior de l'IC 95% de Clopper-Pearson i de Wilson a partir d'una mostra de mida $n$ ($n\geq 40$ per als IC de Wilson) amb 0 èxits:


```{r}
f=function(n){binom.exact(0,n)$upper}
plot(1:100,sapply(1:100,f),pch=20,cex=0.5,xlab="n",ylab="Extrem superior",main="Extrem superior d'un IC 95% en cas de 0 èxits")
curve(3/x,col="red",lwd=1.5,add=TRUE)
points(40:100,3.84/(40:100+3.84),pch=20,cex=0.5,col="blue")
legend("topright",lty=c(NA,NA,1),pch=c(20,20,NA),legend=c("Clopper-Pearson","Wilson","Regla del 3"),col=c("black","blue","red"),cex=0.7)
```

Els extrems superiors dels intervals de Clopper-Pearson i Wilson se superposen...

#### L'interval de confiança per la variància

```{r}
Temps=c(12,13,13,14,14,14,15,15,16,17,17,18,18,19,19,25,25,26,27,30,33,34,35,40,40,51,51,58,59,83)
length(Temps) #n
var(Temps) #variància mostral
qchisq(0.975,29) #quantil 0.975 de la khi^2_29
qchisq(0.025,29) #quantil 0.025 de la khi^2_29
round(c((length(Temps)-1)*var(Temps)/qchisq(0.975,29), (length(Temps)-1)*var(Temps)/qchisq(0.025,29)),2) #L'IC per a la variància
round(sqrt(c((length(Temps)-1)*var(Temps)/qchisq(0.975,29), (length(Temps)-1)*var(Temps)/qchisq(0.025,29))),2) #L'IC per a la desviació típica
```

